
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Payment Dashboard</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

<!-- Shift Database -->
<script src="fireshift.js"></script>

<!-- Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
    --gold: #D4AF37;
    --gold-light: #F5E8B8;
    --gold-lighter: #FDF8E3;
    --gold-dark: #B8860B;
    --light: #FFFDF6;
    --dark: #333333;
    --success: #28a745;
    --warning: #f39c12;
    --danger: #e74c3c;
    --info: #3498db;
    --border: #E5D9B6;
    --radius: 8px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    background: #f9f9f9;
    color: var(--dark);
    line-height: 1.5;
}

/* Header */
.header {
    background: var(--gold);
    color: white;
    padding: 18px 25px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.header-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.header-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.header-item i {
    font-size: 16px;
}

.user-badge {
    background: rgba(255,255,255,0.2);
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 500;
}

.header-btn {
    background: white;
    color: var(--gold-dark);
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
}

.header-btn:hover {
    background: var(--gold-lighter);
    transform: translateY(-1px);
}

.header-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
}

/* Main Content */
.container {
    max-width: 1200px;
    margin: 30px auto;
    padding: 0 20px;
}

/* Dashboard Card */
.dashboard-card {
    background: white;
    border-radius: var(--radius);
    box-shadow: 0 3px 15px rgba(0,0,0,0.05);
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid var(--border);
}

.card-title {
    font-size: 20px;
    font-weight: 600;
    color: var(--gold-dark);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--gold-light);
}

.card-title i {
    color: var(--gold);
}

/* Shift Status */
.shift-status {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 25px;
    padding: 15px;
    background: var(--gold-lighter);
    border-radius: var(--radius);
    border-left: 4px solid var(--gold);
}

.status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #95a5a6;
}

.status-dot.active {
    background: var(--success);
    animation: pulse 2s infinite;
}

.status-dot.inactive {
    background: var(--danger);
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.shift-info {
    flex: 1;
}

.shift-label {
    font-size: 14px;
    color: #666;
    margin-bottom: 4px;
}

.shift-value {
    font-size: 18px;
    font-weight: 600;
    color: var(--dark);
}

.shift-time {
    font-size: 12px;
    color: #777;
    margin-top: 3px;
    font-style: italic;
}

/* Buttons Grid */
.buttons-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.dashboard-btn {
    background: white;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
    color: var(--dark);
    text-decoration: none;
}

.dashboard-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    border-color: var(--gold);
    background: var(--gold-lighter);
}

.dashboard-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.dashboard-btn.disabled:hover {
    transform: none;
    box-shadow: none;
    border-color: var(--border);
    background: white;
}

.btn-icon {
    width: 50px;
    height: 50px;
    background: var(--gold-light);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: var(--gold-dark);
}

.btn-content {
    flex: 1;
}

.btn-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 5px;
}

.btn-description {
    font-size: 13px;
    color: #666;
    line-height: 1.4;
}

/* Special Buttons */
.btn-cash {
    border-left: 4px solid var(--success);
}

.btn-cash .btn-icon {
    background: #d4edda;
    color: var(--success);
}

.btn-logout {
    border-left: 4px solid #dc3545;
}

.btn-logout .btn-icon {
    background: #f8d7da;
    color: #dc3545;
}

.btn-payment {
    border-left: 4px solid var(--info);
}

.btn-payment .btn-icon {
    background: #d1ecf1;
    color: var(--info);
}

/* Status Message */
.status-message {
    padding: 12px 15px;
    margin: 15px 0;
    border-radius: var(--radius);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.status-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.status-info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

.status-warning {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

/* Last Updated */
.last-updated {
    font-size: 11px;
    color: #888;
    margin-top: 5px;
    font-style: italic;
}

/* Responsive */
@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .header-item {
        width: 100%;
        justify-content: space-between;
    }
    
    .shift-status {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .buttons-grid {
        grid-template-columns: 1fr;
    }
    
    .container {
        padding: 0 15px;
        margin: 20px auto;
    }
    
    .dashboard-card {
        padding: 20px;
    }
}

@media (max-width: 480px) {
    .header {
        padding: 15px;
    }
    
    .dashboard-btn {
        padding: 15px;
    }
    
    .btn-icon {
        width: 40px;
        height: 40px;
        font-size: 18px;
    }
}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
    <div class="header-content">
        <div class="header-item">
            <i class="fas fa-user"></i>
            <span class="user-badge">
                <span id="userName"></span> (<span id="userLevel"></span>)
            </span>
        </div>
        
        <div class="header-item">
            <i class="fas fa-calendar-alt"></i>
            <span id="currentDate">Loading...</span>
        </div>
        
        <div class="header-item">
            <i class="fas fa-clock"></i>
            <span id="currentShift">Loading...</span>
        </div>
        
        <button class="header-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            Logout
        </button>
    </div>
</div>

<!-- Main Content -->
<div class="container">
    <div class="dashboard-card">
        <h2 class="card-title">
            <i class="fas fa-tachometer-alt"></i>
            Payment Dashboard
        </h2>
        
        <!-- Shift Status -->
        <div class="shift-status">
            <div class="status-dot" id="statusDot"></div>
            <div class="shift-info">
                <div class="shift-label">Current Shift Status</div>
                <div class="shift-value" id="shiftStatusText">Loading shift status...</div>
                <div class="shift-time" id="shiftTime"></div>
                <div class="last-updated" id="lastUpdated"></div>
            </div>
            <button class="header-btn" id="refreshBtn" onclick="refreshShiftData()">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
        </div>
        
        <!-- Status Message -->
        <div id="statusMessage"></div>
        
        <!-- Navigation Buttons -->
        <div class="buttons-grid">
            <a href="pay.html" class="dashboard-btn btn-payment" id="newPaymentBtn">
                <div class="btn-icon">
                    <i class="fas fa-plus-circle"></i>
                </div>
                <div class="btn-content">
                    <div class="btn-title">New Payment</div>
                    <div class="btn-description">Create new payment entry</div>
                    <div class="last-updated" id="paymentStatus"></div>
                </div>
            </a>
            
            <a href="shiftend.html" class="dashboard-btn">
                <div class="btn-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="btn-content">
                    <div class="btn-title">Reports</div>
                    <div class="btn-description">View shift reports and analytics</div>
                </div>
            </a>
            
            <a href="void.html" class="dashboard-btn" id="updatePaymentsBtn">
                <div class="btn-icon">
                    <i class="fas fa-sync-alt"></i>
                </div>
                <div class="btn-content">
                    <div class="btn-title">Update Payments</div>
                    <div class="btn-description">Manage and update payment records</div>
                </div>
            </a>
            
            <a href="#" class="dashboard-btn btn-cash" id="cashDrawerBtn">
                <div class="btn-icon">
                    <i class="fas fa-cash-register"></i>
                </div>
                <div class="btn-content">
                    <div class="btn-title">Cash Drawer</div>
                    <div class="btn-description">Open cash drawer for transactions</div>
                </div>
            </a>
            
            <a href="dash.html" class="dashboard-btn">
                <div class="btn-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="btn-content">
                    <div class="btn-title">Main Dashboard</div>
                    <div class="btn-description">Return to main dashboard view</div>
                </div>
            </a>
            
            <a href="#" class="dashboard-btn btn-logout" onclick="logout()">
                <div class="btn-icon">
                    <i class="fas fa-sign-out-alt"></i>
                </div>
                <div class="btn-content">
                    <div class="btn-title">Logout</div>
                    <div class="btn-description">Sign out from the system</div>
                </div>
            </a>
        </div>
    </div>
</div>

<script>
// ========== PAYMENT DASHBOARD SCRIPT ==========

// ========== PAYMENT DASHBOARD SCRIPT ==========

console.log("üîß Payment Dashboard script loading...");

// ----------- LOCAL STORAGE KEYS -----------
const SHIFT_STORAGE_KEY = 'currentShiftData';
const SHIFT_TIMESTAMP_KEY = 'shiftDataTimestamp';

// ----------- Load user data -----------
let userData;
try {
    userData = JSON.parse(localStorage.getItem("loggedInUser"));
    console.log("üë§ User data from localStorage:", userData);
    
    if (userData) {
        const name = userData.name || userData.username || "User";
        const role = userData.role || userData.Level || "User";
        document.getElementById("userName").textContent = name;
        document.getElementById("userLevel").textContent = role;
    } else {
        console.log("‚ö†Ô∏è No user found, redirecting to login...");
        window.location.href = "login.html";
        throw new Error("No user data");
    }
} catch (e) {
    console.error("‚ùå Error loading user data:", e);
    setTimeout(() => {
        window.location.href = "login.html";
    }, 2000);
}

// ----------- Set current date -----------
const today = new Date();
document.getElementById("currentDate").textContent = today.toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
});

// ----------- Initialize Firebase with shift config -----------
let shiftFirestore = null;

function initializeShiftFirebase() {
    try {
        console.log("Initializing Firebase with shift config...");
        
        // Check if fireshift.js loaded the config
        if (typeof firebaseConfig === 'undefined' && typeof shiftFirebaseConfig === 'undefined') {
            console.error("‚ùå Shift Firebase config not found in fireshift.js");
            showMessage("Firebase configuration not found", "error");
            return null;
        }
        
        // Use whichever config is available
        const config = firebaseConfig || shiftFirebaseConfig;
        console.log("Using Firebase config for project:", config.projectId);
        
        // Check if Firebase app already exists
        let app;
        try {
            // Try to get existing app
            app = firebase.app('shiftApp');
            console.log("Using existing Firebase app: shiftApp");
        } catch (e) {
            // Create new app for shifts
            app = firebase.initializeApp(config, 'shiftApp');
            console.log("Created new Firebase app: shiftApp");
        }
        
        // Initialize Firestore
        shiftFirestore = firebase.firestore(app);
        console.log("‚úÖ Shift Firestore initialized successfully");
        
        return shiftFirestore;
        
    } catch (error) {
        console.error("‚ùå Error initializing shift Firebase:", error);
        showMessage("Failed to initialize Firebase", "error");
        return null;
    }
}

// ----------- FORMAT DATE FOR DOCUMENT ID -----------
function formatDateForDocumentId(date) {
    // Returns date in format: YYYY_MM_DD (for document ID: shift_YYYY_MM_DD)
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}_${month}_${day}`;
}

// ----------- FORMAT DATE FOR DISPLAY -----------
function formatDateForDisplay(dateString) {
    // Returns date in format: YYYY-MM-DD (for field comparison)
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
    });
}

// ----------- CHECK FOR OPEN SHIFT IN DATA -----------
function checkForOpenShift(shiftData) {
    console.log("üîç Checking for open shift in data...");
    
    let result = {
        success: false,
        isActive: false,
        shiftName: "No Shift Open",
        shiftType: "",
        openTime: "",
        details: {}
    };
    
    if (!shiftData) {
        return result;
    }
    
    // Check morning shift
    if (shiftData.morning && shiftData.morning.status === 'open') {
        result.success = true;
        result.isActive = true;
        result.shiftName = "Morning Shift";
        result.shiftType = "morning";
        result.openTime = shiftData.morning.open || "";
        result.details = shiftData.morning;
        console.log("‚úì Morning shift is OPEN");
        return result;
    }
    
    // Check evening shift
    if (shiftData.evening && shiftData.evening.status === 'open') {
        result.success = true;
        result.isActive = true;
        result.shiftName = "Evening Shift";
        result.shiftType = "evening";
        result.openTime = shiftData.evening.open || "";
        result.details = shiftData.evening;
        console.log("‚úì Evening shift is OPEN");
        return result;
    }
    
    // Check if both shifts are "not_available"
    if (shiftData.morning && shiftData.morning.status === "not_available" && 
        shiftData.evening && shiftData.evening.status === "not_available") {
        result.success = true;
        result.shiftName = "Shifts Not Started Today";
        console.log("‚è≥ Both shifts not available yet");
        return result;
    }
    
    // Check if both shifts are closed
    if ((!shiftData.morning || shiftData.morning.status === "closed") && 
        (!shiftData.evening || shiftData.evening.status === "closed")) {
        result.success = true;
        result.shiftName = "All Shifts Closed";
        console.log("üîí All shifts closed");
        return result;
    }
    
    // Default case
    result.success = true;
    return result;
}

// ----------- SEARCH PREVIOUS DATES FOR OPEN SHIFT -----------
async function findOpenShiftInPreviousDates(startDate) {
    console.log("üîô Searching for open shift in previous dates...");
    
    try {
        // Search up to 7 previous days
        for (let i = 1; i <= 7; i++) {
            // Go back i days
            const previousDate = new Date(startDate);
            previousDate.setDate(startDate.getDate() - i);
            
            // Format for document ID: YYYY_MM_DD
            const previousDateForDocId = formatDateForDocumentId(previousDate);
            const previousDocId = `shift_${previousDateForDocId}`;
            
            // Format for display: YYYY-MM-DD
            const previousDateForDisplay = formatDateForDisplay(previousDate);
            
            console.log(`üìÖ Checking date ${i} day(s) ago: ${previousDateForDocId} (${previousDateForDisplay})`);
            
            try {
                const previousDoc = await shiftFirestore.collection("shifts").doc(previousDocId).get();
                
                if (previousDoc.exists) {
                    const shiftData = previousDoc.data();
                    console.log(`‚úÖ Found document for ${previousDocId}`);
                    
                    // Check if this document has an open shift
                    const shiftCheck = checkForOpenShift(shiftData);
                    
                    if (shiftCheck.isActive) {
                        console.log(`üéâ Found open shift in previous date: ${previousDateForDisplay}`);
                        return {
                            success: true,
                            shiftData: shiftData,
                            foundDate: previousDateForDisplay,
                            foundDateForDocId: previousDateForDocId,
                            shiftCheck: shiftCheck
                        };
                    } else {
                        console.log(`‚û°Ô∏è No open shift in ${previousDateForDisplay}, continuing search...`);
                    }
                } else {
                    console.log(`‚û°Ô∏è No document for ${previousDateForDisplay}, continuing...`);
                }
            } catch (error) {
                console.error(`‚ùå Error checking ${previousDateForDisplay}:`, error);
            }
        }
        
        console.log("üîç No open shift found in any of the previous 7 days");
        return {
            success: false,
            message: "No open shift found in previous dates"
        };
        
    } catch (error) {
        console.error("‚ùå Error searching previous dates:", error);
        return {
            success: false,
            message: "Error: " + error.message
        };
    }
}

// ----------- FETCH SHIFT DATA -----------
async function fetchShiftData() {
    console.log("üåê Fetching shift data...");
    
    try {
        // Initialize Firebase if not done yet
        if (!shiftFirestore) {
            shiftFirestore = initializeShiftFirebase();
            if (!shiftFirestore) {
                throw new Error("Failed to initialize Firebase");
            }
        }
        
        // Get today's date
        const today = new Date();
        
        // Format for document ID: YYYY_MM_DD
        const todayDateForDocId = formatDateForDocumentId(today);
        
        // Format for display: YYYY-MM-DD
        const todayDateForDisplay = formatDateForDisplay(today);
        
        console.log("üìÖ Today's date for document ID:", todayDateForDocId);
        console.log("üìÖ Today's date for display:", todayDateForDisplay);
        
        // Use document ID format: shift_YYYY_MM_DD
        const todayDocId = `shift_${todayDateForDocId}`;
        console.log("üîç Looking for today's shift document:", todayDocId);
        
        // Get today's shift document
        const todayShiftDoc = await shiftFirestore.collection("shifts").doc(todayDocId).get();
        
        let shiftData = null;
        let documentDate = "";
        let foundDate = todayDateForDisplay;
        let foundDateForDocId = todayDateForDocId;
        let shiftCheck = null;
        
        // Check if today's shift exists
        if (todayShiftDoc.exists) {
            shiftData = todayShiftDoc.data();
            documentDate = shiftData.date || todayDateForDisplay;
            
            console.log("‚úÖ Today's shift data retrieved:", shiftData);
            
            // Check if today has any open shift
            shiftCheck = checkForOpenShift(shiftData);
            
            if (shiftCheck.isActive) {
                console.log("‚úì Found open shift in today's document");
                foundDate = todayDateForDisplay;
                foundDateForDocId = todayDateForDocId;
            } else {
                console.log("‚ö†Ô∏è No open shift found in today's document. Searching previous dates...");
                
                // Search for open shift in previous dates
                const previousOpenShift = await findOpenShiftInPreviousDates(today);
                
                if (previousOpenShift.success) {
                    console.log(`‚úì Found open shift in previous date: ${previousOpenShift.foundDate}`);
                    shiftData = previousOpenShift.shiftData;
                    documentDate = previousOpenShift.foundDate;
                    foundDate = previousOpenShift.foundDate;
                    foundDateForDocId = previousOpenShift.foundDateForDocId;
                    shiftCheck = previousOpenShift.shiftCheck;
                } else {
                    console.log("‚ö†Ô∏è No open shift found in any date, using today's data");
                    // Keep today's data even if no shift is open
                }
            }
        } else {
            console.log("‚ùå No shift document found for today:", todayDocId);
            
            // Search for open shift in previous dates
            const previousOpenShift = await findOpenShiftInPreviousDates(today);
            
            if (previousOpenShift.success) {
                console.log(`‚úì Found open shift in previous date: ${previousOpenShift.foundDate}`);
                shiftData = previousOpenShift.shiftData;
                documentDate = previousOpenShift.foundDate;
                foundDate = previousOpenShift.foundDate;
                foundDateForDocId = previousOpenShift.foundDateForDocId;
                shiftCheck = previousOpenShift.shiftCheck;
            } else {
                console.log("‚ö†Ô∏è No shift data found at all");
                return {
                    success: false,
                    message: "No shift data found for today or previous dates",
                    date: todayDateForDisplay,
                    isActive: false
                };
            }
        }
        
        console.log("üìä Final shift analysis:", shiftCheck);
        
        // Format date for nice display based on found date
        const displayDate = new Date(foundDate).toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        // Add indicator if not today's date
        let dateIndicator = "";
        const isFromPreviousDay = foundDate !== todayDateForDisplay;
        
        if (isFromPreviousDay) {
            const foundDateObj = new Date(foundDate);
            const todayObj = new Date(todayDateForDisplay);
            const daysDiff = Math.floor((todayObj - foundDateObj) / (1000 * 60 * 60 * 24));
            
            if (daysDiff === 1) {
                dateIndicator = " (Yesterday)";
            } else {
                dateIndicator = ` (${daysDiff} days ago)`;
            }
        }
        
        const result = {
            success: true,
            name: shiftCheck.shiftName,
            date: displayDate + dateIndicator,
            firestoreDate: documentDate,
            foundDate: foundDate,
            foundDateForDocId: foundDateForDocId,
            isActive: shiftCheck.isActive,
            openTime: shiftCheck.openTime,
            shiftType: shiftCheck.shiftType,
            fullData: shiftData,
            lastUpdated: shiftData.lastUpdated || "",
            timestamp: new Date().toISOString(),
            isFromPreviousDay: isFromPreviousDay,
            documentId: `shift_${foundDateForDocId}`
        };
        
        console.log("üì¶ Final result:", result);
        
        // Save to localStorage
        saveShiftToLocalStorage(result);
        
        return result;
        
    } catch (error) {
        console.error("‚ùå Error fetching shift data:", error);
        return {
            success: false,
            message: "Error: " + error.message,
            timestamp: new Date().toISOString()
        };
    }
}

// ----------- SAVE TO LOCAL STORAGE -----------
function saveShiftToLocalStorage(shiftData) {
    try {
        localStorage.setItem(SHIFT_STORAGE_KEY, JSON.stringify(shiftData));
        localStorage.setItem(SHIFT_TIMESTAMP_KEY, new Date().toISOString());
        console.log("üíæ Saved shift data to localStorage");
    } catch (e) {
        console.error("‚ùå Error saving to localStorage:", e);
    }
}

// ----------- LOAD FROM LOCAL STORAGE -----------
function loadShiftFromLocalStorage() {
    try {
        const savedData = localStorage.getItem(SHIFT_STORAGE_KEY);
        const savedTimestamp = localStorage.getItem(SHIFT_TIMESTAMP_KEY);
        
        if (!savedData || !savedTimestamp) {
            console.log("üì≠ No saved shift data found");
            return null;
        }
        
        const data = JSON.parse(savedData);
        const timestamp = new Date(savedTimestamp);
        const now = new Date();
        const minutesDiff = (now - timestamp) / (1000 * 60);
        
        console.log("üìÇ Loaded shift data from localStorage (age:", minutesDiff.toFixed(0), "minutes)");
        
        // Data is considered fresh if less than 5 minutes old
        if (minutesDiff < 5) {
            return data;
        } else {
            console.log("üìõ Saved data is outdated (older than 5 minutes)");
            return null;
        }
        
    } catch (e) {
        console.error("‚ùå Error loading from localStorage:", e);
        return null;
    }
}

// ----------- REFRESH BUTTON HANDLER -----------
async function refreshShiftData() {
    console.log("üîÑ Manual refresh triggered");
    
    const refreshBtn = document.getElementById("refreshBtn");
    const originalHtml = refreshBtn.innerHTML;
    
    // Add loading state
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    refreshBtn.disabled = true;
    
    try {
        const result = await fetchShiftData();
        updateUIWithShiftData(result);
        showMessage("Shift data refreshed successfully", "success");
    } catch (error) {
        console.error("Refresh error:", error);
        showMessage("Failed to refresh shift data: " + error.message, "error");
    } finally {
        // Remove loading state after a minimum delay
        setTimeout(() => {
            refreshBtn.innerHTML = originalHtml;
            refreshBtn.disabled = false;
        }, 500);
    }
}

// ----------- UPDATE UI -----------
function updateUIWithShiftData(shiftData) {
    console.log("üé® Updating UI with:", shiftData);
    
    if (!shiftData || !shiftData.success) {
        // Show error or cached data
        document.getElementById("currentShift").textContent = shiftData?.message || "Error loading shift";
        document.getElementById("shiftStatusText").textContent = shiftData?.message || "Error";
        document.getElementById("statusDot").className = "status-dot inactive";
        document.getElementById("lastUpdated").textContent = "Failed to load data";
        document.getElementById("shiftTime").textContent = "";
        
        // Disable payment button
        disablePaymentButton();
        return;
    }
    
    // Update shift display
    let displayName = shiftData.name;
    let timeInfo = "";
    
    if (shiftData.openTime && shiftData.openTime.trim() !== "") {
        timeInfo = `Opened at ${shiftData.openTime}`;
        displayName += ` (${shiftData.openTime})`;
    }
    
    // Add indicator if from previous day
    if (shiftData.isFromPreviousDay) {
        displayName += " ‚è™";
        if (!timeInfo) {
            timeInfo = "From previous day";
        } else {
            timeInfo += " (Previous day)";
        }
    }
    
    document.getElementById("currentShift").textContent = displayName;
    document.getElementById("shiftStatusText").textContent = shiftData.name;
    document.getElementById("shiftTime").textContent = timeInfo;
    
    // Update status
    if (shiftData.isActive) {
        document.getElementById("statusDot").className = "status-dot active";
        document.getElementById("statusDot").style.backgroundColor = "#28a745";
        enablePaymentButton();
        showMessage(`${shiftData.name} is active. Payments can be processed.`, "success");
    } else {
        document.getElementById("statusDot").className = "status-dot inactive";
        document.getElementById("statusDot").style.backgroundColor = "#e74c3c";
        disablePaymentButton();
        showMessage(`${shiftData.name} is not active. Payments are disabled.`, "warning");
    }
    
    // Update last updated time
    const updatedTime = new Date(shiftData.timestamp).toLocaleTimeString();
    document.getElementById("lastUpdated").textContent = `Last updated: ${updatedTime}`;
}

// ----------- PAYMENT BUTTON CONTROL -----------
function enablePaymentButton() {
    const newPaymentBtn = document.getElementById("newPaymentBtn");
    const updatePaymentsBtn = document.getElementById("updatePaymentsBtn");
    const cashDrawerBtn = document.getElementById("cashDrawerBtn");
    
    newPaymentBtn.classList.remove("disabled");
    newPaymentBtn.href = "pay.html";
    newPaymentBtn.title = "Click to create new payment";
    newPaymentBtn.onclick = null;
    
    updatePaymentsBtn.classList.remove("disabled");
    updatePaymentsBtn.href = "void.html";
    updatePaymentsBtn.title = "Click to update payment records";
    updatePaymentsBtn.onclick = null;
    
    cashDrawerBtn.classList.remove("disabled");
    cashDrawerBtn.title = "Click to open cash drawer";
    
    document.getElementById("paymentStatus").textContent = "Ready for payments";
    console.log("‚úÖ Payment functions ENABLED");
}

function disablePaymentButton() {
    const newPaymentBtn = document.getElementById("newPaymentBtn");
    const updatePaymentsBtn = document.getElementById("updatePaymentsBtn");
    const cashDrawerBtn = document.getElementById("cashDrawerBtn");
    
    newPaymentBtn.classList.add("disabled");
    newPaymentBtn.removeAttribute("href");
    newPaymentBtn.onclick = function(e) {
        e.preventDefault();
        showMessage("Cannot process payments when no shift is active", "error");
    };
    newPaymentBtn.title = "Payments disabled - no active shift";
    
    updatePaymentsBtn.classList.add("disabled");
    updatePaymentsBtn.removeAttribute("href");
    updatePaymentsBtn.onclick = function(e) {
        e.preventDefault();
        showMessage("Cannot update payments when no shift is active", "error");
    };
    updatePaymentsBtn.title = "Payments disabled - no active shift";
    
    cashDrawerBtn.classList.add("disabled");
    cashDrawerBtn.title = "Cash drawer disabled - no active shift";
    
    document.getElementById("paymentStatus").textContent = "Disabled - No active shift";
    console.log("‚õî Payment functions DISABLED");
}

// ----------- STATUS MESSAGES -----------
function showMessage(message, type = "info") {
    const statusDiv = document.getElementById("statusMessage");
    if (!statusDiv) return;
    
    statusDiv.className = `status-message status-${type}`;
    statusDiv.innerHTML = `
        <i class="fas fa-${getIconForType(type)}"></i>
        <span>${message}</span>
    `;
    
    if (type !== "error" && type !== "warning") {
        setTimeout(() => {
            statusDiv.innerHTML = "";
            statusDiv.className = "status-message";
        }, 5000);
    }
}

function getIconForType(type) {
    switch(type) {
        case 'success': return 'check-circle';
        case 'error': return 'exclamation-circle';
        case 'warning': return 'exclamation-triangle';
        default: return 'info-circle';
    }
}

// ----------- CASH DRAWER -----------
document.getElementById("cashDrawerBtn").addEventListener("click", function(e) {
    e.preventDefault();
    
    // Check if cash drawer button is disabled
    if (this.classList.contains("disabled")) {
        showMessage("Cash drawer is disabled - no active shift", "error");
        return;
    }
    
    // Get current shift data
    const cachedData = loadShiftFromLocalStorage();
    if (!cachedData || !cachedData.isActive) {
        showMessage("Cash drawer can only be opened during active shifts", "error");
        return;
    }
    
    try {
        const printContent = `
            <html>
                <head><title>Cash Drawer</title></head>
                <body style="font-family: Arial; padding: 20px; text-align: center;">
                    <h2>Cash Drawer Command</h2>
                    <p style="font-family: monospace; background: #f0f0f0; padding: 10px; margin: 20px;">
                        ESC p 0 10 250
                    </p>
                    <p>Click Print to open cash drawer</p>
                    <p><small>Select EPSON TM printer</small></p>
                    <p><small>Shift: ${cachedData.name}</small></p>
                    ${cachedData.isFromPreviousDay ? '<p><small><i class="fas fa-history"></i> Previous day shift</small></p>' : ''}
                    <p><small>Time: ${new Date().toLocaleTimeString()}</small></p>
                </body>
            </html>
        `;
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
            showMessage("Cash drawer command sent", "success");
        }, 500);
        
    } catch (error) {
        console.error("Cash drawer error:", error);
        showMessage("Failed to open cash drawer", "error");
    }
});

// ----------- LOGOUT -----------
function logout() {
    if (confirm("Are you sure you want to logout?")) {
        localStorage.removeItem("loggedInUser");
        window.location.href = "login.html";
    }
}

// ----------- INITIAL LOAD -----------
async function initializeDashboard() {
    console.log("üöÄ Initializing payment dashboard...");
    
    // First, try to load from localStorage (cached for 5 minutes)
    const cachedData = loadShiftFromLocalStorage();
    
    if (cachedData) {
        console.log("üìä Using cached data");
        updateUIWithShiftData(cachedData);
    } else {
        console.log("üåê No valid cache, fetching from Firestore");
        document.getElementById("shiftStatusText").textContent = "Loading from server...";
    }
    
    // Always fetch fresh data from Firestore
    try {
        const result = await fetchShiftData();
        updateUIWithShiftData(result);
    } catch (error) {
        console.error("‚ùå Initial fetch failed:", error);
        if (!cachedData) {
            showMessage("Failed to load shift data: " + error.message, "error");
            document.getElementById("shiftStatusText").textContent = "Failed to load";
        }
    }
}

// ----------- EVENT LISTENERS -----------
document.addEventListener('DOMContentLoaded', function() {
    console.log("üìÑ DOM Content Loaded");
    
    // Setup refresh button
    const refreshBtn = document.getElementById("refreshBtn");
    if (refreshBtn) {
        refreshBtn.addEventListener('click', refreshShiftData);
    }
    
    // Initialize dashboard with a delay to ensure everything loads
    setTimeout(() => {
        initializeDashboard();
    }, 1000);
    
    // Auto-refresh every 5 minutes
    setInterval(() => {
        if (userData) {
            refreshShiftData();
        }
    }, 5 * 60 * 1000);
});

// ----------- DEBUG FUNCTIONS -----------
window.showStoredData = function() {
    const data = localStorage.getItem(SHIFT_STORAGE_KEY);
    const timestamp = localStorage.getItem(SHIFT_TIMESTAMP_KEY);
    
    console.log("=== LOCAL STORAGE DATA ===");
    console.log("Shift data:", data ? JSON.parse(data) : "No data");
    console.log("Timestamp:", timestamp);
    console.log("Age:", timestamp ? ((new Date() - new Date(timestamp)) / 1000 / 60).toFixed(2) + " minutes" : "N/A");
};

window.clearShiftCache = function() {
    localStorage.removeItem(SHIFT_STORAGE_KEY);
    localStorage.removeItem(SHIFT_TIMESTAMP_KEY);
    console.log("üßπ Cleared shift cache");
    showMessage("Shift cache cleared. Refreshing...", "info");
    refreshShiftData();
};

// Debug function
window.debugShiftData = async function() {
    console.log("=== DEBUG SHIFT DATA ===");
    
    if (!shiftFirestore) {
        console.log("‚ùå Firestore not initialized");
        return;
    }
    
    const today = new Date();
    const todayDateForDocId = formatDateForDocumentId(today);
    const todayDocId = `shift_${todayDateForDocId}`;
    
    console.log("Looking for document:", todayDocId);
    
    try {
        const shiftDoc = await shiftFirestore.collection("shifts").doc(todayDocId).get();
        
        if (!shiftDoc.exists) {
            console.log("‚ùå No document found for:", todayDocId);
            
            // Try alternative format just in case
            const altDocId = `shift_${formatDateForDisplay(today).replace(/-/g, '_')}`;
            console.log("Trying alternative format:", altDocId);
            
            const altDoc = await shiftFirestore.collection("shifts").doc(altDocId).get();
            if (altDoc.exists) {
                console.log("‚úÖ Found document with alternative format!");
                const data = altDoc.data();
                console.log("üìÑ Full document data:", JSON.stringify(data, null, 2));
                console.log("üìÑ Document ID:", altDoc.id);
            } else {
                console.log("‚ùå No document found with alternative format either");
            }
            return;
        }
        
        const data = shiftDoc.data();
        console.log("üìÑ Full document data:", JSON.stringify(data, null, 2));
        console.log("Document ID:", shiftDoc.id);
        console.log("Document exists:", shiftDoc.exists);
        
        // Log the exact structure
        console.log("\nüîç Structure analysis:");
        console.log("Morning shift:", data.morning);
        console.log("Evening shift:", data.evening);
        
    } catch (error) {
        console.error("‚ùå Debug error:", error);
    }
};

// Test function for previous date search
window.testPreviousSearch = async function() {
    console.log("=== TEST PREVIOUS DATE SEARCH ===");
    
    if (!shiftFirestore) {
        shiftFirestore = initializeShiftFirebase();
    }
    
    const today = new Date();
    
    console.log("Starting from date:", formatDateForDisplay(today));
    console.log("Document ID format:", formatDateForDocumentId(today));
    
    const result = await findOpenShiftInPreviousDates(today);
    console.log("Search result:", result);
    
    if (result.success) {
        alert(`Found open shift in date: ${result.foundDate}\nDocument ID: shift_${result.foundDateForDocId}`);
    } else {
        alert("No open shift found in previous dates");
    }
};
</script>
</body>
</html>
