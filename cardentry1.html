<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Unified Code Parser & Passenger Approval</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --gold: #D4AF37;
    --gold-light: #F5E8B8;
    --gold-dark: #B8860B;
    --gold-darker: #8B6914;
    --white: #FFFFFF;
    --gray-light: #F8F8F8;
    --gray: #E5E5E5;
    --gray-dark: #666666;
    --success: #4CAF50;
    --error: #f44336;
    --warning: #ff9800;
    --info: #2196F3;
    --shift-blue: #4b6cb7;
    --shift-blue-dark: #182848;
    --qr-green: #27ae60;
    --qr-green-dark: #219653;
    --delay-orange: #FF9800;
    --delay-orange-dark: #F57C00;
  }
  
  * {
    box-sizing: border-box;
  }
  
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    padding: 20px; 
    background: var(--white);
    margin: 0;
    color: #333;
    background-color: #f9f9f9;
  }
  
  .container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    max-width: 1600px;
    margin: 0 auto;
  }
  
  .entry-section {
    flex: 1;
    min-width: 280px;
    max-width: 350px;
    background: var(--white);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.08);
    border: 1px solid var(--gold);
    position: relative;
    overflow: hidden;
  }
  
  .entry-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, var(--gold), var(--gold-dark));
  }
  
  .entries-section {
    flex: 4;
    min-width: 900px;
    background: var(--white);
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.08);
    border: 1px solid var(--gold);
    overflow-x: auto;
    position: relative;
  }
  
  .entries-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, var(--gold), var(--gold-dark));
  }
  
  h2, h3 {
    margin-top: 0;
    color: var(--gold-darker);
    padding-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
  }
  
  h2 i, h3 i {
    color: var(--gold);
  }
  
  .form-group {
    margin-bottom: 15px;
  }
  
  label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    font-size: 14px;
    color: var(--gold-darker);
  }
  
  .input-with-icon {
    position: relative;
  }
  
  .input-with-icon i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gold);
    z-index: 1;
  }
  
  input, select, textarea { 
    width: 100%; 
    padding: 10px 10px 10px 35px;
    border: 1px solid var(--gold); 
    border-radius: 6px; 
    font-size: 14px; 
    box-sizing: border-box;
    background: var(--white);
    transition: all 0.3s ease;
  }
  
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--gold-dark);
    box-shadow: 0 0 0 3px var(--gold-light);
  }
  
  textarea {
    resize: vertical;
    min-height: 60px;
    padding-left: 35px;
  }
  
  table { 
    width: 100%; 
    border-collapse: collapse; 
    margin-top: 10px;
    font-size: 13px;
    border: 1px solid var(--gold);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  
  th, td { 
    border: 1px solid var(--gold); 
    padding: 10px; 
    text-align: left; 
    white-space: nowrap;
  }
  
  th {
    background-color: var(--gold-light);
    font-weight: bold;
    color: var(--gold-darker);
    position: sticky;
    top: 0;
  }
  
  tr:nth-child(even) {
    background-color: var(--gray-light);
  }
  
  tr:hover {
    background-color: rgba(212, 175, 55, 0.1);
  }
  
  button.action-btn { 
    width: auto; 
    margin: 0 2px; 
    padding: 8px 14px; 
    font-size: 12px; 
    cursor: pointer; 
    background: var(--gold);
    color: white;
    border: none;
    border-radius: 4px;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-weight: 500;
  }
  
  button.action-btn:hover {
    background: var(--gold-dark);
    transform: translateY(-2px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  }
  
  button.action-btn:disabled {
    opacity: 0.6;
    pointer-events: none;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
  
  .button-group {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }
  
  .button-group button {
    flex: 1;
    padding: 12px;
    font-weight: 600;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    border-radius: 6px;
    font-size: 14px;
  }
  
  #manualSaveBtn {
    background: var(--gold);
    color: white;
    box-shadow: 0 3px 8px rgba(212, 175, 55, 0.3);
  }
  
  #manualSaveBtn:hover {
    background: var(--gold-dark);
    box-shadow: 0 5px 12px rgba(212, 175, 55, 0.4);
  }
  
  .status-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    padding: 10px;
    background: var(--gold-light);
    border-radius: 6px;
    border-left: 4px solid var(--gold);
  }
  
  .status-indicator i {
    color: var(--gold-dark);
  }
  
  @media (max-width: 1200px) {
    .container {
      flex-direction: column;
    }
    
    .entry-section, .entries-section {
      min-width: 100%;
      max-width: 100%;
    }
  }
  
  .gold-line {
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
    margin: 15px 0;
  }
  
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  
  .entries-count {
    background: var(--gold);
    color: white;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  
  .user-shift-container {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
    justify-content: flex-start;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .user-shift-field {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
  }
  
  .user-shift-field label {
    font-size: 14px;
    margin-bottom: 0;
    color: var(--gold-darker);
    font-weight: 600;
  }
  
  .user-shift-field span {
    background: var(--gold-light);
    padding: 8px 14px;
    border-radius: 6px;
    border: 1px solid var(--gold);
    min-width: 120px;
    display: inline-block;
    font-weight: 500;
    text-align: center;
  }
  
  .clear-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--success);
    color: white;
    padding: 12px 24px;
    border-radius: 6px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 1000;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s ease;
  }
  
  .clear-notification.show {
    opacity: 1;
    transform: translateY(0);
  }
  
  .shift-status {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    padding: 10px;
    background: var(--gray-light);
    border-radius: 6px;
    border-left: 4px solid var(--gold);
  }
  
  .status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--success);
  }
  
  .status-dot.inactive {
    background: var(--error);
  }
  
  .disabled {
    opacity: 0.6;
    pointer-events: none;
  }
  
  .float-nav {
    position: fixed;
    bottom: 30px;
    right: 30px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    z-index: 1000;
  }
  
  .float-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--gold);
    color: white;
    border: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .float-btn:hover {
    background: var(--gold-dark);
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  }
  
  .float-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.1);
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .float-btn:hover::after {
    opacity: 1;
  }
  
  .float-tooltip {
    position: absolute;
    right: 70px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    white-space: nowrap;
    opacity: 0;
    transform: translateX(10px);
    transition: all 0.3s ease;
    pointer-events: none;
  }
  
  .float-btn:hover .float-tooltip {
    opacity: 1;
    transform: translateX(0);
  }
  
  @media (max-width: 768px) {
    .float-nav {
      bottom: 20px;
      right: 20px;
    }
    
    .float-btn {
      width: 50px;
      height: 50px;
      font-size: 18px;
    }
    
    .float-tooltip {
      font-size: 12px;
      padding: 6px 10px;
    }
  }

  .scanner-indicator {
    display: none;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    font-size: 12px;
    color: var(--gold-dark);
  }
  
  .scanner-indicator.show {
    display: flex;
  }
  
  .scanner-dots {
    display: flex;
    gap: 3px;
  }
  
  .scanner-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--gold);
    animation: scanning 0.8s infinite ease-in-out;
  }
  
  .scanner-dot:nth-child(1) { animation-delay: -0.32s; }
  .scanner-dot:nth-child(2) { animation-delay: -0.16s; }
  
  @keyframes scanning {
    0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
  }
  
  .alert-notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-20px);
    background: var(--success);
    color: white;
    padding: 12px 24px;
    border-radius: 6px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 1000;
    opacity: 0;
    transition: all 0.3s ease;
  }
  
  .alert-notification.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
  
  .alert-notification.error {
    background: var(--error);
  }
  
  .alert-notification.warning {
    background: var(--warning);
  }
  
  .alert-notification.info {
    background: var(--info);
  }
  
  .spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .card-header {
    background: linear-gradient(135deg, var(--gold-light), var(--gold));
    padding: 15px 20px;
    margin: -20px -20px 15px -20px;
    border-radius: 10px 10px 0 0;
    color: var(--gold-darker);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .fqtv-required {
    background-color: rgba(255, 152, 0, 0.1) !important;
    border-left: 3px solid var(--warning) !important;
  }
  
  .fqtv-warning {
    color: var(--warning);
    font-weight: bold;
    font-style: italic;
  }
  
  .flight-closed {
    background-color: rgba(244, 67, 54, 0.1) !important;
    border-left: 3px solid var(--error) !important;
  }
  
  .flight-closed td {
    opacity: 0.8;
  }
  
  .flight-status-closed {
    color: var(--error);
    font-weight: bold;
    font-size: 0.9em;
    margin-left: 5px;
  }
  
  .flight-closed .action-btn:first-child {
    background: var(--gray) !important;
    color: var(--gray-dark) !important;
    cursor: not-allowed;
    opacity: 0.6;
  }
  
  .flight-closed .action-btn:first-child:hover {
    transform: none !important;
    box-shadow: none !important;
  }
  
  .entry-fields-container {
    margin-top: 10px;
  }
  
  .simple-field-group {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
  }
  
  .simple-field-group .form-group {
    flex: 1;
    margin-bottom: 0;
  }
  
  .entry-card-title {
    text-align: center;
    margin-bottom: 20px;
    color: var(--gold-darker);
    font-size: 18px;
    font-weight: 600;
  }
  
  .no-shift-message {
    text-align: center;
    padding: 10px;
    color: #666;
    font-size: 13px;
  }

  .shift-refresh-btn {
    background: var(--shift-blue);
    color: white;
    border: none;
    border-radius: 5px;
    padding: 8px 16px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
  }
  
  .shift-refresh-btn:hover {
    background: var(--shift-blue-dark);
    transform: translateY(-1px);
  }
  
  .shift-refresh-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }
  
  /* QR Processing Indicator */
  .qr-processing-indicator {
    display: none;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    font-size: 12px;
    color: var(--qr-green);
    padding: 5px 10px;
    background: rgba(39, 174, 96, 0.1);
    border-radius: 4px;
    border-left: 3px solid var(--qr-green);
  }
  
  .qr-processing-indicator.show {
    display: flex;
  }
  
  .qr-processing-indicator i {
    color: var(--qr-green);
  }
  
  .qr-success-badge {
    background: var(--qr-green);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: bold;
    margin-left: 5px;
  }
  
  .dual-save-btn {
    background: linear-gradient(135deg, var(--gold), var(--qr-green));
    color: white;
  }
  
  .dual-save-btn:hover {
    background: linear-gradient(135deg, var(--gold-dark), var(--qr-green-dark));
  }
  
  /* Delay Charge Styles */
  .delay-charge-btn {
    background: var(--delay-orange);
    color: white;
    border: none;
    border-radius: 5px;
    padding: 8px 16px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
  }
  
  .delay-charge-btn:hover {
    background: var(--delay-orange-dark);
    transform: translateY(-2px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  }
  
  .delay-entry {
    background-color: rgba(255, 152, 0, 0.1) !important;
    border-left: 4px solid var(--delay-orange) !important;
  }
  
  .delay-badge {
    background: var(--delay-orange);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: bold;
    margin-left: 5px;
  }
  
  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    z-index: 2000;
    justify-content: center;
    align-items: center;
  }
  
  .modal.show {
    display: flex;
  }
  
  .modal-content {
    background: white;
    padding: 30px;
    border-radius: 10px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    border: 2px solid var(--delay-orange);
    position: relative;
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--delay-orange);
  }
  
  .modal-header h3 {
    margin: 0;
    color: var(--delay-orange);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .close-modal {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--delay-orange);
    padding: 5px;
    line-height: 1;
  }
  
  .close-modal:hover {
    color: var(--delay-orange-dark);
  }
  
  .time-input-group {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }
  
  .time-input-group .form-group {
    flex: 1;
  }
  
  .delay-calc-result {
    margin-top: 20px;
    padding: 15px;
    background: rgba(255, 152, 0, 0.1);
    border-radius: 6px;
    border-left: 4px solid var(--delay-orange);
  }
  
  .delay-calc-result h4 {
    margin-top: 0;
    margin-bottom: 10px;
    color: var(--delay-orange);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .delay-calc-details {
    font-size: 14px;
    line-height: 1.5;
  }
  
  .delay-calc-details p {
    margin: 5px 0;
  }
  
  .delay-amount {
    font-weight: bold;
    color: var(--delay-orange-dark);
  }
  
  .no-charge {
    color: var(--success);
    font-weight: bold;
  }
  
  /* Local Storage Tab Styles */
  .local-storage-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    z-index: 3000;
    justify-content: center;
    align-items: center;
  }
  
  .local-storage-modal.show {
    display: flex;
  }
  
  .local-storage-content {
    background: white;
    padding: 20px;
    border-radius: 10px;
    width: 95%;
    max-width: 1200px;
    max-height: 90vh;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    border: 2px solid var(--gold);
    position: relative;
    display: flex;
    flex-direction: column;
  }
  
  .local-storage-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--gold);
  }
  
  .local-storage-header h3 {
    margin: 0;
    color: var(--gold-darker);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .close-storage-modal {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--gold);
    padding: 5px;
    line-height: 1;
  }
  
  .close-storage-modal:hover {
    color: var(--gold-dark);
  }
  
  .storage-tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 15px;
    border-bottom: 1px solid var(--gold);
    flex-wrap: wrap;
  }
  
  .storage-tab {
    padding: 10px 20px;
    background: var(--gray-light);
    border: 1px solid var(--gold);
    border-bottom: none;
    border-radius: 6px 6px 0 0;
    cursor: pointer;
    font-weight: 500;
    color: var(--gold-darker);
    transition: all 0.3s ease;
    white-space: nowrap;
  }
  
  .storage-tab:hover {
    background: var(--gold-light);
  }
  
  .storage-tab.active {
    background: var(--gold);
    color: white;
    font-weight: 600;
  }
  
  .storage-tab-content {
    flex: 1;
    overflow: auto;
    margin-bottom: 20px;
  }
  
  .storage-panel {
    display: none;
    padding: 15px;
    background: var(--gray-light);
    border-radius: 6px;
    border: 1px solid var(--gold);
    max-height: 60vh;
    overflow: auto;
  }
  
  .storage-panel.active {
    display: block;
  }
  
  .storage-data-item {
    margin-bottom: 15px;
    padding: 10px;
    background: white;
    border-radius: 4px;
    border-left: 4px solid var(--info);
  }
  
  .storage-data-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  
  .storage-key {
    font-weight: bold;
    color: var(--gold-darker);
    font-size: 14px;
  }
  
  .storage-size {
    background: var(--info);
    color: white;
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: bold;
  }
  
  .storage-value {
    font-family: monospace;
    font-size: 12px;
    white-space: pre-wrap;
    word-break: break-all;
    background: rgba(0,0,0,0.03);
    padding: 8px;
    border-radius: 4px;
    border: 1px solid var(--gray);
    max-height: 200px;
    overflow-y: auto;
  }
  
  .storage-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid var(--gold);
  }
  
  .delete-storage-btn {
    background: var(--error);
    color: white;
    border: none;
    border-radius: 5px;
    padding: 10px 20px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
  }
  
  .delete-storage-btn:hover {
    background: #d32f2f;
    transform: translateY(-2px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  }
  
  .storage-stats {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
    padding: 10px;
    background: var(--gold-light);
    border-radius: 6px;
    font-size: 13px;
  }
  
  .storage-stat-item {
    text-align: center;
    flex: 1;
  }
  
  .storage-stat-value {
    font-size: 18px;
    font-weight: bold;
    color: var(--gold-darker);
  }
  
  .storage-stat-label {
    font-size: 11px;
    color: var(--gray-dark);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .empty-storage {
    text-align: center;
    padding: 30px;
    color: var(--gray-dark);
    font-style: italic;
  }
  
  .view-json-btn {
    background: var(--info);
    color: white;
    border: none;
    border-radius: 3px;
    padding: 3px 8px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .view-json-btn:hover {
    background: #1976d2;
  }
  
  .json-viewer-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.8);
    z-index: 4000;
    justify-content: center;
    align-items: center;
  }
  
  .json-viewer-modal.show {
    display: flex;
  }
  
  .json-viewer-content {
    background: #1e1e1e;
    padding: 20px;
    border-radius: 10px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    position: relative;
  }
  
  .json-viewer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #444;
  }
  
  .json-viewer-header h4 {
    margin: 0;
    color: #fff;
    font-family: monospace;
  }
  
  .close-json-viewer {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #fff;
    padding: 5px;
  }
  
  .json-viewer-body {
    background: #252525;
    padding: 15px;
    border-radius: 6px;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 13px;
    color: #f8f8f2;
    max-height: 70vh;
    overflow: auto;
    white-space: pre-wrap;
    word-break: break-all;
  }
  
  /* Approved Entries Table Styles */
  .approved-entries-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 12px;
  }
  
  .approved-entries-table th,
  .approved-entries-table td {
    border: 1px solid var(--gold);
    padding: 8px;
    text-align: left;
  }
  
  .approved-entries-table th {
    background: var(--gold-light);
    font-weight: bold;
    color: var(--gold-darker);
  }
  
  .approved-entries-table tr:nth-child(even) {
    background: var(--gray-light);
  }
  
  .approved-entries-table tr:hover {
    background: rgba(212, 175, 55, 0.1);
  }
  
  /* SQ flight highlight */
  .sq-flight {
    background-color: rgba(0, 123, 255, 0.05) !important;
    border-left: 3px solid var(--info) !important;
  }
  
  .sq-flight td:first-child {
    cursor: pointer;
    position: relative;
  }
  
  .sq-flight td:first-child:hover::after {
    content: "ðŸ”¢ Click to enter number";
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    color: var(--info);
    background: white;
    padding: 2px 5px;
    border-radius: 3px;
    border: 1px solid var(--info);
    white-space: nowrap;
  }
  
  /* Numeric Keyboard Modal Styles */
  .numeric-keyboard-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    z-index: 5000;
    justify-content: center;
    align-items: center;
  }
  
  .numeric-keyboard-modal.show {
    display: flex;
  }
  
  .numeric-keyboard-content {
    background: white;
    padding: 25px;
    border-radius: 10px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    border: 2px solid var(--gold);
    position: relative;
  }
  
  .numeric-keyboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--gold);
  }
  
  .numeric-keyboard-header h3 {
    margin: 0;
    color: var(--gold-darker);
    font-size: 16px;
  }
  
  .close-numeric-keyboard {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--gold);
    padding: 5px;
  }
  
  .numeric-display {
    margin: 15px 0;
    padding: 15px;
    background: var(--gold-light);
    border-radius: 6px;
    border: 1px solid var(--gold);
    font-size: 24px;
    font-weight: bold;
    text-align: center;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow-x: auto;
    white-space: nowrap;
  }
  
  .numeric-keyboard-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 15px;
  }
  
  .numeric-key {
    padding: 20px;
    font-size: 18px;
    font-weight: bold;
    background: var(--gray-light);
    border: 2px solid var(--gold);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
    user-select: none;
  }
  
  .numeric-key:hover {
    background: var(--gold-light);
    transform: translateY(-2px);
  }
  
  .numeric-key:active {
    transform: translateY(0);
    background: var(--gold);
    color: white;
  }
  
  .numeric-key-special {
    background: var(--gold);
    color: white;
  }
  
  .numeric-key-special:hover {
    background: var(--gold-dark);
  }
  
  .numeric-keyboard-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }
  
  .numeric-keyboard-actions button {
    flex: 1;
    padding: 12px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s ease;
  }
  
  #applyNumericBtn {
    background: var(--success);
    color: white;
  }
  
  #applyNumericBtn:hover {
    background: #388e3c;
  }
  
  #clearNumericBtn {
    background: var(--error);
    color: white;
  }
  
  #clearNumericBtn:hover {
    background: #d32f2f;
  }
  
  #closeNumericBtn {
    background: var(--gray);
    color: var(--gray-dark);
  }
  
  #closeNumericBtn:hover {
    background: #ddd;
  }
  
  @media (max-width: 768px) {
    .user-shift-container {
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
    
    .user-shift-field {
      width: 100%;
      justify-content: space-between;
    }
    
    .user-shift-field span {
      min-width: 150px;
      text-align: right;
    }
    
    .time-input-group {
      flex-direction: column;
    }
    
    .modal-content {
      width: 95%;
      padding: 20px;
    }
    
    .local-storage-content {
      width: 98%;
      padding: 15px;
    }
    
    .storage-tabs {
      overflow-x: auto;
      flex-wrap: nowrap;
    }
    
    .storage-tab {
      padding: 8px 12px;
      font-size: 13px;
    }
    
    .storage-stats {
      flex-direction: column;
      gap: 10px;
    }
    
    .storage-stat-item {
      text-align: left;
      display: flex;
      justify-content: space-between;
    }
    
    .approved-entries-table {
      font-size: 11px;
    }
    
    .approved-entries-table th,
    .approved-entries-table td {
      padding: 6px;
    }
    
    .numeric-keyboard-content {
      width: 95%;
      padding: 20px;
    }
    
    .numeric-key {
      padding: 15px;
      font-size: 16px;
    }
    
    .numeric-display {
      font-size: 20px;
      min-height: 50px;
    }
  }
</style>
</head>
<body>

<div class="clear-notification" id="clearNotification">
  <i class="fas fa-check-circle"></i>
  <span>Fields cleared for next entry</span>
</div>

<div class="alert-notification" id="alertNotification">
  <i class="fas fa-check-circle"></i>
  <span id="alertMessage">Operation completed successfully</span>
</div>

<!-- Numeric Keyboard Modal -->
<div class="numeric-keyboard-modal" id="numericKeyboardModal">
  <div class="numeric-keyboard-content">
    <div class="numeric-keyboard-header">
      <h3><i class="fas fa-keyboard"></i> Enter Number for SQ Passenger</h3>
      <button class="close-numeric-keyboard" id="closeNumericKeyboardBtn">&times;</button>
    </div>
    
    <div class="numeric-display" id="numericDisplay">0</div>
    
    <div class="numeric-keyboard-grid">
      <div class="numeric-key" data-value="1">1</div>
      <div class="numeric-key" data-value="2">2</div>
      <div class="numeric-key" data-value="3">3</div>
      <div class="numeric-key" data-value="4">4</div>
      <div class="numeric-key" data-value="5">5</div>
      <div class="numeric-key" data-value="6">6</div>
      <div class="numeric-key" data-value="7">7</div>
      <div class="numeric-key" data-value="8">8</div>
      <div class="numeric-key" data-value="9">9</div>
      <div class="numeric-key" data-value="0">0</div>
      <div class="numeric-key" id="backspaceKey" data-action="backspace"><i class="fas fa-backspace"></i></div>
      <div class="numeric-key" id="clearKey" data-action="clear">C</div>
    </div>
    
    <div class="numeric-keyboard-actions">
      <button id="applyNumericBtn" class="numeric-keyboard-actions-btn">
        <i class="fas fa-check"></i> Apply
      </button>
      <button id="closeNumericBtn" class="numeric-keyboard-actions-btn">
        <i class="fas fa-times"></i> Cancel
      </button>
    </div>
  </div>
</div>

<!-- Local Storage Modal -->
<div class="local-storage-modal" id="localStorageModal">
  <div class="local-storage-content">
    <div class="local-storage-header">
      <h3><i class="fas fa-database"></i> Local Storage Manager</h3>
      <button class="close-storage-modal" id="closeStorageModalBtn">&times;</button>
    </div>
    
    <div class="storage-stats" id="storageStats">
      <!-- Stats will be populated by JavaScript -->
    </div>
    
    <div class="storage-tabs" id="storageTabs">
      <!-- Tabs will be populated by JavaScript -->
    </div>
    
    <div class="storage-tab-content">
      <div class="storage-panel active" id="allStoragePanel">
        <!-- All storage items will be displayed here -->
      </div>
      <!-- Other panels will be created dynamically -->
    </div>
    
    <div class="storage-actions">
      <button id="refreshStorageBtn" class="action-btn">
        <i class="fas fa-sync-alt"></i> Refresh Storage
      </button>
      <button id="clearAllStorageBtn" class="delete-storage-btn">
        <i class="fas fa-trash"></i> Clear All Local Storage
      </button>
    </div>
  </div>
</div>

<!-- JSON Viewer Modal -->
<div class="json-viewer-modal" id="jsonViewerModal">
  <div class="json-viewer-content">
    <div class="json-viewer-header">
      <h4 id="jsonViewerTitle">JSON Viewer</h4>
      <button class="close-json-viewer" id="closeJsonViewerBtn">&times;</button>
    </div>
    <div class="json-viewer-body" id="jsonViewerBody"></div>
  </div>
</div>

<!-- Delay Charge Modal -->
<div class="modal" id="delayChargeModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-clock"></i> Delay Charge Entry</h3>
      <button class="close-modal" id="closeModalBtn">&times;</button>
    </div>
    
    <div class="form-group">
      <label for="delayFlightInput"><i class="fas fa-plane"></i> Flight Number</label>
      <div class="input-with-icon">
        <i class="fas fa-plane-departure"></i>
        <input type="text" id="delayFlightInput" placeholder="Enter flight number (e.g., EK654)">
      </div>
    </div>
    
    <div class="time-input-group">
      <div class="form-group">
        <label for="entryTimeInput"><i class="fas fa-sign-in-alt"></i> Entry Time</label>
        <div class="input-with-icon">
          <i class="fas fa-clock"></i>
          <input type="time" id="entryTimeInput" value="00:00">
        </div>
      </div>
      
      <div class="form-group">
        <label for="exitTimeInput"><i class="fas fa-sign-out-alt"></i> Exit Time</label>
        <div class="input-with-icon">
          <i class="fas fa-clock"></i>
          <input type="time" id="exitTimeInput" value="00:00">
        </div>
      </div>
    </div>
    
    <div class="time-input-group">
      <div class="form-group">
        <label for="stdTimeInput"><i class="fas fa-plane-departure"></i> STD (Departure Time)</label>
        <div class="input-with-icon">
          <i class="fas fa-plane"></i>
          <input type="time" id="stdTimeInput" value="00:00">
        </div>
      </div>
      
      <div class="form-group">
        <label for="delayPaxInput"><i class="fas fa-users"></i> Number of Pax</label>
        <div class="input-with-icon">
          <i class="fas fa-user-friends"></i>
          <input type="number" id="delayPaxInput" value="1" min="1" step="1">
        </div>
      </div>
    </div>
    
    <div id="delayCalcResult" class="delay-calc-result" style="display: none;">
      <h4><i class="fas fa-calculator"></i> Delay Calculation</h4>
      <div id="delayCalcDetails" class="delay-calc-details"></div>
    </div>
    
    <div class="button-group">
      <button id="calculateDelayBtn" class="delay-charge-btn">
        <i class="fas fa-calculator"></i> Calculate Delay
      </button>
      <button id="saveDelayBtn" class="delay-charge-btn" style="background: var(--delay-orange-dark);">
        <i class="fas fa-save"></i> Save Delay Charge
      </button>
    </div>
  </div>
</div>

<div class="float-nav">
  <button id="storageManagerBtn" class="float-btn" style="background: var(--info);">
    <i class="fas fa-database"></i>
    <span class="float-tooltip">Storage Manager</span>
  </button>
  <button id="delayChargeBtn" class="float-btn" style="background: var(--delay-orange);">
    <i class="fas fa-clock"></i>
    <span class="float-tooltip">Delay Charge Entry</span>
  </button>
  <button id="refreshShiftBtn" class="float-btn shift-refresh-float">
    <i class="fas fa-sync-alt"></i>
    <span class="float-tooltip">Refresh Shift</span>
  </button>
  <a href="dash.html" class="float-btn">
    <i class="fas fa-home"></i>
    <span class="float-tooltip">Home Dashboard</span>
  </a>
  <a href="updateCard.html" class="float-btn">
    <i class="fas fa-chart-bar"></i>
    <span class="float-tooltip">Reports</span>
  </a>
  <a href="qrReport.html" class="float-btn" style="background: var(--qr-green);">
    <i class="fas fa-qrcode"></i>
    <span class="float-tooltip">QR Reports</span>
  </a>
</div>

<div class="container">
  <div class="entry-section" id="passengerEntryCard">
    <div class="entry-card-title">
      <i class="fas fa-user-plus"></i> Enter Passenger Details
    </div>
    
    <div class="form-group">
      <label for="codeInput"><i class="fas fa-barcode"></i> Scan Barcode</label>
      <div class="input-with-icon">
        <i class="fas fa-qrcode"></i>
        <input id="codeInput" placeholder="Scan or paste barcode" autocomplete="off" autofocus>
      </div>
      <div class="scanner-indicator" id="scannerIndicator">
        <div class="scanner-dots">
          <div class="scanner-dot"></div>
          <div class="scanner-dot"></div>
          <div class="scanner-dot"></div>
        </div>
        <span>Processing barcode...</span>
      </div>
      <div class="qr-processing-indicator" id="qrProcessingIndicator">
        <i class="fas fa-sync-alt fa-spin"></i>
        <span>Processing QR data...</span>
      </div>
    </div>
    
    <div class="gold-line"></div>
    
    <div class="entry-fields-container">
      <div class="simple-field-group">
        <div class="form-group">
          <label for="nameInput"><i class="fas fa-user"></i> Name</label>
          <div class="input-with-icon">
            <i class="fas fa-signature"></i>
            <input id="nameInput" placeholder="Passenger name">
          </div>
        </div>
        
        <div class="form-group">
          <label for="flightInput"><i class="fas fa-plane"></i> Flight</label>
          <div class="input-with-icon">
            <i class="fas fa-plane-departure"></i>
            <input id="flightInput" placeholder="Flight number">
          </div>
        </div>
      </div>
      
      <div class="simple-field-group">
        <div class="form-group">
          <label for="pnrInput"><i class="fas fa-ticket-alt"></i> PNR</label>
          <div class="input-with-icon">
            <i class="fas fa-receipt"></i>
            <input id="pnrInput" placeholder="PNR code">
          </div>
        </div>
        
        <div class="form-group">
          <label for="seatInput"><i class="fas fa-chair"></i> Seat</label>
          <div class="input-with-icon">
            <i class="fas fa-couch"></i>
            <input id="seatInput" placeholder="Seat number">
          </div>
        </div>
      </div>
      
      <div class="simple-field-group">
        <div class="form-group">
          <label for="airlineSelect"><i class="fas fa-building"></i> Airline</label>
          <div class="input-with-icon">
            <i class="fas fa-warehouse"></i>
            <select id="airlineSelect"><option value="">Select Airline</option></select>
          </div>
        </div>
        
        <div class="form-group">
          <label for="classInput"><i class="fas fa-star"></i> Class</label>
          <div class="input-with-icon">
            <i class="fas fa-star-half-alt"></i>
            <input id="classInput" placeholder="Class" readonly>
          </div>
        </div>
      </div>
      
      <div class="simple-field-group">
        <div class="form-group">
          <label for="fqtvInput"><i class="fas fa-id-card"></i> FQTV</label>
          <div class="input-with-icon">
            <i class="fas fa-address-card"></i>
            <input id="fqtvInput" placeholder="FQTV" readonly>
          </div>
        </div>
        
        <div class="form-group">
          <label for="numPaxInput"><i class="fas fa-users"></i> Pax</label>
          <div class="input-with-icon">
            <i class="fas fa-user-friends"></i>
            <input id="numPaxInput" placeholder="No of Pax" type="number" value="1" min="1">
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="serialInput"><i class="fas fa-hashtag"></i> Serial No</label>
        <div class="input-with-icon">
          <i class="fas fa-list-ol"></i>
          <input id="serialInput" placeholder="Serial number">
        </div>
      </div>
      
      <div class="form-group">
        <label for="remarksInput"><i class="fas fa-sticky-note"></i> Remarks</label>
        <div class="input-with-icon">
          <i class="fas fa-comment-alt"></i>
          <textarea id="remarksInput" placeholder="Additional remarks"></textarea>
        </div>
      </div>
    </div>
    
    <div class="button-group">
      <button id="manualSaveBtn" class="dual-save-btn">
        <i class="fas fa-save"></i> Save Entry (All Systems)
      </button>
    </div>
    
    <div id="qrStatus" style="font-size: 12px; margin-top: 10px; text-align: center;"></div>
  </div>
  
  <div class="entries-section">
    <div class="section-header">
      <h3><i class="fas fa-list-alt"></i> Saved Entries</h3>
      <div class="entries-count" id="entriesCount">0 entries</div>
    </div>
    
    <div class="user-shift-container">
      <div class="user-shift-field">
        <label>User:</label>
        <span id="userDisplay">Loading...</span>
      </div>
      <div class="user-shift-field">
        <label>Current Shift:</label>
        <span id="shiftDisplay">Loading...</span>
      </div>
      <div class="user-shift-field">
        <label>Shift Date:</label>
        <span id="dateDisplay">-</span>
      </div>
    </div>
    
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Flight</th>
          <th>Seat</th>
          <th>Class</th>
          <th>FQTV</th>
          <th>Pax</th>
          <th>Serial</th>
          <th>Remarks</th>
          <th>PNR</th>
          <th>Date</th>
          <th>Shift</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="entriesList"></tbody>
    </table>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="./firebackup.js"></script>
<script src="./fireC1.js"></script>
<!-- Shift System Firebase Configuration -->
<script src="./fireshift.js"></script>
<!-- QR Firebase Configuration -->
<script src="./qr-firebase-config.js"></script>
<script>
// ----- Airlines dropdown -----
const airlines = {
  'EK':'Emirates','FZ':'Flydubai','BA':'British Airways','EY':'Etihad',
  'MH':'Malaysia Airlines','AI':'Air India','AZ':'Alitalia','VS':'Virgin Atlantic',
  'PG':'Bangkok Airways','GF':'Gulf Air','Q2':'Malindivian','UL':'Srilankan Airlines',
  'AK':'Air Asia','SQ':'Singapore Airlines','6E':'Indigo','OS':'Austrian Airlines',
  '8D':'Fits Air','SU':'Aeroflot','OD':'Batik Air','TK':'Turkish Airline',
  'G9':'Air Arabia','SV':'Saudia','MU':'China Eastern Airlines','BS':'US-Bangla Airlines',
  '3U':'Sichuan Airlines','A1': 'Avia Maldives', 'DR': 'DER Turistic Service AG', 'HP':'Hotel Plan', 'HU':'Humming Bird',
  'KU':'Kouni UK', 'NT' : 'Nanto Tours','MT':'Maldives Travel Factory', 'WI':'Wako International', 'KC':'Air Astana','HIS':'Japan HIS Tours',
  'JD':'Capital Airlines', 'J2':'Azerbaijan Airlines', 'VO':'Voyages Maldives', 'WK':'Edelweiss','DE':'Condor','NO':'Neos','4Y':'Discover Airlines',
  // Add more airlines for FQTV detection
  'JL':'Japan Airlines', 'QF':'Qantas Airways', 'CX':'Cathay Pacific', 'AA':'American Airlines',
  'LA':'LATAM Airlines', 'AY':'Finnair', 'IB':'Iberia', 'QR':'Qatar Airways',
  // Added for better FQTV detection
  'LX':'Swiss International Air Lines', 'LH':'Lufthansa', 'AC':'Air Canada', 'NH':'All Nippon Airways',
  'BR':'EVA Air', 'CI':'China Airlines', 'NZ':'Air New Zealand', 'VA':'Virgin Australia',
  'AF':'Air France', 'KL':'KLM', 'DL':'Delta Air Lines', 'UA':'United Airlines',
  'B6':'JetBlue', 'WN':'Southwest Airlines', 'WS':'WestJet', 'AS':'Alaska Airlines',
  'F9':'Frontier Airlines', 'G4':'Allegiant Air', 'NK':'Spirit Airlines', 'SY':'Sun Country Airlines',
  '9W':'Jet Airways', 'ET':'Ethiopian Airlines', 'KE':'Korean Air', 'OZ':'Asiana Airlines',
  'PR':'Philippine Airlines', 'TG':'Thai Airways'
};

// ----- FQTV Tier Level Mappings -----
const fqtvTierMappings = {
  'same': {
    'n1': 'Silver',
    'n2': 'Gold',
    'n3': 'Platinum'
  },
  'different': {
    'n1': 'Ruby',
    'n2': 'Sapphire',
    'n3': 'Emerald'
  }
};

// ----- QR System Storage -----
let qrEntriesProcessed = [];

// ----- Initialize Airline Dropdown -----
const airlineSelect = document.getElementById('airlineSelect');
for(let iata in airlines){
  const opt = document.createElement('option');
  opt.value = iata;
  opt.textContent = airlines[iata];
  airlineSelect.appendChild(opt);
}

// ----- Elements -----
const codeInput = document.getElementById('codeInput');
const nameInput = document.getElementById('nameInput');
const pnrInput = document.getElementById('pnrInput');
const flightInput = document.getElementById('flightInput');
const seatInput = document.getElementById('seatInput');
const classInput = document.getElementById('classInput');
const fqtvInput = document.getElementById('fqtvInput');
const serialInput = document.getElementById('serialInput');
const remarksInput = document.getElementById('remarksInput');
const numPaxInput = document.getElementById('numPaxInput');
const userDisplay = document.getElementById('userDisplay');
const shiftDisplay = document.getElementById('shiftDisplay');
const dateDisplay = document.getElementById('dateDisplay');
const entriesList = document.getElementById('entriesList');
const manualSaveBtn = document.getElementById('manualSaveBtn');
const entriesCount = document.getElementById('entriesCount');
const clearNotification = document.getElementById('clearNotification');
const alertNotification = document.getElementById('alertNotification');
const alertMessage = document.getElementById('alertMessage');
const passengerEntryCard = document.getElementById('passengerEntryCard');
const scannerIndicator = document.getElementById('scannerIndicator');
const refreshShiftBtn = document.getElementById('refreshShiftBtn');
const qrProcessingIndicator = document.getElementById('qrProcessingIndicator');
const qrStatus = document.getElementById('qrStatus');

// ----- Delay Charge Elements -----
const delayChargeModal = document.getElementById('delayChargeModal');
const closeModalBtn = document.getElementById('closeModalBtn');
const delayChargeBtn = document.getElementById('delayChargeBtn');
const delayFlightInput = document.getElementById('delayFlightInput');
const entryTimeInput = document.getElementById('entryTimeInput');
const exitTimeInput = document.getElementById('exitTimeInput');
const stdTimeInput = document.getElementById('stdTimeInput');
const delayPaxInput = document.getElementById('delayPaxInput');
const calculateDelayBtn = document.getElementById('calculateDelayBtn');
const saveDelayBtn = document.getElementById('saveDelayBtn');
const delayCalcResult = document.getElementById('delayCalcResult');
const delayCalcDetails = document.getElementById('delayCalcDetails');

// ----- Local Storage Elements -----
const localStorageModal = document.getElementById('localStorageModal');
const closeStorageModalBtn = document.getElementById('closeStorageModalBtn');
const storageManagerBtn = document.getElementById('storageManagerBtn');
const refreshStorageBtn = document.getElementById('refreshStorageBtn');
const clearAllStorageBtn = document.getElementById('clearAllStorageBtn');
const jsonViewerModal = document.getElementById('jsonViewerModal');
const closeJsonViewerBtn = document.getElementById('closeJsonViewerBtn');
const jsonViewerBody = document.getElementById('jsonViewerBody');
const jsonViewerTitle = document.getElementById('jsonViewerTitle');

// ----- Numeric Keyboard Elements -----
const numericKeyboardModal = document.getElementById('numericKeyboardModal');
const closeNumericKeyboardBtn = document.getElementById('closeNumericKeyboardBtn');
const numericDisplay = document.getElementById('numericDisplay');
const applyNumericBtn = document.getElementById('applyNumericBtn');
const closeNumericBtn = document.getElementById('closeNumericBtn');
const backspaceKey = document.getElementById('backspaceKey');
const clearKey = document.getElementById('clearKey');

// ----- Global Variables -----
let isApproving = false;
let currentShiftType = null;
let currentShiftDate = null;
let renderTimeout = null;
let isRendering = false;
let lastRenderData = '';
let currentShiftStatus = 'not_started';
let shiftDb = null;
let backgroundSaveQueue = [];
let isBackgroundSaving = false;
let scannerTimer;
let lastValue = '';
let isScannerActive = false;
let isProcessing = false;

// ----- Numeric Keyboard Variables -----
let currentNumericValue = '0';
let currentEditingRowIndex = -1;
let currentEditingField = '';

// ----- QR System Variables -----
let qrDb = null;
let qrFirebaseInitialized = false;
let qrEntries = [];
let qrEntriesLocal = [];
let qrSystemAvailable = false;

// ----- Shift Cache -----
let shiftCacheInitialized = false;
let shiftCache = {
  data: null,
  timestamp: 0,
  ttl: 10 * 60 * 1000, // 10 minutes
  dateKey: '',
  shiftType: '',
  openTime: ''
};

// ----- Approved Entries Cache -----
let approvedEntriesCache = {};

// ----- Delay Charge Calculation Constants -----
const FREE_HOURS = 3; // First 3 hours free
const CHARGE_PER_HOUR = 0; // Charge amount per hour per pax (0 as requested)
const MIN_STAY_MINUTES = 60; // Minimum stay to be considered

// ----- Maldives Timezone Functions -----
function getMaldivesTime() {
  const now = new Date();
  const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
  const maldivesTime = new Date(utc + (5 * 3600000));
  return maldivesTime;
}

function formatDateToYYYYMMDD(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function getMaldivesTimeString() {
  const maldivesTime = getMaldivesTime();
  return maldivesTime.toTimeString().split(' ')[0].slice(0, 5);
}

function getMaldivesDateTimeISO() {
  return getMaldivesTime().toISOString();
}

function formatDateForDocumentId(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}_${month}_${day}`;
}

function getCurrentDate() {
  return formatDateToYYYYMMDD(getMaldivesTime());
}

function getCurrentTime() {
  return getMaldivesTimeString();
}

// ----- Date Format Functions -----
function formatDateForDisplay(dateString) {
  if (!dateString) return '-';
  try {
    if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
      const [year, month, day] = dateString.split('-').map(Number);
      const date = new Date(year, month - 1, day);
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
    }
    return dateString;
  } catch (error) {
    return dateString;
  }
}

// ----- Alert System -----
function showAlert(message, isError = false, isWarning = false, isInfo = false) {
  alertMessage.textContent = message;
  alertNotification.className = 'alert-notification';
  
  if (isError) {
    alertNotification.classList.add('error');
    alertNotification.querySelector('i').className = 'fas fa-exclamation-circle';
  } else if (isWarning) {
    alertNotification.classList.add('warning');
    alertNotification.querySelector('i').className = 'fas fa-exclamation-triangle';
  } else if (isInfo) {
    alertNotification.classList.add('info');
    alertNotification.querySelector('i').className = 'fas fa-info-circle';
  } else {
    alertNotification.querySelector('i').className = 'fas fa-check-circle';
  }
  
  alertNotification.classList.add('show');
  
  setTimeout(() => {
    alertNotification.classList.remove('show');
  }, 3000);
}

// ----- Generate Unique Key for QR Code -----
function generateUniqueKeyFromCode(codeValue) {
  let hash = 0;
  for (let i = 0; i < codeValue.length; i++) {
    const char = codeValue.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return Math.abs(hash).toString(16);
}

// ----- Check QR Duplicate -----
function isQRDuplicate(uniqueKey) {
  if (qrEntriesProcessed.includes(uniqueKey)) {
    return true;
  }
  
  const processedCodes = JSON.parse(localStorage.getItem('qrProcessedCodes') || '[]');
  if (processedCodes.includes(uniqueKey)) {
    return true;
  }
  
  return false;
}

// ----- Mark QR as Processed -----
function markQRAsProcessed(uniqueKey) {
  qrEntriesProcessed.push(uniqueKey);
  
  const processedCodes = JSON.parse(localStorage.getItem('qrProcessedCodes') || '[]');
  if (!processedCodes.includes(uniqueKey)) {
    processedCodes.push(uniqueKey);
    if (processedCodes.length > 1000) {
      processedCodes.splice(0, processedCodes.length - 1000);
    }
    localStorage.setItem('qrProcessedCodes', JSON.stringify(processedCodes));
  }
}

// ----- Clear Old Processed Codes -----
function clearOldProcessedCodes() {
  const processedCodes = JSON.parse(localStorage.getItem('qrProcessedCodes') || '[]');
  const oneWeekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
  const recentCodes = processedCodes.filter(code => {
    const match = code.match(/_(\d+)$/);
    if (match) {
      const timestamp = parseInt(match[1]);
      return timestamp > oneWeekAgo;
    }
    return true;
  });
  
  localStorage.setItem('qrProcessedCodes', JSON.stringify(recentCodes));
  qrEntriesProcessed = recentCodes;
}

// ----- Initialize QR Firebase -----
function initializeQRFirebase() {
  try {
    console.log("ðŸ”„ Initializing QR Firebase...");
    
    if (!qrFirebaseConfig) {
      console.warn("âš ï¸ QR Firebase config not available");
      showAlert("QR system configuration not found", true);
      qrSystemAvailable = false;
      return false;
    }
    
    console.log("âœ… Using QR Firebase project:", qrFirebaseConfig.projectId);
    
    let qrApp;
    try {
      qrApp = firebase.app('qrSystem');
      console.log("âœ… Using existing QR Firebase app");
    } catch (e) {
      try {
        qrApp = firebase.initializeApp(qrFirebaseConfig, 'qrSystem');
        console.log("âœ… Created new QR Firebase app for project:", qrFirebaseConfig.projectId);
      } catch (initError) {
        console.error("âŒ Error creating QR Firebase app:", initError);
        showAlert("Failed to initialize QR system", true);
        qrSystemAvailable = false;
        return false;
      }
    }
    
    try {
      qrDb = firebase.firestore(qrApp);
      
      const settings = {
        cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
      };
      
      qrDb.settings(settings);
      
      console.log("âœ… QR Firestore initialized");
      qrFirebaseInitialized = true;
      qrSystemAvailable = true;
      showAlert("QR system connected successfully", false, false, true);
      
      return true;
      
    } catch (firestoreError) {
      console.error("âŒ Error initializing QR Firestore:", firestoreError);
      
      qrDb = firebase.firestore(qrApp);
      qrFirebaseInitialized = true;
      qrSystemAvailable = true;
      
      if (firestoreError.code === 'permission-denied') {
        console.warn("âš ï¸ Permission denied - check Firebase rules for project:", qrFirebaseConfig.projectId);
        showAlert("QR system: Permission denied - check Firestore rules", true);
      } else {
        showAlert("QR system initialized (offline mode)", false, true, false);
      }
      
      return true;
    }
    
  } catch (error) {
    console.error("âŒ Unexpected error in QR Firebase initialization:", error);
    showAlert("QR system initialization error", true);
    qrSystemAvailable = false;
    return false;
  }
}

// ----- Load QR Entries -----
async function loadQREntries() {
  if (!qrFirebaseInitialized || !qrSystemAvailable) {
    console.log("QR system not available, skipping load");
    return;
  }
  
  try {
    console.log("ðŸ“¥ Loading QR entries from Firebase...");
    
    const snapshot = await qrDb.collection('flightEntries')
      .orderBy('timestamp', 'desc')
      .limit(200)
      .get();
    
    qrEntries = [];
    snapshot.forEach(doc => {
      qrEntries.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log(`âœ… Loaded ${qrEntries.length} QR entries from Firebase`);
    
  } catch (error) {
    console.error('âŒ Error loading QR entries:', error);
    qrStatus.innerHTML = `<span style="color: var(--error);"><i class="fas fa-exclamation-circle"></i> QR load failed: ${error.message}</span>`;
  }
}

// ----- Save to QR System -----
async function saveToQRSystem(codeValue) {
  if (!qrFirebaseInitialized || !qrSystemAvailable) {
    console.log("QR system not available, skipping save");
    return false;
  }
  
  try {
    qrProcessingIndicator.classList.add('show');
    
    const uniqueKey = generateUniqueKeyFromCode(codeValue);
    
    if (isQRDuplicate(uniqueKey)) {
      console.log("âš ï¸ Duplicate QR code detected, skipping save");
      qrProcessingIndicator.classList.remove('show');
      qrStatus.innerHTML = `<span style="color: var(--warning);"><i class="fas fa-exclamation-triangle"></i> Duplicate QR code - already processed</span>`;
      return false;
    }
    
    const qrData = extractQRDataFromCode(codeValue);
    
    // FIXED: Correct FFP tier mapping for QR system
    if (qrData.originalTier) {
      const tierUpper = qrData.originalTier.toUpperCase();
      if (tierUpper === 'N1') {
        qrData.ffpTier = 'Silver';
      } else if (tierUpper === 'N2') {
        qrData.ffpTier = 'Gold';
      } else if (tierUpper === 'N3') {
        qrData.ffpTier = 'Platinum';
      } else {
        qrData.ffpTier = qrData.originalTier;
      }
    }
    
    markQRAsProcessed(uniqueKey);
    
    qrData.processedAt = getMaldivesDateTimeISO();
    qrData.processedBy = userDisplay.textContent;
    qrData.sourceSystem = 'UnifiedCardEntry';
    qrData.uniqueKey = uniqueKey;
    
    if (!qrData.timestamp) {
      qrData.timestamp = firebase.firestore.FieldValue.serverTimestamp();
    }
    
    console.log("ðŸ’¾ Attempting to save QR data to project:", qrFirebaseConfig.projectId, {
      flight: qrData.flightNumber,
      passenger: `${qrData.firstName} ${qrData.lastName}`,
      carrier: qrData.carrierCode,
      seat: qrData.seatNumber,
      secNumber: qrData.secNumber,
      ffpTier: qrData.ffpTier // Debug log
    });
    
    const docRef = await qrDb.collection('flightEntries').add(qrData);
    qrData.id = docRef.id;
    
    qrEntries.unshift(qrData);
    qrEntriesLocal.push({
      ...qrData,
      synced: true,
      syncedAt: getMaldivesDateTimeISO()
    });
    
    console.log('âœ… QR entry saved to Firebase with ID:', docRef.id);
    qrProcessingIndicator.classList.remove('show');
    
    qrStatus.innerHTML = `<span style="color: var(--qr-green);"><i class="fas fa-check-circle"></i> QR entry saved successfully!</span>`;
    
    setTimeout(() => {
      qrStatus.innerHTML = '';
    }, 3000);
    
    return true;
    
  } catch (error) {
    console.error('âŒ Error saving to QR system:', error);
    qrProcessingIndicator.classList.remove('show');
    
    let errorMessage = error.message;
    if (error.code === 'permission-denied') {
      errorMessage = 'Permission denied - check Firebase Firestore rules';
      console.error('ðŸ”’ Firestore Rules Issue: Go to Firebase Console â†’ Firestore Database â†’ Rules');
      console.error('ðŸ”’ Project:', qrFirebaseConfig.projectId);
    } else if (error.message.includes('timeout')) {
      errorMessage = 'Save timeout - check connection';
    } else if (error.message.includes('network')) {
      errorMessage = 'Network error - working offline';
    }
    
    qrStatus.innerHTML = `<span style="color: var(--error);"><i class="fas fa-exclamation-circle"></i> QR save failed: ${errorMessage}</span>`;
    
    storeQRDataLocally(codeValue);
    
    return false;
  }
}

// ----- Store QR Data Locally -----
function storeQRDataLocally(codeValue) {
  try {
    const qrData = extractQRDataFromCode(codeValue);
    
    // FIXED: Apply correct tier mapping for local storage too
    if (qrData.originalTier) {
      const tierUpper = qrData.originalTier.toUpperCase();
      if (tierUpper === 'N1') {
        qrData.ffpTier = 'Silver';
      } else if (tierUpper === 'N2') {
        qrData.ffpTier = 'Gold';
      } else if (tierUpper === 'N3') {
        qrData.ffpTier = 'Platinum';
      } else {
        qrData.ffpTier = qrData.originalTier;
      }
    }
    
    qrData.localSaveTime = getMaldivesDateTimeISO();
    qrData.status = 'pending_sync';
    
    let localQRData = JSON.parse(localStorage.getItem('localQRData') || '[]');
    
    const isDuplicate = localQRData.some(item => 
      item.uniqueKey === qrData.uniqueKey
    );
    
    if (!isDuplicate) {
      localQRData.push(qrData);
      localStorage.setItem('localQRData', JSON.stringify(localQRData));
      console.log('ðŸ’¾ QR data stored locally for later sync');
    }
    
  } catch (error) {
    console.error('Error storing QR data locally:', error);
  }
}

// ----- Extract QR Data from Code -----
function extractQRDataFromCode(codeValue) {
  let data = {
    firstName: '',
    lastName: '',
    carrierCode: '',
    destination: '',
    origin: '',
    flightNumber: '',
    seatNumber: '',
    cabinCode: '',
    secNumber: '',
    ffpOwner: '',
    ffpNumber: '',
    ffpTier: '',
    originalTier: '',
    guestCategory: 'Guest',
    paxType: 'Adult',
    cabin: 'Economy',
    flightDate: getCurrentDate(),
    originalCode: codeValue,
    uniqueKey: generateUniqueKeyFromCode(codeValue)
  };
  
  codeValue = codeValue.toUpperCase().replace(/\s+/g, ' ').trim();
  
  const mlePos = codeValue.indexOf('MLE');
  
  if (mlePos !== -1) {
    const textBeforeMLE = codeValue.substring(0, mlePos);
    let processedText = '';
    
    if (textBeforeMLE.length >= 8) {
      processedText = textBeforeMLE.substring(2, textBeforeMLE.length - 7);
    } else if (textBeforeMLE.length > 2) {
      processedText = textBeforeMLE.substring(2);
    }
    
    if (processedText.includes('/')) {
      const nameParts = processedText.split('/');
      if (nameParts.length >= 2) {
        data.lastName = nameParts[0].trim();
        data.firstName = nameParts[1].trim();
      } else if (nameParts.length === 1) {
        data.lastName = nameParts[0].trim();
      }
    } else {
      data.lastName = processedText.trim();
    }
    
    let wordStart = mlePos;
    let wordEnd = mlePos + 3;
    
    while (wordStart > 0 && /[A-Z0-9]/.test(codeValue[wordStart - 1])) {
      wordStart--;
    }
    
    while (wordEnd < codeValue.length && /[A-Z0-9]/.test(codeValue[wordEnd])) {
      wordEnd++;
    }
    
    const mleWord = codeValue.substring(wordStart, wordEnd);
    
    data.carrierCode = mleWord.length >= 2 ? mleWord.substring(mleWord.length - 2) : mleWord;
    
    if (mleWord.length >= 5) {
      data.destination = mleWord.substring(3, mleWord.length - 2);
    }
    
    if (mleWord.length >= 3) {
      data.origin = mleWord.substring(0, 3);
    }
    
    let nextWordStart = wordEnd;
    
    while (nextWordStart < codeValue.length && !/[A-Z0-9]/.test(codeValue[nextWordStart])) {
      nextWordStart++;
    }
    
    let nextWordEnd = nextWordStart;
    while (nextWordEnd < codeValue.length && /[A-Z0-9]/.test(codeValue[nextWordEnd])) {
      nextWordEnd++;
    }
    
    if (nextWordStart < codeValue.length) {
      data.flightNumber = codeValue.substring(nextWordStart, nextWordEnd);
    }
    
    let seatWordStart = nextWordEnd;
    
    while (seatWordStart < codeValue.length && !/[A-Z0-9]/.test(codeValue[seatWordStart])) {
      seatWordStart++;
    }
    
    let seatWordEnd = seatWordStart;
    while (seatWordEnd < codeValue.length && /[A-Z0-9]/.test(codeValue[seatWordEnd])) {
      seatWordEnd++;
    }
    
    if (seatWordStart < codeValue.length) {
      const seatWord = codeValue.substring(seatWordStart, seatWordEnd);
      
      console.log("Seat word:", seatWord);
      
      if (seatWord.length >= 9) {
        const rowPart = seatWord.substring(5, seatWord.length - 5);
        const seatLetter = seatWord.substring(seatWord.length - 5, seatWord.length - 4);
        data.seatNumber = rowPart + seatLetter;
        console.log("Seat number extracted:", data.seatNumber);
      }
      
      if (seatWord.length >= 4) {
        data.cabinCode = seatWord.substring(3, 4);
      }
      
      if (seatWord.length >= 4) {
        const last4Chars = seatWord.substring(seatWord.length - 4);
        if (/^\d{4}$/.test(last4Chars)) {
          data.secNumber = last4Chars.substring(1);
        } else {
          let digitsEnd = seatWord.length;
          let digitsStart = seatWord.length - 1;
          
          while (digitsStart >= 0 && /\d/.test(seatWord[digitsStart])) {
            digitsStart--;
          }
          
          digitsStart++;
          
          if (digitsStart < digitsEnd) {
            const secDigits = seatWord.substring(digitsStart, digitsEnd);
            if (secDigits.length >= 4) {
              data.secNumber = secDigits.substring(1);
            } else {
              data.secNumber = secDigits;
            }
          }
        }
        console.log("SEC number extracted:", data.secNumber);
      }
    }
    
    const words = codeValue.split(' ').filter(word => word.trim() !== '');
    let ffpOwner = '';
    let ffpNumber = '';
    let ffpTier = '';
    let originalTier = '';
    
    if (words.length >= 2) {
      const lastWord = words[words.length - 1];
      const secondLastWord = words[words.length - 2];
      
      if (secondLastWord.length < 4) {
        ffpOwner = '';
        ffpNumber = '';
        ffpTier = '';
        originalTier = '';
      } else {
        ffpNumber = secondLastWord;
        
        if (words.length >= 3) {
          const thirdLastWord = words[words.length - 3];
          if (thirdLastWord.length === 2 && /^[A-Z]{2}$/.test(thirdLastWord)) {
            ffpOwner = thirdLastWord;
          }
        }
        
        if (lastWord.length === 2 && /^[A-Z0-9]{2}$/.test(lastWord.toUpperCase())) {
          originalTier = lastWord.toUpperCase();
          // Note: We'll fix the tier mapping later in saveToQRSystem
          ffpTier = originalTier;
        }
      }
    }
    
    data.ffpOwner = ffpOwner;
    data.ffpNumber = ffpNumber;
    data.ffpTier = ffpTier;
    data.originalTier = originalTier;
    
    switch(data.cabinCode) {
      case 'J':
        data.cabin = 'Business';
        break;
      case 'Y':
        data.cabin = 'Economy';
        break;
      case 'F':
        data.cabin = 'First';
        break;
      default:
        data.cabin = 'Economy';
    }
    
    const cabinCodeUpper = (data.cabinCode || '').toUpperCase();
    const cabinNameLower = (data.cabin || '').toLowerCase();
    const isEconomy = (cabinCodeUpper === 'Y' || cabinNameLower.includes('economy'));
    
    const ffpTierUpper = (data.ffpTier || '').toUpperCase();
    const isN0Tier = ffpTierUpper === 'N0' || ffpTierUpper.includes('N0');
    const isTierEmpty = !data.ffpTier || data.ffpTier.trim() === '';
    const isFFPNumberEmpty = !data.ffpNumber || data.ffpNumber.trim() === '';
    
    if (isEconomy && (isN0Tier || isTierEmpty || isFFPNumberEmpty)) {
      data.guestCategory = 'Guest';
    } else if (isEconomy && data.ffpNumber && data.ffpNumber.trim() !== '') {
      data.guestCategory = 'Primary';
    } else {
      data.guestCategory = 'Primary';
    }
    
    const carrierUpper = (data.carrierCode || '').toUpperCase();
    const tierUpper = (data.ffpTier || '').toUpperCase();
    const originalTierUpper = (data.originalTier || '').toUpperCase();
    
    if (carrierUpper === 'QR') {
      const isExactlyN0 = tierUpper === 'N0' || originalTierUpper === 'N0';
      const isEmptyTier = (tierUpper === '' || tierUpper === null || tierUpper === undefined) && 
                         (originalTierUpper === '' || originalTierUpper === null || originalTierUpper === undefined);
      
      if (isExactlyN0 || isEmptyTier) {
        data.ffpOwner = '';
        data.ffpNumber = '';
        data.ffpTier = '';
      }
    }
  }
  
  return data;
}

// ----- Convert FFP Tier -----
function convertFFPTier(carrierCode, ffpOwner, originalTier) {
  if (!originalTier || originalTier.trim() === '') {
    return originalTier || '';
  }
  
  const tier = originalTier.toUpperCase();
  
  // FIXED: Correct tier mapping
  if (tier === 'N1') {
    return 'Silver';
  } else if (tier === 'N2') {
    return 'Gold';
  } else if (tier === 'N3') {
    return 'Platinum';
  } else if (tier === 'N0') {
    return 'N0';
  }
  
  return originalTier;
}

// ----- Process FQTV Tier Level -----
function processFqtvTier(fqtvNumber, flightCode) {
  if (!fqtvNumber || fqtvNumber.trim() === '') return '';
  
  const fqtvUpper = fqtvNumber.toUpperCase();
  
  let tierCode = '';
  if (fqtvUpper.includes(' N3') || fqtvUpper.endsWith('N3') || fqtvUpper.includes('/N3')) {
    tierCode = 'n3';
  } else if (fqtvUpper.includes(' N2') || fqtvUpper.endsWith('N2') || fqtvUpper.includes('/N2')) {
    tierCode = 'n2';
  } else if (fqtvUpper.includes(' N1') || fqtvUpper.endsWith('N1') || fqtvUpper.includes('/N1')) {
    tierCode = 'n1';
  }
  
  if (!tierCode) {
    const tierMatch = fqtvUpper.match(/([Nn][123])$/);
    if (tierMatch) {
      tierCode = tierMatch[1].toLowerCase();
    }
  }
  
  if (!tierCode) return '';
  
  let fqtvAirlineCode = '';
  const fqtvMatch = fqtvUpper.match(/^([A-Z0-9]{2})[- ]/);
  if (fqtvMatch) {
    fqtvAirlineCode = fqtvMatch[1];
  } else {
    fqtvAirlineCode = fqtvUpper.substring(0, 2);
  }
  
  const flightAirlineCode = flightCode.slice(0, 2).toUpperCase();
  
  let tierMapping;
  if (fqtvAirlineCode && flightAirlineCode && 
      fqtvAirlineCode.toUpperCase() === flightAirlineCode.toUpperCase()) {
    tierMapping = fqtvTierMappings.same;
  } else {
    tierMapping = fqtvTierMappings.different;
  }
  
  return tierMapping[tierCode] || '';
}

// ----- User Authentication -----
const userData = JSON.parse(localStorage.getItem("loggedInUser"));

if (userData) {
    userDisplay.textContent = userData.name || userData.username;
} else {
    window.location.href = "login.html";
}

// ----- Initialize Shift Firebase -----
function initializeShiftFirebase() {
  try {
    console.log("Initializing Shift Firebase...");
    
    if (typeof shiftFirebaseConfig === 'undefined') {
      console.error("âŒ Shift Firebase config not found in fireshift.js");
      showAlert("Shift system configuration not found", true);
      return false;
    }
    
    console.log("Using Firebase config for project:", shiftFirebaseConfig.projectId);
    
    let app;
    try {
      app = firebase.app('shiftSystem');
      console.log("âœ… Using existing Shift Firebase app");
    } catch (e) {
      app = firebase.initializeApp(shiftFirebaseConfig, 'shiftSystem');
      console.log("âœ… Created new Shift Firebase app");
    }
    
    shiftDb = firebase.firestore(app);
    shiftCacheInitialized = true;
    console.log("âœ… Shift Firestore initialized successfully");
    
    return true;
    
  } catch (error) {
    console.error("âŒ Error initializing shift Firebase:", error);
    showAlert("Failed to initialize shift system", true);
    return false;
  }
}

// ----- Check for Open Shift -----
function checkForOpenShift(shiftData) {
  console.log("ðŸ” Checking for open shift in data...");
  
  let result = {
    success: false,
    isActive: false,
    shiftName: "No Shift Open",
    shiftType: "",
    openTime: "",
    details: {}
  };
  
  if (!shiftData) {
    return result;
  }
  
  if (shiftData.morning && shiftData.morning.status === 'open') {
    result.success = true;
    result.isActive = true;
    result.shiftName = "Morning Shift";
    result.shiftType = "morning";
    result.openTime = shiftData.morning.open || "";
    result.details = shiftData.morning;
    console.log("âœ“ Morning shift is OPEN");
    return result;
  }
  
  if (shiftData.evening && shiftData.evening.status === 'open') {
    result.success = true;
    result.isActive = true;
    result.shiftName = "Evening Shift";
    result.shiftType = "evening";
    result.openTime = shiftData.evening.open || "";
    result.details = shiftData.evening;
    console.log("âœ“ Evening shift is OPEN");
    return result;
  }
  
  if (shiftData.morning || shiftData.evening) {
    result.success = true;
    result.shiftName = "Shift Not Open";
    console.log("âš ï¸ Shift exists but not open");
  }
  
  return result;
}

// ----- Fetch Current Open Shift -----
async function fetchCurrentOpenShift() {
  console.log("ðŸŒ Fetching current open shift...");
  
  try {
    refreshShiftBtn.disabled = true;
    refreshShiftBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    if (!shiftCacheInitialized) {
      if (!initializeShiftFirebase()) {
        showNoShiftMessage();
        refreshShiftBtn.disabled = false;
        refreshShiftBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
        return;
      }
    }
    
    const now = Date.now();
    if (shiftCache.data && (now - shiftCache.timestamp < shiftCache.ttl)) {
      console.log("ðŸ“Š Using cached shift data");
      const shiftCheck = checkForOpenShift(shiftCache.data);
      if (shiftCheck.isActive) {
        updateShiftUI(shiftCheck, shiftCache.dateKey, shiftCache.dateKey !== getCurrentDate());
        refreshShiftBtn.disabled = false;
        refreshShiftBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
        return;
      }
    }
    
    const maldivesNow = getMaldivesTime();
    const todayDateForYYYYMMDD = formatDateToYYYYMMDD(maldivesNow);
    const todayDateForDocId = formatDateForDocumentId(maldivesNow);
    const todayDocId = `shift_${todayDateForDocId}`;
    
    console.log("ðŸ“… Today's date:", todayDateForYYYYMMDD);
    console.log("ðŸ“„ Document ID:", todayDocId);
    
    let shiftData = null;
    let foundDate = todayDateForYYYYMMDD;
    let shiftCheck = null;
    let isFromPreviousDay = false;
    
    try {
      const todayShiftDoc = await shiftDb.collection("shifts").doc(todayDocId).get();
      
      if (todayShiftDoc.exists) {
        shiftData = todayShiftDoc.data();
        console.log("âœ… Found today's shift document");
        console.log("Shift data:", shiftData);
        
        shiftCheck = checkForOpenShift(shiftData);
        
        if (shiftCheck.isActive) {
          console.log("ðŸŽ‰ Active shift found for today");
        } else {
          console.log("âš ï¸ No active shift today, checking previous day...");
          const previousResult = await checkPreviousDayForOpenShift();
          if (previousResult.success && previousResult.shiftCheck.isActive) {
            shiftData = previousResult.shiftData;
            foundDate = previousResult.foundDate;
            shiftCheck = previousResult.shiftCheck;
            isFromPreviousDay = true;
            console.log(`âœ… Found open shift from ${foundDate} (previous day)`);
          }
        }
      } else {
        console.log("âš ï¸ No shift document for today, checking previous day...");
        const previousResult = await checkPreviousDayForOpenShift();
        if (previousResult.success && previousResult.shiftCheck.isActive) {
          shiftData = previousResult.shiftData;
          foundDate = previousResult.foundDate;
          shiftCheck = previousResult.shiftCheck;
          isFromPreviousDay = true;
          console.log(`âœ… Found open shift from ${foundDate} (previous day)`);
        }
      }
    } catch (error) {
      console.error("âŒ Error fetching shift document:", error);
      showAlert("Error fetching shift data", true);
      refreshShiftBtn.disabled = false;
      refreshShiftBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
      return;
    }
    
    if (!shiftCheck || !shiftCheck.isActive) {
      console.log("âŒ No active shift found anywhere");
      showNoShiftMessage();
      showAlert("No active shift found. Please open a shift in Shift Management.", true);
      refreshShiftBtn.disabled = false;
      refreshShiftBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
      return;
    }
    
    shiftCache.data = shiftData;
    shiftCache.timestamp = now;
    shiftCache.dateKey = foundDate;
    shiftCache.shiftType = shiftCheck.shiftType;
    shiftCache.openTime = shiftCheck.openTime;
    
    updateShiftUI(shiftCheck, foundDate, isFromPreviousDay);
    
    console.log("âœ… Shift loaded successfully");
    
  } catch (error) {
    console.error("âŒ Error fetching shift data:", error);
    showNoShiftMessage();
    showAlert("Error loading shift information: " + error.message, true);
  } finally {
    refreshShiftBtn.disabled = false;
    refreshShiftBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
  }
}

// ----- Check Previous Day for Open Shift -----
async function checkPreviousDayForOpenShift() {
  try {
    const todayMaldives = getMaldivesTime();
    const yesterday = new Date(todayMaldives);
    yesterday.setDate(todayMaldives.getDate() - 1);
    
    const yesterdayForDocId = formatDateForDocumentId(yesterday);
    const yesterdayDocId = `shift_${yesterdayForDocId}`;
    const yesterdayDate = formatDateToYYYYMMDD(yesterday);
    
    console.log(`ðŸ” Checking previous day: ${yesterdayDocId} (${yesterdayDate})`);
    
    const yesterdayDoc = await shiftDb.collection("shifts").doc(yesterdayDocId).get();
    
    if (yesterdayDoc.exists) {
      const shiftData = yesterdayDoc.data();
      console.log(`âœ… Found shift document for previous day`);
      
      const shiftCheck = checkForOpenShift(shiftData);
      
      if (shiftCheck.isActive) {
        return {
          success: true,
          shiftData: shiftData,
          foundDate: yesterdayDate,
          foundDateForDocId: yesterdayForDocId,
          shiftCheck: shiftCheck,
          isFromPreviousDay: true
        };
      } else {
        console.log("âš ï¸ Previous day shift exists but not open");
      }
    } else {
      console.log("âš ï¸ No shift document for previous day");
    }
    
    return {
      success: false,
      message: "No open shift found in previous day"
    };
    
  } catch (error) {
    console.error("âŒ Error checking previous day:", error);
    return {
      success: false,
      message: "Error: " + error.message
    };
  }
}

// ----- Update Shift UI -----
function updateShiftUI(shiftCheck, foundDate, isFromPreviousDay = false) {
  currentShiftType = shiftCheck.shiftType;
  currentShiftDate = foundDate;
  currentShiftStatus = 'open';
  
  const displayDate = formatDateForDisplay(foundDate);
  
  let dateIndicator = "";
  if (isFromPreviousDay) {
    const foundDateObj = new Date(foundDate);
    const todayDateStr = getCurrentDate();
    const todayDateObj = new Date(todayDateStr);
    const daysDiff = Math.floor((todayDateObj - foundDateObj) / (1000 * 60 * 60 * 24));
    
    if (daysDiff === 1) {
      dateIndicator = " (Yesterday)";
    } else if (daysDiff > 1) {
      dateIndicator = ` (${daysDiff} days ago)`;
    }
  }
  
  shiftDisplay.textContent = shiftCheck.shiftName;
  dateDisplay.textContent = displayDate + dateIndicator;
  
  passengerEntryCard.classList.remove("disabled");
  
  saveCurrentShiftToLocalStorage(shiftCheck.shiftName, 'open', foundDate, isFromPreviousDay);
  
  updateExistingEntriesDate();
  
  showAlert(`${shiftCheck.shiftName} is OPEN - Date: ${displayDate}`, false);
  
  console.log("âœ… Shift UI updated:", {
    shift: shiftCheck.shiftName,
    date: foundDate,
    isFromPreviousDay: isFromPreviousDay
  });
}

// ----- Save Shift to LocalStorage -----
function saveCurrentShiftToLocalStorage(shiftName, shiftStatus, foundDate, isFromPreviousDay = false) {
  const shiftInfo = {
    shiftName: shiftName,
    shiftType: currentShiftType,
    shiftDate: foundDate,
    shiftStatus: shiftStatus,
    isFromPreviousDay: isFromPreviousDay,
    lastUpdated: getMaldivesDateTimeISO(),
    fetchedAt: getCurrentTime()
  };
  
  localStorage.setItem('currentShiftInfo', JSON.stringify(shiftInfo));
  console.log("ðŸ’¾ Shift saved to localStorage:", shiftInfo);
}

// ----- Load Shift from LocalStorage -----
function loadCurrentShiftFromLocalStorage() {
  try {
    const savedShift = localStorage.getItem('currentShiftInfo');
    if (savedShift) {
      const shiftInfo = JSON.parse(savedShift);
      
      const lastUpdated = new Date(shiftInfo.lastUpdated);
      const now = getMaldivesTime();
      const minutesDiff = (now - lastUpdated) / (1000 * 60);
      
      if (minutesDiff < 10 && shiftInfo.shiftStatus === 'open') {
        console.log("ðŸ“‚ Loading shift from localStorage (fresh cache)");
        
        currentShiftType = shiftInfo.shiftType;
        currentShiftDate = shiftInfo.shiftDate;
        currentShiftStatus = shiftInfo.shiftStatus;
        
        let displayDate = formatDateForDisplay(shiftInfo.shiftDate);
        if (shiftInfo.isFromPreviousDay) {
          const shiftDateObj = new Date(shiftInfo.shiftDate);
          const todayDateStr = getCurrentDate();
          const todayDateObj = new Date(todayDateStr);
          const daysDiff = Math.floor((todayDateObj - shiftDateObj) / (1000 * 60 * 60 * 24));
          
          if (daysDiff === 1) {
            displayDate += " (Yesterday)";
          } else if (daysDiff > 1) {
            displayDate += ` (${daysDiff} days ago)`;
          }
        }
        
        shiftDisplay.textContent = shiftInfo.shiftName;
        dateDisplay.textContent = displayDate;
        passengerEntryCard.classList.remove("disabled");
        
        console.log("âœ… Shift loaded from cache:", shiftInfo.shiftName);
        return true;
      } else {
        console.log("ðŸ”„ LocalStorage cache expired, fetching fresh data");
        localStorage.removeItem('currentShiftInfo');
      }
    }
  } catch (error) {
    console.error("âŒ Error loading shift from localStorage:", error);
    localStorage.removeItem('currentShiftInfo');
  }
  return false;
}

// ----- Show No Shift Message -----
function showNoShiftMessage() {
  shiftDisplay.textContent = "No Shift";
  dateDisplay.textContent = "-";
  passengerEntryCard.classList.add("disabled");
  currentShiftType = null;
  currentShiftDate = null;
  currentShiftStatus = 'not_started';
  
  console.log("âš ï¸ No active shift - system disabled");
}

// ----- Update Existing Entries Date -----
function updateExistingEntriesDate() {
  if (!currentShiftType || !currentShiftDate) return;
  
  let data = JSON.parse(localStorage.getItem('codesData') || '[]');
  
  let updated = false;
  data = data.map(entry => {
    if (!entry.approved && entry.date !== currentShiftDate) {
      entry.date = currentShiftDate;
      entry.shift = currentShiftType;
      updated = true;
    }
    return entry;
  });
  
  if (updated) {
    localStorage.setItem('codesData', JSON.stringify(data));
    renderEntries();
    console.log("ðŸ“ Updated existing entries to current shift date");
  }
}

// ----- Refresh Shift Data -----
async function refreshShiftData() {
  console.log("ðŸ”„ Manual shift refresh requested");
  
  try {
    refreshShiftBtn.disabled = true;
    refreshShiftBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    
    shiftCache.data = null;
    shiftCache.timestamp = 0;
    localStorage.removeItem('currentShiftInfo');
    
    await fetchCurrentOpenShift();
    
    console.log("âœ… Shift data refreshed");
    
  } catch (error) {
    console.error("âŒ Error refreshing shift:", error);
    showAlert("Error refreshing shift data", true);
  } finally {
    refreshShiftBtn.disabled = false;
    refreshShiftBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
  }
}

// ----- Approve Entry - SAVE TO LOCALSTORAGE FIRST -----
async function approveEntry(index) {
  if (!currentShiftType || currentShiftStatus !== 'open') {
    showAlert('No active shift or shift not open!', true);
    return;
  }
  
  if (isApproving) {
    return;
  }
  
  isApproving = true;
  
  try {
    let data = JSON.parse(localStorage.getItem('codesData')||'[]');
    const entry = data[index];
    
    if (!entry) {
      isApproving = false;
      return;
    }

    if (isFqtvRequired(entry.class, entry.fqtv)) {
      showAlert(`Cannot approve: Economy Class passenger requires FQTV card or primary guest seat`, true);
      isApproving = false;
      return;
    }

    const flightUpper = entry.flight.toUpperCase();
    const nameUpper = entry.name.toUpperCase();
    const seatUpper = entry.seat.toUpperCase();
    
    const duplicateCheck = checkDuplicateInCache(entry.flight, entry.seat, currentShiftDate, entry.name);
    if (duplicateCheck.isDuplicate) {
      showAlert(duplicateCheck.message, true);
      isApproving = false;
      
      data.splice(index, 1);
      localStorage.setItem('codesData', JSON.stringify(data));
      renderEntries();
      return;
    }
    
    let processedFqtv = '';
    if (entry.fqtv && entry.fqtv.trim() !== '') {
      let fqtvValue = entry.fqtv.trim();
      
      const tierMatch = fqtvValue.match(/\/(Sapphire|Emerald|Ruby|Platinum|Gold|Silver|G|S)$/i);
      const hasTier = tierMatch !== null;
      
      if (hasTier) {
        processedFqtv = fqtvValue;
      } else {
        fqtvValue = fqtvValue.replace(/\/\s*(Sapphire|Emerald|Ruby|Platinum|Gold|Silver|GOLD|SILVER|PLATINUM|SAPPHIRE|EMERALD|RUBY)\s*$/i, '').trim();
        fqtvValue = fqtvValue.replace(/\/[Nn][123]\s*$/, '').trim();
        
        const tierLevel = processFqtvTier(fqtvValue, entry.flight);
        
        if (tierLevel) {
          processedFqtv = `${fqtvValue}/${tierLevel}`;
        } else {
          processedFqtv = fqtvValue;
        }
      }
    }

    const approvedEntry = {
      airline: airlines[entry.airline] || entry.airline,
      approved: true,
      checkinTime: "",
      date: currentShiftDate,
      flightNo: flightUpper,
      fqtv: processedFqtv,
      name: entry.name,
      numPax: Number(entry.numPax) || 0,
      remarks: entry.remarks || "-",
      seatNo: seatUpper,
      class: entry.class || "-",
      pnr: entry.pnr,
      serial: entry.serial || "-",
      shift: currentShiftType,
      timeAdded: getCurrentTime(),
      approvedBy: userData ? userData.name : 'Unknown',
      approvedAt: getMaldivesDateTimeISO(),
      localId: `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      synced: false,
      syncedAt: null,
      originalEntry: entry
    };

    let docName;
    const timestamp = Date.now();
    const randomSuffix = Math.random().toString(36).substring(2, 8);
    
    if (flightUpper.startsWith('SQ')) {
      const cleanName = nameUpper.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30);
      docName = `${approvedEntry.date}_${flightUpper}_${cleanName}_${timestamp}_${randomSuffix}`;
    } else {
      docName = `${approvedEntry.date}_${flightUpper}_${seatUpper}_${timestamp}`;
    }
    
    approvedEntry.docName = docName;
    
    // FIXED: SAVE TO LOCALSTORAGE FIRST
    saveToApprovedCache(entry.flight, entry.seat, approvedEntry.date, entry.name, docName);
    
    let approvedLocalData = JSON.parse(localStorage.getItem('approvedLocalData') || '[]');
    approvedLocalData.push(approvedEntry);
    localStorage.setItem('approvedLocalData', JSON.stringify(approvedLocalData));
    
    data.splice(index, 1);
    localStorage.setItem('codesData', JSON.stringify(data));
    
    renderEntries();
    
    showAlert(`Entry approved and saved to local storage!`, false);
    
    // Then save to Firebase in background
    if (window.passengerDb) {
      addToBackgroundSaveQueue(approvedEntry);
    } else {
      showAlert("Approved locally, will sync to server when connection available", true);
    }
    
  } catch (e) {
    console.error('Error in approval:', e);
    showAlert('Error: ' + e.message, true);
  } finally {
    isApproving = false;
  }
}

// ----- Background Save Queue Management -----
function addToBackgroundSaveQueue(approvedEntry) {
  backgroundSaveQueue.push(approvedEntry);
  
  if (!isBackgroundSaving) {
    processBackgroundSaveQueue();
  }
}

async function processBackgroundSaveQueue() {
  if (isBackgroundSaving || backgroundSaveQueue.length === 0) return;
  
  isBackgroundSaving = true;
  
  while (backgroundSaveQueue.length > 0) {
    const approvedEntry = backgroundSaveQueue[0];
    
    try {
      // Remove the synced field before saving to Firebase
      const firebaseEntry = { ...approvedEntry };
      delete firebaseEntry.synced;
      delete firebaseEntry.syncedAt;
      delete firebaseEntry.localId;
      delete firebaseEntry.originalEntry;
      
      await window.passengerDb.collection('passengers').doc(approvedEntry.docName).set(firebaseEntry);
      console.log(`âœ… Firebase save completed: ${approvedEntry.docName}`);
      
      // Mark as synced in localStorage
      markAsSyncedInLocalStorage(approvedEntry.localId);
      backgroundSaveQueue.shift();
      
      await new Promise(resolve => setTimeout(resolve, 100));
    } catch (error) {
      console.error('âŒ Firebase save failed:', error);
      const failedEntry = backgroundSaveQueue.shift();
      backgroundSaveQueue.push(failedEntry);
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
  }
  
  isBackgroundSaving = false;
}

function markAsSyncedInLocalStorage(localId) {
  try {
    let approvedLocalData = JSON.parse(localStorage.getItem('approvedLocalData') || '[]');
    
    approvedLocalData = approvedLocalData.map(item => {
      if (item.localId === localId) {
        return {
          ...item,
          synced: true,
          syncedAt: getMaldivesDateTimeISO()
        };
      }
      return item;
    });
    
    localStorage.setItem('approvedLocalData', JSON.stringify(approvedLocalData));
    console.log(`âœ… Marked entry ${localId} as synced in localStorage`);
  } catch (error) {
    console.error('Error marking as synced:', error);
  }
}

// ----- Load Approved Entries Cache -----
function loadApprovedEntriesCache() {
  try {
    const cacheData = localStorage.getItem('approvedEntriesCache');
    if (cacheData) {
      approvedEntriesCache = JSON.parse(cacheData);
      console.log(`âœ… Loaded ${Object.keys(approvedEntriesCache).length} approved entries from cache`);
    }
  } catch (error) {
    console.error('âŒ Error loading approved entries cache:', error);
    approvedEntriesCache = {};
  }
}

// ----- Save Approved Entry to Cache -----
function saveToApprovedCache(flight, seat, date, name = null, docId = null) {
  const flightUpper = flight.toUpperCase();
  const nameUpper = name ? name.toUpperCase() : '';
  const seatUpper = seat ? seat.toUpperCase() : '';
  const timestamp = Date.now();
  
  if (flightUpper.startsWith('SQ')) {
    if (nameUpper) {
      const uniqueKey = `${date}_SQ_${nameUpper}_${timestamp}`;
      approvedEntriesCache[uniqueKey] = {
        date: date,
        flight: flightUpper,
        name: nameUpper,
        seat: seatUpper || '',
        cachedAt: getMaldivesDateTimeISO(),
        docId: docId,
        timestamp: timestamp
      };
    }
  } else {
    const seatKey = `${date}_${flightUpper}_${seatUpper}`;
    approvedEntriesCache[seatKey] = {
      date: date,
      flight: flightUpper,
      seat: seatUpper,
      cachedAt: getMaldivesDateTimeISO(),
      docId: docId
    };
  }
  
  localStorage.setItem('approvedEntriesCache', JSON.stringify(approvedEntriesCache));
}

// ----- Check Duplicate in Cache -----
function checkDuplicateInCache(flight, seat, date, name = null) {
  const flightUpper = flight.toUpperCase();
  const nameUpper = name ? name.toUpperCase() : '';
  const seatUpper = seat ? seat.toUpperCase() : '';
  
  if (flightUpper.startsWith('SQ')) {
    if (nameUpper) {
      for (const key in approvedEntriesCache) {
        const entry = approvedEntriesCache[key];
        
        if (entry.date !== date) continue;
        if (entry.flight !== flightUpper) continue;
        if (entry.name !== nameUpper) continue;
        
        return { 
          isDuplicate: true, 
          message: `${name} is already approved for flight ${flight} today`
        };
      }
    }
    return { isDuplicate: false };
  }
  
  const seatKey = `${date}_${flightUpper}_${seatUpper}`;
  if (approvedEntriesCache[seatKey]) {
    return { 
      isDuplicate: true, 
      message: `Seat ${seat} is already approved for flight ${flight}`
    };
  }
  
  return { isDuplicate: false };
}

// ----- Clear input fields -----
function clearInputFields() {
  nameInput.value = '';
  pnrInput.value = '';
  flightInput.value = '';
  airlineSelect.value = '';
  seatInput.value = '';
  classInput.value = '';
  numPaxInput.value = '1';
  fqtvInput.value = '';
  serialInput.value = '';
  remarksInput.value = '';
  qrStatus.innerHTML = '';
  
  clearNotification.classList.add('show');
  setTimeout(() => {
    clearNotification.classList.remove('show');
  }, 3000);
}

// ----- Check if FQTV is required -----
function isFqtvRequired(classValue, fqtvValue) {
  return classValue && classValue.toUpperCase() === 'Y' && 
         (!fqtvValue || fqtvValue.trim() === '');
}

// ----- Duplicate Entry Check -----
function isDuplicateEntry(entry) {
  const data = JSON.parse(localStorage.getItem('codesData') || '[]');
  const flightUpper = entry.flight.toUpperCase();
  const nameUpper = entry.name.toUpperCase();
  const seatUpper = entry.seat.toUpperCase();
  
  if (flightUpper.startsWith('SQ')) {
    return data.some(existingEntry => 
      existingEntry.date === currentShiftDate && 
      existingEntry.flight.toUpperCase() === flightUpper && 
      existingEntry.name.toUpperCase() === nameUpper &&
      !existingEntry.approved
    );
  }
  
  return data.some(existingEntry => 
    existingEntry.date === currentShiftDate && 
    existingEntry.flight.toUpperCase() === flightUpper && 
    existingEntry.name.toUpperCase() === nameUpper &&
    existingEntry.seat.toUpperCase() === seatUpper &&
    !existingEntry.approved
  );
}

// ----- Save Entry -----
async function saveEntry(entry){
  if (!currentShiftType || currentShiftStatus !== 'open') {
    showAlert('No active shift or shift not open!', true);
    return;
  }
  
  entry.date = currentShiftDate;
  entry.shift = currentShiftType;
  
  if (isDuplicateEntry(entry)) {
    console.log('Duplicate passenger detected, skipping save');
    showAlert(`${entry.name} is already entered for flight ${entry.flight}`, true);
    
    codeInput.value = '';
    codeInput.focus();
    setTimeout(clearInputFields, 2000);
    return;
  }
  
  const flightUpper = entry.flight.toUpperCase();
  const isQRFlight = flightUpper.startsWith('QR');
  
  let qrSaved = false;
  if (isQRFlight) {
    try {
      qrSaved = await saveToQRSystem(entry.code);
      if (qrSaved) {
        console.log('âœ… QR data saved successfully');
      }
    } catch (error) {
      console.error('âŒ Error saving QR data:', error);
    }
  }
  
  let data = JSON.parse(localStorage.getItem('codesData')||'[]');
  data.push(entry);
  localStorage.setItem('codesData', JSON.stringify(data));
  
  if (!renderTimeout) {
    renderTimeout = setTimeout(() => {
      renderEntries();
      renderTimeout = null;
    }, 50);
  }

  if (isQRFlight && qrSaved) {
    showAlert(`Entry saved! ${entry.name} - QR data saved to both systems`, false);
  } else if (isQRFlight && !qrSaved) {
    showAlert(`Entry saved! ${entry.name} - QR system save failed`, true);
  } else {
    showAlert(`Entry saved! ${entry.name}`);
  }

  codeInput.value = '';
  codeInput.focus();
  setTimeout(clearInputFields, 2000);
}

// ----- Optimized Render Function -----
async function renderEntries() {
  if (isRendering) {
    clearTimeout(renderTimeout);
    renderTimeout = setTimeout(renderEntries, 100);
    return;
  }
  
  isRendering = true;
  
  try {
    const data = JSON.parse(localStorage.getItem('codesData') || '[]').filter(e => !e.approved);
    const dataString = JSON.stringify(data);
    
    if (dataString === lastRenderData && entriesList.children.length > 0) {
      isRendering = false;
      return;
    }
    
    lastRenderData = dataString;
    entriesCount.textContent = `${data.length} entries`;
    
    entriesList.innerHTML = '';
    
    const fragment = document.createDocumentFragment();
    
    for (const [i, e] of data.entries()) {
      const tr = document.createElement('tr');
      
      const isFqtvNeeded = isFqtvRequired(e.class, e.fqtv);
      const isQRFlight = e.flight.toUpperCase().startsWith('QR');
      const isDelayEntry = e.isDelayCharge || false;
      const isSQFlight = e.flight.toUpperCase().startsWith('SQ');
      
      if (isFqtvNeeded) {
        tr.classList.add('fqtv-required');
      }
      
      if (isDelayEntry) {
        tr.classList.add('delay-entry');
      }
      
      if (isSQFlight) {
        tr.classList.add('sq-flight');
      }
      
      let fqtvDisplay = e.fqtv || '';
      if (isFqtvNeeded && !fqtvDisplay) {
        fqtvDisplay = '<span class="fqtv-warning">FQTV REQUIRED </span>';
      }
      
      const approveBtn = document.createElement('button');
      approveBtn.className = 'action-btn';
      approveBtn.innerHTML = '<i class="fas fa-check-circle"></i> Approve';
      approveBtn.onclick = (function(index) {
        return function(event) {
          event.stopPropagation();
          event.preventDefault();
          approveEntry(index);
        };
      })(i);
      
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'action-btn';
      deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
      deleteBtn.onclick = (function(index) {
        return function(event) {
          event.stopPropagation();
          event.preventDefault();
          deleteEntry(index);
        };
      })(i);
      
      const actionsCell = document.createElement('td');
      actionsCell.appendChild(approveBtn);
      actionsCell.appendChild(deleteBtn);
      
      // FIXED: Don't add QR or DELAY to flight number
      let flightDisplay = escapeHtml(e.flight);
      
      tr.innerHTML = `
        <td class="editable-cell" contenteditable="true" data-field="name">${escapeHtml(e.name)}</td>
        <td class="editable-cell" contenteditable="true" data-field="flight">${flightDisplay}</td>
        <td class="editable-cell" contenteditable="true" data-field="seat">${escapeHtml(e.seat)}</td>
        <td class="editable-cell" contenteditable="true" data-field="class">${escapeHtml(e.class || '')}</td>
        <td class="editable-cell" contenteditable="true" data-field="fqtv">${fqtvDisplay}</td>
        <td class="editable-cell" contenteditable="true" data-field="numPax">${e.numPax}</td>
        <td class="editable-cell" contenteditable="true" data-field="serial">${escapeHtml(e.serial)}</td>
        <td class="editable-cell" contenteditable="true" data-field="remarks">${escapeHtml(e.remarks)}</td>
        <td class="editable-cell" contenteditable="true" data-field="pnr">${escapeHtml(e.pnr)}</td>
        <td>${formatDateForDisplay(e.date)}</td>
        <td>${e.shift || currentShiftType || '-'}</td>
      `;
      
      tr.appendChild(actionsCell);
      fragment.appendChild(tr);
    }
    
    entriesList.appendChild(fragment);
    addAutoSaveListeners();
    addSQFlightClickListeners();
    
  } catch (error) {
    console.error('Error rendering entries:', error);
  } finally {
    isRendering = false;
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function addAutoSaveListeners() {
  const editableCells = document.querySelectorAll('.editable-cell');
  editableCells.forEach(cell => {
    cell.addEventListener('blur', function() {
      const row = this.closest('tr');
      const rowIndex = Array.from(row.parentNode.children).indexOf(row);
      saveEditedEntry(rowIndex);
    });
  });
}

function addSQFlightClickListeners() {
  const sqFlights = document.querySelectorAll('.sq-flight td:first-child');
  sqFlights.forEach((cell, index) => {
    // Remove existing listeners
    cell.removeEventListener('click', handleSQNameClick);
    // Add new listener
    cell.addEventListener('click', handleSQNameClick);
  });
}

function handleSQNameClick(event) {
  const cell = event.target;
  const row = cell.closest('tr');
  const rowIndex = Array.from(row.parentNode.children).indexOf(row);
  
  if (rowIndex >= 0) {
    const data = JSON.parse(localStorage.getItem('codesData') || '[]');
    const entry = data[rowIndex];
    
    if (entry && entry.flight.toUpperCase().startsWith('SQ')) {
      openNumericKeyboard(rowIndex, cell.textContent);
    }
  }
}

function openNumericKeyboard(rowIndex, currentValue) {
  currentEditingRowIndex = rowIndex;
  currentEditingField = 'name';
  
  // Try to extract numeric value from current name
  const numericMatch = currentValue.match(/\d+/);
  if (numericMatch) {
    currentNumericValue = numericMatch[0];
  } else {
    currentNumericValue = '0';
  }
  
  numericDisplay.textContent = currentNumericValue;
  numericKeyboardModal.classList.add('show');
  
  // Focus the modal
  setTimeout(() => {
    numericDisplay.focus();
  }, 100);
}

function saveEditedEntry(rowIndex) {
  const data = JSON.parse(localStorage.getItem('codesData')||'[]');
  const entry = data[rowIndex];
  
  if (!entry) return;
  
  const rows = entriesList.querySelectorAll('tr');
  const targetRow = rows[rowIndex];
  
  if (!targetRow) return;
  
  entry.name = targetRow.cells[0].textContent.trim();
  entry.flight = targetRow.cells[1].textContent.trim();
  entry.seat = targetRow.cells[2].textContent.trim();
  entry.class = targetRow.cells[3].textContent.trim();
  
  let fqtvValue = targetRow.cells[4].textContent.trim();
  fqtvValue = fqtvValue.replace('FQTV REQUIRED', '').trim();
  entry.fqtv = fqtvValue;
  
  entry.numPax = Number(targetRow.cells[5].textContent.trim()) || 0;
  entry.serial = targetRow.cells[6].textContent.trim();
  entry.remarks = targetRow.cells[7].textContent.trim();
  entry.pnr = targetRow.cells[8].textContent.trim();
  
  localStorage.setItem('codesData', JSON.stringify(data));
}

// ----- Numeric Keyboard Functions -----
function initializeNumericKeyboard() {
  // Add event listeners to numeric keys
  document.querySelectorAll('.numeric-key[data-value]').forEach(key => {
    key.addEventListener('click', () => {
      const value = key.getAttribute('data-value');
      handleNumericInput(value);
    });
  });
  
  // Backspace key
  backspaceKey.addEventListener('click', () => {
    handleBackspace();
  });
  
  // Clear key
  clearKey.addEventListener('click', () => {
    handleClear();
  });
  
  // Apply button
  applyNumericBtn.addEventListener('click', () => {
    applyNumericValue();
  });
  
  // Close button
  closeNumericBtn.addEventListener('click', () => {
    closeNumericKeyboard();
  });
  
  // Close modal button
  closeNumericKeyboardBtn.addEventListener('click', () => {
    closeNumericKeyboard();
  });
  
  // Close modal when clicking outside
  numericKeyboardModal.addEventListener('click', (e) => {
    if (e.target === numericKeyboardModal) {
      closeNumericKeyboard();
    }
  });
  
  // Keyboard support
  document.addEventListener('keydown', (e) => {
    if (numericKeyboardModal.classList.contains('show')) {
      if (e.key >= '0' && e.key <= '9') {
        handleNumericInput(e.key);
      } else if (e.key === 'Backspace') {
        handleBackspace();
        e.preventDefault();
      } else if (e.key === 'Enter') {
        applyNumericValue();
        e.preventDefault();
      } else if (e.key === 'Escape') {
        closeNumericKeyboard();
        e.preventDefault();
      }
    }
  });
}

function handleNumericInput(value) {
  if (currentNumericValue === '0') {
    currentNumericValue = value;
  } else {
    currentNumericValue += value;
  }
  numericDisplay.textContent = currentNumericValue;
}

function handleBackspace() {
  if (currentNumericValue.length > 1) {
    currentNumericValue = currentNumericValue.slice(0, -1);
  } else {
    currentNumericValue = '0';
  }
  numericDisplay.textContent = currentNumericValue;
}

function handleClear() {
  currentNumericValue = '0';
  numericDisplay.textContent = currentNumericValue;
}

function applyNumericValue() {
  if (currentEditingRowIndex >= 0 && currentEditingField) {
    const data = JSON.parse(localStorage.getItem('codesData')||'[]');
    const entry = data[currentEditingRowIndex];
    
    if (entry) {
      if (currentEditingField === 'name') {
        // For SQ flights, we want to replace the name with just the number
        entry.name = currentNumericValue;
        
        // Update the table cell
        const rows = entriesList.querySelectorAll('tr');
        if (rows[currentEditingRowIndex]) {
          rows[currentEditingRowIndex].cells[0].textContent = currentNumericValue;
        }
        
        localStorage.setItem('codesData', JSON.stringify(data));
        showAlert(`Name updated to number: ${currentNumericValue}`, false);
      }
    }
  }
  
  closeNumericKeyboard();
}

function closeNumericKeyboard() {
  numericKeyboardModal.classList.remove('show');
  currentEditingRowIndex = -1;
  currentEditingField = '';
  currentNumericValue = '0';
}

// ----- Delete Entry -----
function deleteEntry(index) {
  if (isApproving) {
    return;
  }
  
  let data = JSON.parse(localStorage.getItem('codesData')||'[]');
  
  if (index >= 0 && index < data.length) {
    data.splice(index, 1);
    localStorage.setItem('codesData', JSON.stringify(data));
    renderEntries();
    showAlert('Entry deleted successfully!');
  }
}

// ----- Parse code -----
function parseCode(){
  const code = codeInput.value.trim().toUpperCase();
  if(!code) return;
  const parts = code.split(/\s+/);

  const idxMLE = code.indexOf('MLE');
  let name='', pnr='';
  if(idxMLE!==-1){
    let fullNamePart = code.substring(0,idxMLE).trim();
    if(fullNamePart.length>8){
      name = fullNamePart.substring(2, fullNamePart.length-7).trim();
      pnr = fullNamePart.substring(fullNamePart.length-7).trim();
    }
  }

  let flightNo=''; let flightTokenIndex=-1;
  for(let i=0;i<parts.length;i++){
    if(parts[i].includes('MLE')){
      flightTokenIndex=i;
      const mleToken = parts[i];
      flightNo = mleToken.slice(-2) + (parts[i+1]||'').slice(0,4);
      break;
    }
  }

  if(flightNo.length>=2){
    const iata = flightNo.slice(0,2);
    airlineSelect.value = airlines[iata]?iata:'';
  } else airlineSelect.value='';

  let seatNo='';
  let seatClass='';
  if(flightTokenIndex!==-1 && parts[flightTokenIndex+2]){
    let seatToken = parts[flightTokenIndex+2];
    if(seatToken.length>9){
      if (seatToken.length >= 4) {
        seatClass = seatToken.charAt(3);
      }
      
      if (seatToken.length >= 8) {
        const rowPart = seatToken.substring(4, 7);
        const seatLetter = seatToken.charAt(7);
        const rowNumber = parseInt(rowPart, 10).toString();
        seatNo = rowNumber + seatLetter;
      }
    }
  }

  // FQTV detection
  let fqtv = null;
  let fqtvTierCode = '';
  let hasNoFqtv = false;

  const allPossibleAirlineCodes = [
    ...Object.keys(airlines),
    'LX', 'LH', 'AC', 'NH', 'BR', 'CI', 'NZ', 'VA', 'AF', 'KL', 'DL', 'UA', 'B6', 'WN',
    'WS', 'AS', 'F9', 'G4', 'NK', 'SY', '9W', 'AI', 'ET', 'KE', 'OZ', 'PR', 'TG'
  ];

  for (let i = 0; i < parts.length; i++) {
    const currentToken = parts[i].toUpperCase();
    
    for (const airlineCode of allPossibleAirlineCodes) {
      if (currentToken === airlineCode) {
        if (i + 1 < parts.length) {
          const nextToken = parts[i + 1];
          
          if (/^\d+$/.test(nextToken)) {
            fqtv = airlineCode + ' ' + nextToken;
            
            for (let j = i + 2; j < parts.length && j < i + 5; j++) {
              const tierToken = parts[j].toUpperCase();
              if (tierToken.includes('SAPPHIRE')) {
                fqtvTierCode = 'n2';
              } else if (tierToken.includes('EMERALD')) {
                fqtvTierCode = 'n3';
              } else if (tierToken.includes('RUBY')) {
                fqtvTierCode = 'n1';
              } else if (tierToken.includes('PLATINUM')) {
                fqtvTierCode = 'n3';
              } else if (tierToken.includes('GOLD')) {
                fqtvTierCode = 'n2';
              } else if (tierToken.includes('SILVER')) {
                fqtvTierCode = 'n1';
              } else if (tierToken === 'N0') {
                hasNoFqtv = true;
                fqtv = '';
              } else if (tierToken === 'N1' || tierToken === 'N2' || tierToken === 'N3') {
                fqtvTierCode = tierToken.toLowerCase();
              }
            }
            break;
          }
        }
      }
      
      if (currentToken.startsWith(airlineCode) && currentToken.length > airlineCode.length) {
        const remainder = currentToken.substring(airlineCode.length);
        if (/^\d+$/.test(remainder)) {
          fqtv = airlineCode + ' ' + remainder;
          
          for (let j = i + 1; j < parts.length && j < i + 4; j++) {
            const tierToken = parts[j].toUpperCase();
            if (tierToken.includes('SAPPHIRE')) fqtvTierCode = 'n2';
            else if (tierToken.includes('EMERALD')) fqtvTierCode = 'n3';
            else if (tierToken.includes('RUBY')) fqtvTierCode = 'n1';
            else if (tierToken.includes('PLATINUM')) fqtvTierCode = 'n3';
            else if (tierToken.includes('GOLD')) fqtvTierCode = 'n2';
            else if (tierToken.includes('SILVER')) fqtvTierCode = 'n1';
            else if (tierToken === 'N0') { hasNoFqtv = true; fqtv = ''; }
            else if (tierToken === 'N1' || tierToken === 'N2' || tierToken === 'N3') fqtvTierCode = tierToken.toLowerCase();
          }
          break;
        }
      }
    }
    
    if (fqtv) break;
  }

  if (!fqtv && !hasNoFqtv) {
    for (let i = 0; i < parts.length - 2; i++) {
      if ((parts[i] === 'LX' || parts[i] === 'LH') && 
          /^\d+$/.test(parts[i + 1])) {
        fqtv = parts[i] + ' ' + parts[i + 1];
        break;
      }
    }
  }

  if (!hasNoFqtv && fqtv) {
    fqtv = fqtv.trim();
    
    if (fqtv) {
      const airlineCode = fqtv.substring(0, 2).toUpperCase();
      
      if (allPossibleAirlineCodes.includes(airlineCode)) {
        fqtv = fqtv.replace(/^([A-Z0-9]{2})\s+/, '$1-');
      }
    }
    
    if (fqtv && fqtvTierCode) {
      const flightAirlineCode = flightNo.slice(0, 2).toUpperCase();
      let fqtvAirlineCode = '';
      
      const fqtvUpper = fqtv.toUpperCase();
      
      const dashMatch = fqtvUpper.match(/^([A-Z0-9]{2})[- ]/);
      if (dashMatch) {
        fqtvAirlineCode = dashMatch[1];
      } else {
        fqtvAirlineCode = fqtvUpper.substring(0, 2);
      }
      
      let tierName;
      if (fqtvAirlineCode && flightAirlineCode && 
          fqtvAirlineCode.toUpperCase() === flightAirlineCode.toUpperCase()) {
        tierName = fqtvTierMappings.same[fqtvTierCode] || '';
      } else {
        tierName = fqtvTierMappings.different[fqtvTierCode] || '';
      }
      
      if (tierName) {
        const standardTierRegex = /\/(Sapphire|Emerald|Ruby|Platinum|Gold|Silver)$/i;
        if (!standardTierRegex.test(fqtv)) {
          fqtv = fqtv.replace(/\/\s*(Sapphire|Emerald|Ruby|Platinum|Gold|Silver|SAPPHIRE|EMERALD|RUBY|PLATINUM|GOLD|SILVER|G|S)\s*$/i, '');
          fqtv = fqtv.replace(/[Nn][123]\s*$/, '').trim();
          fqtv = `${fqtv}/${tierName}`;
        }
      }
    }
  }

  const lastTwo = code.slice(-2);
  if (!hasNoFqtv && (flightNo.startsWith('BA') || flightNo.startsWith('MH')) && fqtv) {
    if (lastTwo === 'Y1') {
      if (!fqtv.includes('/')) {
        fqtv += '/G';
      } else if (!fqtv.includes('/G')) {
        fqtv = fqtv.replace(/\/[^\/]+$/, '/G');
      }
    } else if (lastTwo === 'Y2') {
      if (!fqtv.includes('/')) {
        fqtv += '/S';
      } else if (!fqtv.includes('/S')) {
        fqtv = fqtv.replace(/\/[^\/]+$/, '/S');
      }
    } else if (flightNo.startsWith('OS')) {
      const lastIndex = parts.length - 1;
      const fourthLast = parts[lastIndex - 3] || '';
      const thirdLast = parts[lastIndex - 2] || '';
      const fourthLastToken = fourthLast.trim();
      const thirdLastToken = thirdLast.trim();
      
      if (fourthLastToken.length === 2 && thirdLastToken.length > 4) {
        if (!fqtv) {
          fqtv = (fourthLastToken + ' ' + thirdLastToken).trim();
        }
      }
    }
  }

  // SPECIAL HANDLING FOR SQ FLIGHTS
  if (flightNo.startsWith('SQ')) {
    seatNo = '';
    pnr = '';
  }

  nameInput.value = name;
  pnrInput.value = pnr;
  flightInput.value = flightNo;
  seatInput.value = seatNo;
  classInput.value = seatClass;
  fqtvInput.value = hasNoFqtv ? '' : (fqtv || '');
  serialInput.value = '';
  remarksInput.value = '';
  numPaxInput.value = 1;
}

// ----- Barcode Scanner Detection -----
function handleScannerInput() {
  if (isProcessing) return;
  
  const currentValue = codeInput.value;
  
  if (currentValue.length > lastValue.length + 5) {
    isScannerActive = true;
    scannerIndicator.classList.add('show');
    
    clearTimeout(scannerTimer);
    scannerTimer = setTimeout(() => {
      processScannerInput();
    }, 100);
  } 
  else if (currentValue !== lastValue) {
    if (isScannerActive) {
      isScannerActive = false;
      scannerIndicator.classList.remove('show');
    }
    
    clearTimeout(scannerTimer);
    scannerTimer = setTimeout(() => {
      processManualInput();
    }, 800);
  }
  
  lastValue = currentValue;
}

function processScannerInput() {
  if (isProcessing) return;
  isProcessing = true;
  
  scannerIndicator.classList.remove('show');
  isScannerActive = false;
  
  parseCode();
  const entry = {
    date: currentShiftDate,
    user: userDisplay.textContent,
    shift: currentShiftType,
    code: codeInput.value,
    name: nameInput.value,
    pnr: pnrInput.value,
    flight: flightInput.value,
    airline: airlineSelect.value,
    seat: seatInput.value,
    class: classInput.value,
    serial: serialInput.value,
    remarks: remarksInput.value,
    fqtv: fqtvInput.value,
    numPax: parseInt(numPaxInput.value) || 0, // FIXED: Use parseInt and allow 0
    approved: false
  };
  saveEntry(entry);
  
  setTimeout(() => {
    isProcessing = false;
  }, 1000);
}

function processManualInput() {
  if (isProcessing) return;
  isProcessing = true;
  
  parseCode();
  const entry = {
    date: currentShiftDate,
    user: userDisplay.textContent,
    shift: currentShiftType,
    code: codeInput.value,
    name: nameInput.value,
    pnr: pnrInput.value,
    flight: flightInput.value,
    airline: airlineSelect.value,
    seat: seatInput.value,
    class: classInput.value,
    serial: serialInput.value,
    remarks: remarksInput.value,
    fqtv: fqtvInput.value,
    numPax: parseInt(numPaxInput.value) || 0, // FIXED: Use parseInt and allow 0
    approved: false
  };
  saveEntry(entry);
  
  setTimeout(() => {
    isProcessing = false;
  }, 1000);
}

function handleFieldExit() {
  if (isProcessing) return;
  
  const code = codeInput.value.trim();
  if (code) {
    parseCode();
    if (nameInput.value && flightInput.value) {
      isProcessing = true;
      const entry = {
        date: currentShiftDate,
        user: userDisplay.textContent,
        shift: currentShiftType,
        code: codeInput.value,
        name: nameInput.value,
        pnr: pnrInput.value,
        flight: flightInput.value,
        airline: airlineSelect.value,
        seat: seatInput.value,
        class: classInput.value,
        serial: serialInput.value,
        remarks: remarksInput.value,
        fqtv: fqtvInput.value,
        numPax: parseInt(numPaxInput.value) || 0, // FIXED: Use parseInt and allow 0
        approved: false
      };
      saveEntry(entry);
      
      setTimeout(() => {
        isProcessing = false;
      }, 1000);
    }
  }
}

// ----- DELAY CHARGE FUNCTIONS -----

// ----- Calculate Delay Charge -----
function calculateDelayCharge(entryTime, exitTime, stdTime, numPax) {
  const [entryHour, entryMin] = entryTime.split(':').map(Number);
  const [exitHour, exitMin] = exitTime.split(':').map(Number);
  const [stdHour, stdMin] = stdTime.split(':').map(Number);
  
  const entryTotalMinutes = entryHour * 60 + entryMin;
  const exitTotalMinutes = exitHour * 60 + exitMin;
  const stdTotalMinutes = stdHour * 60 + stdMin;
  
  let totalStayMinutes = exitTotalMinutes - entryTotalMinutes;
  
  if (totalStayMinutes < 0) {
    totalStayMinutes += 24 * 60;
  }
  
  const totalStayHours = Math.floor(totalStayMinutes / 60);
  const remainingMinutes = totalStayMinutes % 60;
  
  let lateDepartureMinutes = 0;
  if (exitTotalMinutes > stdTotalMinutes) {
    lateDepartureMinutes = exitTotalMinutes - stdTotalMinutes;
  }
  
  let chargeableHours = 0;
  if (totalStayMinutes > FREE_HOURS * 60) {
    const exceedMinutes = totalStayMinutes - (FREE_HOURS * 60);
    chargeableHours = Math.floor(exceedMinutes / 60);
  }
  
  const totalCharge = 0;
  
  return {
    totalStayMinutes,
    totalStayHours,
    remainingMinutes,
    lateDepartureMinutes,
    chargeableHours,
    totalCharge,
    chargePerPax: 0
  };
}

// ----- Show Delay Charge Modal -----
function showDelayChargeModal() {
  if (!currentShiftType || currentShiftStatus !== 'open') {
    showAlert('No active shift or shift not open!', true);
    return;
  }
  
  delayFlightInput.value = '';
  entryTimeInput.value = '00:00';
  exitTimeInput.value = '00:00';
  stdTimeInput.value = '00:00';
  delayPaxInput.value = '1';
  delayCalcResult.style.display = 'none';
  
  const currentTime = getCurrentTime();
  entryTimeInput.value = currentTime;
  exitTimeInput.value = currentTime;
  
  delayChargeModal.classList.add('show');
  
  setTimeout(() => {
    delayFlightInput.focus();
  }, 100);
}

// ----- Calculate Delay Button Handler -----
function handleCalculateDelay() {
  const flightNo = delayFlightInput.value.trim();
  const entryTime = entryTimeInput.value;
  const exitTime = exitTimeInput.value;
  const stdTime = stdTimeInput.value;
  const numPax = parseInt(delayPaxInput.value) || 1;
  
  if (!flightNo) {
    showAlert('Please enter flight number', true);
    delayFlightInput.focus();
    return;
  }
  
  if (!entryTime || !exitTime || !stdTime) {
    showAlert('Please enter all time fields', true);
    return;
  }
  
  if (entryTime === '00:00' || exitTime === '00:00' || stdTime === '00:00') {
    showAlert('Please set proper time values', true);
    return;
  }
  
  const calculation = calculateDelayCharge(entryTime, exitTime, stdTime, numPax);
  
  delayCalcResult.style.display = 'block';
  
  if (calculation.chargeableHours > 0) {
    delayCalcDetails.innerHTML = `
      <p><strong>Flight:</strong> ${flightNo.toUpperCase()}</p>
      <p><strong>Total Stay:</strong> ${calculation.totalStayHours}h ${calculation.remainingMinutes}m</p>
      <p><strong>Free Hours:</strong> ${FREE_HOURS}h</p>
      <p><strong>Chargeable Hours:</strong> ${calculation.chargeableHours}h (complete hours only)</p>
      <p><strong>Number of Pax:</strong> ${numPax}</p>
      <p><strong>Remarks to be saved:</strong> <em>"Delay charges for ${numPax} pax for ${calculation.chargeableHours} hour(s)"</em></p>
      <p><strong>Total Charge:</strong> <span class="delay-amount">$${calculation.totalCharge.toFixed(2)}</span></p>
    `;
  } else {
    delayCalcDetails.innerHTML = `
      <p><strong>Flight:</strong> ${flightNo.toUpperCase()}</p>
      <p><strong>Total Stay:</strong> ${calculation.totalStayHours}h ${calculation.remainingMinutes}m</p>
      <p><strong>Free Hours:</strong> ${FREE_HOURS}h</p>
      <p><strong>Chargeable Hours:</strong> ${calculation.chargeableHours}h</p>
      <p><strong>Status:</strong> <span class="no-charge">No Charge - Within ${FREE_HOURS}h free period</span></p>
    `;
  }
}

// ----- Save Delay Charge Entry -----
async function saveDelayChargeEntry() {
  const flightNo = delayFlightInput.value.trim().toUpperCase();
  const entryTime = entryTimeInput.value;
  const exitTime = exitTimeInput.value;
  const stdTime = stdTimeInput.value;
  const numPax = parseInt(delayPaxInput.value) || 1;
  
  // Validate inputs
  if (!flightNo) {
    showAlert('Please enter flight number', true);
    delayFlightInput.focus();
    return;
  }
  
  if (!entryTime || !exitTime || !stdTime) {
    showAlert('Please enter all time fields', true);
    return;
  }
  
  if (entryTime === '00:00' || exitTime === '00:00' || stdTime === '00:00') {
    showAlert('Please set proper time values', true);
    return;
  }
  
  // Calculate delay charge
  const calculation = calculateDelayCharge(entryTime, exitTime, stdTime, numPax);
  
  // Generate remarks as requested: "Delay charges for X pax for Y hour(s)"
  let remarks = `Delay charges for ${numPax} pax for ${calculation.chargeableHours} hour(s)`;
  
  // Create delay charge entry with corrections:
  const delayEntry = {
    date: currentShiftDate,
    user: userDisplay.textContent,
    shift: currentShiftType,
    code: 'DELAY_CHARGE',
    name: 'DELAY CHARGE',
    pnr: 'DELAY',
    flight: flightNo, // JUST THE FLIGHT NUMBER, NO "DELAY" TEXT
    airline: flightNo.substring(0, 2),
    seat: '', // EMPTY SEAT
    class: 'J', // CLASS SET TO "J"
    serial: '', // EMPTY SERIAL
    remarks: remarks,
    fqtv: '',
    numPax: 0, // SET TO 0 AS REQUESTED - FIXED
    approved: false,
    isDelayCharge: true,
    delayDetails: {
      entryTime: entryTime,
      exitTime: exitTime,
      stdTime: stdTime,
      totalStayMinutes: calculation.totalStayMinutes,
      totalStayHours: calculation.totalStayHours,
      remainingMinutes: calculation.remainingMinutes,
      chargeableHours: calculation.chargeableHours,
      totalCharge: calculation.totalCharge,
      calculatedAt: getMaldivesDateTimeISO()
    }
  };
  
  // Save the entry
  let data = JSON.parse(localStorage.getItem('codesData')||'[]');
  data.push(delayEntry);
  localStorage.setItem('codesData', JSON.stringify(data));
  
  // Close modal
  delayChargeModal.classList.remove('show');
  
  // Show success message
  showAlert(`Delay charge entry saved for flight ${flightNo}`, false);
  
  // Render entries
  renderEntries();
  
  // Reset form
  delayFlightInput.value = '';
  entryTimeInput.value = '00:00';
  exitTimeInput.value = '00:00';
  stdTimeInput.value = '00:00';
  delayPaxInput.value = '1';
  delayCalcResult.style.display = 'none';
}

// ----- LOCAL STORAGE MANAGEMENT FUNCTIONS -----

// Show Local Storage Modal
function showLocalStorageModal() {
  loadStorageData();
  localStorageModal.classList.add('show');
}

// Load and display storage data
function loadStorageData() {
  const allKeys = Object.keys(localStorage);
  const storageStats = document.getElementById('storageStats');
  const storageTabs = document.getElementById('storageTabs');
  const allStoragePanel = document.getElementById('allStoragePanel');
  
  let totalSize = 0;
  allKeys.forEach(key => {
    const value = localStorage.getItem(key);
    totalSize += (key.length + value.length) * 2;
  });
  
  storageStats.innerHTML = `
    <div class="storage-stat-item">
      <div class="storage-stat-value">${allKeys.length}</div>
      <div class="storage-stat-label">Total Items</div>
    </div>
    <div class="storage-stat-item">
      <div class="storage-stat-value">${(totalSize / 1024).toFixed(2)} KB</div>
      <div class="storage-stat-label">Total Size</div>
    </div>
    <div class="storage-stat-item">
      <div class="storage-stat-value">${(localStorage.length / 5000 * 100).toFixed(1)}%</div>
      <div class="storage-stat-label">Capacity Used</div>
    </div>
  `;
  
  storageTabs.innerHTML = '';
  
  const allTab = document.createElement('button');
  allTab.className = 'storage-tab active';
  allTab.textContent = 'All Items';
  allTab.onclick = () => showStorageTab('all', allTab);
  storageTabs.appendChild(allTab);
  
  const categories = {
    'codesData': 'Pending Entries',
    'approvedLocalData': 'Approved Entries (Local)',
    'qrProcessedCodes': 'QR Processed Codes',
    'localQRData': 'Local QR Data',
    'approvedEntriesCache': 'Approved Cache',
    'currentShiftInfo': 'Shift Info',
    'loggedInUser': 'User Data'
  };
  
  Object.keys(categories).forEach(categoryKey => {
    if (localStorage.getItem(categoryKey)) {
      const tab = document.createElement('button');
      tab.className = 'storage-tab';
      tab.textContent = categories[categoryKey];
      tab.dataset.key = categoryKey;
      tab.onclick = () => showStorageTab(categoryKey, tab);
      storageTabs.appendChild(tab);
    }
  });
  
  const otherKeys = allKeys.filter(key => !Object.keys(categories).includes(key));
  if (otherKeys.length > 0) {
    const otherTab = document.createElement('button');
    otherTab.className = 'storage-tab';
    otherTab.textContent = `Other (${otherKeys.length})`;
    otherTab.dataset.key = 'other';
    otherTab.onclick = () => showStorageTab('other', otherTab);
    storageTabs.appendChild(otherTab);
  }
  
  displayStorageItems('all', allKeys, allStoragePanel);
  
  showStorageTab('all', allTab);
}

// Display storage items in a panel
function displayStorageItems(category, keys, panel) {
  panel.innerHTML = '';
  
  if (keys.length === 0) {
    panel.innerHTML = '<div class="empty-storage">No data found in this category</div>';
    return;
  }
  
  if (category === 'approvedLocalData') {
    displayApprovedEntries(panel);
    return;
  }
  
  keys.forEach(key => {
    try {
      const value = localStorage.getItem(key);
      const itemSize = (key.length + value.length) * 2;
      let parsedValue;
      let isJson = false;
      
      try {
        parsedValue = JSON.parse(value);
        isJson = true;
      } catch (e) {
        parsedValue = value;
      }
      
      const valueStr = isJson ? JSON.stringify(parsedValue, null, 2) : value;
      
      const itemDiv = document.createElement('div');
      itemDiv.className = 'storage-data-item';
      itemDiv.innerHTML = `
        <div class="storage-data-header">
          <span class="storage-key">${key}</span>
          <span class="storage-size">${(itemSize / 1024).toFixed(2)} KB</span>
        </div>
        <div class="storage-value">${isJson ? 'JSON Data - ' : ''}${valueStr.length > 500 ? valueStr.substring(0, 500) + '...' : valueStr}</div>
        <div style="margin-top: 8px; display: flex; gap: 5px;">
          ${isJson ? `<button class="view-json-btn" onclick="viewJson('${key}', ${JSON.stringify(parsedValue)})">View JSON</button>` : ''}
          <button class="action-btn" onclick="deleteStorageItem('${key}')" style="padding: 3px 8px; font-size: 11px;">
            <i class="fas fa-trash"></i> Delete
          </button>
          <button class="action-btn" onclick="copyStorageItem('${key}')" style="padding: 3px 8px; font-size: 11px;">
            <i class="fas fa-copy"></i> Copy
          </button>
        </div>
      `;
      
      panel.appendChild(itemDiv);
    } catch (error) {
      console.error(`Error processing key ${key}:`, error);
    }
  });
}

// Display approved entries in a table
function displayApprovedEntries(panel) {
  try {
    const approvedLocalData = JSON.parse(localStorage.getItem('approvedLocalData') || '[]');
    
    if (approvedLocalData.length === 0) {
      panel.innerHTML = '<div class="empty-storage">No approved entries found in local storage</div>';
      return;
    }
    
    const table = document.createElement('table');
    table.className = 'approved-entries-table';
    table.innerHTML = `
      <thead>
        <tr>
          <th>Name</th>
          <th>Flight</th>
          <th>Seat</th>
          <th>Class</th>
          <th>FQTV</th>
          <th>Pax</th>
          <th>Serial</th>
          <th>PNR</th>
          <th>Date</th>
          <th>Shift</th>
          <th>Synced</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        ${approvedLocalData.map((entry, index) => `
          <tr>
            <td>${escapeHtml(entry.name)}</td>
            <td>${escapeHtml(entry.flightNo)}</td>
            <td>${escapeHtml(entry.seatNo)}</td>
            <td>${escapeHtml(entry.class)}</td>
            <td>${escapeHtml(entry.fqtv || '')}</td>
            <td>${entry.numPax}</td>
            <td>${escapeHtml(entry.serial)}</td>
            <td>${escapeHtml(entry.pnr || '')}</td>
            <td>${formatDateForDisplay(entry.date)}</td>
            <td>${entry.shift}</td>
            <td>${entry.synced ? '<span style="color: var(--success);"><i class="fas fa-check-circle"></i> Yes</span>' : '<span style="color: var(--warning);"><i class="fas fa-clock"></i> Pending</span>'}</td>
            <td>
              <button class="action-btn" onclick="deleteApprovedEntry(${index})" style="padding: 3px 8px; font-size: 11px;">
                <i class="fas fa-trash"></i> Delete
              </button>
              ${!entry.synced ? `
                <button class="action-btn" onclick="syncApprovedEntry(${index})" style="padding: 3px 8px; font-size: 11px; background: var(--info);">
                  <i class="fas fa-sync-alt"></i> Sync Now
                </button>
              ` : ''}
            </td>
          </tr>
        `).join('')}
      </tbody>
    `;
    
    panel.appendChild(table);
    
  } catch (error) {
    console.error('Error displaying approved entries:', error);
    panel.innerHTML = `<div class="empty-storage">Error loading approved entries: ${error.message}</div>`;
  }
}

// Delete approved entry
function deleteApprovedEntry(index) {
  if (confirm('Are you sure you want to delete this approved entry from local storage?\n\nThis will remove it from the local storage but won\'t affect Firebase if already synced.')) {
    try {
      const approvedLocalData = JSON.parse(localStorage.getItem('approvedLocalData') || '[]');
      const deletedEntry = approvedLocalData.splice(index, 1)[0];
      localStorage.setItem('approvedLocalData', JSON.stringify(approvedLocalData));
      
      // Also remove from cache
      if (deletedEntry.flightNo && deletedEntry.seatNo && deletedEntry.date) {
        const flightUpper = deletedEntry.flightNo.toUpperCase();
        const seatUpper = deletedEntry.seatNo.toUpperCase();
        const seatKey = `${deletedEntry.date}_${flightUpper}_${seatUpper}`;
        delete approvedEntriesCache[seatKey];
        localStorage.setItem('approvedEntriesCache', JSON.stringify(approvedEntriesCache));
      }
      
      showAlert('Approved entry deleted from local storage', false);
      loadStorageData();
      
    } catch (error) {
      console.error('Error deleting approved entry:', error);
      showAlert('Error deleting approved entry: ' + error.message, true);
    }
  }
}

// Sync approved entry manually
function syncApprovedEntry(index) {
  try {
    const approvedLocalData = JSON.parse(localStorage.getItem('approvedLocalData') || '[]');
    const entry = approvedLocalData[index];
    
    if (!entry) {
      showAlert('Entry not found', true);
      return;
    }
    
    if (entry.synced) {
      showAlert('Entry is already synced', true);
      return;
    }
    
    if (!window.passengerDb) {
      showAlert('Firebase connection not available', true);
      return;
    }
    
    showAlert('Syncing entry to Firebase...', false, false, true);
    
    // Remove local-only fields before saving to Firebase
    const firebaseEntry = { ...entry };
    delete firebaseEntry.synced;
    delete firebaseEntry.syncedAt;
    delete firebaseEntry.localId;
    delete firebaseEntry.originalEntry;
    
    window.passengerDb.collection('passengers').doc(entry.docName).set(firebaseEntry)
      .then(() => {
        // Mark as synced in localStorage
        entry.synced = true;
        entry.syncedAt = getMaldivesDateTimeISO();
        localStorage.setItem('approvedLocalData', JSON.stringify(approvedLocalData));
        
        showAlert('Entry synced successfully to Firebase!', false);
        loadStorageData();
      })
      .catch(error => {
        console.error('Error syncing entry:', error);
        showAlert('Error syncing to Firebase: ' + error.message, true);
      });
    
  } catch (error) {
    console.error('Error syncing approved entry:', error);
    showAlert('Error syncing entry: ' + error.message, true);
  }
}

// Show specific storage tab
function showStorageTab(category, tabElement) {
  document.querySelectorAll('.storage-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  tabElement.classList.add('active');
  
  let panel = document.getElementById(`${category}Panel`);
  if (!panel) {
    panel = document.createElement('div');
    panel.id = `${category}Panel`;
    panel.className = 'storage-panel';
    document.querySelector('.storage-tab-content').appendChild(panel);
  }
  
  document.querySelectorAll('.storage-panel').forEach(p => {
    p.classList.remove('active');
  });
  
  panel.classList.add('active');
  
  const allKeys = Object.keys(localStorage);
  let filteredKeys = [];
  
  if (category === 'all') {
    filteredKeys = allKeys;
  } else if (category === 'other') {
    const categories = [
      'codesData', 'approvedLocalData', 'qrProcessedCodes', 
      'localQRData', 'approvedEntriesCache', 'currentShiftInfo', 
      'loggedInUser'
    ];
    filteredKeys = allKeys.filter(key => !categories.includes(key));
  } else {
    filteredKeys = allKeys.filter(key => key === category);
  }
  
  displayStorageItems(category, filteredKeys, panel);
}

// View JSON in modal
function viewJson(key, data) {
  jsonViewerTitle.textContent = `JSON Data: ${key}`;
  jsonViewerBody.textContent = JSON.stringify(data, null, 2);
  
  jsonViewerModal.classList.add('show');
}

// Copy storage item to clipboard
function copyStorageItem(key) {
  try {
    const value = localStorage.getItem(key);
    navigator.clipboard.writeText(value).then(() => {
      showAlert(`Copied "${key}" to clipboard`, false, false, true);
    }).catch(err => {
      showAlert(`Failed to copy: ${err}`, true);
    });
  } catch (error) {
    showAlert(`Error copying: ${error.message}`, true);
  }
}

// Delete a specific storage item
function deleteStorageItem(key) {
  if (confirm(`Are you sure you want to delete "${key}" from local storage?\n\nThis action cannot be undone.`)) {
    localStorage.removeItem(key);
    showAlert(`Deleted "${key}" from local storage`, false);
    loadStorageData();
  }
}

// Clear all local storage
function clearAllLocalStorage() {
  if (confirm('âš ï¸ WARNING: Are you absolutely sure you want to clear ALL local storage?\n\nThis will delete:\nâ€¢ All pending passenger entries\nâ€¢ All approved entries (including unsynced)\nâ€¢ QR processed codes\nâ€¢ Shift information\nâ€¢ User session\n\nThis action cannot be undone!')) {
    localStorage.clear();
    showAlert('All local storage cleared successfully', false);
    
    window.location.reload();
  }
}

// ----- Event Listeners -----
manualSaveBtn.addEventListener('click', async function() {
  if (isProcessing) return;
  isProcessing = true;
  
  parseCode();
  const entry = {
    date: currentShiftDate,
    user: userDisplay.textContent,
    shift: currentShiftType,
    code: codeInput.value,
    name: nameInput.value,
    pnr: pnrInput.value,
    flight: flightInput.value,
    airline: airlineSelect.value,
    seat: seatInput.value,
    class: classInput.value,
    serial: serialInput.value,
    remarks: remarksInput.value,
    fqtv: fqtvInput.value,
    numPax: parseInt(numPaxInput.value) || 0, // FIXED: Use parseInt and allow 0
    approved: false
  };
  
  await saveEntry(entry);
  
  setTimeout(() => {
    isProcessing = false;
  }, 1000);
});

refreshShiftBtn.addEventListener('click', refreshShiftData);

// Delay charge event listeners
delayChargeBtn.addEventListener('click', showDelayChargeModal);
closeModalBtn.addEventListener('click', () => {
  delayChargeModal.classList.remove('show');
});

calculateDelayBtn.addEventListener('click', handleCalculateDelay);
saveDelayBtn.addEventListener('click', saveDelayChargeEntry);

// Local storage event listeners
storageManagerBtn.addEventListener('click', showLocalStorageModal);
closeStorageModalBtn.addEventListener('click', () => {
  localStorageModal.classList.remove('show');
});

refreshStorageBtn.addEventListener('click', loadStorageData);
clearAllStorageBtn.addEventListener('click', clearAllLocalStorage);

closeJsonViewerBtn.addEventListener('click', () => {
  jsonViewerModal.classList.remove('show');
});

// Close modals when clicking outside
delayChargeModal.addEventListener('click', (e) => {
  if (e.target === delayChargeModal) {
    delayChargeModal.classList.remove('show');
  }
});

localStorageModal.addEventListener('click', (e) => {
  if (e.target === localStorageModal) {
    localStorageModal.classList.remove('show');
  }
});

jsonViewerModal.addEventListener('click', (e) => {
  if (e.target === jsonViewerModal) {
    jsonViewerModal.classList.remove('show');
  }
});

numericKeyboardModal.addEventListener('click', (e) => {
  if (e.target === numericKeyboardModal) {
    closeNumericKeyboard();
  }
});

// ----- Initialize System -----
document.addEventListener('DOMContentLoaded', async function() {
  console.log("ðŸš€ Initializing unified passenger approval system...");
  console.log("ðŸ“‹ System Configuration:");
  console.log("- Card System: cardsystem-21773");
  console.log("- QR System: qrcards-2378e");
  console.log("- Delay Charge System: Enabled");
  console.log("- Storage Manager: Enabled");
  console.log("- Numeric Keyboard for SQ Flights: Enabled");
  console.log("- FIXED: N1â†’Silver, N2â†’Gold, N3â†’Platinum for QR saves");
  console.log("- FIXED: Pax = 0 now saves as 0 (not 1)");
  console.log("- FIXED: No QR/DELAY badges added to flight numbers");
  
  clearOldProcessedCodes();
  
  loadApprovedEntriesCache();
  
  // Initialize numeric keyboard
  initializeNumericKeyboard();
  
  setTimeout(() => {
    initializeQRFirebase();
    loadQREntries();
  }, 1000);
  
  const loadedFromCache = loadCurrentShiftFromLocalStorage();
  
  if (!loadedFromCache) {
    console.log("ðŸ”„ No fresh cache, fetching shift data from server");
    showNoShiftMessage();
    
    setTimeout(() => {
      fetchCurrentOpenShift();
    }, 1000);
  } else {
    console.log("âœ… Shift loaded from cache");
  }
  
  codeInput.addEventListener('input', handleScannerInput);
  
  codeInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      clearTimeout(scannerTimer);
      if (isScannerActive) {
        processScannerInput();
      } else {
        processManualInput();
      }
    }
  });
  
  codeInput.addEventListener('blur', handleFieldExit);
  
  renderEntries();
  
  setInterval(() => {
    if (currentShiftStatus === 'open') {
      console.log("ðŸ”„ Periodic shift check");
      fetchCurrentOpenShift();
    }
  }, 5 * 60 * 1000);
  
  setInterval(() => {
    loadQREntries();
  }, 2 * 60 * 1000);
  
  // Background sync of approved entries
  setInterval(() => {
    if (window.passengerDb && backgroundSaveQueue.length === 0) {
      processBackgroundSaveQueue();
    }
  }, 30 * 1000);
  
  window.addEventListener('beforeunload', () => {
    console.log("ðŸ§¹ Cleaning up before unload");
  });
});

// ----- Debug Functions -----
window.debugSystemsInfo = function() {
  console.log("=== DEBUG SYSTEMS INFO ===");
  console.log("Card System Project:", window.passengerDb ? "cardsystem-21773" : "Not initialized");
  console.log("QR System Project:", qrFirebaseConfig ? qrFirebaseConfig.projectId : "Not configured");
  console.log("QR Firebase Initialized:", qrFirebaseInitialized);
  console.log("QR System Available:", qrSystemAvailable);
  console.log("QR Entries Count:", qrEntries.length);
  console.log("QR Processed Codes:", qrEntriesProcessed.length);
  
  console.log("\n=== LOCAL STORAGE INFO ===");
  console.log("Pending Entries:", JSON.parse(localStorage.getItem('codesData') || '[]').length);
  console.log("Approved Entries (Local):", JSON.parse(localStorage.getItem('approvedLocalData') || '[]').length);
  console.log("Approved Cache Entries:", Object.keys(approvedEntriesCache).length);
  
  console.log("\n=== SHIFT INFO ===");
  console.log("Current Shift Type:", currentShiftType);
  console.log("Current Shift Date:", currentShiftDate);
  console.log("Current Shift Status:", currentShiftStatus);
  
  alert(`System Information:\n\n` +
        `Card System: ${window.passengerDb ? 'âœ… Initialized (cardsystem-21773)' : 'âŒ Not initialized'}\n` +
        `QR System: ${qrFirebaseInitialized ? 'âœ… Initialized (' + qrFirebaseConfig.projectId + ')' : 'âŒ Not initialized'}\n` +
        `QR Available: ${qrSystemAvailable ? 'âœ…' : 'âŒ'}\n` +
        `QR Entries: ${qrEntries.length}\n` +
        `QR Processed: ${qrEntriesProcessed.length}\n\n` +
        `Pending Entries: ${JSON.parse(localStorage.getItem('codesData') || '[]').length}\n` +
        `Approved (Local): ${JSON.parse(localStorage.getItem('approvedLocalData') || '[]').length}\n\n` +
        `Shift: ${currentShiftType || 'None'}\n` +
        `Date: ${currentShiftDate || '-'}\n` +
        `Status: ${currentShiftStatus}`);
};

// ----- QR System Helper Functions -----
window.openQRReport = function() {
  window.open('qrReport.html', '_blank');
};

// ----- Test QR System Connection -----
window.testQRConnection = async function() {
  if (!qrFirebaseInitialized || !qrSystemAvailable) {
    alert("QR system not initialized");
    return;
  }
  
  try {
    showAlert("Testing QR system connection...", false, false, true);
    
    const testData = {
      test: true,
      timestamp: getMaldivesDateTimeISO(),
      message: "Connection test from unified system"
    };
    
    const docRef = await qrDb.collection('testConnections').add(testData);
    alert(`âœ… QR System Connection Successful!\n\nProject: ${qrFirebaseConfig.projectId}\nTest Document ID: ${docRef.id}\n\nDocument saved successfully.`);
    
    await docRef.delete();
    
  } catch (error) {
    alert(`âŒ QR System Connection Failed!\n\nError: ${error.message}\n\nProject: ${qrFirebaseConfig.projectId}\n\nCheck:\n1. Firebase Firestore Rules\n2. Internet Connection\n3. Project Configuration`);
    console.error("Connection test error:", error);
  }
};
</script>
</body>
</html>
