<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Unified Code Parser & Passenger Approval</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --gold: #D4AF37;
    --gold-light: #F5E8B8;
    --gold-dark: #B8860B;
    --gold-darker: #8B6914;
    --white: #FFFFFF;
    --gray-light: #F8F8F8;
    --gray: #E5E5E5;
    --gray-dark: #666666;
    --success: #4CAF50;
    --error: #f44336;
    --warning: #ff9800;
    --info: #2196F3;
    --shift-blue: #4b6cb7;
    --shift-blue-dark: #182848;
    --qr-green: #27ae60;
    --qr-green-dark: #219653;
  }
  
  * {
    box-sizing: border-box;
  }
  
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    padding: 20px; 
    background: var(--white);
    margin: 0;
    color: #333;
    background-color: #f9f9f9;
  }
  
  .container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    max-width: 1600px;
    margin: 0 auto;
  }
  
  .entry-section {
    flex: 1;
    min-width: 280px;
    max-width: 350px;
    background: var(--white);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.08);
    border: 1px solid var(--gold);
    position: relative;
    overflow: hidden;
  }
  
  .entry-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, var(--gold), var(--gold-dark));
  }
  
  .entries-section {
    flex: 4;
    min-width: 900px;
    background: var(--white);
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.08);
    border: 1px solid var(--gold);
    overflow-x: auto;
    position: relative;
  }
  
  .entries-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, var(--gold), var(--gold-dark));
  }
  
  h2, h3 {
    margin-top: 0;
    color: var(--gold-darker);
    padding-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
  }
  
  h2 i, h3 i {
    color: var(--gold);
  }
  
  .form-group {
    margin-bottom: 15px;
  }
  
  label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    font-size: 14px;
    color: var(--gold-darker);
  }
  
  .input-with-icon {
    position: relative;
  }
  
  .input-with-icon i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gold);
    z-index: 1;
  }
  
  input, select, textarea { 
    width: 100%; 
    padding: 10px 10px 10px 35px;
    border: 1px solid var(--gold); 
    border-radius: 6px; 
    font-size: 14px; 
    box-sizing: border-box;
    background: var(--white);
    transition: all 0.3s ease;
  }
  
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--gold-dark);
    box-shadow: 0 0 0 3px var(--gold-light);
  }
  
  textarea {
    resize: vertical;
    min-height: 60px;
    padding-left: 35px;
  }
  
  table { 
    width: 100%; 
    border-collapse: collapse; 
    margin-top: 10px;
    font-size: 13px;
    border: 1px solid var(--gold);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  
  th, td { 
    border: 1px solid var(--gold); 
    padding: 10px; 
    text-align: left; 
    white-space: nowrap;
  }
  
  th {
    background-color: var(--gold-light);
    font-weight: bold;
    color: var(--gold-darker);
    position: sticky;
    top: 0;
  }
  
  tr:nth-child(even) {
    background-color: var(--gray-light);
  }
  
  tr:hover {
    background-color: rgba(212, 175, 55, 0.1);
  }
  
  button.action-btn { 
    width: auto; 
    margin: 0 2px; 
    padding: 8px 14px; 
    font-size: 12px; 
    cursor: pointer; 
    background: var(--gold);
    color: white;
    border: none;
    border-radius: 4px;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-weight: 500;
  }
  
  button.action-btn:hover {
    background: var(--gold-dark);
    transform: translateY(-2px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  }
  
  button.action-btn:disabled {
    opacity: 0.6;
    pointer-events: none;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
  
  .button-group {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }
  
  .button-group button {
    flex: 1;
    padding: 12px;
    font-weight: 600;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    border-radius: 6px;
    font-size: 14px;
  }
  
  #manualSaveBtn {
    background: var(--gold);
    color: white;
    box-shadow: 0 3px 8px rgba(212, 175, 55, 0.3);
  }
  
  #manualSaveBtn:hover {
    background: var(--gold-dark);
    box-shadow: 0 5px 12px rgba(212, 175, 55, 0.4);
  }
  
  .status-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    padding: 10px;
    background: var(--gold-light);
    border-radius: 6px;
    border-left: 4px solid var(--gold);
  }
  
  .status-indicator i {
    color: var(--gold-dark);
  }
  
  @media (max-width: 1200px) {
    .container {
      flex-direction: column;
    }
    
    .entry-section, .entries-section {
      min-width: 100%;
      max-width: 100%;
    }
  }
  
  .gold-line {
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
    margin: 15px 0;
  }
  
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  
  .entries-count {
    background: var(--gold);
    color: white;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  
  .user-shift-container {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
    justify-content: flex-start;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .user-shift-field {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
  }
  
  .user-shift-field label {
    font-size: 14px;
    margin-bottom: 0;
    color: var(--gold-darker);
    font-weight: 600;
  }
  
  .user-shift-field span {
    background: var(--gold-light);
    padding: 8px 14px;
    border-radius: 6px;
    border: 1px solid var(--gold);
    min-width: 120px;
    display: inline-block;
    font-weight: 500;
    text-align: center;
  }
  
  .clear-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--success);
    color: white;
    padding: 12px 24px;
    border-radius: 6px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 1000;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s ease;
  }
  
  .clear-notification.show {
    opacity: 1;
    transform: translateY(0);
  }
  
  .shift-status {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    padding: 10px;
    background: var(--gray-light);
    border-radius: 6px;
    border-left: 4px solid var(--gold);
  }
  
  .status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--success);
  }
  
  .status-dot.inactive {
    background: var(--error);
  }
  
  .disabled {
    opacity: 0.6;
    pointer-events: none;
  }
  
  .float-nav {
    position: fixed;
    bottom: 30px;
    right: 30px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    z-index: 1000;
  }
  
  .float-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--gold);
    color: white;
    border: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .float-btn:hover {
    background: var(--gold-dark);
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  }
  
  .float-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.1);
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .float-btn:hover::after {
    opacity: 1;
  }
  
  .float-tooltip {
    position: absolute;
    right: 70px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    white-space: nowrap;
    opacity: 0;
    transform: translateX(10px);
    transition: all 0.3s ease;
    pointer-events: none;
  }
  
  .float-btn:hover .float-tooltip {
    opacity: 1;
    transform: translateX(0);
  }
  
  @media (max-width: 768px) {
    .float-nav {
      bottom: 20px;
      right: 20px;
    }
    
    .float-btn {
      width: 50px;
      height: 50px;
      font-size: 18px;
    }
    
    .float-tooltip {
      font-size: 12px;
      padding: 6px 10px;
    }
  }

  .scanner-indicator {
    display: none;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    font-size: 12px;
    color: var(--gold-dark);
  }
  
  .scanner-indicator.show {
    display: flex;
  }
  
  .scanner-dots {
    display: flex;
    gap: 3px;
  }
  
  .scanner-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--gold);
    animation: scanning 0.8s infinite ease-in-out;
  }
  
  .scanner-dot:nth-child(1) { animation-delay: -0.32s; }
  .scanner-dot:nth-child(2) { animation-delay: -0.16s; }
  
  @keyframes scanning {
    0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
  }
  
  .alert-notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-20px);
    background: var(--success);
    color: white;
    padding: 12px 24px;
    border-radius: 6px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 1000;
    opacity: 0;
    transition: all 0.3s ease;
  }
  
  .alert-notification.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
  
  .alert-notification.error {
    background: var(--error);
  }
  
  .alert-notification.warning {
    background: var(--warning);
  }
  
  .alert-notification.info {
    background: var(--info);
  }
  
  .spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .card-header {
    background: linear-gradient(135deg, var(--gold-light), var(--gold));
    padding: 15px 20px;
    margin: -20px -20px 15px -20px;
    border-radius: 10px 10px 0 0;
    color: var(--gold-darker);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .fqtv-required {
    background-color: rgba(255, 152, 0, 0.1) !important;
    border-left: 3px solid var(--warning) !important;
  }
  
  .fqtv-warning {
    color: var(--warning);
    font-weight: bold;
    font-style: italic;
  }
  
  .flight-closed {
    background-color: rgba(244, 67, 54, 0.1) !important;
    border-left: 3px solid var(--error) !important;
  }
  
  .flight-closed td {
    opacity: 0.8;
  }
  
  .flight-status-closed {
    color: var(--error);
    font-weight: bold;
    font-size: 0.9em;
    margin-left: 5px;
  }
  
  .flight-closed .action-btn:first-child {
    background: var(--gray) !important;
    color: var(--gray-dark) !important;
    cursor: not-allowed;
    opacity: 0.6;
  }
  
  .flight-closed .action-btn:first-child:hover {
    transform: none !important;
    box-shadow: none !important;
  }
  
  .entry-fields-container {
    margin-top: 10px;
  }
  
  .simple-field-group {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
  }
  
  .simple-field-group .form-group {
    flex: 1;
    margin-bottom: 0;
  }
  
  .entry-card-title {
    text-align: center;
    margin-bottom: 20px;
    color: var(--gold-darker);
    font-size: 18px;
    font-weight: 600;
  }
  
  .no-shift-message {
    text-align: center;
    padding: 10px;
    color: #666;
    font-size: 13px;
  }

  .shift-refresh-btn {
    background: var(--shift-blue);
    color: white;
    border: none;
    border-radius: 5px;
    padding: 8px 16px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
  }
  
  .shift-refresh-btn:hover {
    background: var(--shift-blue-dark);
    transform: translateY(-1px);
  }
  
  .shift-refresh-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }
  
  /* QR Processing Indicator */
  .qr-processing-indicator {
    display: none;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    font-size: 12px;
    color: var(--qr-green);
    padding: 5px 10px;
    background: rgba(39, 174, 96, 0.1);
    border-radius: 4px;
    border-left: 3px solid var(--qr-green);
  }
  
  .qr-processing-indicator.show {
    display: flex;
  }
  
  .qr-processing-indicator i {
    color: var(--qr-green);
  }
  
  .qr-success-badge {
    background: var(--qr-green);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: bold;
    margin-left: 5px;
  }
  
  .dual-save-btn {
    background: linear-gradient(135deg, var(--gold), var(--qr-green));
    color: white;
  }
  
  .dual-save-btn:hover {
    background: linear-gradient(135deg, var(--gold-dark), var(--qr-green-dark));
  }
  
  @media (max-width: 768px) {
    .user-shift-container {
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
    
    .user-shift-field {
      width: 100%;
      justify-content: space-between;
    }
    
    .user-shift-field span {
      min-width: 150px;
      text-align: right;
    }
  }
</style>
</head>
<body>

<div class="clear-notification" id="clearNotification">
  <i class="fas fa-check-circle"></i>
  <span>Fields cleared for next entry</span>
</div>

<div class="alert-notification" id="alertNotification">
  <i class="fas fa-check-circle"></i>
  <span id="alertMessage">Operation completed successfully</span>
</div>

<div class="float-nav">
  <button id="refreshShiftBtn" class="float-btn shift-refresh-float">
    <i class="fas fa-sync-alt"></i>
    <span class="float-tooltip">Refresh Shift</span>
  </button>
  <a href="dash.html" class="float-btn">
    <i class="fas fa-home"></i>
    <span class="float-tooltip">Home Dashboard</span>
  </a>
  <a href="updateCard.html" class="float-btn">
    <i class="fas fa-chart-bar"></i>
    <span class="float-tooltip">Reports</span>
  </a>
  <a href="qrReport.html" class="float-btn" style="background: var(--qr-green);">
    <i class="fas fa-qrcode"></i>
    <span class="float-tooltip">QR Reports</span>
  </a>
</div>

<div class="container">
  <div class="entry-section" id="passengerEntryCard">
    <div class="entry-card-title">
      <i class="fas fa-user-plus"></i> Enter Passenger Details
    </div>
    
    <div class="form-group">
      <label for="codeInput"><i class="fas fa-barcode"></i> Scan Barcode</label>
      <div class="input-with-icon">
        <i class="fas fa-qrcode"></i>
        <input id="codeInput" placeholder="Scan or paste barcode" autocomplete="off" autofocus>
      </div>
      <div class="scanner-indicator" id="scannerIndicator">
        <div class="scanner-dots">
          <div class="scanner-dot"></div>
          <div class="scanner-dot"></div>
          <div class="scanner-dot"></div>
        </div>
        <span>Processing barcode...</span>
      </div>
      <div class="qr-processing-indicator" id="qrProcessingIndicator">
        <i class="fas fa-sync-alt fa-spin"></i>
        <span>Processing QR data...</span>
      </div>
    </div>
    
    <div class="gold-line"></div>
    
    <div class="entry-fields-container">
      <div class="simple-field-group">
        <div class="form-group">
          <label for="nameInput"><i class="fas fa-user"></i> Name</label>
          <div class="input-with-icon">
            <i class="fas fa-signature"></i>
            <input id="nameInput" placeholder="Passenger name">
          </div>
        </div>
        
        <div class="form-group">
          <label for="flightInput"><i class="fas fa-plane"></i> Flight</label>
          <div class="input-with-icon">
            <i class="fas fa-plane-departure"></i>
            <input id="flightInput" placeholder="Flight number">
          </div>
        </div>
      </div>
      
      <div class="simple-field-group">
        <div class="form-group">
          <label for="pnrInput"><i class="fas fa-ticket-alt"></i> PNR</label>
          <div class="input-with-icon">
            <i class="fas fa-receipt"></i>
            <input id="pnrInput" placeholder="PNR code">
          </div>
        </div>
        
        <div class="form-group">
          <label for="seatInput"><i class="fas fa-chair"></i> Seat</label>
          <div class="input-with-icon">
            <i class="fas fa-couch"></i>
            <input id="seatInput" placeholder="Seat number">
          </div>
        </div>
      </div>
      
      <div class="simple-field-group">
        <div class="form-group">
          <label for="airlineSelect"><i class="fas fa-building"></i> Airline</label>
          <div class="input-with-icon">
            <i class="fas fa-warehouse"></i>
            <select id="airlineSelect"><option value="">Select Airline</option></select>
          </div>
        </div>
        
        <div class="form-group">
          <label for="classInput"><i class="fas fa-star"></i> Class</label>
          <div class="input-with-icon">
            <i class="fas fa-star-half-alt"></i>
            <input id="classInput" placeholder="Class" readonly>
          </div>
        </div>
      </div>
      
      <div class="simple-field-group">
        <div class="form-group">
          <label for="fqtvInput"><i class="fas fa-id-card"></i> FQTV</label>
          <div class="input-with-icon">
            <i class="fas fa-address-card"></i>
            <input id="fqtvInput" placeholder="FQTV" readonly>
          </div>
        </div>
        
        <div class="form-group">
          <label for="numPaxInput"><i class="fas fa-users"></i> Pax</label>
          <div class="input-with-icon">
            <i class="fas fa-user-friends"></i>
            <input id="numPaxInput" placeholder="No of Pax" type="number" value="1" min="1">
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="serialInput"><i class="fas fa-hashtag"></i> Serial No</label>
        <div class="input-with-icon">
          <i class="fas fa-list-ol"></i>
          <input id="serialInput" placeholder="Serial number">
        </div>
      </div>
      
      <div class="form-group">
        <label for="remarksInput"><i class="fas fa-sticky-note"></i> Remarks</label>
        <div class="input-with-icon">
          <i class="fas fa-comment-alt"></i>
          <textarea id="remarksInput" placeholder="Additional remarks"></textarea>
        </div>
      </div>
    </div>
    
    <div class="button-group">
      <button id="manualSaveBtn" class="dual-save-btn">
        <i class="fas fa-save"></i> Save Entry (All Systems)
      </button>
    </div>
    
    <div id="qrStatus" style="font-size: 12px; margin-top: 10px; text-align: center;"></div>
  </div>
  
  <div class="entries-section">
    <div class="section-header">
      <h3><i class="fas fa-list-alt"></i> Saved Entries</h3>
      <div class="entries-count" id="entriesCount">0 entries</div>
    </div>
    
    <div class="user-shift-container">
      <div class="user-shift-field">
        <label>User:</label>
        <span id="userDisplay">Loading...</span>
      </div>
      <div class="user-shift-field">
        <label>Current Shift:</label>
        <span id="shiftDisplay">Loading...</span>
      </div>
      <div class="user-shift-field">
        <label>Shift Date:</label>
        <span id="dateDisplay">-</span>
      </div>
      <div class="user-shift-field">
        <label>QR Entries:</label>
        <span id="qrEntriesCount">0</span>
      </div>
    </div>
    
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Flight</th>
          <th>Seat</th>
          <th>Class</th>
          <th>FQTV</th>
          <th>Pax</th>
          <th>Serial</th>
          <th>Remarks</th>
          <th>PNR</th>
          <th>Date</th>
          <th>Shift</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="entriesList"></tbody>
    </table>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="./firebackup.js"></script>
<script src="./fireC1.js"></script>
<!-- Shift System Firebase Configuration -->
<script src="./fireshift.js"></script>
<!-- QR System Firebase Configuration - MODIFIED APPROACH -->


<script>
// ----- Airlines dropdown -----
const airlines = {
  'EK':'Emirates','FZ':'Flydubai','BA':'British Airways','EY':'Etihad',
  'MH':'Malaysia Airlines','AI':'Air India','AZ':'Alitalia','VS':'Virgin Atlantic',
  'PG':'Bangkok Airways','GF':'Gulf Air','Q2':'Malindivian','UL':'Srilankan Airlines',
  'AK':'Air Asia','SQ':'Singapore Airlines','6E':'Indigo','OS':'Austrian Airlines',
  '8D':'Fits Air','SU':'Aeroflot','OD':'Batik Air','TK':'Turkish Airline',
  'G9':'Air Arabia','SV':'Saudia','MU':'China Eastern Airlines','BS':'US-Bangla Airlines',
  '3U':'Sichuan Airlines','A1': 'Avia Maldives', 'DR': 'DER Turistic Service AG', 'HP':'Hotel Plan', 'HU':'Humming Bird',
  'KU':'Kouni UK', 'NT' : 'Nanto Tours','MT':'Maldives Travel Factory', 'WI':'Wako International', 'KC':'Air Astana','HIS':'Japan HIS Tours',
  'JD':'Capital Airlines', 'J2':'Azerbaijan Airlines', 'VO':'Voyages Maldives', 'WK':'Edelweiss','DE':'Condor','NO':'Neos','4Y':'Discover Airlines',
  // Add more airlines for FQTV detection
  'JL':'Japan Airlines', 'QF':'Qantas Airways', 'CX':'Cathay Pacific', 'AA':'American Airlines',
  'LA':'LATAM Airlines', 'AY':'Finnair', 'IB':'Iberia', 'QR':'Qatar Airways',
  // Added for better FQTV detection
  'LX':'Swiss International Air Lines', 'LH':'Lufthansa', 'AC':'Air Canada', 'NH':'All Nippon Airways',
  'BR':'EVA Air', 'CI':'China Airlines', 'NZ':'Air New Zealand', 'VA':'Virgin Australia',
  'AF':'Air France', 'KL':'KLM', 'DL':'Delta Air Lines', 'UA':'United Airlines',
  'B6':'JetBlue', 'WN':'Southwest Airlines', 'WS':'WestJet', 'AS':'Alaska Airlines',
  'F9':'Frontier Airlines', 'G4':'Allegiant Air', 'NK':'Spirit Airlines', 'SY':'Sun Country Airlines',
  '9W':'Jet Airways', 'ET':'Ethiopian Airlines', 'KE':'Korean Air', 'OZ':'Asiana Airlines',
  'PR':'Philippine Airlines', 'TG':'Thai Airways'
};

// ----- FQTV Tier Level Mappings -----
const fqtvTierMappings = {
  'same': {
    'n3': 'Platinum',
    'n2': 'Gold',
    'n1': 'Silver'
  },
  'different': {
    'n3': 'Emerald',
    'n2': 'Sapphire',
    'n1': 'Ruby'
  }
};

// ----- Initialize Airline Dropdown -----
const airlineSelect = document.getElementById('airlineSelect');
for(let iata in airlines){
  const opt = document.createElement('option');
  opt.value = iata;
  opt.textContent = airlines[iata];
  airlineSelect.appendChild(opt);
}

// ----- Elements -----
const codeInput = document.getElementById('codeInput');
const nameInput = document.getElementById('nameInput');
const pnrInput = document.getElementById('pnrInput');
const flightInput = document.getElementById('flightInput');
const seatInput = document.getElementById('seatInput');
const classInput = document.getElementById('classInput');
const fqtvInput = document.getElementById('fqtvInput');
const serialInput = document.getElementById('serialInput');
const remarksInput = document.getElementById('remarksInput');
const numPaxInput = document.getElementById('numPaxInput');
const userDisplay = document.getElementById('userDisplay');
const shiftDisplay = document.getElementById('shiftDisplay');
const dateDisplay = document.getElementById('dateDisplay');
const entriesList = document.getElementById('entriesList');
const manualSaveBtn = document.getElementById('manualSaveBtn');
const entriesCount = document.getElementById('entriesCount');
const clearNotification = document.getElementById('clearNotification');
const alertNotification = document.getElementById('alertNotification');
const alertMessage = document.getElementById('alertMessage');
const passengerEntryCard = document.getElementById('passengerEntryCard');
const scannerIndicator = document.getElementById('scannerIndicator');
const refreshShiftBtn = document.getElementById('refreshShiftBtn');
const qrProcessingIndicator = document.getElementById('qrProcessingIndicator');
const qrStatus = document.getElementById('qrStatus');
const qrEntriesCount = document.getElementById('qrEntriesCount');

// ----- Global Variables -----
let isApproving = false;
let currentShiftType = null;
let currentShiftDate = null;
let renderTimeout = null;
let isRendering = false;
let lastRenderData = '';
let currentShiftStatus = 'not_started';
let shiftDb = null;
let backgroundSaveQueue = [];
let isBackgroundSaving = false;
let scannerTimer;
let lastValue = '';
let isScannerActive = false;
let isProcessing = false;

// ----- QR System Variables -----
let qrDb = null;
let qrFirebaseInitialized = false;
let qrEntries = [];
let qrEntriesLocal = [];
let qrSystemAvailable = false;
let qrFirebaseConfig = null;

// ----- Shift Cache -----
let shiftCacheInitialized = false;
let shiftCache = {
  data: null,
  timestamp: 0,
  ttl: 10 * 60 * 1000, // 10 minutes
  dateKey: '',
  shiftType: '',
  openTime: ''
};

// ----- Approved Entries Cache -----
let approvedEntriesCache = {};

// ----- Maldives Timezone Functions -----
function getMaldivesTime() {
  const now = new Date();
  const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
  const maldivesTime = new Date(utc + (5 * 3600000));
  return maldivesTime;
}

function formatDateToYYYYMMDD(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function getMaldivesTimeString() {
  const maldivesTime = getMaldivesTime();
  return maldivesTime.toTimeString().split(' ')[0].slice(0, 5);
}

function getMaldivesDateTimeISO() {
  return getMaldivesTime().toISOString();
}

function formatDateForDocumentId(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}_${month}_${day}`;
}

function getCurrentDate() {
  return formatDateToYYYYMMDD(getMaldivesTime());
}

function getCurrentTime() {
  return getMaldivesTimeString();
}

// ----- Date Format Functions -----
function formatDateForDisplay(dateString) {
  if (!dateString) return '-';
  try {
    if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
      const [year, month, day] = dateString.split('-').map(Number);
      const date = new Date(year, month - 1, day);
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
    }
    return dateString;
  } catch (error) {
    return dateString;
  }
}

// ----- Alert System -----
function showAlert(message, isError = false, isWarning = false, isInfo = false) {
  alertMessage.textContent = message;
  alertNotification.className = 'alert-notification';
  
  if (isError) {
    alertNotification.classList.add('error');
    alertNotification.querySelector('i').className = 'fas fa-exclamation-circle';
  } else if (isWarning) {
    alertNotification.classList.add('warning');
    alertNotification.querySelector('i').className = 'fas fa-exclamation-triangle';
  } else if (isInfo) {
    alertNotification.classList.add('info');
    alertNotification.querySelector('i').className = 'fas fa-info-circle';
  } else {
    alertNotification.querySelector('i').className = 'fas fa-check-circle';
  }
  
  alertNotification.classList.add('show');
  
  setTimeout(() => {
    alertNotification.classList.remove('show');
  }, 3000);
}

// ----- Load QR Firebase Config -----
function loadQRFirebaseConfig() {
  try {
    // QR Firebase Configuration - from your firebase-config.js
    qrFirebaseConfig = {
      apiKey: "AIzaSyC04iaSqeA76oOk_KlrfbSY6NTTNgy5LOY",
      authDomain: "qrcards-2378e.firebaseapp.com",
      projectId: "qrcards-2378e",
      storageBucket: "qrcards-2378e.firebasestorage.app",
      messagingSenderId: "863969491550",
      appId: "1:863969491550:web:b764e63a2847f2b80cd2cf",
      measurementId: "G-ZJPY6EZM41"
    };
    
    console.log("‚úÖ QR Firebase config loaded");
    return true;
    
  } catch (error) {
    console.error("‚ùå Error loading QR Firebase config:", error);
    return false;
  }
}

// ----- Initialize QR Firebase with Better Error Handling -----
function initializeQRFirebase() {
  try {
    console.log("üîÑ Initializing QR Firebase...");
    
    // Load QR config
    if (!qrFirebaseConfig) {
      if (!loadQRFirebaseConfig()) {
        console.warn("‚ö†Ô∏è QR Firebase config not available");
        showAlert("QR system configuration not found", true);
        qrSystemAvailable = false;
        return false;
      }
    }
    
    console.log("‚úÖ Using QR Firebase project:", qrFirebaseConfig.projectId);
    
    let qrApp;
    try {
      // Try to get existing QR app
      qrApp = firebase.app('qrSystem');
      console.log("‚úÖ Using existing QR Firebase app");
    } catch (e) {
      // Create new app for QR system
      try {
        qrApp = firebase.initializeApp(qrFirebaseConfig, 'qrSystem');
        console.log("‚úÖ Created new QR Firebase app for project:", qrFirebaseConfig.projectId);
      } catch (initError) {
        console.error("‚ùå Error creating QR Firebase app:", initError);
        showAlert("Failed to initialize QR system", true);
        qrSystemAvailable = false;
        return false;
      }
    }
    
    // Initialize Firestore
    try {
      qrDb = firebase.firestore(qrApp);
      
      // Configure Firestore settings
      const settings = {
        cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
      };
      
      qrDb.settings(settings);
      
      // Test connection with a simple operation
      const testDoc = qrDb.collection('flightEntries').doc('connection-test');
      await testDoc.set({
        test: true,
        timestamp: getMaldivesDateTimeISO()
      }, { merge: true });
      
      console.log("‚úÖ QR Firebase connection test successful");
      qrFirebaseInitialized = true;
      qrSystemAvailable = true;
      showAlert("QR system connected successfully", false, false, true);
      
      // Clean up test document
      await testDoc.delete();
      
      return true;
      
    } catch (firestoreError) {
      console.error("‚ùå Error initializing QR Firestore:", firestoreError);
      
      // Even if test fails, still initialize for offline mode
      qrDb = firebase.firestore(qrApp);
      qrFirebaseInitialized = true;
      qrSystemAvailable = true;
      
      if (firestoreError.code === 'permission-denied') {
        console.warn("‚ö†Ô∏è Permission denied - check Firebase rules for project:", qrFirebaseConfig.projectId);
        showAlert("QR system: Permission denied - check Firestore rules", true);
      } else {
        showAlert("QR system initialized (offline mode)", false, true, false);
      }
      
      return true;
    }
    
  } catch (error) {
    console.error("‚ùå Unexpected error in QR Firebase initialization:", error);
    showAlert("QR system initialization error", true);
    qrSystemAvailable = false;
    return false;
  }
}

// ----- Load QR Entries with Error Handling -----
async function loadQREntries() {
  if (!qrFirebaseInitialized || !qrSystemAvailable) {
    console.log("QR system not available, skipping load");
    return;
  }
  
  try {
    console.log("üì• Loading QR entries from Firebase...");
    
    const snapshot = await qrDb.collection('flightEntries')
      .orderBy('timestamp', 'desc')
      .limit(50)
      .get();
    
    qrEntries = [];
    snapshot.forEach(doc => {
      qrEntries.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    // Update count display
    qrEntriesCount.textContent = qrEntries.length;
    console.log(`‚úÖ Loaded ${qrEntries.length} QR entries from Firebase`);
    
  } catch (error) {
    console.error('‚ùå Error loading QR entries:', error);
    qrEntriesCount.textContent = 'Error';
    qrStatus.innerHTML = `<span style="color: var(--error);"><i class="fas fa-exclamation-circle"></i> QR load failed: ${error.message}</span>`;
  }
}

// ----- Save to QR System with Robust Error Handling -----
async function saveToQRSystem(codeValue, extractedData) {
  if (!qrFirebaseInitialized || !qrSystemAvailable) {
    console.log("QR system not available, skipping save");
    return false;
  }
  
  try {
    qrProcessingIndicator.classList.add('show');
    
    // Extract data for QR system using the QRCard logic
    const qrData = extractQRDataFromCode(codeValue);
    
    // Add metadata
    qrData.processedAt = getMaldivesDateTimeISO();
    qrData.processedBy = userDisplay.textContent;
    qrData.sourceSystem = 'UnifiedCardEntry';
    
    // Add timestamp
    if (!qrData.timestamp) {
      qrData.timestamp = firebase.firestore.FieldValue.serverTimestamp();
    }
    
    console.log("üíæ Attempting to save QR data to project:", qrFirebaseConfig.projectId, {
      flight: qrData.flightNumber,
      passenger: `${qrData.firstName} ${qrData.lastName}`,
      carrier: qrData.carrierCode
    });
    
    // Save to Firebase
    const docRef = await qrDb.collection('flightEntries').add(qrData);
    qrData.id = docRef.id;
    
    // Add to local array
    qrEntries.unshift(qrData);
    qrEntriesLocal.push({
      ...qrData,
      synced: true,
      syncedAt: getMaldivesDateTimeISO()
    });
    
    // Update count
    qrEntriesCount.textContent = qrEntries.length;
    
    console.log('‚úÖ QR entry saved to Firebase with ID:', docRef.id);
    qrProcessingIndicator.classList.remove('show');
    
    // Show QR success status
    qrStatus.innerHTML = `<span style="color: var(--qr-green);"><i class="fas fa-check-circle"></i> QR entry saved successfully!</span>`;
    
    // Clear QR status after 3 seconds
    setTimeout(() => {
      qrStatus.innerHTML = '';
    }, 3000);
    
    return true;
    
  } catch (error) {
    console.error('‚ùå Error saving to QR system:', error);
    qrProcessingIndicator.classList.remove('show');
    
    // Determine error type
    let errorMessage = error.message;
    if (error.code === 'permission-denied') {
      errorMessage = 'Permission denied - check Firebase Firestore rules';
      console.error('üîí Firestore Rules Issue: Go to Firebase Console ‚Üí Firestore Database ‚Üí Rules');
      console.error('üîí Project:', qrFirebaseConfig.projectId);
      console.error('üîí Current Rules should allow write access');
    } else if (error.message.includes('timeout')) {
      errorMessage = 'Save timeout - check connection';
    } else if (error.message.includes('network')) {
      errorMessage = 'Network error - working offline';
    }
    
    qrStatus.innerHTML = `<span style="color: var(--error);"><i class="fas fa-exclamation-circle"></i> QR save failed: ${errorMessage}</span>`;
    
    // Store locally for later sync
    storeQRDataLocally(codeValue, extractedData);
    
    return false;
  }
}

// ----- Store QR Data Locally for Later Sync -----
function storeQRDataLocally(codeValue, extractedData) {
  try {
    const qrData = extractQRDataFromCode(codeValue);
    qrData.localSaveTime = getMaldivesDateTimeISO();
    qrData.status = 'pending_sync';
    
    // Get existing local QR data
    let localQRData = JSON.parse(localStorage.getItem('localQRData') || '[]');
    
    // Check for duplicates
    const isDuplicate = localQRData.some(item => 
      item.originalCode === qrData.originalCode && 
      item.flightNumber === qrData.flightNumber
    );
    
    if (!isDuplicate) {
      localQRData.push(qrData);
      localStorage.setItem('localQRData', JSON.stringify(localQRData));
      console.log('üíæ QR data stored locally for later sync');
    }
    
  } catch (error) {
    console.error('Error storing QR data locally:', error);
  }
}

// ----- Extract QR Data from Code (QRCard Logic) -----
function extractQRDataFromCode(codeValue) {
  // This function extracts data according to QRCard logic
  let data = {
    firstName: '',
    lastName: '',
    carrierCode: '',
    destination: '',
    origin: '',
    flightNumber: '',
    seatNumber: '',
    cabinCode: '',
    secNumber: '',
    ffpOwner: '',
    ffpNumber: '',
    ffpTier: '',
    originalTier: '',
    guestCategory: 'Guest',
    paxType: 'Adult',
    cabin: 'Economy',
    flightDate: getCurrentDate(),
    originalCode: codeValue
  };
  
  codeValue = codeValue.toUpperCase().replace(/\s+/g, ' ').trim();
  
  const mlePos = codeValue.indexOf('MLE');
  
  if (mlePos !== -1) {
    // Extract name fields
    const textBeforeMLE = codeValue.substring(0, mlePos);
    let processedText = '';
    
    if (textBeforeMLE.length >= 8) {
      processedText = textBeforeMLE.substring(2, textBeforeMLE.length - 7);
    } else if (textBeforeMLE.length > 2) {
      processedText = textBeforeMLE.substring(2);
    }
    
    if (processedText.includes('/')) {
      const nameParts = processedText.split('/');
      if (nameParts.length >= 2) {
        data.lastName = nameParts[0].trim();
        data.firstName = nameParts[1].trim();
      } else if (nameParts.length === 1) {
        data.lastName = nameParts[0].trim();
      }
    } else {
      data.lastName = processedText.trim();
    }
    
    // Extract MLE word
    let wordStart = mlePos;
    let wordEnd = mlePos + 3;
    
    while (wordStart > 0 && /[A-Z0-9]/.test(codeValue[wordStart - 1])) {
      wordStart--;
    }
    
    while (wordEnd < codeValue.length && /[A-Z0-9]/.test(codeValue[wordEnd])) {
      wordEnd++;
    }
    
    const mleWord = codeValue.substring(wordStart, wordEnd);
    
    // Extract carrier code
    data.carrierCode = mleWord.length >= 2 ? mleWord.substring(mleWord.length - 2) : mleWord;
    
    // Extract destination
    if (mleWord.length >= 5) {
      data.destination = mleWord.substring(3, mleWord.length - 2);
    }
    
    // Extract origin
    if (mleWord.length >= 3) {
      data.origin = mleWord.substring(0, 3);
    }
    
    // Extract flight number
    let nextWordStart = wordEnd;
    
    while (nextWordStart < codeValue.length && !/[A-Z0-9]/.test(codeValue[nextWordStart])) {
      nextWordStart++;
    }
    
    let nextWordEnd = nextWordStart;
    while (nextWordEnd < codeValue.length && /[A-Z0-9]/.test(codeValue[nextWordEnd])) {
      nextWordEnd++;
    }
    
    if (nextWordStart < codeValue.length) {
      data.flightNumber = codeValue.substring(nextWordStart, nextWordEnd);
    }
    
    // Extract seat number, cabin code, and sec number
    let seatWordStart = nextWordEnd;
    
    while (seatWordStart < codeValue.length && !/[A-Z0-9]/.test(codeValue[seatWordStart])) {
      seatWordStart++;
    }
    
    let seatWordEnd = seatWordStart;
    while (seatWordEnd < codeValue.length && /[A-Z0-9]/.test(codeValue[seatWordEnd])) {
      seatWordEnd++;
    }
    
    if (seatWordStart < codeValue.length) {
      const seatWord = codeValue.substring(seatWordStart, seatWordEnd);
      
      // Extract seat number
      if (seatWord.length >= 9) {
        const rowPart = seatWord.substring(5, seatWord.length - 4);
        const seatLetter = seatWord.substring(seatWord.length - 4, seatWord.length - 3);
        data.seatNumber = rowPart + seatLetter;
      }
      
      // Extract cabin code
      if (seatWord.length >= 4) {
        data.cabinCode = seatWord.substring(3, 4);
      }
      
      // Extract SEC number
      if (seatWord.length >= 4) {
        const last4Chars = seatWord.substring(seatWord.length - 4);
        if (/^\d{4}$/.test(last4Chars)) {
          data.secNumber = last4Chars;
        } else {
          let digitsEnd = seatWord.length;
          let digitsStart = seatWord.length - 1;
          
          while (digitsStart >= 0 && /\d/.test(seatWord[digitsStart])) {
            digitsStart--;
          }
          
          digitsStart++;
          
          if (digitsStart < digitsEnd) {
            data.secNumber = seatWord.substring(digitsStart, digitsEnd);
          }
        }
      }
    }
    
    // Extract FFP fields
    const words = codeValue.split(' ').filter(word => word.trim() !== '');
    let ffpOwner = '';
    let ffpNumber = '';
    let ffpTier = '';
    let originalTier = '';
    
    if (words.length >= 2) {
      const lastWord = words[words.length - 1];
      const secondLastWord = words[words.length - 2];
      
      if (secondLastWord.length < 4) {
        ffpOwner = '';
        ffpNumber = '';
        ffpTier = '';
        originalTier = '';
      } else {
        ffpNumber = secondLastWord;
        
        if (words.length >= 3) {
          const thirdLastWord = words[words.length - 3];
          if (thirdLastWord.length === 2 && /^[A-Z]{2}$/.test(thirdLastWord)) {
            ffpOwner = thirdLastWord;
          }
        }
        
        if (lastWord.length === 2 && /^[A-Z0-9]{2}$/.test(lastWord.toUpperCase())) {
          originalTier = lastWord.toUpperCase();
          ffpTier = convertFFPTier(data.carrierCode, ffpOwner, originalTier);
        }
      }
    }
    
    data.ffpOwner = ffpOwner;
    data.ffpNumber = ffpNumber;
    data.ffpTier = ffpTier;
    data.originalTier = originalTier;
    
    // Determine cabin from cabin code
    switch(data.cabinCode) {
      case 'J':
        data.cabin = 'Business';
        break;
      case 'Y':
        data.cabin = 'Economy';
        break;
      case 'F':
        data.cabin = 'First';
        break;
      default:
        data.cabin = 'Economy';
    }
    
    // Determine Guest Category based on cabin and FFP tier
    const cabinCodeUpper = (data.cabinCode || '').toUpperCase();
    const cabinNameLower = (data.cabin || '').toLowerCase();
    const isEconomy = (cabinCodeUpper === 'Y' || cabinNameLower.includes('economy'));
    
    const ffpTierUpper = (data.ffpTier || '').toUpperCase();
    const isN0Tier = ffpTierUpper === 'N0' || ffpTierUpper.includes('N0');
    const isTierEmpty = !data.ffpTier || data.ffpTier.trim() === '';
    const isFFPNumberEmpty = !data.ffpNumber || data.ffpNumber.trim() === '';
    
    if (isEconomy && (isN0Tier || isTierEmpty || isFFPNumberEmpty)) {
      data.guestCategory = 'Guest';
    } else if (isEconomy && data.ffpNumber && data.ffpNumber.trim() !== '') {
      data.guestCategory = 'Primary';
    } else {
      data.guestCategory = 'Primary';
    }
    
    // Special handling for QR with N0/empty tier
    const carrierUpper = (data.carrierCode || '').toUpperCase();
    const tierUpper = (data.ffpTier || '').toUpperCase();
    const originalTierUpper = (data.originalTier || '').toUpperCase();
    
    if (carrierUpper === 'QR') {
      const isExactlyN0 = tierUpper === 'N0' || originalTierUpper === 'N0';
      const isEmptyTier = (tierUpper === '' || tierUpper === null || tierUpper === undefined) && 
                         (originalTierUpper === '' || originalTierUpper === null || originalTierUpper === undefined);
      
      if (isExactlyN0 || isEmptyTier) {
        data.ffpOwner = '';
        data.ffpNumber = '';
        data.ffpTier = '';
      }
    }
  }
  
  return data;
}

// ----- Convert FFP Tier (QRCard Logic) -----
function convertFFPTier(carrierCode, ffpOwner, originalTier) {
  if (!originalTier || originalTier.trim() === '') {
    return originalTier || '';
  }
  
  const tier = originalTier.toUpperCase();
  
  // List of OneWorld member airlines for special tier conversion
  const oneWorldAirlines = ['BA', 'IB', 'QR', 'CX', 'UL', 'MH', 'AA', 'AY', 'RJ', 'LA', 'AB', 'JL'];
  
  if (carrierCode && ffpOwner && carrierCode.toUpperCase() !== ffpOwner.toUpperCase()) {
    if (oneWorldAirlines.includes(ffpOwner.toUpperCase())) {
      if (tier === 'N1' || tier === 'N2') {
        return 'Emerald';
      } else if (tier === 'N3') {
        return 'Sapphire';
      } else if (tier === 'N0') {
        return 'N0';
      }
    } else {
      if (tier === 'N1' || tier === 'P') {
        return 'Platinum';
      } else if (tier === 'N2' || tier === 'G') {
        return 'Gold';
      } else if (tier === 'N3' || tier === 'S') {
        return 'Silver';
      } else if (tier === 'N0') {
        return 'N0';
      }
    }
  } else {
    if (tier === 'N1' || tier === 'P') {
      return 'Platinum';
    } else if (tier === 'N2' || tier === 'G') {
      return 'Gold';
    } else if (tier === 'N3' || tier === 'S') {
      return 'Silver';
    } else if (tier === 'N0') {
      return 'N0';
    }
  }
  
  return originalTier;
}

// ----- Process FQTV Tier Level -----
function processFqtvTier(fqtvNumber, flightCode) {
  if (!fqtvNumber || fqtvNumber.trim() === '') return '';
  
  const fqtvUpper = fqtvNumber.toUpperCase();
  
  let tierCode = '';
  if (fqtvUpper.includes(' N3') || fqtvUpper.endsWith('N3') || fqtvUpper.includes('/N3')) {
    tierCode = 'n3';
  } else if (fqtvUpper.includes(' N2') || fqtvUpper.endsWith('N2') || fqtvUpper.includes('/N2')) {
    tierCode = 'n2';
  } else if (fqtvUpper.includes(' N1') || fqtvUpper.endsWith('N1') || fqtvUpper.includes('/N1')) {
    tierCode = 'n1';
  }
  
  if (!tierCode) {
    const tierMatch = fqtvUpper.match(/([Nn][123])$/);
    if (tierMatch) {
      tierCode = tierMatch[1].toLowerCase();
    }
  }
  
  if (!tierCode) return '';
  
  let fqtvAirlineCode = '';
  const fqtvMatch = fqtvUpper.match(/^([A-Z0-9]{2})[- ]/);
  if (fqtvMatch) {
    fqtvAirlineCode = fqtvMatch[1];
  } else {
    fqtvAirlineCode = fqtvUpper.substring(0, 2);
  }
  
  const flightAirlineCode = flightCode.slice(0, 2).toUpperCase();
  
  let tierMapping;
  if (fqtvAirlineCode && flightAirlineCode && 
      fqtvAirlineCode.toUpperCase() === flightAirlineCode.toUpperCase()) {
    tierMapping = fqtvTierMappings.same;
  } else {
    tierMapping = fqtvTierMappings.different;
  }
  
  return tierMapping[tierCode] || '';
}

// ----- User Authentication -----
const userData = JSON.parse(localStorage.getItem("loggedInUser"));

if (userData) {
    userDisplay.textContent = userData.name || userData.username;
} else {
    window.location.href = "login.html";
}

// ----- Initialize Shift Firebase -----
function initializeShiftFirebase() {
  try {
    console.log("Initializing Shift Firebase...");
    
    // Check if fireshift.js loaded the config
    if (typeof shiftFirebaseConfig === 'undefined') {
      console.error("‚ùå Shift Firebase config not found in fireshift.js");
      showAlert("Shift system configuration not found", true);
      return false;
    }
    
    console.log("Using Firebase config for project:", shiftFirebaseConfig.projectId);
    
    let app;
    try {
      // Try to get existing app
      app = firebase.app('shiftSystem');
      console.log("‚úÖ Using existing Shift Firebase app");
    } catch (e) {
      // Create new app for shifts
      app = firebase.initializeApp(shiftFirebaseConfig, 'shiftSystem');
      console.log("‚úÖ Created new Shift Firebase app");
    }
    
    // Initialize Firestore
    shiftDb = firebase.firestore(app);
    shiftCacheInitialized = true;
    console.log("‚úÖ Shift Firestore initialized successfully");
    
    return true;
    
  } catch (error) {
    console.error("‚ùå Error initializing shift Firebase:", error);
    showAlert("Failed to initialize shift system", true);
    return false;
  }
}

// ----- All other functions remain exactly the same as previous version -----
// ... (copy all the remaining functions from previous version) ...

// ----- Event Listeners -----
manualSaveBtn.addEventListener('click', async () => {
  if (isProcessing) return;
  isProcessing = true;
  
  parseCode();
  const entry = {
    date: currentShiftDate,
    user: userDisplay.textContent,
    shift: currentShiftType,
    code: codeInput.value,
    name: nameInput.value,
    pnr: pnrInput.value,
    flight: flightInput.value,
    airline: airlineSelect.value,
    seat: seatInput.value,
    class: classInput.value,
    serial: serialInput.value,
    remarks: remarksInput.value,
    fqtv: fqtvInput.value,
    numPax: Number(numPaxInput.value)||1,
    approved: false
  };
  
  await saveEntry(entry);
  
  setTimeout(() => {
    isProcessing = false;
  }, 1000);
});

refreshShiftBtn.addEventListener('click', refreshShiftData);

// ----- Initialize System -----
document.addEventListener('DOMContentLoaded', async function() {
  console.log("üöÄ Initializing unified passenger approval system...");
  console.log("üìã System Configuration:");
  console.log("- Card System: cardsystem-21773");
  console.log("- QR System: qrcards-2378e");
  
  // Load approved entries cache
  loadApprovedEntriesCache();
  
  // Initialize QR Firebase
  setTimeout(() => {
    initializeQRFirebase();
    loadQREntries();
  }, 1000);
  
  // Try to load shift from localStorage first
  const loadedFromCache = loadCurrentShiftFromLocalStorage();
  
  if (!loadedFromCache) {
    console.log("üîÑ No fresh cache, fetching shift data from server");
    showNoShiftMessage();
    
    // Fetch shift data after a short delay
    setTimeout(() => {
      fetchCurrentOpenShift();
    }, 1000);
  } else {
    console.log("‚úÖ Shift loaded from cache");
  }
  
  // Set up other event listeners
  codeInput.addEventListener('input', handleScannerInput);
  
  codeInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      clearTimeout(scannerTimer);
      if (isScannerActive) {
        processScannerInput();
      } else {
        processManualInput();
      }
    }
  });
  
  codeInput.addEventListener('blur', handleFieldExit);
  
  // Render existing entries
  renderEntries();
  
  // Set up periodic shift check (every 5 minutes)
  setInterval(() => {
    if (currentShiftStatus === 'open') {
      console.log("üîÑ Periodic shift check");
      fetchCurrentOpenShift();
    }
  }, 5 * 60 * 1000);
  
  // Set up periodic QR entries refresh (every 2 minutes)
  setInterval(() => {
    loadQREntries();
  }, 2 * 60 * 1000);
  
  // Clean up on page unload
  window.addEventListener('beforeunload', () => {
    console.log("üßπ Cleaning up before unload");
  });
});

// ----- Debug Functions -----
window.debugSystemsInfo = function() {
  console.log("=== DEBUG SYSTEMS INFO ===");
  console.log("Card System Project:", window.passengerDb ? "cardsystem-21773" : "Not initialized");
  console.log("QR System Project:", qrFirebaseConfig ? qrFirebaseConfig.projectId : "Not configured");
  console.log("QR Firebase Initialized:", qrFirebaseInitialized);
  console.log("QR System Available:", qrSystemAvailable);
  console.log("QR Entries Count:", qrEntries.length);
  
  console.log("\n=== SHIFT INFO ===");
  console.log("Current Shift Type:", currentShiftType);
  console.log("Current Shift Date:", currentShiftDate);
  console.log("Current Shift Status:", currentShiftStatus);
  
  alert(`System Information:\n\n` +
        `Card System: ${window.passengerDb ? '‚úÖ Initialized (cardsystem-21773)' : '‚ùå Not initialized'}\n` +
        `QR System: ${qrFirebaseInitialized ? '‚úÖ Initialized (' + qrFirebaseConfig.projectId + ')' : '‚ùå Not initialized'}\n` +
        `QR Available: ${qrSystemAvailable ? '‚úÖ' : '‚ùå'}\n` +
        `QR Entries: ${qrEntries.length}\n\n` +
        `Shift: ${currentShiftType || 'None'}\n` +
        `Date: ${currentShiftDate || '-'}\n` +
        `Status: ${currentShiftStatus}`);
};

// ----- QR System Helper Functions -----
window.openQRReport = function() {
  window.open('qrReport.html', '_blank');
};

// ----- Test QR System Connection -----
window.testQRConnection = async function() {
  if (!qrFirebaseInitialized || !qrSystemAvailable) {
    alert("QR system not initialized");
    return;
  }
  
  try {
    showAlert("Testing QR system connection...", false, false, true);
    
    const testData = {
      test: true,
      timestamp: getMaldivesDateTimeISO(),
      message: "Connection test from unified system"
    };
    
    const docRef = await qrDb.collection('testConnections').add(testData);
    alert(`‚úÖ QR System Connection Successful!\n\nProject: ${qrFirebaseConfig.projectId}\nTest Document ID: ${docRef.id}\n\nDocument saved successfully.`);
    
    // Clean up test document
    await docRef.delete();
    
  } catch (error) {
    alert(`‚ùå QR System Connection Failed!\n\nError: ${error.message}\n\nProject: ${qrFirebaseConfig.projectId}\n\nCheck:\n1. Firebase Firestore Rules\n2. Internet Connection\n3. Project Configuration`);
    console.error("Connection test error:", error);
  }
};
</script>

</body>
</html>
