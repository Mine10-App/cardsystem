<!DOCTYPE html>
<html>
<head>
  <title>Passenger Payment POS</title>
  <style>
    /* ======== GOLDEN THEME STYLES ======== */
    :root {
      --gold-light: #faf3e0;
      --gold-medium: #f5e6ca;
      --gold-dark: #d4b483;
      --gold-accent: #c19a6b;
      --gold-deep: #b8860b;
      --text-dark: #333333;
      --text-medium: #5a4a42;
      --text-light: #7a6a62;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, var(--gold-light) 0%, var(--gold-medium) 100%);
      min-height: 100vh;
      color: var(--text-dark);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .containerB {
      max-width: 1200px;
      margin: 0 auto;
      height: auto; /* Let content determine height */
      min-height: 0; /* Remove minimum height */
      padding: 1px 0; /* Reduce vertical padding */
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 20px 25px;
      background: linear-gradient(135deg, var(--gold-accent) 0%, var(--gold-deep) 100%);
      color: white;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(193, 154, 107, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .header-left h1 {
      margin: 0;
      font-size: 26px;
      font-weight: 600;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .header-left p {
      margin: 5px 0 0;
      opacity: 0.95;
      font-size: 14px;
      font-weight: 300;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .search-container {
      display: flex;
      gap: 10px;
      align-items: center;
    }

       /* Option 1: Simple container */
.button-container {
  display: flex;
  gap: 10px;
  margin: 10px 0;
  padding: 10px;
}

/* Option 2: Container with styling */
.button-container {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  padding: 20px;
  background-color: #77d8f8;
  border-radius: 8px;
  border: 1px solid #ddd;
  margin: 20px 0;
}

/* Option 3: Center aligned container */
.button-container {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  padding: 10px;
  background: linear-gradient(to right, #a67c00, #c59402);
  border-radius: 5px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* Option 4: Vertical button container */
.button-container.vertical {
  display: flex;
  flex-direction: column;
  gap: 5px;
  max-width: 200px;
  padding: 10px;
}

 .home-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 7px 20px;
  background-color: #f5ede9;
  color: rgb(0, 0, 0);
  border: #ffffff;
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
  text-decoration: none;
  transition: background-color 0.3s;
}

.home-btn:hover {
  background-color: #da7f3e;
  text-decoration: none;
  color: white;
}

.home-btn .icon-home {
  margin-right: 8px;
  font-size: 18px;
}
    
    .search-input {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      width: 200px;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.9);
    }
    
    .search-btn {
      padding: 8px 15px;
      background: rgba(255, 255, 255, 0.9);
      color: var(--gold-deep);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .search-btn:hover {
      background: white;
      transform: translateY(-1px);
    }
    
    .main-content {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(193, 154, 107, 0.1);
      flex: 1;
      min-width: 300px;
      border: 1px solid var(--gold-medium);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(193, 154, 107, 0.15);
    }
    
    .card h3 {
      margin-top: 0;
      color: var(--gold-deep);
      padding-bottom: 10px;
      border-bottom: 2px solid var(--gold-dark);
      font-size: 18px;
      font-weight: 600;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text-medium);
      font-size: 14px;
    }
    
    .input-group input, .input-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gold-medium);
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
      transition: all 0.3s;
      background-color: white;
      color: var(--text-dark);
    }
    
    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: var(--gold-accent);
      box-shadow: 0 0 0 3px rgba(193, 154, 107, 0.2);
    }
    
    .input-group input[readonly] {
      background-color: var(--gold-light);
      font-weight: 600;
      color: var(--text-dark);
      border-color: var(--gold-dark);
      padding: 8px 12px;
      font-size: 13px;
    }
    
    .input-group input.positive {
      color: #27ae60;
      font-weight: bold;
    }
    
    .input-group input.negative {
      color: #e74c3c;
      font-weight: bold;
    }
    
    .input-group input.zero {
      color: var(--gold-deep);
      font-weight: bold;
    }
    
    .row {
      display: flex;
      gap: 12px;
    }
    
    .row .input-group {
      flex: 1;
    }
    
    .boarding-pass-section {
      background: linear-gradient(135deg, #fff9f0 0%, #fef5e7 100%);
      border-left: 4px solid var(--gold-accent);
      width: 100%;
      margin-bottom: 20px;
      border: 1px solid var(--gold-dark);
    }
    
    .boarding-pass-section h3 {
      border-bottom-color: var(--gold-accent);
    }
    
    .section-note {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 5px;
      font-style: italic;
    }
    
    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      flex: 1;
      min-width: 140px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .btn i {
      font-size: 16px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--gold-accent) 0%, var(--gold-deep) 100%);
      color: white;
      border: 1px solid var(--gold-dark);
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, var(--gold-deep) 0%, #a67c00 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(193, 154, 107, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
      border: 1px solid #229954;
    }
    
    .btn-success:hover {
      background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
      color: white;
      border: 1px solid #6c7b7d;
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, #7f8c8d 0%, #636e72 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(127, 140, 141, 0.3);
    }
    
    .btn-info {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      border: 1px solid #2573a7;
    }
    
    .btn-info:hover {
      background: linear-gradient(135deg, #2980b9 0%, #1f639b 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }
    
    .payment-summary {
      background: linear-gradient(135deg, #f8f9fa 0%, #f1f8e9 100%);
      border-left: 4px solid var(--gold-deep);
      border: 1px solid var(--gold-accent);
    }
    
    .payment-summary .input-group label {
      color: var(--text-dark);
      font-weight: 600;
      font-size: 13px;
    }
    
    .summary-value {
      font-size: 16px;
      font-weight: bold;
      color: var(--gold-deep);
      text-align: right;
    }
    
    #log {
      margin-top: 15px;
    }
    
    .logs-section {
      width: 100%;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      box-shadow: 0 2px 8px rgba(193, 154, 107, 0.1);
      border-radius: 6px;
      overflow: hidden;
    }
    
    th {
      background: linear-gradient(135deg, var(--gold-accent) 0%, var(--gold-deep) 100%);
      color: white;
      padding: 12px 14px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid var(--gold-dark);
      font-size: 14px;
    }
    
    td {
      padding: 10px 14px;
      border-bottom: 1px solid var(--gold-light);
      background-color: white;
      font-size: 13px;
    }
    
    tr:hover {
      background-color: var(--gold-light);
    }
    
    .action-btn {
      padding: 6px 12px;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      font-size: 12px;
    }
    
    .action-btn:hover {
      background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(231, 76, 60, 0.3);
    }
    
    .edit-btn {
      padding: 6px 12px;
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      font-size: 12px;
      margin-right: 4px;
    }
    
    .edit-btn:hover {
      background: linear-gradient(135deg, #2980b9 0%, #1f639b 100%);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(52, 152, 219, 0.3);
    }
    
    .complete-btn {
      padding: 6px 12px;
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      font-size: 12px;
      margin-right: 4px;
    }
    
    .complete-btn:hover {
      background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(46, 204, 113, 0.3);
    }
    
    .print-btn {
      padding: 6px 12px;
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      font-size: 12px;
      margin-right: 4px;
    }
    
    .print-btn:hover {
      background: linear-gradient(135deg, #8e44ad 0%, #7d3c98 100%);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(155, 89, 182, 0.3);
    }
    
    .currency-badge {
      display: inline-block;
      padding: 3px 8px;
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    
    .rate-badge {
      display: inline-block;
      padding: 3px 8px;
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
      color: white;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    
    .payment-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    
    .payment-cash {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
    }
    
    .payment-card {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      color: white;
    }
    
    .payment-method-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 4px;
    }
    
    .payment-method-visa {
      background: linear-gradient(135deg, #1a1f71 0%, #1a237e 100%);
      color: white;
    }
    
    .payment-method-mastercard {
      background: linear-gradient(135deg, #eb001b 0%, #f79e1b 100%);
      color: white;
    }
    
    .payment-method-amex {
      background: linear-gradient(135deg, #2e77bb 0%, #006fcf 100%);
      color: white;
    }
    
    .payment-method-unionpay {
      background: linear-gradient(135deg, #ff5f00 0%, #ff7f00 100%);
      color: white;
    }
    
    .payment-method-qr {
      background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
      color: white;
    }
    
    .card-details {
      font-size: 10px;
      color: var(--text-light);
      margin-top: 3px;
    }
    
    .status-pending {
      display: inline-block;
      padding: 3px 8px;
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      color: white;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    
    .status-completed {
      display: inline-block;
      padding: 3px 8px;
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    
    .status-void {
      display: inline-block;
      padding: 3px 8px;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    
    .shift-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    
    .shift-morning {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
    }
    
    .shift-evening {
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
      color: white;
    }
    
    .receipt-badge {
      display: inline-block;
      padding: 3px 8px;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }

    .void-badge {
      display: inline-block;
      padding: 3px 8px;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    .compact-info-summary {
      display: flex;
      justify-content: space-between;
      background: var(--gold-light);
      padding: 10px 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      border: 1px solid var(--gold-medium);
    }

    .info-row {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      flex: 1;
    }

    .info-row .info-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-medium);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .info-value-summary {
      font-size: 14px;
      font-weight: bold;
      color: var(--gold-deep);
      background: white;
      padding: 5px 12px;
      border-radius: 4px;
      min-width: 120px;
      text-align: center;
      border: 1px solid var(--gold-accent);
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .header-right {
        flex-direction: column;
        width: 100%;
      }
      
      .compact-info {
        text-align: center;
      }
      
      .search-container {
        width: 100%;
      }
      
      .search-input {
        width: 100%;
      }
      
      .main-content {
        flex-direction: column;
      }
      
      .row {
        flex-direction: column;
        gap: 10px;
      }
      
      .btn {
        min-width: 100%;
      }
      
      .header-left h1 {
        font-size: 22px;
      }
    }
    
    /* Hidden receipt styles */
    #receiptArea {
      display: none;
    }
    
    .gold-ornament {
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--gold-accent), transparent);
      margin: 8px 0;
    }
    
    /* Icon styles */
    .icon {
      display: inline-block;
      width: 18px;
      height: 18px;
      background-size: contain;
      background-repeat: no-repeat;
      vertical-align: middle;
      margin-right: 6px;
    }
    
    .icon-scan { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M2 6h2v12H2zm3 0h1v12H5zm2 0h3v12H7zm4 0h1v12h-1zm3 0h2v12h-2zm4 0h1v12h-1zm2 0h1v12h-1zm2 0h2v12h-2z"/></svg>'); }
    .icon-save { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>'); }
    .icon-print { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>'); }
    .icon-view { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>'); }
    .icon-search { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>'); }
     .icon-home { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>'); }
    .icon-report { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M15.73 3H8.27L3 8.27v7.46L8.27 21h7.46L21 15.73V8.27L15.73 3zM12 17.3c-.72 0-1.3-.58-1.3-1.3s.58-1.3 1.3-1.3 1.3.58 1.3 1.3-.58 1.3-1.3 1.3zm1-4.3h-2V7h2v6z"/></svg>'); }
    .icon-void { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>'); }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 10px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      border: 1px solid var(--gold-medium);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--gold-dark);
    }
    
    .modal-header h3 {
      margin: 0;
      color: var(--gold-deep);
      font-size: 18px;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: var(--text-light);
    }
    
    .close-modal:hover {
      color: var(--gold-accent);
    }
    
    /* Modal select styling */
    .modal select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gold-medium);
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
      transition: all 0.3s;
      background-color: white;
      color: var(--text-dark);
      cursor: pointer;
    }
    
    .modal select:focus {
      outline: none;
      border-color: var(--gold-accent);
      box-shadow: 0 0 0 3px rgba(193, 154, 107, 0.2);
    }
    
    .modal select[readonly] {
      background-color: var(--gold-light);
      cursor: not-allowed;
    }
    
    /* Tabs for payment logs */
    .tab-container {
      margin-bottom: 15px;
    }
    
    .tab-buttons {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
    }
    
    .tab-btn {
      padding: 8px 16px;
      background: var(--gold-light);
      border: 1px solid var(--gold-medium);
      border-radius: 5px 5px 0 0;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-medium);
      transition: all 0.3s;
      font-size: 13px;
    }
    
    .tab-btn.active {
      background: var(--gold-accent);
      color: white;
      border-color: var(--gold-accent);
    }
    
    .tab-btn:hover:not(.active) {
      background: var(--gold-medium);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .expiry-note {
      font-size: 10px;
      color: #e74c3c;
      margin-top: 3px;
      font-weight: 600;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1001;
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
      max-width: 300px;
    }
    
    .notification.success {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    }
    
    .notification.warning {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    }
    
    .notification.error {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }
    
    .notification.info {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    /* Login user display */
    .user-display {
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 15px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 13px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      min-width: 150px;
      text-align: center;
      cursor: pointer;
    }
    
    .user-display:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    /* Supervisor specific styles */
    .supervisor-only {
      border-left: 4px solid #3498db;
      background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%);
    }
    
    .shift-select-container {
      margin-top: 10px;
      padding: 10px;
      background: rgba(52, 152, 219, 0.1);
      border-radius: 6px;
      border: 1px solid #3498db;
      display: none;
    }
    
    .shift-select-container .input-group {
      margin-bottom: 0;
    }
    
    /* Card separator */
    .card-separator {
      border-top: 1px solid var(--gold-medium);
      margin: 15px 0;
    }
    
    /* Void receipt warning */
    .void-warning {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
      text-align: center;
      font-weight: bold;
      border: 2px dashed white;
    }
    
    .void-info {
      background: linear-gradient(135deg, #f5b7b1 0%, #f1948a 100%);
      padding: 8px;
      border-radius: 6px;
      margin: 5px 0;
      border-left: 4px solid #c0392b;
    }
    
    /* Shift display styles */
    .shift-display {
      background: rgba(255, 255, 255, 0.15);
      padding: 5px 10px;
      border-radius: 4px;
      margin: 5px 0;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .shift-info {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .shift-refresh-btn {
      padding: 4px 8px;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 3px;
      color: white;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.3s;
    }
    
    .shift-refresh-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }
    
    .shift-date {
      font-weight: bold;
      color: #ffd700;
    }
    
    .shift-name {
      font-weight: bold;
      color: #87ceeb;
    }
  </style>
</head>
<body>
  <div class="containerB">
    <div class="button-container">
          <button class="home-btn" onclick="window.location.href='dashP.html'">
            <span class="icon icon-home"></span> Home
          </button>

          <button class="home-btn" onclick="window.location.href='shiftend.html'">
            <span class="icon icon-report"></span> Report
          </button>
          <button class="home-btn" onclick="window.location.href='void.html'">
            <span class="icon icon-void"></span> Void
          </button>
        </div>
      </div>
  <div class="container">
    <!-- COMPACT HEADER WITH SEARCH -->
    <div class="header">
      <div class="header-left">
        <h1>Passenger Payment POS</h1>
        <p>Koveli Lounge - Passenger Payment Processing</p>
        <!-- Shift Information Display -->
        <div class="shift-info" id="shiftInfoDisplay">
          Loading shift info...
        </div>
      </div>
      <div class="header-right">
        <div class="user-display" id="userDisplay" onclick="logoutUser()" title="Double-click to logout">
          <span id="currentUser">Loading...</span>
        </div>
        <div class="search-container">
          <input class="search-input" id="receiptSearch" type="text" placeholder="Receipt No...">
          <button class="search-btn" onclick="searchReceipt()">
            <span class="icon icon-search"></span>Search
          </button>
        </div>
      </div>
    </div>
    
    <!-- BOARDING PASS SECTION -->
    <div class="card boarding-pass-section">
      <h3><span class="icon icon-scan"></span>Boarding Pass Scanning</h3>
      <div class="input-group">
        <input id="codeInput" type="text" placeholder="Paste boarding pass barcode content here">
        <div class="section-note">The system will automatically parse passenger information</div>
      </div>
    </div>
    
    <div class="main-content">
      <div class="card">
        <h3>Passenger Information</h3>
        <div class="row">
          <div class="input-group">
            <label for="name">Full Name</label>
            <input id="name" type="text" placeholder="Passenger name">
          </div>
          <div class="input-group">
            <label for="flightNo">Flight Number</label>
            <input id="flightNo" type="text" placeholder="Flight code">
          </div>
        </div>
        
        <div class="row">
          <div class="input-group">
            <label for="seatNo">Seat Number</label>
            <input id="seatNo" type="text" placeholder="Seat assignment">
          </div>
        </div>
        
        <!-- SHIFT INFORMATION DISPLAY -->
        <div class="shift-display" id="shiftDisplaySection">
          <div class="input-group">
            <label>Shift Information</label>
            <div style="display: flex; align-items: center; gap: 10px;">
              <input id="currentShiftDate" type="text" readonly style="flex: 1; background: var(--gold-light);">
              <input id="currentShiftName" type="text" readonly style="flex: 1; background: var(--gold-light); font-weight: bold;">
              <button class="shift-refresh-btn" onclick="fetchShiftFromFirebase(true)">
                üîÑ Refresh
              </button>
            </div>
            <div class="section-note">Date and shift are fetched from Firebase. Press refresh to update.</div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3>Passenger Details</h3>
        <div class="row">
          <div class="input-group">
            <label for="adults">Adults</label>
            <input id="adults" type="number" value="1" min="0">
          </div>
          <div class="input-group">
            <label for="kids">Children</label>
            <input id="kids" type="number" value="0" min="0">
          </div>
        </div>
        
        <div class="row">
          <div class="input-group">
            <label for="rateType">Rate Type</label>
            <select id="rateType">
              <option value="A">Rate A (Standard)</option>
              <option value="B">Rate B (Special)</option>
            </select>
          </div>
          <div class="input-group">
            <label for="currency">Currency</label>
            <select id="currency">
              <option value="USD">USD</option>
              <option value="MVR">MVR</option>
            </select>
          </div>
        </div>
        
        <div class="input-group">
          <label for="paymentType">Payment Method</label>
          <select id="paymentType">
            <option value="Card">Card Payment</option>
            <option value="Cash">Cash Payment</option>
            <option value="Visa">Visa</option>
            <option value="MasterCard">MasterCard</option>
            <option value="Amex">American Express (Amex)</option>
            <option value="UnionPay">UnionPay</option>
            <option value="QRSales">QR Sales</option>
          </select>
        </div>
        
        <!-- Cash Payment Fields (Hidden by default) -->
        <div id="cashPaymentFields" style="display: none;">
          <div class="input-group">
            <label for="paidAmount">Paid Amount</label>
            <input id="paidAmount" type="number" value="0.00" step="0.01" min="0">
          </div>
          
          <div class="input-group">
            <label>Balance Amount</label>
            <input id="balance" type="text" readonly class="summary-value" value="0.00">
          </div>
        </div>
      </div>
      
      <div class="card payment-summary">
        <h3>Payment Summary</h3>
        <div class="compact-info-summary">
          <div class="info-row">
            <span class="info-label">Receipt No:</span>
            <span class="info-value-summary" id="headerReceiptNo">AUTO</span>
          </div>
          <div class="info-row">
            <span class="info-label">Expiry Time:</span>
            <span class="info-value-summary" id="headerExpiryTime">--:--</span>
          </div>
        </div>
        <div class="input-group">
          <label>Subtotal Amount</label>
          <input id="subtotal" type="text" readonly class="summary-value" value="0.00">
        </div>
        
        <div class="input-group">
          <label>GST (8%)</label>
          <input id="gst" type="text" readonly class="summary-value" value="0.00">
        </div>
        
        <div class="input-group">
          <label>Total Amount</label>
          <input id="total" type="text" readonly class="summary-value" value="0.00">
        </div>
        
        <div class="gold-ornament"></div>
        
        <div class="buttons">
          <button class="btn btn-primary" onclick="saveNow()">
            <span class="icon icon-save"></span>Save & Print
          </button>
          <button class="btn btn-success" onclick="printReceipt()">
            <span class="icon icon-print"></span>Reprint
          </button>
          <button class="btn btn-secondary" onclick="loadPayments()">
            <span class="icon icon-view"></span>View Logs
          </button>
        </div>
      </div>
    </div>
    
    <div class="logs-section">
      <div class="card">
        <h3>Today's Pending Payments</h3>
        
        <!-- Tabs for Pending Payments Only -->
        <div class="tab-container">
          <div class="tab-buttons">
            <button class="tab-btn active" onclick="showTab('pendingCards')">Today's Pending</button>
            <button class="tab-btn" onclick="cleanupOldLocalPayments(); loadPayments();">Cleanup Old Data</button>
          </div>
          
          <div id="pendingCards" class="tab-content active">
            <div id="pendingLog">
              <p style="text-align: center; color: var(--text-light); padding: 20px;">
                Click "View Logs" to display today's pending transaction history
              </p>
            </div>
          </div>
        </div>
        
        <!-- Supervisor Cleanup Section -->
        <div id="supervisorCleanupSection" style="display: none; margin-top: 10px;">
          <button class="btn btn-secondary" onclick="manualCleanupAllOldData()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
            üóëÔ∏è Supervisor Cleanup
          </button>
          <div class="section-note">Deletes all local data except today's entries</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for entering card details -->
  <div id="cardDetailsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Enter Payment Details</h3>
        <button class="close-modal" onclick="closeModal()">&times;</button>
      </div>
      
      <div class="input-group">
        <label>Receipt Number</label>
        <input id="modalReceiptNo" type="text" readonly>
      </div>
      
      <div class="input-group">
        <label>Payment ID</label>
        <input id="modalPaymentId" type="text" readonly>
      </div>
      
      <div class="input-group">
        <label>Passenger Name</label>
        <input id="modalPassengerName" type="text" readonly>
      </div>
      
      <div class="input-group">
        <label for="modalPaymentMethod">Payment Method *</label>
        <select id="modalPaymentMethod" required>
          <option value="">Select Payment Method</option>
          <option value="Visa">Visa</option>
          <option value="MasterCard">MasterCard</option>
          <option value="Amex">American Express (Amex)</option>
          <option value="UnionPay">UnionPay</option>
          <option value="QR">QR Sales</option>
        </select>
      </div>
      
      <div class="input-group">
        <label>Total Amount</label>
        <input id="modalTotalAmount" type="text" readonly>
      </div>
      
      <div class="row">
        <div class="input-group">
          <label for="modalBatchNo">Batch Number *</label>
          <input id="modalBatchNo" type="text" placeholder="Enter batch number" required>
        </div>
        <div class="input-group">
          <label for="modalApprovalCode">Approval Code *</label>
          <input id="modalApprovalCode" type="text" placeholder="Enter approval code" required>
        </div>
      </div>
      
      <div class="buttons">
        <button class="btn btn-success" onclick="saveCardDetails()">
          Save & Print Final
        </button>
        <button class="btn btn-secondary" onclick="closeModal()">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Search Result Modal -->
  <div id="searchResultModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Receipt Found</h3>
        <button class="close-modal" onclick="closeSearchModal()">&times;</button>
      </div>
      
      <div id="searchResultContent">
        <!-- Search results will be displayed here -->
      </div>
      
      <div class="buttons" id="searchResultActions" style="display: none;">
        <button class="btn btn-success" onclick="printFoundReceipt()">
          <span class="icon icon-print"></span>Print Receipt
        </button>
        <button class="btn btn-info" onclick="addCardDetailsToFoundReceipt()">
          Add Card Details
        </button>
        <button class="btn btn-secondary" onclick="closeSearchModal()">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Notification Container -->
  <div id="notificationContainer"></div>

  <!-- Hidden Receipt for 76mm Printer - PROFESSIONAL DESIGN with VOID support -->
  <div id="receiptArea" style="display:none;">
    <div id="receiptContent" style="width:280px;font-family:'Courier New', monospace;font-size:12px;line-height:1.2;">
      <!-- Company Header -->
      <div style="text-align:center;font-weight:bold;font-size:14px;margin-bottom:3px;letter-spacing:1px;">
        KOVELI LOUNGE
      </div>
      <div style="text-align:center;font-size:10px;margin-bottom:3px;">
        Velana International Airport
      </div>
      <div style="text-align:center;font-size:9px;margin-bottom:5px;">
        +960 304 6677
      </div>
      
      <!-- Receipt Header -->
      <div style="text-align:center;font-weight:bold;font-size:11px;margin-bottom:5px;border-top:1px dashed #000;border-bottom:1px dashed #000;padding:3px 0;" id="r_header">
        PASSENGER PAYMENT RECEIPT
      </div>
      
      <!-- VOID WARNING BANNER -->
      <div id="r_void_banner" style="display:none;text-align:center;background:#e74c3c;color:white;font-weight:bold;margin-bottom:5px;padding:3px;font-size:12px;border:2px solid #000;">
        ‚ö†Ô∏è VOID RECEIPT ‚ö†Ô∏è
      </div>
      
      <!-- Receipt Info -->
      <div style="margin-bottom:5px;">
        <div style="display:flex;justify-content:space-between;">
          <span><b>Receipt:</b></span>
          <span id="r_receiptNo"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Date:</b></span>
          <span id="r_date"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Shift:</b></span>
          <span id="r_shift"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Staff:</b></span>
          <span id="r_staff"></span>
        </div>
      </div>
      
      <!-- VOID Information -->
      <div id="r_void_info" style="display:none;margin-bottom:5px;background:#f8d7da;border:1px solid #f5c6cb;padding:3px;">
        <div style="text-align:center;font-weight:bold;color:#721c24;font-size:10px;margin-bottom:2px;">VOID INFORMATION</div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Voided By:</b></span>
          <span id="r_voided_by"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Voided At:</b></span>
          <span id="r_voided_at"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Reason:</b></span>
          <span id="r_void_reason"></span>
        </div>
      </div>
      
      <!-- Separator -->
      <div style="border-bottom:1px dashed #000;margin:5px 0;"></div>
      
      <!-- Passenger Details -->
      <div style="margin-bottom:5px;">
        <div style="display:flex;justify-content:space-between;">
          <span><b>Name:</b></span>
          <span id="r_name" style="text-align:right;max-width:180px;"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Flight:</b></span>
          <span id="r_flight"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Seat:</b></span>
          <span id="r_seat"></span>
        </div>
      </div>
      
      <!-- Payment Details -->
      <div style="margin-bottom:5px;">
        <div style="display:flex;justify-content:space-between;">
          <span><b>Adults:</b></span>
          <span id="r_adults"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Children:</b></span>
          <span id="r_kids"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Payment Method:</b></span>
          <span id="r_payment_method"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Currency:</b></span>
          <span id="r_currency"></span>
        </div>
      </div>
      
      <!-- Card Details (only if available) -->
      <div id="r_card_details" style="display:none;margin-bottom:5px;">
        <div style="display:flex;justify-content:space-between;">
          <span><b>Batch No:</b></span>
          <span id="r_batch"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Approval Code:</b></span>
          <span id="r_approval"></span>
        </div>
      </div>
      
      <!-- Cash Details (only if cash payment) -->
      <div id="r_cash_details" style="display:none;margin-bottom:5px;">
        <div style="display:flex;justify-content:space-between;">
          <span><b>Paid Amount:</b></span>
          <span id="r_paid"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Balance:</b></span>
          <span id="r_balance"></span>
        </div>
      </div>
      
      <!-- Separator -->
      <div style="border-bottom:1px dashed #000;margin:5px 0;"></div>
      
      <!-- Payment Summary -->
      <div style="margin-bottom:5px;">
        <div style="display:flex;justify-content:space-between;">
          <span>Subtotal:</span>
          <span id="r_subtotal"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span>GST (8%):</span>
          <span id="r_gst"></span>
        </div>
        <div style="display:flex;justify-content:space-between;font-weight:bold;border-top:1px solid #000;padding-top:2px;">
          <span>TOTAL:</span>
          <span id="r_total"></span>
        </div>
      </div>
      
      <!-- Separator -->
      <div style="border-bottom:1px dashed #000;margin:5px 0;"></div>
      
      <!-- Expiry Information -->
      <div style="text-align:center;margin-bottom:5px;" id="r_expiry_section">
        <div style="font-size:10px;"><b>VALID UNTIL</b></div>
        <div style="font-weight:bold;color:#e74c3c;font-size:12px;" id="r_expiry"></div>
      </div>
      
      <!-- Footer -->
      <div style="text-align:center;font-size:9px;margin-top:10px;">
        Thank you for choosing Koveli Lounge
      </div>
      <div style="text-align:center;font-size:8px;margin-top:3px;">
        ---------------------------------
      </div>
    </div>
  </div>

  <!-- Add Firebase SDK and your scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="fireW1.js"></script>
  <script src="rate1.js"></script>
  
  <!-- Company Information -->
  <script src="Co.js"></script>

  <script>
// ======== MAIN APPLICATION CODE ========

// Store current payment data
let currentPaymentData = null;
let receiptCounter = null;
let lastReceiptNumber = null;
let pendingSyncQueue = [];
let isSyncing = false;
let currentUser = null;
let foundReceiptData = null;
let isSupervisor = false;

// Maldives timezone offset (UTC+5 hours in milliseconds)
const MALDIVES_OFFSET = 5 * 60 * 60 * 1000;

// ----------- SHIFT MANAGEMENT CONSTANTS -----------
const SHIFT_STORAGE_KEY = 'currentShiftData_PAYMENT';
const SHIFT_TIMESTAMP_KEY = 'shiftDataTimestamp_PAYMENT';
const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes in milliseconds

// Check if Firebase is initialized
function checkFirebase() {
  if (!window.walkinDb) {
    console.error("Firebase not initialized. Check fireW.js");
    return false;
  }
  return true;
}

// Check if Company Info is loaded
function checkCompanyInfo() {
  if (!window.companyInfo) {
    console.warn("Company info not loaded from Co.js");
    // Provide default values
    window.companyInfo = {
      name: "Koveli Lounge",
      address: "Velana International Airport",
      phone: "+960 304 6677"
    };
  }
}

// ======== SHIFT MANAGEMENT FUNCTIONS ========
function getMaldivesTime() {
    const now = new Date();
    return new Date(now.getTime() + MALDIVES_OFFSET);
}

function parseFirebaseDate(dateString) {
    // Parse Firebase date string like "2025-12-19"
    if (!dateString) return new Date();
    
    const parts = dateString.split('-');
    if (parts.length !== 3) {
        console.error("Invalid date format:", dateString);
        return new Date();
    }
    
    const year = parseInt(parts[0]);
    const month = parseInt(parts[1]) - 1;
    const day = parseInt(parts[2]);
    
    return new Date(year, month, day);
}

function getDateKeyFromFirebaseDate(dateString) {
    // Convert Firebase date string "2025-12-19" to key "2025_12_19"
    if (!dateString) return '';
    return dateString.replace(/-/g, '_');
}

// ----------- INITIALIZE SHIFT FIREBASE -----------
function initializeShiftFirebase() {
    try {
        console.log("Initializing Firebase for shift data...");
        
        // Check if shift config is loaded from fireshift.js
        if (typeof firebaseConfig === 'undefined' && typeof shiftFirebaseConfig === 'undefined') {
            console.error("‚ùå Shift Firebase config not found in fireshift.js");
            showNotification("Firebase configuration not found", "error");
            return null;
        }
        
        // Use whichever config is available
        const config = firebaseConfig || shiftFirebaseConfig;
        console.log("Using Firebase config for project:", config.projectId);
        
        // Check if Firebase app already exists
        let app;
        try {
            // Try to get existing app
            app = firebase.app('shiftApp');
            console.log("Using existing Firebase app: shiftApp");
        } catch (e) {
            // Create new app for shifts
            app = firebase.initializeApp(config, 'shiftApp');
            console.log("Created new Firebase app: shiftApp");
        }
        
        // Initialize Firestore
        const shiftFirestore = firebase.firestore(app);
        console.log("‚úÖ Shift Firestore initialized successfully");
        
        return shiftFirestore;
        
    } catch (error) {
        console.error("‚ùå Error initializing shift Firebase:", error);
        showNotification("Failed to initialize Firebase for shift data", "error");
        return null;
    }
}

// ----------- CHECK FOR OPEN SHIFT -----------
function checkForOpenShift(shiftData) {
    console.log("üîç Checking for open shift in data...");
    
    let result = {
        success: false,
        isActive: false,
        shiftName: "No Shift Open",
        shiftType: "",
        openTime: "",
        details: {},
        firebaseDate: shiftData?.date || ""
    };
    
    if (!shiftData) {
        return result;
    }
    
    // Check morning shift
    if (shiftData.morning && shiftData.morning.status === 'open') {
        result.success = true;
        result.isActive = true;
        result.shiftName = "Morning Shift";
        result.shiftType = "morning";
        result.openTime = shiftData.morning.open || "";
        result.details = shiftData.morning;
        console.log("‚úì Morning shift is OPEN");
        return result;
    }
    
    // Check evening shift
    if (shiftData.evening && shiftData.evening.status === 'open') {
        result.success = true;
        result.isActive = true;
        result.shiftName = "Evening Shift";
        result.shiftType = "evening";
        result.openTime = shiftData.evening.open || "";
        result.details = shiftData.evening;
        console.log("‚úì Evening shift is OPEN");
        return result;
    }
    
    // Check if both shifts are "not_available"
    if (shiftData.morning && shiftData.morning.status === "not_available" && 
        shiftData.evening && shiftData.evening.status === "not_available") {
        result.success = true;
        result.shiftName = "Shifts Not Started Today";
        console.log("‚è≥ Both shifts not available yet");
        return result;
    }
    
    // Check if both shifts are closed
    if ((!shiftData.morning || shiftData.morning.status === "closed") && 
        (!shiftData.evening || shiftData.evening.status === "closed")) {
        result.success = true;
        result.shiftName = "All Shifts Closed";
        console.log("üîí All shifts closed");
        return result;
    }
    
    // Default case
    result.success = true;
    return result;
}

// ----------- FETCH SHIFT DATA (SAME AS DASHBOARD) -----------
async function fetchShiftDataFromFirebase(forceRefresh = false) {
    console.log("üåê Fetching shift data from Firebase...");
    
    try {
        // Initialize Firebase for shifts if not done yet
        let shiftFirestore = initializeShiftFirebase();
        if (!shiftFirestore) {
            throw new Error("Failed to initialize Firebase for shifts");
        }
        
        // Get current Maldives time
        const maldivesNow = getMaldivesTime();
        const todayMaldivesDate = maldivesNow.toISOString().split('T')[0]; // YYYY-MM-DD
        
        console.log("üìÖ Today's Maldives date (ISO):", todayMaldivesDate);
        
        // Try today first, then yesterday, then day before
        let foundShiftData = null;
        let foundFirebaseDate = null;
        let foundDate = null;
        let shiftCheck = null;
        let daysBack = 0;
        let docId = '';
        
        for (let i = 0; i < 3; i++) {
            // Calculate date to check (today - i days)
            const checkDate = new Date(maldivesNow);
            checkDate.setDate(maldivesNow.getDate() - i);
            const checkDateString = checkDate.toISOString().split('T')[0]; // YYYY-MM-DD
            const checkDateKey = checkDateString.replace(/-/g, '_');
            docId = `shift_${checkDateKey}`;
            
            console.log(`üìÖ Checking ${i} day(s) back: ${checkDateString} (doc: ${docId})`);
            
            try {
                // SINGLE READ per date
                const shiftDoc = await shiftFirestore.collection("shifts").doc(docId).get();
                
                if (shiftDoc.exists) {
                    const shiftData = shiftDoc.data();
                    console.log(`‚úÖ Found document for ${checkDateString}`);
                    
                    // Check if this document has an open shift
                    const checkResult = checkForOpenShift(shiftData);
                    
                    if (checkResult.isActive) {
                        console.log(`üéâ Found open shift ${i} day(s) back`);
                        foundShiftData = shiftData;
                        foundFirebaseDate = shiftData.date || checkDateString;
                        foundDate = parseFirebaseDate(foundFirebaseDate);
                        shiftCheck = checkResult;
                        daysBack = i;
                        break; // Stop searching when we find an open shift
                    }
                }
            } catch (error) {
                console.error(`‚ùå Error checking ${checkDateString}:`, error);
                // Continue to next date
            }
        }
        
        if (!foundShiftData) {
            console.log("‚ö†Ô∏è No open shift found in any date");
            return {
                success: false,
                message: "No open shift found",
                date: todayMaldivesDate,
                isActive: false,
                timestamp: new Date().toISOString()
            };
        }
        
        const shiftDateObj = parseFirebaseDate(foundFirebaseDate);
        
        let dateIndicator = "";
        if (daysBack === 1) {
            dateIndicator = " (Yesterday)";
        } else if (daysBack === 2) {
            dateIndicator = " (Day before)";
        } else if (daysBack > 2) {
            dateIndicator = ` (${daysBack} days ago)`;
        }
        
        // Format date for display
        const shiftDateDisplay = shiftDateObj.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        }) + dateIndicator;
        
        const currentDateObj = parseFirebaseDate(todayMaldivesDate);
        const currentDateDisplay = shiftDateObj.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        const isDifferentDay = shiftDateDisplay !== currentDateDisplay;
        
        const result = {
            success: true,
            name: shiftCheck.shiftName,
            shiftDateDisplay: shiftDateDisplay,
            rawShiftDate: shiftDateObj,
            firebaseDate: foundFirebaseDate,
            foundDateKey: getDateKeyFromFirebaseDate(foundFirebaseDate),
            isActive: shiftCheck.isActive,
            openTime: shiftCheck.openTime,
            shiftType: shiftCheck.shiftType,
            fullData: foundShiftData,
            isFromPreviousDay: isDifferentDay,
            daysBack: daysBack,
            timestamp: new Date().toISOString(),
            documentId: docId,
            // Store this for payment page
            currentShiftInfo: {
                shift: shiftCheck.shiftType,
                shiftDate: foundFirebaseDate, // Store as string "2025-12-19"
                shiftDateKey: getDateKeyFromFirebaseDate(foundFirebaseDate),
                shiftName: shiftCheck.shiftName,
                isPreviousDay: isDifferentDay,
                shiftDateDisplay: shiftDateDisplay
            }
        };
        
        console.log("üì¶ Final shift data result:", result);
        
        // Save to localStorage for payment page
        saveShiftToLocalStorage(result);
        
        // Also save the current shift info separately for easy access
        localStorage.setItem('currentShiftInfo', JSON.stringify(result.currentShiftInfo));
        
        return result;
        
    } catch (error) {
        console.error("‚ùå Error fetching shift data:", error);
        return {
            success: false,
            message: "Error: " + error.message,
            timestamp: new Date().toISOString()
        };
    }
}

// ----------- SAVE TO LOCAL STORAGE -----------
function saveShiftToLocalStorage(shiftData) {
    try {
        localStorage.setItem(SHIFT_STORAGE_KEY, JSON.stringify(shiftData));
        localStorage.setItem(SHIFT_TIMESTAMP_KEY, new Date().toISOString());
        console.log("üíæ Saved shift data to localStorage");
    } catch (e) {
        console.error("‚ùå Error saving to localStorage:", e);
    }
}

// ----------- LOAD FROM LOCAL STORAGE -----------
function loadShiftFromLocalStorage() {
    try {
        const savedData = localStorage.getItem(SHIFT_STORAGE_KEY);
        const savedTimestamp = localStorage.getItem(SHIFT_TIMESTAMP_KEY);
        
        if (!savedData || !savedTimestamp) {
            console.log("üì≠ No saved shift data found");
            return null;
        }
        
        const data = JSON.parse(savedData);
        const timestamp = new Date(savedTimestamp);
        const now = new Date();
        const age = now - timestamp;
        
        console.log("üìÇ Loaded shift data from localStorage (age:", Math.floor(age/1000), "seconds)");
        
        // Data is considered fresh if less than cache duration
        if (age < CACHE_DURATION) {
            return data;
        } else {
            console.log("üìõ Saved data is outdated");
            return null;
        }
        
    } catch (e) {
        console.error("‚ùå Error loading from localStorage:", e);
        return null;
    }
}

// ----------- GET CURRENT SHIFT FOR PAYMENTS -----------
function getCurrentShiftInfo() {
    // Try to get from localStorage first (cached)
    const cachedShift = localStorage.getItem('currentShiftInfo');
    
    if (cachedShift) {
        try {
            const shiftInfo = JSON.parse(cachedShift);
            console.log("üìã Using cached shift info:", shiftInfo);
            return shiftInfo;
        } catch (e) {
            console.error("Error parsing cached shift info:", e);
        }
    }
    
    // Default fallback
    const maldivesNow = getMaldivesTime();
    const todayDate = maldivesNow.toISOString().split('T')[0];
    
    return {
        shift: "morning",
        shiftDate: todayDate,
        shiftDateKey: getDateKeyFromFirebaseDate(todayDate),
        shiftName: "Morning Shift",
        isPreviousDay: false,
        shiftDateDisplay: "Today"
    };
}

// ----------- REFRESH SHIFT DATA -----------
async function refreshShiftData(showNotification = true) {
    console.log("üîÑ Refreshing shift data...");
    
    try {
        const result = await fetchShiftDataFromFirebase(true);
        
        if (result.success && result.isActive) {
            // Update UI with shift info
            updateShiftDisplay(result);
            
            if (showNotification) {
                showMessage(`Shift updated: ${result.name} (${result.firebaseDate})`, "success");
            }
            
            return result;
        } else {
            if (showNotification) {
                showMessage("No active shift found", "warning");
            }
            return result;
        }
    } catch (error) {
        console.error("Error refreshing shift data:", error);
        if (showNotification) {
            showMessage("Failed to refresh shift data", "error");
        }
        return null;
    }
}

// ----------- UPDATE SHIFT DISPLAY IN UI -----------
function updateShiftDisplay(shiftData) {
    if (!shiftData) {
        // Try to get cached data
        const cachedData = loadShiftFromLocalStorage();
        if (cachedData) {
            shiftData = cachedData;
        } else {
            document.getElementById("currentShiftDate").value = "Not Available";
            document.getElementById("currentShiftName").value = "No Shift";
            document.getElementById("shiftInfoDisplay").innerHTML = "Shift info not available";
            return;
        }
    }
    
    const dateField = document.getElementById("currentShiftDate");
    const shiftField = document.getElementById("currentShiftName");
    const infoDisplay = document.getElementById("shiftInfoDisplay");
    
    if (dateField) {
        dateField.value = shiftData.firebaseDate || "Not Available";
    }
    
    if (shiftField) {
        shiftField.value = shiftData.name || "No Shift";
    }
    
    if (infoDisplay) {
        const cachedTime = shiftData.timestamp ? 
            new Date(shiftData.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 
            "Just now";
        
        let statusIndicator = "";
        if (!shiftData.isActive) {
            statusIndicator = '<span style="color: #e74c3c; font-weight: bold;"> (INACTIVE)</span>';
        }
        
        infoDisplay.innerHTML = `
            <span style="font-weight: bold; color: #ffd700;">Date: ${shiftData.firebaseDate || "N/A"}</span> | 
            <span style="font-weight: bold; color: #87ceeb;">Shift: ${shiftData.name || "No Shift"}${statusIndicator}</span>
            <button style="padding: 2px 8px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; color: white; cursor: pointer; font-size: 11px; margin-left: 5px;" 
                    onclick="refreshShiftData(true)" title="Refresh from Firebase">
                üîÑ Refresh
            </button>
        `;
    }
}

// ======== NOTIFICATION SYSTEM ========
function showNotification(message, type = 'info', duration = 3000) {
  const container = document.getElementById('notificationContainer');
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  notification.style.animationDuration = `${duration/1000}s`;
  
  container.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, duration);
}

// ----------- SHOW MESSAGE FUNCTION -----------
function showMessage(message, type = "info") {
    showNotification(message, type, 3000);
}

// ======== USER MANAGEMENT ========
function getCurrentUser() {
  // Check if user is logged in from localStorage
  const userData = JSON.parse(localStorage.getItem("loggedInUser"));
  
  if (!userData) {
    // Redirect to login page if not logged in
    window.location.href = "login.html";
    return null;
  }
  
  currentUser = userData.name || userData.username;
  isSupervisor = userData.Level === 'Supervisor';
  
  // Display user info
  document.getElementById('currentUser').textContent = currentUser;
  
  // Check supervisor status
  const supervisorCleanupSection = document.getElementById('supervisorCleanupSection');
  
  if (isSupervisor) {
    supervisorCleanupSection.style.display = 'block';
    showNotification(`Welcome Supervisor ${currentUser}!`, 'success');
  } else {
    supervisorCleanupSection.style.display = 'none';
    showNotification(`Welcome ${currentUser}!`, 'success');
  }
  
  return userData;
}

function logoutUser() {
  if (confirm("Are you sure you want to logout?")) {
    localStorage.removeItem('loggedInUser');
    window.location.href = "login.html";
  }
}

// ======== RECEIPT NUMBER MANAGEMENT ========
async function getNextReceiptNumber() {
  try {
    // Check if we have a pending receipt number in localStorage
    const pendingReceipt = JSON.parse(localStorage.getItem('pendingReceiptNumber') || 'null');
    if (pendingReceipt && pendingReceipt.number && !pendingReceipt.used) {
      console.log("Using pending receipt number:", pendingReceipt.number);
      // Mark as used
      localStorage.setItem('pendingReceiptNumber', JSON.stringify({
        ...pendingReceipt,
        used: true
      }));
      return pendingReceipt.number;
    }
    
    // Always try to get the highest number from Firebase first
    if (checkFirebase()) {
      try {
        const receiptsRef = window.walkinDb.collection("receipts");
        
        // Get the highest receipt number from Firebase
        const snapshot = await receiptsRef
          .orderBy("receiptNumber", "desc")
          .limit(1)
          .get();
        
        let nextNumber = 1564; // Default start
        
        if (!snapshot.empty) {
          const latestReceipt = snapshot.docs[0].data();
          const firebaseNumber = latestReceipt.receiptNumber || 1563;
          
          // Get local counter
          const localCounter = parseInt(localStorage.getItem('receiptCounter') || '1563');
          
          // Use the HIGHER number between Firebase and local
          nextNumber = Math.max(firebaseNumber, localCounter) + 1;
          
          console.log(`Firebase: ${firebaseNumber}, Local: ${localCounter}, Next: ${nextNumber}`);
        } else {
          // No receipts in Firebase yet, use local
          const localCounter = parseInt(localStorage.getItem('receiptCounter') || '1563');
          nextNumber = Math.max(localCounter + 1, 1564);
        }
        
        // Format receipt number WITHOUT leading zeros
        const receiptNumber = nextNumber.toString(); // Just "57777" not "0057777"
        
        // Reserve this number locally to prevent conflicts
        localStorage.setItem('pendingReceiptNumber', JSON.stringify({
          number: receiptNumber,
          numeric: nextNumber,
          timestamp: new Date().toISOString(),
          used: false
        }));
        
        // Update local counter immediately
        localStorage.setItem('receiptCounter', nextNumber.toString());
        
        return receiptNumber;
        
      } catch (firebaseError) {
        console.warn("Firebase receipt number fetch failed, using local:", firebaseError);
        // Fall through to local storage
      }
    }
    
    // Fallback to local storage
    return getNextLocalReceiptNumber();
    
  } catch (error) {
    console.error("Error getting next receipt number:", error);
    // Final fallback
    return getNextLocalReceiptNumber();
  }
}

function getNextLocalReceiptNumber() {
  const key = 'receiptCounter';
  let counter = localStorage.getItem(key);
  
  if (!counter) {
    // Start from 1564 when no counter exists
    counter = "1564";
    localStorage.setItem(key, counter);
  } else {
    counter = (parseInt(counter) + 1).toString();
    localStorage.setItem(key, counter);
  }
  
  // Receipt number is just the number (no leading zeros)
  const receiptNumber = counter;
  
  // Reserve this number locally to prevent conflicts
  localStorage.setItem('pendingReceiptNumber', JSON.stringify({
    number: receiptNumber,
    numeric: parseInt(receiptNumber),
    timestamp: new Date().toISOString(),
    used: false
  }));
  
  return receiptNumber;
}

// ======== CONFIRM RECEIPT NUMBER USAGE ========
function confirmReceiptNumberUsed(receiptNo) {
  try {
    // Mark the pending receipt number as used
    const pendingReceipt = JSON.parse(localStorage.getItem('pendingReceiptNumber') || 'null');
    if (pendingReceipt && pendingReceipt.number === receiptNo) {
      localStorage.setItem('pendingReceiptNumber', JSON.stringify({
        ...pendingReceipt,
        used: true
      }));
    }
    
    // Also update the last used receipt
    localStorage.setItem('lastUsedReceipt', receiptNo);
    
    // Update Firebase with the used receipt number
    if (checkFirebase()) {
      const numericReceipt = parseInt(receiptNo);
      if (!isNaN(numericReceipt)) {
        // Save to receipts collection in Firebase
        window.walkinDb.collection("receipts").doc(`receipt_${receiptNo}`).set({
          receiptNumber: numericReceipt,
          formattedNumber: receiptNo,
          usedAt: new Date().toISOString(),
          usedBy: currentUser || 'Unknown',
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true }).catch(error => {
          console.warn("Could not update Firebase receipt number:", error);
        });
      }
    }
    
  } catch (error) {
    console.error("Error confirming receipt number usage:", error);
  }
}

// ======== FILTER BY CURRENT DAY - TIMEZONE AWARE ========
function getMaldivesTodayRange() {
  // Get today's start and end in Maldives timezone
  const maldivesNow = getMaldivesTime();
  
  // Start of day in Maldives (00:00:00)
  const start = new Date(maldivesNow);
  start.setUTCHours(0, 0, 0, 0);
  const startUTC = new Date(start.getTime() - MALDIVES_OFFSET);
  
  // End of day in Maldives (23:59:59.999)
  const end = new Date(maldivesNow);
  end.setUTCHours(23, 59, 59, 999);
  const endUTC = new Date(end.getTime() - MALDIVES_OFFSET);
  
  return { start: startUTC, end: endUTC };
}

function parsePaymentDate(payment) {
  // Parse payment date consistently with timezone awareness
  
  // First, check for voided timestamp (for voided receipts)
  if (payment.voidedAt) {
    const voidDate = new Date(payment.voidedAt);
    if (!isNaN(voidDate.getTime())) {
      return voidDate;
    }
  }
  
  // Try different timestamp fields
  if (payment.timestamp) {
    if (payment.timestamp.toDate) {
      return payment.timestamp.toDate();
    } else if (typeof payment.timestamp === 'string') {
      return new Date(payment.timestamp);
    } else if (payment.timestamp.seconds) {
      // Firebase Timestamp
      return new Date(payment.timestamp.seconds * 1000);
    }
  }
  
  if (payment.localSaveTime) {
    const date = new Date(payment.localSaveTime);
    if (!isNaN(date.getTime())) return date;
  }
  
  if (payment.time) {
    const date = new Date(payment.time);
    if (!isNaN(date.getTime())) return date;
  }
  
  if (payment.createdAt) {
    const date = new Date(payment.createdAt);
    if (!isNaN(date.getTime())) return date;
  }
  
  // Fallback: Use current date
  return new Date();
}

function isTodayInMaldives(date) {
  // Check if a date is today in Maldives timezone
  const { start, end } = getMaldivesTodayRange();
  return date >= start && date <= end;
}

function filterByCurrentDay(payments) {
  const { start, end } = getMaldivesTodayRange();
  
  console.log('Filtering payments for Maldives day:', {
    start: start.toISOString(),
    end: end.toISOString(),
    localStart: new Date(start.getTime() + MALDIVES_OFFSET).toLocaleString(),
    localEnd: new Date(end.getTime() + MALDIVES_OFFSET).toLocaleString(),
    totalPayments: payments.length
  });
  
  const filteredPayments = payments.filter(payment => {
    // Skip payments that are clearly old (check receipt number if available)
    if (payment.receiptNo) {
      const receiptNum = parseInt(payment.receiptNo);
      if (receiptNum < 1564) {
        return false; // Too old, ignore
      }
    }
    
    // Parse payment date with timezone awareness
    const paymentDate = parsePaymentDate(payment);
    
    if (isNaN(paymentDate.getTime())) {
      console.warn('Invalid date for payment:', payment.receiptNo);
      return false;
    }
    
    // Check if payment is within today's range in Maldives timezone
    const isToday = paymentDate >= start && paymentDate <= end;
    
    if (!isToday) {
      console.log('Payment filtered out (not today):', {
        receiptNo: payment.receiptNo,
        paymentDate: paymentDate.toISOString(),
        maldivesDate: new Date(paymentDate.getTime() + MALDIVES_OFFSET).toLocaleString(),
        inRange: paymentDate >= start && paymentDate <= end
      });
    }
    
    return isToday;
  });
  
  console.log(`Filtered ${filteredPayments.length} payments for today (out of ${payments.length})`);
  return filteredPayments;
}

// ======== LOCAL STORAGE FUNCTIONS ========
function saveToLocalStorage(data) {
  try {
    const pendingPayments = JSON.parse(localStorage.getItem('pendingPayments') || '[]');
    
    // Add Maldives timestamp for consistency
    data.maldivesTimestamp = getMaldivesTime().toISOString();
    
    // Check if payment already exists
    const existingIndex = pendingPayments.findIndex(p => p.id === data.id);
    
    if (existingIndex !== -1) {
      // Update existing payment
      pendingPayments[existingIndex] = data;
    } else {
      // Add new payment
      pendingPayments.push(data);
    }
    
    localStorage.setItem('pendingPayments', JSON.stringify(pendingPayments));
    
    // Add to sync queue if not already there
    const inQueue = pendingSyncQueue.some(p => p.id === data.id);
    if (!inQueue) {
      pendingSyncQueue.push(data);
    }
    
    // Start sync process if not already running
    if (!isSyncing && checkFirebase()) {
      syncPendingPayments();
    }
    
    return data.id;
  } catch (error) {
    console.error("Error saving to localStorage:", error);
    throw error;
  }
}

function getPendingPayments() {
  try {
    return JSON.parse(localStorage.getItem('pendingPayments') || '[]');
  } catch (error) {
    console.error("Error getting pending payments:", error);
    return [];
  }
}

// ======== SAVE PAYMENT WITH SHIFT DATA ========
async function savePayment(data) {
  try {
    // Generate receipt number
    if (!data.receiptNo) {
      data.receiptNo = await getNextReceiptNumber();
    }
    
    console.log("Saving payment. Receipt No:", data.receiptNo, "Type:", typeof data.receiptNo);
    
    // CONFIRM the receipt number is being used
    confirmReceiptNumberUsed(data.receiptNo);
    
    // Add current user to data
    data.staff = currentUser;
    const userData = JSON.parse(localStorage.getItem("loggedInUser"));
    data.userId = userData ? userData.id : '';
    
    // Get current shift information for payment data
    const currentShift = getCurrentShiftInfo();
    
    // Add shift information to data
    data.shiftDate = currentShift.shiftDate; // From Firebase "2025-12-19"
    data.shiftName = currentShift.shiftName; // "Morning Shift" or "Evening Shift"
    data.shiftType = currentShift.shift; // "morning" or "evening"
    
    // Add Maldives timestamp
    data.maldivesTimestamp = getMaldivesTime().toISOString();
    
    // DOCUMENT ID IS THE RECEIPT NUMBER
    const docId = data.receiptNo.toString(); // Ensure it's a string
    data.id = docId;
    
    console.log("Document ID set to:", docId);
    console.log("Shift data attached:", {
      shiftDate: data.shiftDate,
      shiftName: data.shiftName,
      shiftType: data.shiftType
    });
    
    // Create complete payment record with timestamp
    const paymentRecord = {
      ...data,
      timestamp: new Date().toISOString(),
      localSaveTime: new Date().toISOString(),
      maldivesDate: getMaldivesTime().toISOString(),
      synced: false,
      syncAttempts: 0
    };
    
    // Save to localStorage immediately (fast)
    saveToLocalStorage(paymentRecord);
    
    // Update current payment data
    currentPaymentData = {
      id: docId,
      ...data
    };
    
    // Update header display
    document.getElementById("headerReceiptNo").textContent = data.receiptNo;
    
    // Show success notification with shift info
    showNotification(`Saved locally: ${data.receiptNo} (${currentShift.shiftName} - ${currentShift.shiftDate})`, 'success');
    
    return { id: docId, receiptNo: data.receiptNo };
    
  } catch (error) {
    console.error("Error in savePayment:", error);
    throw error;
  }
}

// ======== UPDATE SAVE NOW FUNCTION WITH SHIFT CHECK ========
async function saveNow(){
  // Check if rates are loaded
  if (!window.rates) {
    showNotification("Error: Rates not loaded. Check rate.js", "error");
    return;
  }

  // Get current shift information
  const currentShift = getCurrentShiftInfo();
  
  // Check if we have a valid shift date
  if (!currentShift.shiftDate || currentShift.shiftDate === "") {
    showNotification("Error: No shift date available. Please refresh shift data.", "error");
    return;
  }
  
  // Warn if using previous day shift
  if (currentShift.isPreviousDay) {
    if (!confirm(`WARNING: You are saving to previous day's shift (${currentShift.shiftDate}). Continue anyway?`)) {
      return;
    }
  }

  const paymentType = document.getElementById("paymentType").value;
  const total = parseFloat(document.getElementById("total").value) || 0;
  
  // Calculate expiry time (using Maldives timezone)
  const expiryData = calculateExpiryTime();
  
  // OPTIMIZED DATA STRUCTURE - Save only essential data
  const data = {
    time: new Date().toISOString(),
    name: document.getElementById("name").value,
    flightNo: document.getElementById("flightNo").value,
    seatNo: document.getElementById("seatNo").value,
    shiftDate: currentShift.shiftDate, // Use date from shift data
    shiftName: currentShift.shiftName, // Use shift name from shift data
    shiftType: currentShift.shift, // "morning" or "evening"
    adults: parseInt(document.getElementById("adults").value),
    kids: parseInt(document.getElementById("kids").value),
    currency: document.getElementById("currency").value,
    paymentType: paymentType,
    total: total,
    expiryFormatted: expiryData.formatted,
    expiryTimestamp: expiryData.timestamp,
    firstReceiptPrinted: false,
    finalReceiptPrinted: false,
    cardDetailsAdded: false,
    voided: false // Initialize as not voided
  };
  
  // Add payment-specific fields
  if (paymentType === "Cash") {
    const paidAmount = parseFloat(document.getElementById("paidAmount").value) || 0;
    const balance = paidAmount - total;
    
    data.paidAmount = paidAmount;
    data.balance = balance;
    data.cardDetailsAdded = true; // Cash payments are complete immediately
    data.finalReceiptPrinted = false; // Cash payments need final receipt
  }
  
  // Validate data
  if (!data.name || !data.flightNo) {
    showNotification("Please fill in passenger name and flight number", "warning");
    return;
  }
  
  if (isNaN(data.total) || data.total <= 0) {
    showNotification("Invalid payment amount. Check passenger details.", "warning");
    return;
  }
  
  // Validate cash payment
  if (paymentType === "Cash") {
    if (data.paidAmount < data.total) {
      if (!confirm(`Paid amount (${data.paidAmount}) is less than total (${data.total}). Continue anyway?`)) {
        return;
      }
    }
  }
  
  // Check for duplicate pending payment
  const pendingPayments = getPendingPayments();
  const duplicate = pendingPayments.find(p => 
    p.name === data.name && 
    p.flightNo === data.flightNo &&
    !p.voided &&
    Math.abs(parsePaymentDate(p).getTime() - new Date().getTime()) < 60000 // Within 1 minute
  );
  
  if (duplicate) {
    if (!confirm(`A payment for ${data.name} (${data.flightNo}) was recently saved. Create another receipt?`)) {
      return;
    }
  }
  
  try {
    // Save immediately (local storage first, then background sync to Firebase)
    const result = await savePayment(data);
    currentPaymentData = {
      id: result.id,
      receiptNo: result.receiptNo,
      ...data
    };
    
    console.log("Payment saved locally. ID:", result.id, "Receipt No:", result.receiptNo);
    console.log("Shift data saved:", {
      shiftDate: data.shiftDate,
      shiftName: data.shiftName
    });
    
    // Auto-print first receipt
    setTimeout(() => {
      printReceipt('first');
    }, 300);
    
    // Reset form for next entry
    resetFormForNextEntry();
    
  } catch (error) {
    console.error("Error in saveNow:", error);
    showNotification("Error saving payment: " + error.message, "error");
  }
}

// ======== AUTO EVENT LISTENERS ========
window.onload = async function(){
  // Initialize company info
  checkCompanyInfo();
  
  // Get current user from localStorage
  getCurrentUser();
  
  // Check if Firebase is initialized
  if (!checkFirebase()) {
    showNotification("Firebase not initialized. Working in offline mode.", "warning", 5000);
  } else {
    console.log("Firebase is ready");
  }
  
  // Load shift data from localStorage or fetch from Firebase
  const cachedShiftData = loadShiftFromLocalStorage();
  if (cachedShiftData) {
    updateShiftDisplay(cachedShiftData);
    console.log("Using cached shift data");
  } else {
    // Fetch fresh shift data
    console.log("No cached shift data, fetching from Firebase...");
    showNotification("Loading shift data...", "info", 2000);
    await refreshShiftData(false);
  }
  
  updatePricing();
  togglePaymentFields();

  // Live update pricing
  ['adults','kids','rateType','currency'].forEach(id=>{
    document.getElementById(id).addEventListener('input', updatePricing);
    document.getElementById(id).addEventListener('change', updatePricing);
  });
  
  // Update cash fields when paid amount changes
  document.getElementById("paidAmount").addEventListener('input', updateCashFields);
  
  // Toggle payment fields when payment type changes
  document.getElementById("paymentType").addEventListener('change', function() {
    togglePaymentFields();
    
    // Update the modal payment method dropdown to match selection
    const selectedMethod = this.value;
    if (selectedMethod !== 'Cash') {
      // When selecting a non-cash method, pre-select it in modal
      const modalPaymentMethod = document.getElementById("modalPaymentMethod");
      if (modalPaymentMethod) {
        // Find and select the option
        for (let option of modalPaymentMethod.options) {
          if (option.value === selectedMethod) {
            option.selected = true;
            break;
          }
        }
      }
    }
  });

  // Auto parse code as user types
  document.getElementById("codeInput").addEventListener('input', parseCode);
  
  // Prevent focus on readonly fields
  ['subtotal','gst','total','balance'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('focus', function() { this.blur(); });
    }
  });
  
  // Close modals when clicking outside
  document.getElementById("cardDetailsModal").addEventListener('click', function(e) {
    if (e.target === this) {
      closeModal();
    }
  });
  
  document.getElementById("searchResultModal").addEventListener('click', function(e) {
    if (e.target === this) {
      closeSearchModal();
    }
  });
  
  // Search on Enter key in receipt search
  document.getElementById("receiptSearch").addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      searchReceipt();
    }
  });
  
  // Initialize expiry time
  calculateExpiryTime();
  
  // Cleanup old local payment data on startup
  setTimeout(() => {
    cleanupOldLocalPayments();
  }, 3000);
  
  // Start syncing any pending payments
  setTimeout(() => {
    pendingSyncQueue = getPendingPayments().filter(p => !p.synced);
    if (pendingSyncQueue.length > 0 && checkFirebase()) {
      syncPendingPayments();
      showNotification(`Syncing ${pendingSyncQueue.length} pending payments...`, "info", 3000);
    }
  }, 2000);
  
  // Auto-refresh shift data every 5 minutes
  setInterval(() => {
    refreshShiftData(false);
  }, 5 * 60 * 1000);
};
  </script>
</body>
</html>
