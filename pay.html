<!DOCTYPE html>
<html>
<head>
  <title>Passenger Payment POS</title>
  <style>
    /* ======== GOLDEN THEME STYLES ======== */
    :root {
      --gold-light: #faf3e0;
      --gold-medium: #f5e6ca;
      --gold-dark: #d4b483;
      --gold-accent: #c19a6b;
      --gold-deep: #b8860b;
      --text-dark: #333333;
      --text-medium: #5a4a42;
      --text-light: #7a6a62;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, var(--gold-light) 0%, var(--gold-medium) 100%);
      min-height: 100vh;
      color: var(--text-dark);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .containerB {
      max-width: 1200px;
      margin: 0 auto;
      height: auto;
      min-height: 0;
      padding: 1px 0;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 20px 25px;
      background: linear-gradient(135deg, var(--gold-accent) 0%, var(--gold-deep) 100%);
      color: white;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(193, 154, 107, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .header-left h1 {
      margin: 0;
      font-size: 26px;
      font-weight: 600;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .header-left p {
      margin: 5px 0 0;
      opacity: 0.95;
      font-size: 14px;
      font-weight: 300;
    }
    
    .shift-display {
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 15px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 13px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      min-width: 200px;
      text-align: center;
      cursor: pointer;
    }
    
    .shift-display:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .shift-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }
    
    .shift-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }
    
    .shift-morning-dot {
      background-color: #3498db;
    }
    
    .shift-evening-dot {
      background-color: #9b59b6;
    }
    
    .shift-date {
      font-size: 11px;
      opacity: 0.9;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .search-container {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .home-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 7px 20px;
      background-color: #f5ede9;
      color: rgb(0, 0, 0);
      border: #ffffff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      text-decoration: none;
      transition: background-color 0.3s;
    }

    .home-btn:hover {
      background-color: #da7f3e;
      text-decoration: none;
      color: white;
    }

    .home-btn .icon-home {
      margin-right: 8px;
      font-size: 18px;
    }
    
    .search-input {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      width: 200px;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.9);
    }
    
    .search-btn {
      padding: 8px 15px;
      background: rgba(255, 255, 255, 0.9);
      color: var(--gold-deep);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .search-btn:hover {
      background: white;
      transform: translateY(-1px);
    }
    
    .main-content {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(193, 154, 107, 0.1);
      flex: 1;
      min-width: 300px;
      border: 1px solid var(--gold-medium);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(193, 154, 107, 0.15);
    }
    
    .card h3 {
      margin-top: 0;
      color: var(--gold-deep);
      padding-bottom: 10px;
      border-bottom: 2px solid var(--gold-dark);
      font-size: 18px;
      font-weight: 600;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text-medium);
      font-size: 14px;
    }
    
    .input-group input, .input-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gold-medium);
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
      transition: all 0.3s;
      background-color: white;
      color: var(--text-dark);
    }
    
    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: var(--gold-accent);
      box-shadow: 0 0 0 3px rgba(193, 154, 107, 0.2);
    }
    
    .input-group input[readonly] {
      background-color: var(--gold-light);
      font-weight: 600;
      color: var(--text-dark);
      border-color: var(--gold-dark);
      padding: 8px 12px;
      font-size: 13px;
    }
    
    .row {
      display: flex;
      gap: 12px;
    }
    
    .row .input-group {
      flex: 1;
    }
    
    .boarding-pass-section {
      background: linear-gradient(135deg, #fff9f0 0%, #fef5e7 100%);
      border-left: 4px solid var(--gold-accent);
      width: 100%;
      margin-bottom: 20px;
      border: 1px solid var(--gold-dark);
    }
    
    .boarding-pass-section h3 {
      border-bottom-color: var(--gold-accent);
    }
    
    .section-note {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 5px;
      font-style: italic;
    }
    
    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      flex: 1;
      min-width: 140px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .btn i {
      font-size: 16px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--gold-accent) 0%, var(--gold-deep) 100%);
      color: white;
      border: 1px solid var(--gold-dark);
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, var(--gold-deep) 0%, #a67c00 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(193, 154, 107, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
      border: 1px solid #229954;
    }
    
    .btn-success:hover {
      background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
      color: white;
      border: 1px solid #6c7b7d;
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, #7f8c8d 0%, #636e72 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(127, 140, 141, 0.3);
    }
    
    .btn-info {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      border: 1px solid #2573a7;
    }
    
    .btn-info:hover {
      background: linear-gradient(135deg, #2980b9 0%, #1f639b 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }
    
    .payment-summary {
      background: linear-gradient(135deg, #f8f9fa 0%, #f1f8e9 100%);
      border-left: 4px solid var(--gold-deep);
      border: 1px solid var(--gold-accent);
    }
    
    .payment-summary .input-group label {
      color: var(--text-dark);
      font-weight: 600;
      font-size: 13px;
    }
    
    .summary-value {
      font-size: 16px;
      font-weight: bold;
      color: var(--gold-deep);
      text-align: right;
    }
    
    #log {
      margin-top: 15px;
    }
    
    .logs-section {
      width: 100%;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      box-shadow: 0 2px 8px rgba(193, 154, 107, 0.1);
      border-radius: 6px;
      overflow: hidden;
    }
    
    th {
      background: linear-gradient(135deg, var(--gold-accent) 0%, var(--gold-deep) 100%);
      color: white;
      padding: 12px 14px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid var(--gold-dark);
      font-size: 14px;
    }
    
    td {
      padding: 10px 14px;
      border-bottom: 1px solid var(--gold-light);
      background-color: white;
      font-size: 13px;
    }
    
    tr:hover {
      background-color: var(--gold-light);
    }
    
    .action-btn {
      padding: 6px 12px;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      font-size: 12px;
    }
    
    .action-btn:hover {
      background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(231, 76, 60, 0.3);
    }
    
    .edit-btn {
      padding: 6px 12px;
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      font-size: 12px;
      margin-right: 4px;
    }
    
    .edit-btn:hover {
      background: linear-gradient(135deg, #2980b9 0%, #1f639b 100%);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(52, 152, 219, 0.3);
    }
    
    .complete-btn {
      padding: 6px 12px;
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      font-size: 12px;
      margin-right: 4px;
    }
    
    .complete-btn:hover {
      background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(46, 204, 113, 0.3);
    }
    
    .print-btn {
      padding: 6px 12px;
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      font-size: 12px;
      margin-right: 4px;
    }
    
    .print-btn:hover {
      background: linear-gradient(135deg, #8e44ad 0%, #7d3c98 100%);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(155, 89, 182, 0.3);
    }
    
    .currency-badge {
      display: inline-block;
      padding: 3px 8px;
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    
    .payment-method-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 4px;
    }
    
    .payment-method-visa {
      background: linear-gradient(135deg, #1a1f71 0%, #1a237e 100%);
      color: white;
    }
    
    .payment-method-mastercard {
      background: linear-gradient(135deg, #eb001b 0%, #f79e1b 100%);
      color: white;
    }
    
    .payment-method-amex {
      background: linear-gradient(135deg, #2e77bb 0%, #006fcf 100%);
      color: white;
    }
    
    .payment-method-unionpay {
      background: linear-gradient(135deg, #ff5f00 0%, #ff7f00 100%);
      color: white;
    }
    
    .payment-method-qr {
      background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
      color: white;
    }
    
    .status-pending {
      display: inline-block;
      padding: 3px 8px;
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      color: white;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    
    .status-completed {
      display: inline-block;
      padding: 3px 8px;
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    
    .shift-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    
    .shift-morning {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
    }
    
    .shift-evening {
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
      color: white;
    }
    
    .receipt-badge {
      display: inline-block;
      padding: 3px 8px;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    
    .compact-info-summary {
      display: flex;
      justify-content: space-between;
      background: var(--gold-light);
      padding: 10px 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      border: 1px solid var(--gold-medium);
    }

    .info-row {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      flex: 1;
    }

    .info-row .info-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-medium);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .info-value-summary {
      font-size: 14px;
      font-weight: bold;
      color: var(--gold-deep);
      background: white;
      padding: 5px 12px;
      border-radius: 4px;
      min-width: 120px;
      text-align: center;
      border: 1px solid var(--gold-accent);
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .header-right {
        flex-direction: column;
        width: 100%;
      }
      
      .search-container {
        width: 100%;
      }
      
      .search-input {
        width: 100%;
      }
      
      .main-content {
        flex-direction: column;
      }
      
      .row {
        flex-direction: column;
        gap: 10px;
      }
      
      .btn {
        min-width: 100%;
      }
      
      .header-left h1 {
        font-size: 22px;
      }
    }
    
    /* Hidden receipt styles */
    #receiptArea {
      display: none;
    }
    
    .gold-ornament {
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--gold-accent), transparent);
      margin: 8px 0;
    }
    
    /* Icon styles */
    .icon {
      display: inline-block;
      width: 18px;
      height: 18px;
      background-size: contain;
      background-repeat: no-repeat;
      vertical-align: middle;
      margin-right: 6px;
    }
    
    .icon-scan { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M2 6h2v12H2zm3 0h1v12H5zm2 0h3v12H7zm4 0h1v12h-1zm3 0h2v12h-2zm4 0h1v12h-1zm2 0h1v12h-1zm2 0h2v12h-2z"/></svg>'); }
    .icon-save { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>'); }
    .icon-print { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>'); }
    .icon-view { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>'); }
    .icon-search { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>'); }
    .icon-home { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>'); }
    .icon-report { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M15.73 3H8.27L3 8.27v7.46L8.27 21h7.46L21 15.73V8.27L15.73 3zM12 17.3c-.72 0-1.3-.58-1.3-1.3s.58-1.3 1.3-1.3 1.3.58 1.3 1.3-.58 1.3-1.3 1.3zm1-4.3h-2V7h2v6z"/></svg>'); }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 10px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      border: 1px solid var(--gold-medium);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--gold-dark);
    }
    
    .modal-header h3 {
      margin: 0;
      color: var(--gold-deep);
      font-size: 18px;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: var(--text-light);
    }
    
    .close-modal:hover {
      color: var(--gold-accent);
    }
    
    /* Notification Container */
    #notificationContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1001;
    }
    
    .notification {
      padding: 12px 20px;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      margin-bottom: 10px;
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
      max-width: 300px;
    }
    
    .notification.success {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    }
    
    .notification.warning {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    }
    
    .notification.error {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }
    
    .notification.info {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="containerB">
    <div class="button-container">
      <button class="home-btn" onclick="window.location.href='dashP.html'">
        <span class="icon icon-home"></span> Home
      </button>
      <button class="home-btn" onclick="window.location.href='shiftend.html'">
        <span class="icon icon-report"></span> Report
      </button>
      <button class="home-btn" onclick="window.location.href='void.html'">
        <span class="icon icon-report"></span> Void
      </button>
    </div>
  </div>
  
  <div class="container">
    <!-- HEADER WITH SHIFT DISPLAY -->
    <div class="header">
      <div class="header-left">
        <h1>Passenger Payment POS</h1>
        <p>Koveli Lounge - Passenger Payment Processing</p>
      </div>
      <div class="header-right">
        <div class="shift-display" id="shiftDisplay" onclick="showShiftInfo()">
          <div class="shift-indicator">
            <span class="shift-dot" id="shiftDot"></span>
            <span id="shiftType">Loading...</span>
          </div>
          <div class="shift-date" id="shiftDate">--/--/----</div>
        </div>
        <div class="search-container">
          <input class="search-input" id="receiptSearch" type="text" placeholder="Receipt No...">
          <button class="search-btn" onclick="searchReceipt()">
            <span class="icon icon-search"></span>Search
          </button>
        </div>
      </div>
    </div>
    
    <!-- BOARDING PASS SECTION -->
    <div class="card boarding-pass-section">
      <h3><span class="icon icon-scan"></span>Boarding Pass Scanning</h3>
      <div class="input-group">
        <input id="codeInput" type="text" placeholder="Paste boarding pass barcode content here">
        <div class="section-note">The system will automatically parse passenger information</div>
      </div>
    </div>
    
    <div class="main-content">
      <div class="card">
        <h3>Passenger Information</h3>
        <div class="row">
          <div class="input-group">
            <label for="name">Full Name</label>
            <input id="name" type="text" placeholder="Passenger name">
          </div>
          <div class="input-group">
            <label for="flightNo">Flight Number</label>
            <input id="flightNo" type="text" placeholder="Flight code">
          </div>
        </div>
        
        <div class="row">
          <div class="input-group">
            <label for="seatNo">Seat Number</label>
            <input id="seatNo" type="text" placeholder="Seat assignment">
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3>Passenger Details</h3>
        <div class="row">
          <div class="input-group">
            <label for="adults">Adults</label>
            <input id="adults" type="number" value="1" min="0">
          </div>
          <div class="input-group">
            <label for="kids">Children</label>
            <input id="kids" type="number" value="0" min="0">
          </div>
        </div>
        
        <div class="row">
          <div class="input-group">
            <label for="rateType">Rate Type</label>
            <select id="rateType">
              <option value="A">Rate A (Standard)</option>
              <option value="B">Rate B (Special)</option>
            </select>
          </div>
          <div class="input-group">
            <label for="currency">Currency</label>
            <select id="currency">
              <option value="USD">USD</option>
              <option value="MVR">MVR</option>
            </select>
          </div>
        </div>
        
        <div class="input-group">
          <label for="paymentType">Payment Method</label>
          <select id="paymentType">
            <option value="Cash">Cash</option>
            <option value="Visa">Visa</option>
            <option value="MasterCard">MasterCard</option>
            <option value="Amex">American Express</option>
            <option value="UnionPay">UnionPay</option>
            <option value="QR">QR Sales</option>
          </select>
        </div>
        
        <!-- Cash Payment Fields -->
        <div id="cashPaymentFields" style="display: none;">
          <div class="input-group">
            <label for="paidAmount">Paid Amount</label>
            <input id="paidAmount" type="number" value="0.00" step="0.01" min="0">
          </div>
          
          <div class="input-group">
            <label>Balance Amount</label>
            <input id="balance" type="text" readonly class="summary-value" value="0.00">
          </div>
        </div>
      </div>
      
      <div class="card payment-summary">
        <h3>Payment Summary</h3>
        <div class="compact-info-summary">
          <div class="info-row">
            <span class="info-label">Receipt No:</span>
            <span class="info-value-summary" id="headerReceiptNo">AUTO</span>
          </div>
          <div class="info-row">
            <span class="info-label">Expiry Time:</span>
            <span class="info-value-summary" id="headerExpiryTime">--:--</span>
          </div>
        </div>
        
        <div class="input-group">
          <label>Subtotal Amount</label>
          <input id="subtotal" type="text" readonly class="summary-value" value="0.00">
        </div>
        
        <div class="input-group">
          <label>GST (8%)</label>
          <input id="gst" type="text" readonly class="summary-value" value="0.00">
        </div>
        
        <div class="input-group">
          <label>Total Amount</label>
          <input id="total" type="text" readonly class="summary-value" value="0.00">
        </div>
        
        <div class="gold-ornament"></div>
        
        <div class="buttons">
          <button class="btn btn-primary" onclick="saveNow()">
            <span class="icon icon-save"></span>Save & Print
          </button>
          <button class="btn btn-success" onclick="printReceipt()">
            <span class="icon icon-print"></span>Reprint
          </button>
          <button class="btn btn-secondary" onclick="loadPayments()">
            <span class="icon icon-view"></span>View Logs
          </button>
        </div>
      </div>
    </div>
    
    <!-- PENDING PAYMENTS SECTION -->
    <div class="logs-section">
      <div class="card">
        <h3>Today's Pending Payments</h3>
        <div id="pendingLog">
          <p style="text-align: center; color: var(--text-light); padding: 20px;">
            Click "View Logs" to display today's pending transaction history
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL FOR PAYMENT DETAILS -->
  <div id="cardDetailsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Enter Payment Details</h3>
        <button class="close-modal" onclick="closeModal()">&times;</button>
      </div>
      
      <div class="input-group">
        <label>Receipt Number</label>
        <input id="modalReceiptNo" type="text" readonly>
      </div>
      
      <div class="input-group">
        <label>Payment ID</label>
        <input id="modalPaymentId" type="text" readonly>
      </div>
      
      <div class="input-group">
        <label>Passenger Name</label>
        <input id="modalPassengerName" type="text" readonly>
      </div>
      
      <div class="input-group">
        <label for="modalPaymentMethod">Payment Method *</label>
        <select id="modalPaymentMethod" required>
          <option value="">Select Payment Method</option>
          <option value="Visa">Visa</option>
          <option value="MasterCard">MasterCard</option>
          <option value="Amex">American Express</option>
          <option value="UnionPay">UnionPay</option>
          <option value="QR">QR Sales</option>
        </select>
      </div>
      
      <div class="input-group">
        <label>Total Amount</label>
        <input id="modalTotalAmount" type="text" readonly>
      </div>
      
      <div class="row">
        <div class="input-group">
          <label for="modalBatchNo">Batch Number *</label>
          <input id="modalBatchNo" type="text" placeholder="Enter batch number" required>
        </div>
        <div class="input-group">
          <label for="modalApprovalCode">Approval Code *</label>
          <input id="modalApprovalCode" type="text" placeholder="Enter approval code" required>
        </div>
      </div>
      
      <div class="buttons">
        <button class="btn btn-success" onclick="saveCardDetails()">
          Save & Print Final
        </button>
        <button class="btn btn-secondary" onclick="closeModal()">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- SEARCH MODAL -->
  <div id="searchResultModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Receipt Found</h3>
        <button class="close-modal" onclick="closeSearchModal()">&times;</button>
      </div>
      
      <div id="searchResultContent">
        <!-- Search results will be displayed here -->
      </div>
      
      <div class="buttons" id="searchResultActions" style="display: none;">
        <button class="btn btn-success" onclick="printFoundReceipt()">
          <span class="icon icon-print"></span>Print Receipt
        </button>
        <button class="btn btn-info" onclick="addCardDetailsToFoundReceipt()">
          Add Card Details
        </button>
        <button class="btn btn-secondary" onclick="closeSearchModal()">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- NOTIFICATION CONTAINER -->
  <div id="notificationContainer"></div>

  <!-- HIDDEN RECEIPT TEMPLATE -->
  <div id="receiptArea" style="display:none;">
    <div id="receiptContent" style="width:280px;font-family:'Courier New', monospace;font-size:12px;line-height:1.2;">
      <div style="text-align:center;font-weight:bold;font-size:14px;margin-bottom:3px;letter-spacing:1px;">
        KOVELI LOUNGE
      </div>
      <div style="text-align:center;font-size:10px;margin-bottom:3px;">
        Velana International Airport
      </div>
      <div style="text-align:center;font-size:9px;margin-bottom:5px;">
        +960 304 6677
      </div>
      
      <div style="text-align:center;font-weight:bold;font-size:11px;margin-bottom:5px;border-top:1px dashed #000;border-bottom:1px dashed #000;padding:3px 0;" id="r_header">
        PASSENGER PAYMENT RECEIPT
      </div>
      
      <div style="margin-bottom:5px;">
        <div style="display:flex;justify-content:space-between;">
          <span><b>Receipt:</b></span>
          <span id="r_receiptNo"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Date:</b></span>
          <span id="r_date"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Shift:</b></span>
          <span id="r_shift"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Staff:</b></span>
          <span id="r_staff"></span>
        </div>
      </div>
      
      <div style="border-bottom:1px dashed #000;margin:5px 0;"></div>
      
      <div style="margin-bottom:5px;">
        <div style="display:flex;justify-content:space-between;">
          <span><b>Name:</b></span>
          <span id="r_name" style="text-align:right;max-width:180px;"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Flight:</b></span>
          <span id="r_flight"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Seat:</b></span>
          <span id="r_seat"></span>
        </div>
      </div>
      
      <div style="margin-bottom:5px;">
        <div style="display:flex;justify-content:space-between;">
          <span><b>Adults:</b></span>
          <span id="r_adults"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Children:</b></span>
          <span id="r_kids"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Payment Method:</b></span>
          <span id="r_payment_method"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Currency:</b></span>
          <span id="r_currency"></span>
        </div>
      </div>
      
      <div id="r_card_details" style="display:none;margin-bottom:5px;">
        <div style="display:flex;justify-content:space-between;">
          <span><b>Batch No:</b></span>
          <span id="r_batch"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Approval Code:</b></span>
          <span id="r_approval"></span>
        </div>
      </div>
      
      <div id="r_cash_details" style="display:none;margin-bottom:5px;">
        <div style="display:flex;justify-content:space-between;">
          <span><b>Paid Amount:</b></span>
          <span id="r_paid"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Balance:</b></span>
          <span id="r_balance"></span>
        </div>
      </div>
      
      <div style="border-bottom:1px dashed #000;margin:5px 0;"></div>
      
      <div style="margin-bottom:5px;">
        <div style="display:flex;justify-content:space-between;">
          <span>Subtotal:</span>
          <span id="r_subtotal"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span>GST (8%):</span>
          <span id="r_gst"></span>
        </div>
        <div style="display:flex;justify-content:space-between;font-weight:bold;border-top:1px solid #000;padding-top:2px;">
          <span>TOTAL:</span>
          <span id="r_total"></span>
        </div>
      </div>
      
      <div style="border-bottom:1px dashed #000;margin:5px 0;"></div>
      
      <div style="text-align:center;margin-bottom:5px;" id="r_expiry_section">
        <div style="font-size:10px;"><b>VALID UNTIL</b></div>
        <div style="font-weight:bold;color:#e74c3c;font-size:12px;" id="r_expiry"></div>
      </div>
      
      <div style="text-align:center;font-size:9px;margin-top:10px;">
        Thank you for choosing Koveli Lounge
      </div>
      <div style="text-align:center;font-size:8px;margin-top:3px;">
        ---------------------------------
      </div>
    </div>
  </div>

  <!-- FIREBASE AND OTHER SCRIPTS -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="fireW1.js"></script>
  <script src="rate1.js"></script>
  <script src="Co.js"></script>
  <script src="fireshift.js"></script>

  <script>
// ======== GLOBAL VARIABLES ========
let currentPaymentData = null;
let currentUser = null;
let isSupervisor = false;
let foundReceiptData = null;
let currentShift = null;
let currentShiftDate = null;

// Maldives timezone offset (UTC+5)
const MALDIVES_OFFSET = 5 * 60 * 60 * 1000;

// ======== TIMEZONE FUNCTIONS ========
function getMaldivesTime() {
  const now = new Date();
  return new Date(now.getTime() + MALDIVES_OFFSET);
}

function formatMaldivesDate(date) {
  const maldivesDate = new Date(date.getTime() + MALDIVES_OFFSET);
  return maldivesDate.toLocaleDateString('en-GB', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  });
}

function formatMaldivesDateTime(date) {
  const maldivesDate = new Date(date.getTime() + MALDIVES_OFFSET);
  return maldivesDate.toLocaleDateString('en-GB', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    hour12: true
  });
}

function getDateKey(date) {
  const maldivesDate = new Date(date.getTime() + MALDIVES_OFFSET);
  return maldivesDate.toISOString().split('T')[0]; // YYYY-MM-DD
}

// ======== SHIFT MANAGEMENT ========
async function loadCurrentShift() {
  try {
    // First check localStorage for active shift
    const savedShift = localStorage.getItem('currentShift');
    const savedShiftDate = localStorage.getItem('currentShiftDate');
    
    if (savedShift && savedShiftDate) {
      // Check if saved shift is still valid (not older than 24 hours)
      const savedDate = new Date(savedShiftDate);
      const now = getMaldivesTime();
      const hoursDiff = (now - savedDate) / (1000 * 60 * 60);
      
      if (hoursDiff < 24) {
        currentShift = savedShift;
        currentShiftDate = savedDate;
        updateShiftDisplay();
        return;
      }
    }
    
    // If no valid shift in localStorage, check Firebase for open shifts
    if (window.walkinDb) {
      const now = getMaldivesTime();
      const todayKey = getDateKey(now);
      const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
      const yesterdayKey = getDateKey(yesterday);
      
      // Try today's date first
      let shiftDoc = await window.walkinDb.collection("shifts")
        .doc(todayKey)
        .get();
      
      if (shiftDoc.exists) {
        const shiftData = shiftDoc.data();
        if (shiftData.isOpen) {
          currentShift = shiftData.shiftType || 'Morning';
          currentShiftDate = new Date(shiftData.openedAt);
          saveShiftToLocalStorage();
          updateShiftDisplay();
          return;
        }
      }
      
      // Try yesterday's date
      shiftDoc = await window.walkinDb.collection("shifts")
        .doc(yesterdayKey)
        .get();
      
      if (shiftDoc.exists) {
        const shiftData = shiftDoc.data();
        if (shiftData.isOpen) {
          currentShift = shiftData.shiftType || 'Morning';
          currentShiftDate = new Date(shiftData.openedAt);
          saveShiftToLocalStorage();
          updateShiftDisplay();
          return;
        }
      }
    }
    
    // If no open shift found, create a new one for today
    currentShift = 'Morning';
    currentShiftDate = getMaldivesTime();
    saveShiftToLocalStorage();
    updateShiftDisplay();
    
  } catch (error) {
    console.error("Error loading shift:", error);
    // Default to today's morning shift
    currentShift = 'Morning';
    currentShiftDate = getMaldivesTime();
    saveShiftToLocalStorage();
    updateShiftDisplay();
  }
}

function saveShiftToLocalStorage() {
  localStorage.setItem('currentShift', currentShift);
  localStorage.setItem('currentShiftDate', currentShiftDate.toISOString());
}

function updateShiftDisplay() {
  const shiftDot = document.getElementById('shiftDot');
  const shiftType = document.getElementById('shiftType');
  const shiftDate = document.getElementById('shiftDate');
  
  if (currentShift === 'Morning') {
    shiftDot.className = 'shift-dot shift-morning-dot';
    shiftType.textContent = 'Morning Shift';
  } else {
    shiftDot.className = 'shift-dot shift-evening-dot';
    shiftType.textContent = 'Evening Shift';
  }
  
  shiftDate.textContent = formatMaldivesDate(currentShiftDate);
}

function showShiftInfo() {
  const info = `Current Shift: ${currentShift}\n` +
               `Shift Date: ${formatMaldivesDate(currentShiftDate)}\n` +
               `Opened: ${formatMaldivesDateTime(currentShiftDate)}`;
  alert(info);
}

// ======== NOTIFICATION SYSTEM ========
function showNotification(message, type = 'info', duration = 3000) {
  const container = document.getElementById('notificationContainer');
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  notification.style.animationDuration = `${duration/1000}s`;
  
  container.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, duration);
}

// ======== USER MANAGEMENT ========
function getCurrentUser() {
  const userData = JSON.parse(localStorage.getItem("loggedInUser"));
  
  if (!userData) {
    window.location.href = "login.html";
    return null;
  }
  
  currentUser = userData.name || userData.username;
  isSupervisor = userData.Level === 'Supervisor';
  return userData;
}

// ======== RECEIPT NUMBER MANAGEMENT ========
async function getNextReceiptNumber() {
  try {
    // Check localStorage for counter
    let counter = localStorage.getItem('receiptCounter');
    
    if (!counter) {
      // Start from 1564
      counter = "1564";
    } else {
      counter = (parseInt(counter) + 1).toString();
    }
    
    // Save to localStorage
    localStorage.setItem('receiptCounter', counter);
    
    return counter;
    
  } catch (error) {
    console.error("Error getting receipt number:", error);
    // Fallback: Generate based on timestamp
    return Date.now().toString().slice(-6);
  }
}

// ======== PRICING CALCULATIONS ========
function updatePricing() {
  const adults = parseInt(document.getElementById("adults").value) || 0;
  const kids = parseInt(document.getElementById("kids").value) || 0;
  const rateType = document.getElementById("rateType").value;
  const currency = document.getElementById("currency").value;

  if (!window.rates) {
    document.getElementById("subtotal").value = "0.00";
    document.getElementById("gst").value = "0.00";
    document.getElementById("total").value = "0.00";
    return;
  }

  const adultKey = `Adult${rateType}${currency}`;
  const kidKey = `Kids${rateType}${currency}`;
  
  if(!window.rates[adultKey] || !window.rates[kidKey]) {
    return;
  }

  const adultRate = window.rates[adultKey];
  const kidRate = window.rates[kidKey];
  
  const subtotal = (adults * adultRate.price) + (kids * kidRate.price);
  const gst = subtotal * (adultRate.GST / 100);
  const total = subtotal + gst;

  document.getElementById("subtotal").value = subtotal.toFixed(2);
  document.getElementById("gst").value = gst.toFixed(2);
  document.getElementById("total").value = total.toFixed(2);
  
  updateCashFields();
  calculateExpiryTime();
}

function updateCashFields() {
  const paymentType = document.getElementById("paymentType").value;
  const total = parseFloat(document.getElementById("total").value) || 0;
  
  if (paymentType === "Cash") {
    const paidAmount = parseFloat(document.getElementById("paidAmount").value) || 0;
    const balance = paidAmount - total;
    document.getElementById("balance").value = balance.toFixed(2);
  }
}

function togglePaymentFields() {
  const paymentType = document.getElementById("paymentType").value;
  const cashFields = document.getElementById("cashPaymentFields");
  
  if (paymentType === "Cash") {
    cashFields.style.display = "block";
    const total = parseFloat(document.getElementById("total").value) || 0;
    document.getElementById("paidAmount").value = total.toFixed(2);
    updateCashFields();
  } else {
    cashFields.style.display = "none";
  }
}

// ======== EXPIRY TIME CALCULATION ========
function calculateExpiryTime() {
  const now = getMaldivesTime();
  const expiry = new Date(now.getTime() + 3 * 60 * 60 * 1000);
  
  let hours = expiry.getUTCHours();
  let minutes = expiry.getUTCMinutes();
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12;
  hours = hours ? hours : 12;
  minutes = minutes < 10 ? '0' + minutes : minutes;
  
  const expiryTime = `${hours}:${minutes} ${ampm}`;
  document.getElementById("headerExpiryTime").textContent = expiryTime;
  
  return {
    time: expiry,
    formatted: expiryTime,
    timestamp: expiry.getTime()
  };
}

// ======== BOARDING PASS PARSING ========
function parseCode() {
  const code = document.getElementById("codeInput").value.trim().toUpperCase();
  if(!code) return;
  
  // Simple parsing logic
  const parts = code.split(/\s+/);
  
  // Extract name (simplified)
  let name = '';
  if (parts.length > 0) {
    // Remove PNR and other codes
    name = parts[0].replace(/[0-9]/g, '').trim();
  }
  
  // Extract flight number (looking for MLE pattern)
  let flightNo = '';
  for(let i = 0; i < parts.length; i++) {
    if(parts[i].includes('MLE')) {
      flightNo = parts[i];
      break;
    }
  }
  
  // Extract seat number (usually after flight)
  let seatNo = '';
  const flightIndex = parts.findIndex(p => p.includes('MLE'));
  if(flightIndex !== -1 && parts[flightIndex + 1]) {
    seatNo = parts[flightIndex + 1].substring(0, 3);
  }
  
  document.getElementById("name").value = name;
  document.getElementById("flightNo").value = flightNo;
  document.getElementById("seatNo").value = seatNo;
  
  updatePricing();
}

// ======== SAVE PAYMENT ========
async function saveNow() {
  if (!window.rates) {
    showNotification("Error: Rates not loaded.", "error");
    return;
  }

  const paymentType = document.getElementById("paymentType").value;
  const total = parseFloat(document.getElementById("total").value) || 0;
  
  if (!currentShift || !currentShiftDate) {
    showNotification("Shift not loaded. Please refresh.", "error");
    return;
  }

  // Validate required fields
  const name = document.getElementById("name").value.trim();
  const flightNo = document.getElementById("flightNo").value.trim();
  
  if (!name || !flightNo) {
    showNotification("Please fill in passenger name and flight number", "warning");
    return;
  }

  if (isNaN(total) || total <= 0) {
    showNotification("Invalid payment amount.", "warning");
    return;
  }

  // Calculate expiry
  const expiryData = calculateExpiryTime();
  
  // Prepare payment data
  const paymentData = {
    receiptNo: await getNextReceiptNumber(),
    name: name,
    flightNo: flightNo,
    seatNo: document.getElementById("seatNo").value.trim(),
    shift: currentShift,
    shiftDate: currentShiftDate.toISOString(),
    shiftDateKey: getDateKey(currentShiftDate),
    adults: parseInt(document.getElementById("adults").value),
    kids: parseInt(document.getElementById("kids").value),
    rateType: document.getElementById("rateType").value,
    currency: document.getElementById("currency").value,
    paymentType: paymentType,
    subtotal: parseFloat(document.getElementById("subtotal").value),
    gst: parseFloat(document.getElementById("gst").value),
    total: total,
    expiryFormatted: expiryData.formatted,
    expiryTimestamp: expiryData.timestamp,
    staff: currentUser,
    timestamp: getMaldivesTime().toISOString(),
    maldivesTimestamp: getMaldivesTime().toISOString(),
    cardDetailsAdded: paymentType === 'Cash',
    finalReceiptPrinted: false,
    voided: false
  };

  // Add payment-specific fields
  if (paymentType === "Cash") {
    const paidAmount = parseFloat(document.getElementById("paidAmount").value) || 0;
    const balance = paidAmount - total;
    paymentData.paidAmount = paidAmount;
    paymentData.balance = balance;
  }

  try {
    // Save to localStorage first
    saveToLocalStorage(paymentData);
    
    // Save to Firebase if available
    if (window.walkinDb) {
      await saveToFirebase(paymentData);
    }
    
    // Update UI
    document.getElementById("headerReceiptNo").textContent = paymentData.receiptNo;
    currentPaymentData = paymentData;
    
    // Print receipt
    setTimeout(() => {
      printReceipt('first');
    }, 300);
    
    // Reset form
    resetFormForNextEntry();
    
    showNotification(`Payment saved: ${paymentData.receiptNo}`, "success");
    
  } catch (error) {
    console.error("Error saving payment:", error);
    showNotification("Error saving payment", "error");
  }
}

function saveToLocalStorage(payment) {
  try {
    const payments = JSON.parse(localStorage.getItem('payments') || '[]');
    payments.push(payment);
    localStorage.setItem('payments', JSON.stringify(payments));
  } catch (error) {
    console.error("Error saving to localStorage:", error);
  }
}

async function saveToFirebase(payment) {
  if (!window.walkinDb) return;
  
  try {
    // Use receipt number as document ID for easy lookup
    await window.walkinDb.collection("payments").doc(payment.receiptNo).set({
      ...payment,
      firebaseTimestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
  } catch (error) {
    console.error("Error saving to Firebase:", error);
    throw error;
  }
}

function resetFormForNextEntry() {
  document.getElementById("codeInput").value = "";
  document.getElementById("name").value = "";
  document.getElementById("flightNo").value = "";
  document.getElementById("seatNo").value = "";
  document.getElementById("adults").value = 1;
  document.getElementById("kids").value = 0;
  updatePricing();
  document.getElementById("codeInput").focus();
}

// ======== LOAD PAYMENTS ========
async function loadPayments() {
  try {
    showNotification("Loading payments...", "info", 2000);
    
    if (!currentShift || !currentShiftDate) {
      await loadCurrentShift();
    }
    
    const payments = await getPaymentsForCurrentShift();
    displayPayments(payments);
    
  } catch (error) {
    console.error("Error loading payments:", error);
    showNotification("Error loading payments", "error");
  }
}

async function getPaymentsForCurrentShift() {
  const shiftDateKey = getDateKey(currentShiftDate);
  
  try {
    // Try Firebase first
    if (window.walkinDb) {
      const snapshot = await window.walkinDb.collection("payments")
        .where("shiftDateKey", "==", shiftDateKey)
        .where("shift", "==", currentShift)
        .limit(50)
        .get();
      
      const firebasePayments = [];
      snapshot.forEach(doc => {
        firebasePayments.push(doc.data());
      });
      
      if (firebasePayments.length > 0) {
        return firebasePayments;
      }
    }
    
    // Fallback to localStorage
    const payments = JSON.parse(localStorage.getItem('payments') || '[]');
    return payments.filter(p => 
      p.shiftDateKey === shiftDateKey && 
      p.shift === currentShift
    );
    
  } catch (error) {
    console.error("Error fetching payments:", error);
    // Return localStorage payments
    const payments = JSON.parse(localStorage.getItem('payments') || '[]');
    return payments.filter(p => 
      p.shiftDateKey === shiftDateKey && 
      p.shift === currentShift
    );
  }
}

function displayPayments(payments) {
  const container = document.getElementById("pendingLog");
  
  if (payments.length === 0) {
    container.innerHTML = `<p style="text-align: center; color: var(--text-light); padding: 20px;">
      No payments found for current shift.
    </p>`;
    return;
  }
  
  // Filter to show only pending non-cash payments
  const pendingPayments = payments.filter(p => 
    p.paymentType !== 'Cash' && 
    !p.cardDetailsAdded &&
    !p.voided
  );
  
  if (pendingPayments.length === 0) {
    container.innerHTML = `<p style="text-align: center; color: var(--text-light); padding: 20px;">
      No pending card payments for current shift.
    </p>`;
    return;
  }
  
  let html = `<table>
    <tr>
      <th>Receipt No</th>
      <th>Name</th>
      <th>Payment Method</th>
      <th>Total</th>
      <th>Expiry</th>
      <th>Actions</th>
    </tr>`;
  
  pendingPayments.forEach(p => {
    const currencyBadge = p.currency === 'USD' ? 
      '<span class="currency-badge">USD</span>' : 
      '<span class="currency-badge">MVR</span>';
    
    const paymentBadgeClass = `payment-method-${p.paymentType.toLowerCase()}`;
    const paymentBadge = `<span class="payment-method-badge ${paymentBadgeClass}">${p.paymentType}</span>`;
    
    html += `<tr>
      <td><span class="receipt-badge">${p.receiptNo}</span></td>
      <td>${p.name}</td>
      <td>${paymentBadge}</td>
      <td><strong>${p.total.toFixed(2)}</strong> ${currencyBadge}</td>
      <td>${p.expiryFormatted}</td>
      <td>
        <button class="complete-btn" onclick="addCardDetails('${p.receiptNo}')">Add Details</button>
        <button class="print-btn" onclick="reprintPayment('${p.receiptNo}')">Print</button>
      </td>
    </tr>`;
  });
  
  html += "</table>";
  container.innerHTML = html;
}

// ======== PAYMENT DETAILS MODAL ========
async function addCardDetails(receiptNo) {
  const payment = await findPaymentByReceiptNo(receiptNo);
  if (!payment) {
    showNotification("Payment not found", "error");
    return;
  }
  
  if (payment.voided) {
    showNotification("Cannot add details to voided receipt", "error");
    return;
  }
  
  document.getElementById("modalPaymentId").value = receiptNo;
  document.getElementById("modalReceiptNo").value = receiptNo;
  document.getElementById("modalPassengerName").value = payment.name;
  document.getElementById("modalTotalAmount").value = payment.total.toFixed(2);
  document.getElementById("modalPaymentMethod").value = payment.paymentType || '';
  document.getElementById("modalBatchNo").value = payment.batchNo || '';
  document.getElementById("modalApprovalCode").value = payment.approvalCode || '';
  
  document.getElementById("cardDetailsModal").style.display = "flex";
}

async function saveCardDetails() {
  const receiptNo = document.getElementById("modalPaymentId").value;
  const paymentMethod = document.getElementById("modalPaymentMethod").value;
  const batchNo = document.getElementById("modalBatchNo").value;
  const approvalCode = document.getElementById("modalApprovalCode").value;
  
  if (!paymentMethod || !batchNo || !approvalCode) {
    showNotification("Please fill all required fields", "warning");
    return;
  }
  
  try {
    // Update payment data
    const updates = {
      paymentType: paymentMethod,
      batchNo: batchNo,
      approvalCode: approvalCode,
      cardDetailsAdded: true
    };
    
    // Update localStorage
    updateLocalPayment(receiptNo, updates);
    
    // Update Firebase if available
    if (window.walkinDb) {
      await window.walkinDb.collection("payments").doc(receiptNo).update(updates);
    }
    
    // Close modal and refresh
    closeModal();
    loadPayments();
    
    // Print final receipt
    const payment = await findPaymentByReceiptNo(receiptNo);
    if (payment) {
      printReceipt('final', payment);
    }
    
    showNotification("Payment details saved successfully!", "success");
    
  } catch (error) {
    console.error("Error saving card details:", error);
    showNotification("Error saving details", "error");
  }
}

function updateLocalPayment(receiptNo, updates) {
  const payments = JSON.parse(localStorage.getItem('payments') || '[]');
  const updatedPayments = payments.map(p => {
    if (p.receiptNo === receiptNo) {
      return { ...p, ...updates };
    }
    return p;
  });
  localStorage.setItem('payments', JSON.stringify(updatedPayments));
}

function closeModal() {
  document.getElementById("cardDetailsModal").style.display = "none";
  document.getElementById("modalPaymentMethod").value = "";
  document.getElementById("modalBatchNo").value = "";
  document.getElementById("modalApprovalCode").value = "";
}

// ======== SEARCH FUNCTIONALITY ========
async function searchReceipt() {
  const receiptNo = document.getElementById("receiptSearch").value.trim();
  if (!receiptNo) {
    showNotification("Please enter receipt number", "warning");
    return;
  }
  
  showNotification("Searching...", "info", 1500);
  
  const payment = await findPaymentByReceiptNo(receiptNo);
  if (payment) {
    foundReceiptData = payment;
    displaySearchResult(payment);
    showNotification(`Found receipt: ${receiptNo}`, "success");
  } else {
    showNotification("Receipt not found", "error");
  }
}

async function findPaymentByReceiptNo(receiptNo) {
  try {
    // Try Firebase first
    if (window.walkinDb) {
      const doc = await window.walkinDb.collection("payments").doc(receiptNo).get();
      if (doc.exists) {
        return doc.data();
      }
    }
    
    // Try localStorage
    const payments = JSON.parse(localStorage.getItem('payments') || '[]');
    return payments.find(p => p.receiptNo === receiptNo);
    
  } catch (error) {
    console.error("Error searching payment:", error);
    const payments = JSON.parse(localStorage.getItem('payments') || '[]');
    return payments.find(p => p.receiptNo === receiptNo);
  }
}

function displaySearchResult(payment) {
  const contentDiv = document.getElementById("searchResultContent");
  const actionsDiv = document.getElementById("searchResultActions");
  
  const displayDate = formatMaldivesDateTime(new Date(payment.timestamp));
  
  let html = `
    <div style="margin-bottom: 15px;">
      <h4 style="margin: 0 0 10px 0;">Receipt Details</h4>
      
      <div class="input-group">
        <label>Receipt Number</label>
        <input type="text" readonly value="${payment.receiptNo}">
      </div>
      
      <div class="input-group">
        <label>Transaction Date</label>
        <input type="text" readonly value="${displayDate}">
      </div>
      
      <div class="row">
        <div class="input-group">
          <label>Passenger Name</label>
          <input type="text" readonly value="${payment.name}">
        </div>
        <div class="input-group">
          <label>Flight Number</label>
          <input type="text" readonly value="${payment.flightNo || 'N/A'}">
        </div>
      </div>
      
      <div class="row">
        <div class="input-group">
          <label>Payment Method</label>
          <input type="text" readonly value="${payment.paymentType}">
        </div>
        <div class="input-group">
          <label>Total Amount</label>
          <input type="text" readonly value="${payment.total.toFixed(2)}" class="summary-value">
        </div>
      </div>
      
      <div class="row">
        <div class="input-group">
          <label>Shift</label>
          <input type="text" readonly value="${payment.shift}">
        </div>
        <div class="input-group">
          <label>Staff</label>
          <input type="text" readonly value="${payment.staff}">
        </div>
      </div>
    </div>
  `;
  
  contentDiv.innerHTML = html;
  actionsDiv.style.display = "flex";
  document.getElementById("searchResultModal").style.display = "flex";
}

function closeSearchModal() {
  document.getElementById("searchResultModal").style.display = "none";
  foundReceiptData = null;
}

function printFoundReceipt() {
  if (!foundReceiptData) return;
  
  if (foundReceiptData.paymentType !== 'Cash' && foundReceiptData.cardDetailsAdded) {
    printReceipt('final', foundReceiptData);
  } else if (foundReceiptData.paymentType === 'Cash') {
    printReceipt('first', foundReceiptData);
  } else {
    printReceipt('first', foundReceiptData);
  }
  
  closeSearchModal();
}

function addCardDetailsToFoundReceipt() {
  if (!foundReceiptData) return;
  
  if (foundReceiptData.paymentType !== 'Cash' && !foundReceiptData.cardDetailsAdded) {
    addCardDetails(foundReceiptData.receiptNo);
    closeSearchModal();
  } else {
    showNotification("This receipt doesn't require payment details", "info");
  }
}

async function reprintPayment(receiptNo) {
  const payment = await findPaymentByReceiptNo(receiptNo);
  if (payment) {
    if (payment.paymentType !== 'Cash' && payment.cardDetailsAdded) {
      printReceipt('final', payment);
    } else {
      printReceipt('first', payment);
    }
  }
}

// ======== PRINT RECEIPT ========
function printReceipt(type = 'first', paymentData = null) {
  let payment = paymentData || currentPaymentData;
  if (!payment) return;
  
  // Update receipt content
  const receiptNo = payment.receiptNo;
  const paymentType = payment.paymentType;
  
  document.getElementById("r_receiptNo").textContent = receiptNo + (type === 'final' ? ' (FINAL)' : '');
  document.getElementById("r_date").textContent = formatMaldivesDateTime(new Date(payment.timestamp));
  document.getElementById("r_shift").textContent = payment.shift;
  document.getElementById("r_staff").textContent = payment.staff;
  document.getElementById("r_name").textContent = payment.name;
  document.getElementById("r_flight").textContent = payment.flightNo || 'N/A';
  document.getElementById("r_seat").textContent = payment.seatNo || 'N/A';
  document.getElementById("r_adults").textContent = payment.adults;
  document.getElementById("r_kids").textContent = payment.kids;
  document.getElementById("r_payment_method").textContent = paymentType;
  document.getElementById("r_currency").textContent = payment.currency;
  
  document.getElementById("r_subtotal").textContent = payment.subtotal.toFixed(2);
  document.getElementById("r_gst").textContent = payment.gst.toFixed(2);
  document.getElementById("r_total").textContent = payment.total.toFixed(2);
  document.getElementById("r_expiry").textContent = payment.expiryFormatted;
  
  // Show/hide sections based on payment type
  if (paymentType !== 'Cash') {
    document.getElementById("r_card_details").style.display = "block";
    document.getElementById("r_cash_details").style.display = "none";
    
    if (payment.cardDetailsAdded && payment.batchNo && payment.approvalCode) {
      document.getElementById("r_batch").textContent = payment.batchNo;
      document.getElementById("r_approval").textContent = payment.approvalCode;
    } else {
      document.getElementById("r_card_details").style.display = "none";
    }
  } else {
    document.getElementById("r_card_details").style.display = "none";
    document.getElementById("r_cash_details").style.display = "block";
    document.getElementById("r_paid").textContent = (payment.paidAmount || 0).toFixed(2);
    document.getElementById("r_balance").textContent = (payment.balance || 0).toFixed(2);
  }
  
  // Print the receipt
  printThermalReceipt();
  
  // Show notification
  const receiptType = type === 'final' ? 'Final' : 'First';
  showNotification(`Printed ${receiptType} Receipt: ${receiptNo}`, "success");
}

function printThermalReceipt() {
  const content = document.getElementById("receiptContent").innerHTML;
  
  const printWindow = window.open('', '_blank', 'width=300,height=600');
  
  const thermalCSS = `
    <style>
      @media print {
        body {
          width: 70mm !important;
          margin: 0 !important;
          padding: 0 !important;
          font-family: 'Courier New', monospace !important;
          font-size: 12px !important;
        }
        * {
          font-size: 12px !important;
          line-height: 1.2 !important;
        }
        @page {
          margin: 0;
          size: 70mm auto;
        }
      }
      body {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        width: 70mm;
        margin: 0 auto;
        padding: 5px;
      }
    </style>
  `;
  
  printWindow.document.write(`
    <html>
      <head>
        <title>Koveli Lounge Receipt</title>
        ${thermalCSS}
      </head>
      <body onload="window.print(); setTimeout(() => window.close(), 500);">
        <div style="width:100%;max-width:70mm;margin:0 auto;">
          ${content}
        </div>
      </body>
    </html>
  `);
  
  printWindow.document.close();
}

// ======== INITIALIZATION ========
window.onload = async function() {
  // Initialize company info
  if (!window.companyInfo) {
    window.companyInfo = {
      name: "Koveli Lounge",
      address: "Velana International Airport",
      phone: "+960 304 6677"
    };
  }
  
  // Get current user
  getCurrentUser();
  
  // Load current shift
  await loadCurrentShift();
  
  // Initialize pricing
  updatePricing();
  togglePaymentFields();
  
  // Set up event listeners
  ['adults', 'kids', 'rateType', 'currency'].forEach(id => {
    document.getElementById(id).addEventListener('input', updatePricing);
    document.getElementById(id).addEventListener('change', updatePricing);
  });
  
  document.getElementById("paidAmount").addEventListener('input', updateCashFields);
  
  document.getElementById("paymentType").addEventListener('change', function() {
    togglePaymentFields();
  });
  
  document.getElementById("codeInput").addEventListener('input', parseCode);
  
  // Prevent focus on readonly fields
  ['subtotal', 'gst', 'total', 'balance'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('focus', function() { this.blur(); });
    }
  });
  
  // Close modals when clicking outside
  document.getElementById("cardDetailsModal").addEventListener('click', function(e) {
    if (e.target === this) closeModal();
  });
  
  document.getElementById("searchResultModal").addEventListener('click', function(e) {
    if (e.target === this) closeSearchModal();
  });
  
  // Search on Enter key
  document.getElementById("receiptSearch").addEventListener('keypress', function(e) {
    if (e.key === 'Enter') searchReceipt();
  });
  
  // Initialize expiry time
  calculateExpiryTime();
  
  showNotification("System ready. Current shift: " + currentShift, "success");
};
  </script>
</body>
</html>
