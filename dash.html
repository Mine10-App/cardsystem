<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    
<!-- Shift Database -->
<script src="fireshift.js"></script>

<style>
:root {
  --primary: #d4af37;
  --primary-light: #f4e8c1;
  --primary-dark: #b8941f;
  --success: #2ecc71;
  --danger: #e74c3c;
  --warning: #f39c12;
  --dark: #2c3e50;
  --light: #f8f9fa;
  --gray: #95a5a6;
  --shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  --card-radius: 8px;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #ffffff;
  margin: 0;
  padding: 0;
  min-height: 100vh;
  color: var(--dark);
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

/* Header Styles */
header {
  background: white;
  border-radius: var(--card-radius);
  padding: 15px 25px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 2px solid var(--primary);
}

header h1 {
  color: var(--dark);
  font-weight: 600;
  font-size: 24px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.company-name {
  font-size: 14px;
  color: var(--primary);
  font-weight: 500;
  margin-top: 3px;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--primary);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 16px;
  border: 2px solid var(--primary-light);
}

.user-details {
  text-align: right;
}

.user-name {
  font-weight: 600;
  font-size: 14px;
}

.user-role {
  font-size: 12px;
  color: var(--gray);
}

/* Shift Status */
.shift-status {
  background: white;
  border-radius: var(--card-radius);
  padding: 15px 20px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-left: 4px solid var(--primary);
}

.shift-info {
  display: flex;
  align-items: center;
  gap: 15px;
}

.shift-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--primary-light);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--primary-dark);
  font-size: 16px;
}

.shift-details h2 {
  font-size: 12px;
  color: var(--gray);
  margin-bottom: 4px;
}

.shift-name {
  font-size: 18px;
  font-weight: 600;
  color: var(--dark);
  margin-bottom: 4px;
}

.shift-date {
  font-size: 14px;
  color: var(--gray);
}

.shift-actions {
  display: flex;
  gap: 10px;
  align-items: center;
}

.refresh-btn {
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 4px;
  padding: 8px 15px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.3s ease;
}

.refresh-btn:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
}

.refresh-btn:active {
  transform: translateY(0);
}

.refresh-btn i {
  font-size: 12px;
}

.shift-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
}

.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--success);
}

.status-dot.inactive {
  background: var(--gray);
}

/* Dashboard Grid */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.dashboard-card {
  background: white;
  border-radius: var(--card-radius);
  padding: 20px;
  box-shadow: var(--shadow);
  transition: all 0.3s ease;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  position: relative;
  overflow: hidden;
  border: 1px solid #f0f0f0;
}

.dashboard-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 3px;
  background: var(--primary);
}

.dashboard-card:nth-child(2)::before {
  background: var(--success);
}

.dashboard-card:nth-child(3)::before {
  background: var(--warning);
}

.dashboard-card:nth-child(4)::before {
  background: var(--danger);
}

.dashboard-card:nth-child(5)::before {
  background: #9b59b6;
}

.dashboard-card:nth-child(6)::before {
  background: #1abc9c;
}

.dashboard-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
}

.card-icon {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: var(--light);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 15px;
  font-size: 22px;
  color: var(--primary);
  border: 1px solid var(--primary-light);
}

.dashboard-card:nth-child(2) .card-icon {
  color: var(--success);
  border-color: rgba(46, 204, 113, 0.2);
}

.dashboard-card:nth-child(3) .card-icon {
  color: var(--warning);
  border-color: rgba(243, 156, 18, 0.2);
}

.dashboard-card:nth-child(4) .card-icon {
  color: var(--danger);
  border-color: rgba(231, 76, 60, 0.2);
}

.dashboard-card:nth-child(5) .card-icon {
  color: #9b59b6;
  border-color: rgba(155, 89, 182, 0.2);
}

.dashboard-card:nth-child(6) .card-icon {
  color: #1abc9c;
  border-color: rgba(26, 188, 156, 0.2);
}

.card-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--dark);
}

.card-description {
  font-size: 13px;
  color: var(--gray);
  line-height: 1.4;
}

.card-badge {
  position: absolute;
  top: 12px;
  right: 12px;
  background: var(--primary);
  color: white;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: 600;
}

/* Disabled State */
.dashboard-card.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.dashboard-card.disabled:hover {
  transform: none;
  box-shadow: var(--shadow);
}

.dashboard-card.disabled .card-icon {
  background: #f5f5f5;
  color: var(--gray);
}

/* Loading Animation */
.refresh-btn.loading {
  opacity: 0.7;
  cursor: not-allowed;
}

.refresh-btn.loading i {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Last Updated */
.last-updated {
  font-size: 11px;
  color: var(--gray);
  margin-top: 5px;
  font-style: italic;
}

/* Responsive Design */
@media (max-width: 768px) {
  .dashboard-grid {
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  }
  
  header {
    flex-direction: column;
    gap: 12px;
    text-align: center;
  }
  
  .user-info {
    flex-direction: column;
    gap: 8px;
  }
  
  .user-details {
    text-align: center;
  }
  
  .shift-status {
    flex-direction: column;
    gap: 10px;
    text-align: center;
  }
  
  .shift-actions {
    flex-direction: column;
    gap: 8px;
  }
}

@media (max-width: 480px) {
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
  
  .container {
    padding: 15px;
  }
  
  header h1 {
    font-size: 20px;
  }
}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
      <div class="company-name">Koveli Lounge</div>
    </div>
    <div class="user-info">
      <div class="user-avatar" id="userAvatar">JD</div>
      <div class="user-details">
        <div class="user-name" id="username">John Doe</div>
      </div>
    </div>
  </header>
  
  <div class="shift-status">
    <div class="shift-info">
      <div class="shift-icon">
        <i class="fas fa-business-time"></i>
      </div>
      <div class="shift-details">
        <h2>CURRENT SHIFT STATUS</h2>
        <div class="shift-name" id="shiftName">Loading shift status...</div>
        <div class="shift-date" id="shiftDate"></div>
        <div class="last-updated" id="lastUpdated"></div>
      </div>
    </div>
    <div class="shift-actions">
      <button class="refresh-btn" id="refreshBtn">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
      <div class="shift-indicator">
        <div class="status-dot inactive" id="statusDot"></div>
        <span id="statusText">Loading...</span>
      </div>
    </div>
  </div>
  
  <div class="dashboard-grid">
    <div class="dashboard-card disabled" id="passengerEntryCard">
      <div class="card-icon">
        <i class="fas fa-user-plus"></i>
      </div>
      <h3 class="card-title">Passenger Entry</h3>
      <p class="card-description">Register new passengers and manage passenger information</p>
      <div class="card-badge">New</div>
    </div>
    
    <div class="dashboard-card" onclick="openPage('updateCard.html')">
      <div class="card-icon">
        <i class="fas fa-clipboard-list"></i>
      </div>
      <h3 class="card-title">Passenger Report</h3>
      <p class="card-description">View and analyze passenger data and generate reports</p>
    </div>
    
    <div class="dashboard-card" onclick="openPage('shiftend1.html')">
      <div class="card-icon">
        <i class="fas fa-chart-bar"></i>
      </div>
      <h3 class="card-title">Daily Shift Report</h3>
      <p class="card-description">Comprehensive overview of daily shift activities and metrics</p>
    </div>
    
    <div class="dashboard-card" onclick="openPage('dashP.html')">
      <div class="card-icon">
        <i class="fas fa-credit-card"></i>
      </div>
      <h3 class="card-title">Payment</h3>
      <p class="card-description">Manage payment processing and financial transactions</p>
    </div>
    
    <div class="dashboard-card" onclick="openPage('shift.html')">
      <div class="card-icon">
        <i class="fas fa-users-cog"></i>
      </div>
      <h3 class="card-title">Shift Management</h3>
      <p class="card-description">Configure shifts, assign staff, and manage schedules</p>
    </div>
    
    <div class="dashboard-card" onclick="openPage('login.html')">
      <div class="card-icon">
        <i class="fas fa-sign-out-alt"></i>
      </div>
      <h3 class="card-title">Logout</h3>
      <p class="card-description">Securely log out of the system</p>
    </div>
  </div>
</div>

<script>
// ========== DASHBOARD SCRIPT ==========

console.log("üîß Dashboard script loading...");

// ----------- LOCAL STORAGE KEYS -----------
const SHIFT_STORAGE_KEY = 'currentShiftData';
const SHIFT_TIMESTAMP_KEY = 'shiftDataTimestamp';

// ----------- Load user data -----------
let userData;
try {
    userData = JSON.parse(localStorage.getItem("loggedInUser"));
    console.log("üë§ User data from localStorage:", userData);
    
    if (userData) {
        const name = userData.name || userData.username || "User";
        document.getElementById("username").textContent = name;
        
        // Set user avatar initials
        const initials = name.split(' ')
            .map(n => n[0])
            .join('')
            .toUpperCase()
            .substring(0, 2);
        document.getElementById("userAvatar").textContent = initials;
    } else {
        console.log("‚ö†Ô∏è No user found, redirecting to login...");
        window.location.href = "login.html";
    }
} catch (e) {
    console.error("‚ùå Error loading user data:", e);
    window.location.href = "login.html";
}

// ----------- Initialize Firebase with shift config -----------
let shiftFirestore = null;

function initializeShiftFirebase() {
    try {
        console.log("Initializing Firebase with shift config...");
        
        // Check if fireshift.js loaded the config
        if (typeof firebaseConfig === 'undefined' && typeof shiftFirebaseConfig === 'undefined') {
            console.error("‚ùå Shift Firebase config not found in fireshift.js");
            return null;
        }
        
        // Use whichever config is available
        const config = firebaseConfig || shiftFirebaseConfig;
        console.log("Using Firebase config:", config.projectId);
        
        // Check if Firebase app already exists
        let app;
        try {
            // Try to get existing app
            app = firebase.app('shiftApp');
            console.log("Using existing Firebase app: shiftApp");
        } catch (e) {
            // Create new app for shifts
            app = firebase.initializeApp(config, 'shiftApp');
            console.log("Created new Firebase app: shiftApp");
        }
        
        // Initialize Firestore
        shiftFirestore = firebase.firestore(app);
        console.log("‚úÖ Shift Firestore initialized successfully");
        
        return shiftFirestore;
        
    } catch (error) {
        console.error("‚ùå Error initializing shift Firebase:", error);
        return null;
    }
}

// ----------- FORMAT DATE FOR DOCUMENT ID -----------
function formatDateForDocumentId(date) {
    // Returns date in format: YYYY_MM_DD (for document ID: shift_YYYY_MM_DD)
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}_${month}_${day}`;
}

// ----------- FORMAT DATE FOR DISPLAY -----------
function formatDateForDisplay(date) {
    // Returns date in format: YYYY-MM-DD (for field comparison)
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// ----------- CHECK FOR OPEN SHIFT IN DATA -----------
function checkForOpenShift(shiftData) {
    console.log("üîç Checking for open shift in data...");
    
    let result = {
        success: false,
        isActive: false,
        shiftName: "No Shift Open",
        shiftType: "",
        openTime: "",
        details: {}
    };
    
    if (!shiftData) {
        return result;
    }
    
    // Check morning shift
    if (shiftData.morning && shiftData.morning.status) {
        console.log("üåÖ Morning shift status:", shiftData.morning.status);
        
        if (shiftData.morning.status === "open") {
            result.success = true;
            result.isActive = true;
            result.shiftName = "Morning Shift";
            result.shiftType = "morning";
            result.openTime = shiftData.morning.open || "";
            result.details = shiftData.morning;
            console.log("‚úì Morning shift is OPEN");
            return result;
        }
    }
    
    // Check evening shift
    if (shiftData.evening && shiftData.evening.status) {
        console.log("üåô Evening shift status:", shiftData.evening.status);
        
        if (shiftData.evening.status === "open") {
            result.success = true;
            result.isActive = true;
            result.shiftName = "Evening Shift";
            result.shiftType = "evening";
            result.openTime = shiftData.evening.open || "";
            result.details = shiftData.evening;
            console.log("‚úì Evening shift is OPEN");
            return result;
        }
    }
    
    // Check if both shifts are "not_available"
    if (shiftData.morning && shiftData.morning.status === "not_available" && 
        shiftData.evening && shiftData.evening.status === "not_available") {
        result.success = true;
        result.shiftName = "Shifts Not Started Today";
        console.log("‚è≥ Both shifts not available yet");
        return result;
    }
    
    // Check if both shifts are closed
    if ((!shiftData.morning || shiftData.morning.status === "closed") && 
        (!shiftData.evening || shiftData.evening.status === "closed")) {
        result.success = true;
        result.shiftName = "All Shifts Closed";
        console.log("üîí All shifts closed");
        return result;
    }
    
    // Default case
    result.success = true;
    return result;
}

// ----------- SEARCH PREVIOUS DATES FOR OPEN SHIFT -----------
async function findOpenShiftInPreviousDates(startDate) {
    console.log("üîô Searching for open shift in previous dates...");
    
    try {
        // Search up to 7 previous days
        for (let i = 1; i <= 7; i++) {
            // Go back i days
            const previousDate = new Date(startDate);
            previousDate.setDate(startDate.getDate() - i);
            
            // Format for document ID: YYYY_MM_DD
            const previousDateForDocId = formatDateForDocumentId(previousDate);
            const previousDocId = `shift_${previousDateForDocId}`;
            
            // Format for display: YYYY-MM-DD
            const previousDateForDisplay = formatDateForDisplay(previousDate);
            
            console.log(`üìÖ Checking date ${i} day(s) ago: ${previousDateForDocId} (${previousDateForDisplay})`);
            
            try {
                const previousDoc = await shiftFirestore.collection("shifts").doc(previousDocId).get();
                
                if (previousDoc.exists) {
                    const shiftData = previousDoc.data();
                    console.log(`‚úÖ Found document for ${previousDocId}`);
                    
                    // Check if this document has an open shift
                    const shiftCheck = checkForOpenShift(shiftData);
                    
                    if (shiftCheck.isActive) {
                        console.log(`üéâ Found open shift in previous date: ${previousDateForDisplay}`);
                        return {
                            success: true,
                            shiftData: shiftData,
                            foundDate: previousDateForDisplay,
                            foundDateForDocId: previousDateForDocId,
                            shiftCheck: shiftCheck
                        };
                    } else {
                        console.log(`‚û°Ô∏è No open shift in ${previousDateForDisplay}, continuing search...`);
                    }
                } else {
                    console.log(`‚û°Ô∏è No document for ${previousDateForDisplay}, continuing...`);
                }
            } catch (error) {
                console.error(`‚ùå Error checking ${previousDateForDisplay}:`, error);
            }
        }
        
        console.log("üîç No open shift found in any of the previous 7 days");
        return {
            success: false,
            message: "No open shift found in previous dates"
        };
        
    } catch (error) {
        console.error("‚ùå Error searching previous dates:", error);
        return {
            success: false,
            message: "Error: " + error.message
        };
    }
}

// ----------- FETCH SHIFT DATA -----------
async function fetchShiftData() {
    console.log("üåê Fetching shift data...");
    
    try {
        // Initialize Firebase if not done yet
        if (!shiftFirestore) {
            shiftFirestore = initializeShiftFirebase();
            if (!shiftFirestore) {
                throw new Error("Failed to initialize Firebase");
            }
        }
        
        // Get today's date
        const today = new Date();
        
        // Format for document ID: YYYY_MM_DD
        const todayDateForDocId = formatDateForDocumentId(today);
        
        // Format for display and field comparison: YYYY-MM-DD
        const todayDateForDisplay = formatDateForDisplay(today);
        
        console.log("üìÖ Today's date for document ID:", todayDateForDocId);
        console.log("üìÖ Today's date for display:", todayDateForDisplay);
        
        // Use document ID format: shift_YYYY_MM_DD
        const todayDocId = `shift_${todayDateForDocId}`;
        console.log("üîç Looking for today's shift document:", todayDocId);
        
        // Get today's shift document
        const todayShiftDoc = await shiftFirestore.collection("shifts").doc(todayDocId).get();
        
        let shiftData = null;
        let documentDate = "";
        let foundDate = todayDateForDisplay;
        let foundDateForDocId = todayDateForDocId;
        let shiftCheck = null;
        
        // Check if today's shift exists
        if (todayShiftDoc.exists) {
            shiftData = todayShiftDoc.data();
            documentDate = shiftData.date || todayDateForDisplay;
            
            console.log("‚úÖ Today's shift data retrieved:", shiftData);
            
            // Check if today has any open shift
            shiftCheck = checkForOpenShift(shiftData);
            
            if (shiftCheck.isActive) {
                console.log("‚úì Found open shift in today's document");
                foundDate = todayDateForDisplay;
                foundDateForDocId = todayDateForDocId;
            } else {
                console.log("‚ö†Ô∏è No open shift found in today's document. Searching previous dates...");
                
                // Search for open shift in previous dates
                const previousOpenShift = await findOpenShiftInPreviousDates(today);
                
                if (previousOpenShift.success) {
                    console.log(`‚úì Found open shift in previous date: ${previousOpenShift.foundDate}`);
                    shiftData = previousOpenShift.shiftData;
                    documentDate = previousOpenShift.foundDate;
                    foundDate = previousOpenShift.foundDate;
                    foundDateForDocId = previousOpenShift.foundDateForDocId;
                    shiftCheck = previousOpenShift.shiftCheck;
                } else {
                    console.log("‚ö†Ô∏è No open shift found in any date, using today's data");
                    // Keep today's data even if no shift is open
                }
            }
        } else {
            console.log("‚ùå No shift document found for today:", todayDocId);
            
            // Search for open shift in previous dates
            const previousOpenShift = await findOpenShiftInPreviousDates(today);
            
            if (previousOpenShift.success) {
                console.log(`‚úì Found open shift in previous date: ${previousOpenShift.foundDate}`);
                shiftData = previousOpenShift.shiftData;
                documentDate = previousOpenShift.foundDate;
                foundDate = previousOpenShift.foundDate;
                foundDateForDocId = previousOpenShift.foundDateForDocId;
                shiftCheck = previousOpenShift.shiftCheck;
            } else {
                console.log("‚ö†Ô∏è No shift data found at all");
                return {
                    success: false,
                    message: "No shift data found for today or previous dates",
                    date: todayDateForDisplay,
                    isActive: false
                };
            }
        }
        
        console.log("üìä Final shift analysis:", shiftCheck);
        
        // Format date for nice display
        const displayDate = new Date(foundDate).toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        // Add indicator if not today's date
        let dateIndicator = "";
        if (foundDate !== todayDateForDisplay) {
            const foundDateObj = new Date(foundDate);
            const todayObj = new Date(todayDateForDisplay);
            const daysDiff = Math.floor((todayObj - foundDateObj) / (1000 * 60 * 60 * 24));
            
            if (daysDiff === 1) {
                dateIndicator = " (Yesterday)";
            } else {
                dateIndicator = ` (${daysDiff} days ago)`;
            }
        }
        
        const result = {
            success: true,
            name: shiftCheck.shiftName,
            date: displayDate + dateIndicator,
            firestoreDate: documentDate,
            foundDate: foundDate,
            foundDateForDocId: foundDateForDocId,
            isActive: shiftCheck.isActive,
            openTime: shiftCheck.openTime,
            shiftType: shiftCheck.shiftType,
            fullData: shiftData,
            lastUpdated: shiftData.lastUpdated || "",
            timestamp: new Date().toISOString(),
            isFromPreviousDay: foundDate !== todayDateForDisplay,
            documentId: `shift_${foundDateForDocId}`
        };
        
        console.log("üì¶ Final result:", result);
        
        // Save to localStorage
        saveShiftToLocalStorage(result);
        
        return result;
        
    } catch (error) {
        console.error("‚ùå Error fetching shift data:", error);
        return {
            success: false,
            message: "Error: " + error.message,
            timestamp: new Date().toISOString()
        };
    }
}

// ----------- SAVE TO LOCAL STORAGE -----------
function saveShiftToLocalStorage(shiftData) {
    try {
        localStorage.setItem(SHIFT_STORAGE_KEY, JSON.stringify(shiftData));
        localStorage.setItem(SHIFT_TIMESTAMP_KEY, new Date().toISOString());
        console.log("üíæ Saved shift data to localStorage");
    } catch (e) {
        console.error("‚ùå Error saving to localStorage:", e);
    }
}

// ----------- LOAD FROM LOCAL STORAGE -----------
function loadShiftFromLocalStorage() {
    try {
        const savedData = localStorage.getItem(SHIFT_STORAGE_KEY);
        const savedTimestamp = localStorage.getItem(SHIFT_TIMESTAMP_KEY);
        
        if (!savedData || !savedTimestamp) {
            console.log("üì≠ No saved shift data found");
            return null;
        }
        
        const data = JSON.parse(savedData);
        const timestamp = new Date(savedTimestamp);
        const now = new Date();
        const minutesDiff = (now - timestamp) / (1000 * 60);
        
        console.log("üìÇ Loaded shift data from localStorage (age:", minutesDiff.toFixed(0), "minutes)");
        
        // Data is considered fresh if less than 5 minutes old
        if (minutesDiff < 5) {
            return data;
        } else {
            console.log("üìõ Saved data is outdated (older than 5 minutes)");
            return null;
        }
        
    } catch (e) {
        console.error("‚ùå Error loading from localStorage:", e);
        return null;
    }
}

// ----------- REFRESH BUTTON HANDLER -----------
async function refreshShiftData() {
    console.log("üîÑ Manual refresh triggered");
    
    const refreshBtn = document.getElementById("refreshBtn");
    refreshBtn.classList.add("loading");
    refreshBtn.disabled = true;
    
    try {
        const result = await fetchShiftData();
        updateUIWithShiftData(result);
    } finally {
        // Remove loading state after a minimum delay
        setTimeout(() => {
            refreshBtn.classList.remove("loading");
            refreshBtn.disabled = false;
        }, 500);
    }
}

// ----------- UPDATE UI -----------
function updateUIWithShiftData(shiftData) {
    console.log("üé® Updating UI with:", shiftData);
    
    if (!shiftData || !shiftData.success) {
        // Show error or cached data
        document.getElementById("shiftName").textContent = shiftData?.message || "Error loading shift";
        document.getElementById("shiftDate").textContent = "";
        document.getElementById("statusText").textContent = "Error";
        document.getElementById("statusDot").classList.add("inactive");
        document.getElementById("statusDot").style.backgroundColor = "#e74c3c";
        document.getElementById("lastUpdated").textContent = "Failed to load data";
        
        // Disable passenger entry
        disablePassengerEntry();
        return;
    }
    
    // Update shift display
    let displayName = shiftData.name;
    if (shiftData.openTime && shiftData.openTime.trim() !== "" && shiftData.isActive) {
        displayName += ` (Opened at ${shiftData.openTime})`;
    }
    
    // Add indicator if from previous day
    if (shiftData.isFromPreviousDay) {
        displayName += " ‚è™";
    }
    
    document.getElementById("shiftName").textContent = displayName;
    document.getElementById("shiftDate").textContent = shiftData.date;
    
    // Update status
    if (shiftData.isActive) {
        document.getElementById("statusText").textContent = "Active";
        document.getElementById("statusDot").classList.remove("inactive");
        document.getElementById("statusDot").style.backgroundColor = "#2ecc71";
        enablePassengerEntry();
    } else {
        document.getElementById("statusText").textContent = "Inactive";
        document.getElementById("statusDot").classList.add("inactive");
        document.getElementById("statusDot").style.backgroundColor = "#95a5a6";
        disablePassengerEntry();
    }
    
    // Update last updated time
    const updatedTime = new Date(shiftData.timestamp).toLocaleTimeString();
    document.getElementById("lastUpdated").textContent = `Last updated: ${updatedTime}`;
    
    // Also show Firestore lastUpdated if available
    if (shiftData.lastUpdated) {
        const firestoreTime = new Date(shiftData.lastUpdated).toLocaleTimeString();
        console.log("üïê Firestore lastUpdated:", firestoreTime);
    }
}

// ----------- PASSENGER ENTRY CONTROL -----------
function enablePassengerEntry() {
    const passengerCard = document.getElementById("passengerEntryCard");
    passengerCard.classList.remove("disabled");
    passengerCard.onclick = function() {
        console.log("üìù Opening passenger entry...");
        window.location.href = "cardentry1.html";
    };
    passengerCard.style.cursor = "pointer";
    passengerCard.title = "Click to enter passengers";
    console.log("‚úÖ Passenger entry ENABLED");
}

function disablePassengerEntry() {
    const passengerCard = document.getElementById("passengerEntryCard");
    passengerCard.classList.add("disabled");
    passengerCard.onclick = null;
    passengerCard.style.cursor = "not-allowed";
    passengerCard.title = "Cannot enter passengers when no shift is open";
    console.log("‚õî Passenger entry DISABLED");
}

// ----------- INITIAL LOAD -----------
async function initializeDashboard() {
    console.log("üöÄ Initializing dashboard...");
    
    // First, try to load from localStorage (cached for 5 minutes)
    const cachedData = loadShiftFromLocalStorage();
    
    if (cachedData) {
        console.log("üìä Using cached data");
        updateUIWithShiftData(cachedData);
    } else {
        console.log("üåê No valid cache, fetching from Firestore");
        document.getElementById("shiftName").textContent = "Loading from server...";
    }
    
    // Always fetch fresh data from Firestore
    try {
        const result = await fetchShiftData();
        updateUIWithShiftData(result);
    } catch (error) {
        console.error("‚ùå Initial fetch failed:", error);
        if (!cachedData) {
            document.getElementById("shiftName").textContent = "Failed to load shift data";
            document.getElementById("statusText").textContent = "Error";
            document.getElementById("statusDot").style.backgroundColor = "#e74c3c";
        }
    }
}

// ----------- NAVIGATION -----------
function openPage(page) {
    console.log("üîó Navigating to:", page);
    window.location.href = page;
}

// ----------- SETUP EVENT LISTENERS -----------
document.addEventListener('DOMContentLoaded', function() {
    console.log("üìÑ DOM loaded, setting up dashboard...");
    
    // Setup refresh button
    const refreshBtn = document.getElementById("refreshBtn");
    if (refreshBtn) {
        refreshBtn.addEventListener('click', refreshShiftData);
    }
    
    // Initialize dashboard with a delay to ensure everything loads
    setTimeout(() => {
        initializeDashboard();
    }, 1000);
});

// ----------- DEBUG FUNCTIONS -----------
window.showStoredData = function() {
    const data = localStorage.getItem(SHIFT_STORAGE_KEY);
    const timestamp = localStorage.getItem(SHIFT_TIMESTAMP_KEY);
    
    console.log("=== LOCAL STORAGE DATA ===");
    console.log("Shift data:", data ? JSON.parse(data) : "No data");
    console.log("Timestamp:", timestamp);
    console.log("Age:", timestamp ? ((new Date() - new Date(timestamp)) / 1000 / 60).toFixed(2) + " minutes" : "N/A");
};

window.clearShiftCache = function() {
    localStorage.removeItem(SHIFT_STORAGE_KEY);
    localStorage.removeItem(SHIFT_TIMESTAMP_KEY);
    console.log("üßπ Cleared shift cache");
    alert("Shift cache cleared. Refreshing...");
    refreshShiftData();
};

// Add this function to debug the Firebase data structure
window.debugShiftData = async function() {
    console.log("=== DEBUG SHIFT DATA ===");
    
    if (!shiftFirestore) {
        console.log("‚ùå Firestore not initialized");
        return;
    }
    
    const today = new Date();
    const todayDateForDocId = formatDateForDocumentId(today);
    const todayDocId = `shift_${todayDateForDocId}`;
    
    console.log("Looking for document:", todayDocId);
    
    try {
        const shiftDoc = await shiftFirestore.collection("shifts").doc(todayDocId).get();
        
        if (!shiftDoc.exists) {
            console.log("‚ùå No document found for:", todayDocId);
            
            // Try alternative format just in case
            const altDocId = `shift_${formatDateForDisplay(today).replace(/-/g, '_')}`;
            console.log("Trying alternative format:", altDocId);
            
            const altDoc = await shiftFirestore.collection("shifts").doc(altDocId).get();
            if (altDoc.exists) {
                console.log("‚úÖ Found document with alternative format!");
                const data = altDoc.data();
                console.log("üìÑ Full document data:", JSON.stringify(data, null, 2));
                console.log("üìÑ Document ID:", altDoc.id);
            } else {
                console.log("‚ùå No document found with alternative format either");
            }
            return;
        }
        
        const data = shiftDoc.data();
        console.log("üìÑ Full document data:", JSON.stringify(data, null, 2));
        console.log("üìÑ Document ID:", shiftDoc.id);
        console.log("üìÑ Document exists:", shiftDoc.exists);
        
        // Check morning shift structure
        console.log("\nüåÖ Morning shift analysis:");
        console.log("Morning shift exists:", !!data.morning);
        if (data.morning) {
            console.log("Morning object:", data.morning);
            console.log("Morning status:", data.morning.status);
            console.log("Type of morning.status:", typeof data.morning.status);
            console.log("Value comparison: data.morning.status === 'open'", data.morning.status === 'open');
        }
        
        // Check evening shift structure
        console.log("\nüåô Evening shift analysis:");
        console.log("Evening shift exists:", !!data.evening);
        if (data.evening) {
            console.log("Evening object:", data.evening);
            console.log("Evening status:", data.evening.status);
            console.log("Type of evening.status:", typeof data.evening.status);
            console.log("Value comparison: data.evening.status === 'open'", data.evening.status === 'open');
        }
        
        // Check date field
        console.log("\nüìÖ Date field analysis:");
        console.log("Date field exists:", !!data.date);
        console.log("Date value:", data.date);
        console.log("Date type:", typeof data.date);
        
    } catch (error) {
        console.error("‚ùå Debug error:", error);
    }
};

window.testShiftConnection = async function() {
    console.log("=== SHIFT CONNECTION TEST ===");
    console.log("fireshift.js config loaded:", typeof shiftFirebaseConfig !== 'undefined');
    console.log("firebase SDK loaded:", typeof firebase !== 'undefined');
    console.log("shiftFirestore:", shiftFirestore);
    
    // Initialize if needed
    if (!shiftFirestore) {
        shiftFirestore = initializeShiftFirebase();
    }
    
    // Test Firebase connection
    if (shiftFirestore) {
        console.log("‚úÖ Shift Firestore is initialized");
        
        // Try to get today's shift
        const today = new Date();
        const todayDateForDocId = formatDateForDocumentId(today);
        const docId = `shift_${todayDateForDocId}`;
        
        console.log("Looking for document:", docId);
        
        try {
            const shiftDoc = await shiftFirestore.collection("shifts").doc(docId).get();
            console.log("üìä Today's shift document:", shiftDoc.exists ? "Exists" : "Does not exist");
            if (shiftDoc.exists) {
                const data = shiftDoc.data();
                console.log("Date field:", data.date);
                console.log("Morning status:", data.morning?.status);
                console.log("Evening status:", data.evening?.status);
                console.log("Document ID used:", docId);
            }
        } catch (err) {
            console.error("Error getting today's shift:", err);
        }
    } else {
        console.log("‚ùå Shift Firestore not initialized");
    }
};

// Direct test function to check current shift
window.testCurrentShift = async function() {
    console.log("=== TEST CURRENT SHIFT ===");
    
    if (!shiftFirestore) {
        shiftFirestore = initializeShiftFirebase();
    }
    
    const today = new Date();
    const todayDateForDocId = formatDateForDocumentId(today);
    const docId = `shift_${todayDateForDocId}`;
    
    console.log("Testing with document ID:", docId);
    
    try {
        const shiftDoc = await shiftFirestore.collection("shifts").doc(docId).get();
        
        if (shiftDoc.exists) {
            const data = shiftDoc.data();
            console.log("Document ID:", docId);
            console.log("Document date field:", data.date);
            
            console.log("\nMorning shift details:");
            if (data.morning) {
                console.log("Status:", data.morning.status);
                console.log("Open time:", data.morning.open);
                console.log("Close time:", data.morning.close);
                console.log("Is status 'open'?", data.morning.status === 'open');
            } else {
                console.log("No morning shift data");
            }
            
            console.log("\nEvening shift details:");
            if (data.evening) {
                console.log("Status:", data.evening.status);
                console.log("Open time:", data.evening.open);
                console.log("Close time:", data.evening.close);
                console.log("Is status 'open'?", data.evening.status === 'open');
            } else {
                console.log("No evening shift data");
            }
            
            // Test the logic
            console.log("\nüìã Logic test:");
            let isActive = false;
            let shiftName = "No Shift Open";
            
            if (data.morning && data.morning.status === "open") {
                isActive = true;
                shiftName = "Morning Shift";
                console.log("‚úì Morning shift would be active");
            } else if (data.evening && data.evening.status === "open") {
                isActive = true;
                shiftName = "Evening Shift";
                console.log("‚úì Evening shift would be active");
            } else {
                console.log("‚úó No active shift");
            }
            
            console.log("\nResult would be:");
            console.log("Shift name:", shiftName);
            console.log("Is active:", isActive);
            
        } else {
            console.log("No shift document found for:", docId);
        }
    } catch (error) {
        console.error("Test error:", error);
    }
};

// Test function for previous date search
window.testPreviousSearch = async function() {
    console.log("=== TEST PREVIOUS DATE SEARCH ===");
    
    if (!shiftFirestore) {
        shiftFirestore = initializeShiftFirebase();
    }
    
    const today = new Date();
    
    console.log("Starting from date:", formatDateForDisplay(today));
    console.log("Document ID format:", formatDateForDocumentId(today));
    
    const result = await findOpenShiftInPreviousDates(today);
    console.log("Search result:", result);
    
    if (result.success) {
        alert(`Found open shift in date: ${result.foundDate}\nDocument ID: shift_${result.foundDateForDocId}`);
    } else {
        alert("No open shift found in previous dates");
    }
};

// Quick check function
window.quickCheck = function() {
    console.log("‚ö° Quick check");
    console.log("User:", userData?.name || "No user");
    console.log("ShiftFirestore:", shiftFirestore ? "Initialized" : "Not initialized");
    
    const today = new Date();
    console.log("Today for doc ID:", formatDateForDocumentId(today));
    console.log("Today for display:", formatDateForDisplay(today));
    
    // Show current UI state
    console.log("UI state:");
    console.log("Shift name:", document.getElementById("shiftName").textContent);
    console.log("Status text:", document.getElementById("statusText").textContent);
    console.log("Passenger entry:", document.getElementById("passengerEntryCard").classList.contains("disabled") ? "Disabled" : "Enabled");
};
</script>
</body>
</html>
