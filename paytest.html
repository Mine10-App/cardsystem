<!DOCTYPE html>
<html>
<head>
  <title>Passenger Payment POS</title>
  <style>
    /* ======== GOLDEN THEME STYLES ======== */
    :root {
      --gold-light: #faf3e0;
      --gold-medium: #f5e6ca;
      --gold-dark: #d4b483;
      --gold-accent: #c19a6b;
      --gold-deep: #b8860b;
      --text-dark: #333333;
      --text-medium: #5a4a42;
      --text-light: #7a6a62;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, var(--gold-light) 0%, var(--gold-medium) 100%);
      min-height: 100vh;
      color: var(--text-dark);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .containerB {
      max-width: 1200px;
      margin: 0 auto;
      height: auto;
      min-height: 0;
      padding: 1px 0;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 20px 25px;
      background: linear-gradient(135deg, var(--gold-accent) 0%, var(--gold-deep) 100%);
      color: white;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(193, 154, 107, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .header-left h1 {
      margin: 0;
      font-size: 26px;
      font-weight: 600;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .header-left p {
      margin: 5px 0 0;
      opacity: 0.95;
      font-size: 14px;
      font-weight: 300;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .search-container {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .button-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      padding: 10px;
      background: linear-gradient(to right, #a67c00, #c59402);
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .home-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 7px 20px;
      background-color: #f5ede9;
      color: rgb(0, 0, 0);
      border: #ffffff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      text-decoration: none;
      transition: background-color 0.3s;
    }

    .home-btn:hover {
      background-color: #da7f3e;
      text-decoration: none;
      color: white;
    }

    .home-btn .icon-home {
      margin-right: 8px;
      font-size: 18px;
    }
    
    .search-input {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      width: 200px;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.9);
    }
    
    .search-btn {
      padding: 8px 15px;
      background: rgba(255, 255, 255, 0.9);
      color: var(--gold-deep);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .search-btn:hover {
      background: white;
      transform: translateY(-1px);
    }
    
    .main-content {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(193, 154, 107, 0.1);
      flex: 1;
      min-width: 300px;
      border: 1px solid var(--gold-medium);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(193, 154, 107, 0.15);
    }
    
    .card h3 {
      margin-top: 0;
      color: var(--gold-deep);
      padding-bottom: 10px;
      border-bottom: 2px solid var(--gold-dark);
      font-size: 18px;
      font-weight: 600;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text-medium);
      font-size: 14px;
    }
    
    .input-group input, .input-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gold-medium);
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
      transition: all 0.3s;
      background-color: white;
      color: var(--text-dark);
    }
    
    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: var(--gold-accent);
      box-shadow: 0 0 0 3px rgba(193, 154, 107, 0.2);
    }
    
    .input-group input[readonly] {
      background-color: var(--gold-light);
      font-weight: 600;
      color: var(--text-dark);
      border-color: var(--gold-dark);
      padding: 8px 12px;
      font-size: 13px;
    }
    
    .input-group input.positive {
      color: #27ae60;
      font-weight: bold;
    }
    
    .input-group input.negative {
      color: #e74c3c;
      font-weight: bold;
    }
    
    .input-group input.zero {
      color: var(--gold-deep);
      font-weight: bold;
    }
    
    .row {
      display: flex;
      gap: 12px;
    }
    
    .row .input-group {
      flex: 1;
    }
    
    .boarding-pass-section {
      background: linear-gradient(135deg, #fff9f0 0%, #fef5e7 100%);
      border-left: 4px solid var(--gold-accent);
      width: 100%;
      margin-bottom: 20px;
      border: 1px solid var(--gold-dark);
    }
    
    .boarding-pass-section h3 {
      border-bottom-color: var(--gold-accent);
    }
    
    .section-note {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 5px;
      font-style: italic;
    }
    
    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      flex: 1;
      min-width: 140px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .btn i {
      font-size: 16px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--gold-accent) 0%, var(--gold-deep) 100%);
      color: white;
      border: 1px solid var(--gold-dark);
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, var(--gold-deep) 0%, #a67c00 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(193, 154, 107, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
      border: 1px solid #229954;
    }
    
    .btn-success:hover {
      background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
      color: white;
      border: 1px solid #6c7b7d;
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, #7f8c8d 0%, #636e72 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(127, 140, 141, 0.3);
    }
    
    .btn-info {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      border: 1px solid #2573a7;
    }
    
    .btn-info:hover {
      background: linear-gradient(135deg, #2980b9 0%, #1f639b 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }
    
    .payment-summary {
      background: linear-gradient(135deg, #f8f9fa 0%, #f1f8e9 100%);
      border-left: 4px solid var(--gold-deep);
      border: 1px solid var(--gold-accent);
    }
    
    .payment-summary .input-group label {
      color: var(--text-dark);
      font-weight: 600;
      font-size: 13px;
    }
    
    .summary-value {
      font-size: 16px;
      font-weight: bold;
      color: var(--gold-deep);
      text-align: right;
    }
    
    #log {
      margin-top: 15px;
    }
    
    .logs-section {
      width: 100%;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      box-shadow: 0 2px 8px rgba(193, 154, 107, 0.1);
      border-radius: 6px;
      overflow: hidden;
    }
    
    th {
      background: linear-gradient(135deg, var(--gold-accent) 0%, var(--gold-deep) 100%);
      color: white;
      padding: 12px 14px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid var(--gold-dark);
      font-size: 14px;
    }
    
    td {
      padding: 10px 14px;
      border-bottom: 1px solid var(--gold-light);
      background-color: white;
      font-size: 13px;
    }
    
    tr:hover {
      background-color: var(--gold-light);
    }
    
    .action-btn {
      padding: 6px 12px;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      font-size: 12px;
    }
    
    .action-btn:hover {
      background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(231, 76, 60, 0.3);
    }
    
    .edit-btn {
      padding: 6px 12px;
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      font-size: 12px;
      margin-right: 4px;
    }
    
    .edit-btn:hover {
      background: linear-gradient(135deg, #2980b9 0%, #1f639b 100%);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(52, 152, 219, 0.3);
    }
    
    .complete-btn {
      padding: 6px 12px;
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      font-size: 12px;
      margin-right: 4px;
    }
    
    .complete-btn:hover {
      background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(46, 204, 113, 0.3);
    }
    
    .print-btn {
      padding: 6px 12px;
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      font-size: 12px;
      margin-right: 4px;
    }
    
    .print-btn:hover {
      background: linear-gradient(135deg, #8e44ad 0%, #7d3c98 100%);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(155, 89, 182, 0.3);
    }
    
    .currency-badge {
      display: inline-block;
      padding: 3px 8px;
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    
    .rate-badge {
      display: inline-block;
      padding: 3px 8px;
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
      color: white;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    
    .payment-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    
    .payment-cash {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
    }
    
    .payment-card {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      color: white;
    }
    
    .payment-method-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 4px;
    }
    
    .payment-method-visa {
      background: linear-gradient(135deg, #1a1f71 0%, #1a237e 100%);
      color: white;
    }
    
    .payment-method-mastercard {
      background: linear-gradient(135deg, #eb001b 0%, #f79e1b 100%);
      color: white;
    }
    
    .payment-method-amex {
      background: linear-gradient(135deg, #2e77bb 0%, #006fcf 100%);
      color: white;
    }
    
    .payment-method-unionpay {
      background: linear-gradient(135deg, #ff5f00 0%, #ff7f00 100%);
      color: white;
    }
    
    .payment-method-qr {
      background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
      color: white;
    }
    
    .card-details {
      font-size: 10px;
      color: var(--text-light);
      margin-top: 3px;
    }
    
    .status-pending {
      display: inline-block;
      padding: 3px 8px;
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      color: white;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    
    .status-completed {
      display: inline-block;
      padding: 3px 8px;
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    
    .status-void {
      display: inline-block;
      padding: 3px 8px;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    
    .shift-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    
    .shift-morning {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
    }
    
    .shift-evening {
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
      color: white;
    }
    
    .receipt-badge {
      display: inline-block;
      padding: 3px 8px;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }

    .void-badge {
      display: inline-block;
      padding: 3px 8px;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    .compact-info-summary {
      display: flex;
      justify-content: space-between;
      background: var(--gold-light);
      padding: 10px 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      border: 1px solid var(--gold-medium);
    }

    .info-row {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      flex: 1;
    }

    .info-row .info-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-medium);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .info-value-summary {
      font-size: 14px;
      font-weight: bold;
      color: var(--gold-deep);
      background: white;
      padding: 5px 12px;
      border-radius: 4px;
      min-width: 120px;
      text-align: center;
      border: 1px solid var(--gold-accent);
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .header-right {
        flex-direction: column;
        width: 100%;
      }
      
      .compact-info {
        text-align: center;
      }
      
      .search-container {
        width: 100%;
      }
      
      .search-input {
        width: 100%;
      }
      
      .main-content {
        flex-direction: column;
      }
      
      .row {
        flex-direction: column;
        gap: 10px;
      }
      
      .btn {
        min-width: 100%;
      }
      
      .header-left h1 {
        font-size: 22px;
      }
      
      .compact-info-summary {
        flex-wrap: wrap;
      }
      
      .info-row {
        min-width: 45%;
        margin-bottom: 10px;
      }
    }
    
    /* Hidden receipt styles */
    #receiptArea {
      display: none;
    }
    
    .gold-ornament {
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--gold-accent), transparent);
      margin: 8px 0;
    }
    
    /* Icon styles */
    .icon {
      display: inline-block;
      width: 18px;
      height: 18px;
      background-size: contain;
      background-repeat: no-repeat;
      vertical-align: middle;
      margin-right: 6px;
    }
    
    .icon-scan { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M2 6h2v12H2zm3 0h1v12H5zm2 0h3v12H7zm4 0h1v12h-1zm3 0h2v12h-2zm4 0h1v12h-1zm2 0h1v12h-1zm2 0h2v12h-2z"/></svg>'); }
    .icon-save { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>'); }
    .icon-print { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>'); }
    .icon-view { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>'); }
    .icon-search { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>'); }
     .icon-home { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>'); }
    .icon-report { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M15.73 3H8.27L3 8.27v7.46L8.27 21h7.46L21 15.73V8.27L15.73 3zM12 17.3c-.72 0-1.3-.58-1.3-1.3s.58-1.3 1.3-1.3 1.3.58 1.3 1.3-.58 1.3-1.3 1.3zm1-4.3h-2V7h2v6z"/></svg>'); }
    .icon-void { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c19a6b"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>'); }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 10px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      border: 1px solid var(--gold-medium);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--gold-dark);
    }
    
    .modal-header h3 {
      margin: 0;
      color: var(--gold-deep);
      font-size: 18px;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: var(--text-light);
    }
    
    .close-modal:hover {
      color: var(--gold-accent);
    }
    
    /* Modal select styling */
    .modal select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gold-medium);
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
      transition: all 0.3s;
      background-color: white;
      color: var(--text-dark);
      cursor: pointer;
    }
    
    .modal select:focus {
      outline: none;
      border-color: var(--gold-accent);
      box-shadow: 0 0 0 3px rgba(193, 154, 107, 0.2);
    }
    
    .modal select[readonly] {
      background-color: var(--gold-light);
      cursor: not-allowed;
    }
    
    /* Tabs for payment logs */
    .tab-container {
      margin-bottom: 15px;
    }
    
    .tab-buttons {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
    }
    
    .tab-btn {
      padding: 8px 16px;
      background: var(--gold-light);
      border: 1px solid var(--gold-medium);
      border-radius: 5px 5px 0 0;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-medium);
      transition: all 0.3s;
      font-size: 13px;
    }
    
    .tab-btn.active {
      background: var(--gold-accent);
      color: white;
      border-color: var(--gold-accent);
    }
    
    .tab-btn:hover:not(.active) {
      background: var(--gold-medium);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .expiry-note {
      font-size: 10px;
      color: #e74c3c;
      margin-top: 3px;
      font-weight: 600;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1001;
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
      max-width: 300px;
    }
    
    .notification.success {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    }
    
    .notification.warning {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    }
    
    .notification.error {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }
    
    .notification.info {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    /* Login user display */
    .user-display {
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 15px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 13px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      min-width: 150px;
      text-align: center;
      cursor: pointer;
    }
    
    .user-display:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    /* Supervisor specific styles */
    .supervisor-only {
      border-left: 4px solid #3498db;
      background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%);
    }
    
    .shift-select-container {
      margin-top: 10px;
      padding: 10px;
      background: rgba(52, 152, 219, 0.1);
      border-radius: 6px;
      border: 1px solid #3498db;
      display: none;
    }
    
    .shift-select-container .input-group {
      margin-bottom: 0;
    }
    
    /* Card separator */
    .card-separator {
      border-top: 1px solid var(--gold-medium);
      margin: 15px 0;
    }
    
    /* Void receipt warning */
    .void-warning {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
      text-align: center;
      font-weight: bold;
      border: 2px dashed white;
    }
    
    .void-info {
      background: linear-gradient(135deg, #f5b7b1 0%, #f1948a 100%);
      padding: 8px;
      border-radius: 6px;
      margin: 5px 0;
      border-left: 4px solid #c0392b;
    }
    
    /* Refresh button in search modal */
    .refresh-btn {
      padding: 5px 10px;
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .refresh-btn:hover {
      background: linear-gradient(135deg, #2980b9 0%, #1f639b 100%);
      transform: translateY(-1px);
    }
  </style>
</head>
<body>
  <div class="containerB">
    <div class="button-container">
          <button class="home-btn" onclick="window.location.href='dashP.html'">
            <span class="icon icon-home"></span> Home
          </button>

          <button class="home-btn" onclick="window.location.href='shiftend.html'">
            <span class="icon icon-report"></span> Report
          </button>
          <button class="home-btn" onclick="window.location.href='void.html'">
            <span class="icon icon-void"></span> Void
          </button>
        </div>
      </div>
  <div class="container">
    <!-- COMPACT HEADER WITH SEARCH -->
    <div class="header">
      <div class="header-left">
        <h1>Passenger Payment POS</h1>
        <p>Koveli Lounge - Passenger Payment Processing</p>
      </div>
      <div class="header-right">
        <div class="user-display" id="userDisplay" onclick="logoutUser()" title="Double-click to logout">
          <span id="currentUser">Loading...</span>
        </div>
        <div class="search-container">
          <input class="search-input" id="receiptSearch" type="text" placeholder="Receipt No...">
          <button class="search-btn" onclick="searchReceipt()">
            <span class="icon icon-search"></span>Search
          </button>
        </div>
      </div>
    </div>
    
    <!-- BOARDING PASS SECTION -->
    <div class="card boarding-pass-section">
      <h3><span class="icon icon-scan"></span>Boarding Pass Scanning</h3>
      <div class="input-group">
        <input id="codeInput" type="text" placeholder="Paste boarding pass barcode content here">
        <div class="section-note">The system will automatically parse passenger information</div>
      </div>
    </div>
    
    <div class="main-content">
      <div class="card">
        <h3>Passenger Information</h3>
        <div class="row">
          <div class="input-group">
            <label for="name">Full Name</label>
            <input id="name" type="text" placeholder="Passenger name">
          </div>
          <div class="input-group">
            <label for="flightNo">Flight Number</label>
            <input id="flightNo" type="text" placeholder="Flight code">
          </div>
        </div>
        
        <div class="row">
          <div class="input-group">
            <label for="seatNo">Seat Number</label>
            <input id="seatNo" type="text" placeholder="Seat assignment">
          </div>
        </div>
        
        <!-- SUPERVISOR SHIFT SELECTION - HIDDEN FOR REGULAR USERS -->
        <div class="shift-select-container" id="shiftSelectContainer">
          <div class="input-group">
            <label for="shiftTypeSelect">Select Shift (Supervisor Only)</label>
            <select id="shiftTypeSelect" onchange="updateShift()">
              <option value="Morning">Morning Shift</option>
              <option value="Evening">Evening Shift</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3>Passenger Details</h3>
        <div class="row">
          <div class="input-group">
            <label for="adults">Adults</label>
            <input id="adults" type="number" value="1" min="0">
          </div>
          <div class="input-group">
            <label for="kids">Children</label>
            <input id="kids" type="number" value="0" min="0">
          </div>
        </div>
        
        <div class="row">
          <div class="input-group">
            <label for="rateType">Rate Type</label>
            <select id="rateType">
              <option value="A">Rate A (Standard)</option>
              <option value="B">Rate B (Special)</option>
            </select>
          </div>
          <div class="input-group">
            <label for="currency">Currency</label>
            <select id="currency">
              <option value="USD">USD</option>
              <option value="MVR">MVR</option>
            </select>
          </div>
        </div>
        
        <div class="input-group">
          <label for="paymentType">Payment Method</label>
          <select id="paymentType">
            <option value="Card">Card Payment</option>
            <option value="Cash">Cash Payment</option>
            <option value="Visa">Visa</option>
            <option value="MasterCard">MasterCard</option>
            <option value="Amex">American Express (Amex)</option>
            <option value="UnionPay">UnionPay</option>
            <option value="QRSales">QR Sales</option>
          </select>
        </div>
        
        <!-- Cash Payment Fields (Hidden by default) -->
        <div id="cashPaymentFields" style="display: none;">
          <div class="input-group">
            <label for="paidAmount">Paid Amount</label>
            <input id="paidAmount" type="number" value="0.00" step="0.01" min="0">
          </div>
          
          <div class="input-group">
            <label>Balance Amount</label>
            <input id="balance" type="text" readonly class="summary-value" value="0.00">
          </div>
        </div>
      </div>
      
      <div class="card payment-summary">
        <h3>Payment Summary</h3>
        <div class="compact-info-summary">
          <div class="info-row">
            <span class="info-label">Receipt No:</span>
            <span class="info-value-summary" id="headerReceiptNo">AUTO</span>
          </div>
          <div class="info-row">
            <span class="info-label">Expiry Time:</span>
            <span class="info-value-summary" id="headerExpiryTime">--:--</span>
          </div>
        </div>
        <div class="compact-info-summary">
          <!-- ADDED: Current Shift & Date Display -->
          <div class="info-row">
            <span class="info-label">Shift:</span>
            <span class="info-value-summary" id="currentShiftDisplay">Checking...</span>
          </div>
          <div class="info-row">
            <span class="info-label">Date:</span>
            <span class="info-value-summary" id="currentDateDisplay">--/--/----</span>
          </div>
        </div>
        <div class="input-group">
          <label>Subtotal Amount</label>
          <input id="subtotal" type="text" readonly class="summary-value" value="0.00">
        </div>
        
        <div class="input-group">
          <label>GST (8%)</label>
          <input id="gst" type="text" readonly class="summary-value" value="0.00">
        </div>
        
        <div class="input-group">
          <label>Total Amount</label>
          <input id="total" type="text" readonly class="summary-value" value="0.00">
        </div>
        
        <div class="gold-ornament"></div>
        
        <div class="buttons">
          <button class="btn btn-primary" onclick="saveNow()">
            <span class="icon icon-save"></span>Save & Print
          </button>
          <button class="btn btn-success" onclick="printReceipt()">
            <span class="icon icon-print"></span>Reprint
          </button>
          <button class="btn btn-secondary" onclick="loadPayments()">
            <span class="icon icon-view"></span>View Logs
          </button>
          <button class="btn btn-info" onclick="refreshShiftData()">
            üîÑ Refresh Shift
          </button>
        </div>
      </div>
    </div>
    
    <div class="logs-section">
      <div class="card">
        <h3>Today's Pending Payments</h3>
        
        <!-- Tabs for Pending Payments Only -->
        <div class="tab-container">
          <div class="tab-buttons">
            <button class="tab-btn active" onclick="showTab('pendingCards')">Today's Pending</button>
            <button class="tab-btn" onclick="cleanupOldLocalPayments(); loadPayments();">Cleanup Old Data</button>
          </div>
          
          <div id="pendingCards" class="tab-content active">
            <div id="pendingLog">
              <p style="text-align: center; color: var(--text-light); padding: 20px;">
                Click "View Logs" to display today's pending transaction history
              </p>
            </div>
          </div>
        </div>
        
        <!-- Supervisor Cleanup Section -->
        <div id="supervisorCleanupSection" style="display: none; margin-top: 10px;">
          <button class="btn btn-secondary" onclick="manualCleanupAllOldData()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
            üóëÔ∏è Supervisor Cleanup
          </button>
          <div class="section-note">Deletes all local data except today's entries</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for entering card details -->
  <div id="cardDetailsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Enter Payment Details</h3>
        <button class="close-modal" onclick="closeModal()">&times;</button>
      </div>
      
      <div class="input-group">
        <label>Receipt Number</label>
        <input id="modalReceiptNo" type="text" readonly>
      </div>
      
      <div class="input-group">
        <label>Payment ID</label>
        <input id="modalPaymentId" type="text" readonly>
      </div>
      
      <div class="input-group">
        <label>Passenger Name</label>
        <input id="modalPassengerName" type="text" readonly>
      </div>
      
      <div class="input-group">
        <label for="modalPaymentMethod">Payment Method *</label>
        <select id="modalPaymentMethod" required>
          <option value="">Select Payment Method</option>
          <option value="Visa">Visa</option>
          <option value="MasterCard">MasterCard</option>
          <option value="Amex">American Express (Amex)</option>
          <option value="UnionPay">UnionPay</option>
          <option value="QR">QR Sales</option>
        </select>
      </div>
      
      <div class="input-group">
        <label>Total Amount</label>
        <input id="modalTotalAmount" type="text" readonly>
      </div>
      
      <div class="row">
        <div class="input-group">
          <label for="modalBatchNo">Batch Number *</label>
          <input id="modalBatchNo" type="text" placeholder="Enter batch number" required>
        </div>
        <div class="input-group">
          <label for="modalApprovalCode">Approval Code *</label>
          <input id="modalApprovalCode" type="text" placeholder="Enter approval code" required>
        </div>
      </div>
      
      <div class="buttons">
        <button class="btn btn-success" onclick="saveCardDetails()">
          Save & Print Final
        </button>
        <button class="btn btn-secondary" onclick="closeModal()">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Search Result Modal -->
  <div id="searchResultModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Receipt Found</h3>
        <button class="close-modal" onclick="closeSearchModal()">&times;</button>
      </div>
      
      <div id="searchResultContent">
        <!-- Search results will be displayed here -->
      </div>
      
      <div class="buttons" id="searchResultActions" style="display: none;">
        <button class="btn btn-success" onclick="printFoundReceipt()">
          <span class="icon icon-print"></span>Print Receipt
        </button>
        <button class="btn btn-info" onclick="addCardDetailsToFoundReceipt()">
          Add Card Details
        </button>
        <button class="btn btn-secondary" onclick="closeSearchModal()">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Notification Container -->
  <div id="notificationContainer"></div>

  <!-- Hidden Receipt for 76mm Printer - PROFESSIONAL DESIGN with VOID support -->
  <div id="receiptArea" style="display:none;">
    <div id="receiptContent" style="width:280px;font-family:'Courier New', monospace;font-size:12px;line-height:1.2;">
      <!-- Company Header -->
      <div style="text-align:center;font-weight:bold;font-size:14px;margin-bottom:3px;letter-spacing:1px;">
        KOVELI LOUNGE
      </div>
      <div style="text-align:center;font-size:10px;margin-bottom:3px;">
        Velana International Airport
      </div>
      <div style="text-align:center;font-size:9px;margin-bottom:5px;">
        +960 304 6677
      </div>
      
      <!-- Receipt Header -->
      <div style="text-align:center;font-weight:bold;font-size:11px;margin-bottom:5px;border-top:1px dashed #000;border-bottom:1px dashed #000;padding:3px 0;" id="r_header">
        PASSENGER PAYMENT RECEIPT
      </div>
      
      <!-- VOID WARNING BANNER -->
      <div id="r_void_banner" style="display:none;text-align:center;background:#e74c3c;color:white;font-weight:bold;margin-bottom:5px;padding:3px;font-size:12px;border:2px solid #000;">
        ‚ö†Ô∏è VOID RECEIPT ‚ö†Ô∏è
      </div>
      
      <!-- Receipt Info -->
      <div style="margin-bottom:5px;">
        <div style="display:flex;justify-content:space-between;">
          <span><b>Receipt:</b></span>
          <span id="r_receiptNo"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Date:</b></span>
          <span id="r_date"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Shift:</b></span>
          <span id="r_shift"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Staff:</b></span>
          <span id="r_staff"></span>
        </div>
      </div>
      
      <!-- VOID Information -->
      <div id="r_void_info" style="display:none;margin-bottom:5px;background:#f8d7da;border:1px solid #f5c6cb;padding:3px;">
        <div style="text-align:center;font-weight:bold;color:#721c24;font-size:10px;margin-bottom:2px;">VOID INFORMATION</div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Voided By:</b></span>
          <span id="r_voided_by"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Voided At:</b></span>
          <span id="r_voided_at"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Reason:</b></span>
          <span id="r_void_reason"></span>
        </div>
      </div>
      
      <!-- Separator -->
      <div style="border-bottom:1px dashed #000;margin:5px 0;"></div>
      
      <!-- Passenger Details -->
      <div style="margin-bottom:5px;">
        <div style="display:flex;justify-content:space-between;">
          <span><b>Name:</b></span>
          <span id="r_name" style="text-align:right;max-width:180px;"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Flight:</b></span>
          <span id="r_flight"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Seat:</b></span>
          <span id="r_seat"></span>
        </div>
      </div>
      
      <!-- Payment Details -->
      <div style="margin-bottom:5px;">
        <div style="display:flex;justify-content:space-between;">
          <span><b>Adults:</b></span>
          <span id="r_adults"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Children:</b></span>
          <span id="r_kids"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Payment Method:</b></span>
          <span id="r_payment_method"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Currency:</b></span>
          <span id="r_currency"></span>
        </div>
      </div>
      
      <!-- Card Details (only if available) -->
      <div id="r_card_details" style="display:none;margin-bottom:5px;">
        <div style="display:flex;justify-content:space-between;">
          <span><b>Batch No:</b></span>
          <span id="r_batch"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Approval Code:</b></span>
          <span id="r_approval"></span>
        </div>
      </div>
      
      <!-- Cash Details (only if cash payment) -->
      <div id="r_cash_details" style="display:none;margin-bottom:5px;">
        <div style="display:flex;justify-content:space-between;">
          <span><b>Paid Amount:</b></span>
          <span id="r_paid"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span><b>Balance:</b></span>
          <span id="r_balance"></span>
        </div>
      </div>
      
      <!-- Separator -->
      <div style="border-bottom:1px dashed #000;margin:5px 0;"></div>
      
      <!-- Payment Summary -->
      <div style="margin-bottom:5px;">
        <div style="display:flex;justify-content:space-between;">
          <span>Subtotal:</span>
          <span id="r_subtotal"></span>
        </div>
        <div style="display:flex;justify-content:space-between;">
          <span>GST (8%):</span>
          <span id="r_gst"></span>
        </div>
        <div style="display:flex;justify-content:space-between;font-weight:bold;border-top:1px solid #000;padding-top:2px;">
          <span>TOTAL:</span>
          <span id="r_total"></span>
        </div>
      </div>
      
      <!-- Separator -->
      <div style="border-bottom:1px dashed #000;margin:5px 0;"></div>
      
      <!-- Expiry Information -->
      <div style="text-align:center;margin-bottom:5px;" id="r_expiry_section">
        <div style="font-size:10px;"><b>VALID UNTIL</b></div>
        <div style="font-weight:bold;color:#e74c3c;font-size:12px;" id="r_expiry"></div>
      </div>
      
      <!-- Footer -->
      <div style="text-align:center;font-size:9px;margin-top:10px;">
        Thank you for choosing Koveli Lounge
      </div>
      <div style="text-align:center;font-size:8px;margin-top:3px;">
        ---------------------------------
      </div>
    </div>
  </div>

 <!-- Load Firebase SDK first -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- Load your config files -->
<script src="fireW1.js"></script>  <!-- Transaction Firebase (kwakinsys) -->
<script src="fireshift1.js"></script> <!-- Shift Firebase (cardsystem-21773) -->

<!-- Load other files -->
<script src="rate1.js"></script>
<script src="Co.js"></script>

<script>
// ======== MAIN APPLICATION CODE ========

// Store current payment data
let currentPaymentData = null;
let receiptCounter = null;
let lastReceiptNumber = null;
let pendingSyncQueue = [];
let isSyncing = false;
let currentUser = null;
let foundReceiptData = null;
let isSupervisor = false;

// Shift system variables
let shiftFirebase = null;
let shiftData = null;
let currentShift = 'Morning'; // Default shift

// Maldives timezone offset (UTC+5 hours in milliseconds)
const MALDIVES_OFFSET = 5 * 60 * 60 * 1000;

// ======== SHIFT SYSTEM FUNCTIONS - UPDATED ========

// Initialize Shift Firebase (SEPARATE from transaction Firebase)
function initializeShiftFirebase() {
    try {
        // Check if Firebase SDK is loaded
        if (typeof firebase === 'undefined') {
            console.error("Firebase SDK not loaded");
            return false;
        }
        
        // Check if shift config is available
        if (!window.shiftFirebaseConfig) {
            console.error("Shift Firebase config not found. Check fireshift1.js");
            return false;
        }
        
        console.log("Initializing Shift Firebase with config:", window.shiftFirebaseConfig.projectId);
        
        // Check if shift app already exists
        const existingApp = firebase.apps.find(app => app.name === "shiftApp");
        if (existingApp) {
            console.log("Shift app already exists");
            shiftFirebase = firebase.firestore(existingApp);
            return true;
        }
        
        // Initialize new app instance
        try {
            const shiftApp = firebase.initializeApp(window.shiftFirebaseConfig, "shiftApp");
            shiftFirebase = firebase.firestore(shiftApp);
            
            // Enable offline persistence for shift data
            shiftFirebase.enablePersistence().catch(err => {
                console.warn("Shift Firebase persistence failed:", err);
            });
            
            console.log("Shift Firebase (cardsystem-21773) initialized successfully");
            return true;
        } catch (error) {
            console.error("Error initializing Shift Firebase:", error);
            return false;
        }
    } catch (error) {
        console.error("Error in initializeShiftFirebase:", error);
        return false;
    }
}

// Fetch shift data from Shift Firebase
async function fetchShiftData() {
    try {
        // Initialize shift Firebase if not already
        if (!shiftFirebase) {
            if (!initializeShiftFirebase()) {
                console.warn("Shift Firebase initialization failed");
                setDefaultShiftData();
                return null;
            }
        }
        
        console.log("Fetching shift data from shift Firebase...");
        
        // Get ALL shift documents sorted by date (newest first)
        try {
            const snapshot = await shiftFirebase.collection("shifts")
                .orderBy("date", "desc")
                .limit(10)
                .get();
            
            if (snapshot.empty) {
                console.log("No shift documents found in Firebase");
                setDefaultShiftData();
                return shiftData;
            }
            
            // Find today's shift or the most recent open shift
            const today = getMaldivesDate();
            const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD
            
            console.log("Looking for shift data. Today's date:", todayStr);
            
            let foundShift = null;
            let foundDate = null;
            
            snapshot.forEach(doc => {
                const data = doc.data();
                const shiftDate = data.date || doc.id;
                console.log("Checking shift document:", shiftDate, "Data:", data);
                
                // Check if this is today's shift
                if (shiftDate === todayStr) {
                    foundShift = data;
                    foundDate = shiftDate;
                }
                
                // If not found yet, check for open shifts
                if (!foundShift && (data.morning?.status === "open" || data.evening?.status === "open")) {
                    foundShift = data;
                    foundDate = shiftDate;
                }
            });
            
            // If we found a shift, use it
            if (foundShift) {
                shiftData = foundShift;
                shiftData.date = foundDate; // Ensure date is set
                console.log("Found shift data for date:", foundDate, "Data:", shiftData);
                
                // Determine which shift is currently open
                determineCurrentShift(shiftData);
                
                // Update display
                updateShiftDisplay();
                
                return shiftData;
            } else {
                // Use the most recent shift document
                const mostRecentDoc = snapshot.docs[0];
                shiftData = mostRecentDoc.data();
                shiftData.date = shiftData.date || mostRecentDoc.id;
                
                console.log("Using most recent shift:", shiftData.date);
                
                determineCurrentShift(shiftData);
                updateShiftDisplay();
                
                return shiftData;
            }
            
        } catch (firebaseError) {
            console.error("Error fetching shift data:", firebaseError);
            setDefaultShiftData();
            return shiftData;
        }
        
    } catch (error) {
        console.error("Error in fetchShiftData:", error);
        setDefaultShiftData();
        return shiftData;
    }
}

// Set default shift data when Firebase is unavailable
function setDefaultShiftData() {
    // Set the date to today
    const today = getMaldivesDate();
    const todayStr = today.toISOString().split('T')[0];
    
    shiftData = {
        date: todayStr,
        morning: { 
            status: "closed",
            startTime: "06:00",
            endTime: "18:00"
        },
        evening: { 
            status: "closed",
            startTime: "18:00",
            endTime: "06:00"
        }
    };
    
    // Use time-based shift determination
    determineCurrentShift(shiftData);
    updateShiftDisplay();
    
    console.log("Using default shift data for date:", todayStr);
}

// Determine which shift is currently open
function determineCurrentShift(data) {
    const maldivesNow = getMaldivesDate();
    const currentHour = maldivesNow.getUTCHours();
    
    console.log("Current Maldives hour:", currentHour);
    console.log("Morning shift status:", data.morning?.status);
    console.log("Evening shift status:", data.evening?.status);
    
    // Priority 1: Check status fields from Firebase
    if (data.morning?.status === "open") {
        currentShift = "Morning";
        console.log("Shift determined by Firebase status: Morning (open)");
        return currentShift;
    }
    
    if (data.evening?.status === "open") {
        currentShift = "Evening";
        console.log("Shift determined by Firebase status: Evening (open)");
        return currentShift;
    }
    
    // Priority 2: If no open shifts, use time-based logic
    if (currentHour >= 6 && currentHour < 18) {
        currentShift = "Morning";
        console.log("Shift determined by time: Morning (6AM-6PM)");
    } else {
        currentShift = "Evening";
        console.log("Shift determined by time: Evening (6PM-6AM)");
    }
    
    return currentShift;
}

// Update shift display on the page using date FROM Firebase
function updateShiftDisplay() {
    if (!shiftData) {
        document.getElementById("currentShiftDisplay").textContent = "Morning";
        document.getElementById("currentDateDisplay").textContent = "--/--/----";
        return;
    }
    
    // Get date FROM shiftData (from Firebase document)
    let displayDate = "--/--/----";
    if (shiftData.date) {
        try {
            // Parse the date string (could be YYYY-MM-DD or DD/MM/YYYY)
            let dateStr = shiftData.date.toString();
            
            // If it's in YYYY-MM-DD format, convert to DD/MM/YYYY
            if (dateStr.includes('-') && dateStr.split('-')[0].length === 4) {
                const [year, month, day] = dateStr.split('-');
                displayDate = `${day}/${month}/${year}`;
            } else {
                // Assume it's already in DD/MM/YYYY format
                displayDate = dateStr;
            }
            
            console.log("Using date from Firebase shift document:", shiftData.date, "->", displayDate);
        } catch (e) {
            console.error("Error formatting date:", e);
            displayDate = shiftData.date;
        }
    }
    
    // Update display elements
    document.getElementById("currentShiftDisplay").textContent = currentShift;
    document.getElementById("currentDateDisplay").textContent = displayDate;
    
    // Also update the shift dropdown if supervisor
    if (isSupervisor && document.getElementById("shiftTypeSelect")) {
        document.getElementById("shiftTypeSelect").value = currentShift;
    }
    
    console.log(`Shift display updated: ${currentShift} | Date from Firebase: ${displayDate}`);
}

// Refresh shift data manually
async function refreshShiftData() {
    showNotification("Refreshing shift data...", "info", 1500);
    await fetchShiftData();
    showNotification(`Shift updated: ${currentShift}`, "success");
}

// ======== END SHIFT SYSTEM FUNCTIONS ========

// Check if Firebase is initialized
function checkFirebase() {
  if (!window.walkinDb) {
    console.error("Firebase not initialized. Check fireW.js");
    return false;
  }
  return true;
}

// Check if Company Info is loaded
function checkCompanyInfo() {
  if (!window.companyInfo) {
    console.warn("Company info not loaded from Co.js");
    // Provide default values
    window.companyInfo = {
      name: "Koveli Lounge",
      address: "Velana International Airport",
      phone: "+960 304 6677"
    };
  }
}

// ======== TIMEZONE HELPER FUNCTIONS ========
function getMaldivesDate() {
  // Returns current date/time in Maldives timezone (UTC+5)
  const now = new Date();
  return new Date(now.getTime() + MALDIVES_OFFSET);
}

function getMaldivesTodayRange() {
  // Get today's start and end in Maldives timezone
  const maldivesNow = getMaldivesDate();
  
  // Start of day in Maldives (00:00:00)
  const start = new Date(maldivesNow);
  start.setUTCHours(0, 0, 0, 0);
  const startUTC = new Date(start.getTime() - MALDIVES_OFFSET);
  
  // End of day in Maldives (23:59:59.999)
  const end = new Date(maldivesNow);
  end.setUTCHours(23, 59, 59, 999);
  const endUTC = new Date(end.getTime() - MALDIVES_OFFSET);
  
  return { start: startUTC, end: endUTC };
}

function parsePaymentDate(payment) {
  // Parse payment date consistently with timezone awareness
  
  // First, check for voided timestamp (for voided receipts)
  if (payment.voidedAt) {
    const voidDate = new Date(payment.voidedAt);
    if (!isNaN(voidDate.getTime())) {
      return voidDate;
    }
  }
  
  // Try different timestamp fields
  if (payment.timestamp) {
    if (payment.timestamp.toDate) {
      return payment.timestamp.toDate();
    } else if (typeof payment.timestamp === 'string') {
      return new Date(payment.timestamp);
    } else if (payment.timestamp.seconds) {
      // Firebase Timestamp
      return new Date(payment.timestamp.seconds * 1000);
    }
  }
  
  if (payment.localSaveTime) {
    const date = new Date(payment.localSaveTime);
    if (!isNaN(date.getTime())) return date;
  }
  
  if (payment.time) {
    const date = new Date(payment.time);
    if (!isNaN(date.getTime())) return date;
  }
  
  if (payment.createdAt) {
    const date = new Date(payment.createdAt);
    if (!isNaN(date.getTime())) return date;
  }
  
  // Fallback: Use current date
  return new Date();
}

function isTodayInMaldives(date) {
  // Check if a date is today in Maldives timezone
  const { start, end } = getMaldivesTodayRange();
  return date >= start && date <= end;
}

function formatDateForDisplay(date) {
  // Format date in Maldives timezone
  const maldivesDate = new Date(date.getTime() + MALDIVES_OFFSET);
  return maldivesDate.toLocaleDateString('en-GB', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// ======== NOTIFICATION SYSTEM ========
function showNotification(message, type = 'info', duration = 3000) {
  const container = document.getElementById('notificationContainer');
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  notification.style.animationDuration = `${duration/1000}s`;
  
  container.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, duration);
}

// ======== USER MANAGEMENT ========
function getCurrentUser() {
  // Check if user is logged in from localStorage
  const userData = JSON.parse(localStorage.getItem("loggedInUser"));
  
  if (!userData) {
    // Redirect to login page if not logged in
    window.location.href = "login.html";
    return null;
  }
  
  currentUser = userData.name || userData.username;
  isSupervisor = userData.Level === 'Supervisor';
  
  // Display user info
  document.getElementById('currentUser').textContent = currentUser;
  
  // Check supervisor status - only show shift selector for supervisors
  const shiftSelectContainer = document.getElementById('shiftSelectContainer');
  const supervisorCleanupSection = document.getElementById('supervisorCleanupSection');
  
  if (isSupervisor) {
    shiftSelectContainer.style.display = 'block';
    shiftSelectContainer.classList.add('supervisor-only');
    supervisorCleanupSection.style.display = 'block';
    showNotification(`Welcome Supervisor ${currentUser}!`, 'success');
  } else {
    shiftSelectContainer.style.display = 'none';
    supervisorCleanupSection.style.display = 'none';
    showNotification(`Welcome ${currentUser}!`, 'success');
  }
  
  return userData;
}

function updateShift() {
  if (!isSupervisor) return;
  
  const shiftTypeSelect = document.getElementById('shiftTypeSelect');
  const selectedShift = shiftTypeSelect.value;
  
  // Update the main shift dropdown for all users
  document.getElementById('shiftTypeSelect').value = selectedShift;
  
  showNotification(`Shift changed to: ${selectedShift}`, 'info');
}

function logoutUser() {
  if (confirm("Are you sure you want to logout?")) {
    localStorage.removeItem('loggedInUser');
    window.location.href = "login.html";
  }
}

// ======== RECEIPT NUMBER MANAGEMENT - FIXED VERSION ========
async function getNextReceiptNumber() {
  try {
    // Check if we have a pending receipt number in localStorage
    const pendingReceipt = JSON.parse(localStorage.getItem('pendingReceiptNumber') || 'null');
    if (pendingReceipt && pendingReceipt.number && !pendingReceipt.used) {
      console.log("Using pending receipt number:", pendingReceipt.number);
      // Mark as used
      localStorage.setItem('pendingReceiptNumber', JSON.stringify({
        ...pendingReceipt,
        used: true
      }));
      return pendingReceipt.number;
    }
    
    // Always try to get the highest number from Firebase first
    if (checkFirebase()) {
      try {
        const receiptsRef = window.walkinDb.collection("receipts");
        
        // Get the highest receipt number from Firebase
        const snapshot = await receiptsRef
          .orderBy("receiptNumber", "desc")
          .limit(1)
          .get();
        
        let nextNumber = 1564; // Default start
        
        if (!snapshot.empty) {
          const latestReceipt = snapshot.docs[0].data();
          const firebaseNumber = latestReceipt.receiptNumber || 1563;
          
          // Get local counter
          const localCounter = parseInt(localStorage.getItem('receiptCounter') || '1563');
          
          // Use the HIGHER number between Firebase and local
          nextNumber = Math.max(firebaseNumber, localCounter) + 1;
          
          console.log(`Firebase: ${firebaseNumber}, Local: ${localCounter}, Next: ${nextNumber}`);
        } else {
          // No receipts in Firebase yet, use local
          const localCounter = parseInt(localStorage.getItem('receiptCounter') || '1563');
          nextNumber = Math.max(localCounter + 1, 1564);
        }
        
        // Format receipt number WITHOUT leading zeros
        const receiptNumber = nextNumber.toString(); // Just "57777" not "0057777"
        
        // Reserve this number locally to prevent conflicts
        localStorage.setItem('pendingReceiptNumber', JSON.stringify({
          number: receiptNumber,
          numeric: nextNumber,
          timestamp: new Date().toISOString(),
          used: false
        }));
        
        // Update local counter immediately
        localStorage.setItem('receiptCounter', nextNumber.toString());
        
        return receiptNumber;
        
      } catch (firebaseError) {
        console.warn("Firebase receipt number fetch failed, using local:", firebaseError);
        // Fall through to local storage
      }
    }
    
    // Fallback to local storage
    return getNextLocalReceiptNumber();
    
  } catch (error) {
    console.error("Error getting next receipt number:", error);
    // Final fallback
    return getNextLocalReceiptNumber();
  }
}

function getNextLocalReceiptNumber() {
  const key = 'receiptCounter';
  let counter = localStorage.getItem(key);
  
  if (!counter) {
    // Start from 1564 when no counter exists
    counter = "1564";
    localStorage.setItem(key, counter);
  } else {
    counter = (parseInt(counter) + 1).toString();
    localStorage.setItem(key, counter);
  }
  
  // Receipt number is just the number (no leading zeros)
  const receiptNumber = counter;
  
  // Reserve this number locally to prevent conflicts
  localStorage.setItem('pendingReceiptNumber', JSON.stringify({
    number: receiptNumber,
    numeric: parseInt(receiptNumber),
    timestamp: new Date().toISOString(),
    used: false
  }));
  
  return receiptNumber;
}

// ======== FIXED: CONFIRM RECEIPT NUMBER USAGE ========
function confirmReceiptNumberUsed(receiptNo) {
  try {
    // Mark the pending receipt number as used
    const pendingReceipt = JSON.parse(localStorage.getItem('pendingReceiptNumber') || 'null');
    if (pendingReceipt && pendingReceipt.number === receiptNo) {
      localStorage.setItem('pendingReceiptNumber', JSON.stringify({
        ...pendingReceipt,
        used: true
      }));
    }
    
    // Also update the last used receipt
    localStorage.setItem('lastUsedReceipt', receiptNo);
    
    // Update Firebase with the used receipt number
    if (checkFirebase()) {
      const numericReceipt = parseInt(receiptNo);
      if (!isNaN(numericReceipt)) {
        // Save to receipts collection in Firebase
        window.walkinDb.collection("receipts").doc(`receipt_${receiptNo}`).set({
          receiptNumber: numericReceipt,
          formattedNumber: receiptNo,
          usedAt: new Date().toISOString(),
          usedBy: currentUser || 'Unknown',
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true }).catch(error => {
          console.warn("Could not update Firebase receipt number:", error);
        });
      }
    }
    
  } catch (error) {
    console.error("Error confirming receipt number usage:", error);
  }
}

// ======== FIXED: FILTER BY CURRENT DAY - TIMEZONE AWARE ========
function filterByCurrentDay(payments) {
  const { start, end } = getMaldivesTodayRange();
  
  console.log('Filtering payments for Maldives day:', {
    start: start.toISOString(),
    end: end.toISOString(),
    localStart: new Date(start.getTime() + MALDIVES_OFFSET).toLocaleString(),
    localEnd: new Date(end.getTime() + MALDIVES_OFFSET).toLocaleString(),
    totalPayments: payments.length
  });
  
  const filteredPayments = payments.filter(payment => {
    // Skip payments that are clearly old (check receipt number if available)
    if (payment.receiptNo) {
      const receiptNum = parseInt(payment.receiptNo);
      if (receiptNum < 1564) {
        return false; // Too old, ignore
      }
    }
    
    // Parse payment date with timezone awareness
    const paymentDate = parsePaymentDate(payment);
    
    if (isNaN(paymentDate.getTime())) {
      console.warn('Invalid date for payment:', payment.receiptNo);
      return false;
    }
    
    // Check if payment is within today's range in Maldives timezone
    const isToday = paymentDate >= start && paymentDate <= end;
    
    if (!isToday) {
      console.log('Payment filtered out (not today):', {
        receiptNo: payment.receiptNo,
        paymentDate: paymentDate.toISOString(),
        maldivesDate: new Date(paymentDate.getTime() + MALDIVES_OFFSET).toLocaleString(),
        inRange: paymentDate >= start && paymentDate <= end
      });
    }
    
    return isToday;
  });
  
  console.log(`Filtered ${filteredPayments.length} payments for today (out of ${payments.length})`);
  return filteredPayments;
}

// ======== LOCAL STORAGE FUNCTIONS ========
function saveToLocalStorage(data) {
  try {
    const pendingPayments = JSON.parse(localStorage.getItem('pendingPayments') || '[]');
    
    // Add Maldives timestamp for consistency
    data.maldivesTimestamp = getMaldivesDate().toISOString();
    
    // Check if payment already exists
    const existingIndex = pendingPayments.findIndex(p => p.id === data.id);
    
    if (existingIndex !== -1) {
      // Update existing payment
      pendingPayments[existingIndex] = data;
    } else {
      // Add new payment
      pendingPayments.push(data);
    }
    
    localStorage.setItem('pendingPayments', JSON.stringify(pendingPayments));
    
    // Add to sync queue if not already there
    const inQueue = pendingSyncQueue.some(p => p.id === data.id);
    if (!inQueue) {
      pendingSyncQueue.push(data);
    }
    
    // Start sync process if not already running
    if (!isSyncing && checkFirebase()) {
      syncPendingPayments();
    }
    
    return data.id;
  } catch (error) {
    console.error("Error saving to localStorage:", error);
    throw error;
  }
}

function getPendingPayments() {
  try {
    return JSON.parse(localStorage.getItem('pendingPayments') || '[]');
  } catch (error) {
    console.error("Error getting pending payments:", error);
    return [];
  }
}

function markPaymentAsSynced(paymentId) {
  try {
    const pendingPayments = getPendingPayments();
    const updatedPayments = pendingPayments.map(payment => {
      if (payment.id === paymentId) {
        return { 
          ...payment, 
          synced: true,
          syncAttempts: 0,
          lastSynced: new Date().toISOString()
        };
      }
      return payment;
    });
    
    localStorage.setItem('pendingPayments', JSON.stringify(updatedPayments));
    
    // Also update in sync queue
    const queueIndex = pendingSyncQueue.findIndex(p => p.id === paymentId);
    if (queueIndex !== -1) {
      pendingSyncQueue[queueIndex] = { 
        ...pendingSyncQueue[queueIndex], 
        synced: true,
        syncAttempts: 0
      };
    }
    
  } catch (error) {
    console.error("Error marking payment as synced:", error);
  }
}

function incrementSyncAttempts(paymentId) {
  try {
    const pendingPayments = getPendingPayments();
    const updatedPayments = pendingPayments.map(payment => {
      if (payment.id === paymentId) {
        return { 
          ...payment, 
          syncAttempts: (payment.syncAttempts || 0) + 1,
          lastSyncAttempt: new Date().toISOString()
        };
      }
      return payment;
    });
    
    localStorage.setItem('pendingPayments', JSON.stringify(updatedPayments));
  } catch (error) {
    console.error("Error incrementing sync attempts:", error);
  }
}

// ======== CLEANUP OLD LOCAL PAYMENTS - IMPROVED ========
function cleanupOldLocalPayments() {
  try {
    const pendingPayments = getPendingPayments();
    const { start } = getMaldivesTodayRange();
    
    // Filter to keep only today's payments AND any payments with receipt numbers >= 1564
    const recentPayments = pendingPayments.filter(payment => {
      // Parse payment date
      const paymentDate = parsePaymentDate(payment);
      
      if (isNaN(paymentDate.getTime())) {
        // Invalid date, check receipt number
        if (payment.receiptNo) {
          const receiptNum = parseInt(payment.receiptNo);
          return receiptNum >= 1564;
        }
        return false;
      }
      
      // Check if payment is from today in Maldives timezone
      const isToday = isTodayInMaldives(paymentDate);
      
      // Also check receipt number if available
      if (payment.receiptNo) {
        const receiptNum = parseInt(payment.receiptNo);
        if (receiptNum >= 1564) {
          // Keep payments with valid receipt numbers even if date is ambiguous
          return true;
        }
      }
      
      return isToday;
    });
    
    // Also filter sync queue
    pendingSyncQueue = pendingSyncQueue.filter(payment => {
      const paymentDate = parsePaymentDate(payment);
      
      if (isNaN(paymentDate.getTime())) {
        return false;
      }
      
      const isToday = isTodayInMaldives(paymentDate);
      
      // Check receipt number
      if (payment.receiptNo) {
        const receiptNum = parseInt(payment.receiptNo);
        if (receiptNum >= 1564) {
          return true;
        }
      }
      
      return isToday;
    });
    
    // Update localStorage with filtered payments
    localStorage.setItem('pendingPayments', JSON.stringify(recentPayments));
    
    // Count how many were removed
    const removedCount = pendingPayments.length - recentPayments.length;
    if (removedCount > 0) {
      console.log(`Cleaned up ${removedCount} old local payments`);
      showNotification(`Cleaned up ${removedCount} old payments from local storage`, 'info');
    }
    
    return recentPayments;
  } catch (error) {
    console.error("Error cleaning up old payments:", error);
    return [];
  }
}

// ======== FIREBASE SYNC FUNCTIONS ========
async function syncPendingPayments() {
  if (!checkFirebase() || isSyncing || pendingSyncQueue.length === 0) {
    return;
  }
  
  isSyncing = true;
  
  try {
    const payment = pendingSyncQueue[0]; // Get first pending payment
    
    if (payment.syncAttempts > 3) {
      // Too many attempts, skip for now
      console.warn(`Skipping payment ${payment.id} after ${payment.syncAttempts} attempts`);
      pendingSyncQueue.shift();
      isSyncing = false;
      if (pendingSyncQueue.length > 0) {
        setTimeout(syncPendingPayments, 1000);
      }
      return;
    }
    
    console.log("Syncing payment to Firebase. Document ID:", payment.id, "Receipt No:", payment.receiptNo);
    
    // Prepare Firebase data
    const firebaseData = {
      receiptNo: payment.receiptNo,
      name: payment.name || '',
      flightNo: payment.flightNo || '',
      seatNo: payment.seatNo || '',
      shift: currentShift, // Use the current shift from shift system
      adults: payment.adults || 0,
      kids: payment.kids || 0,
      currency: payment.currency || 'USD',
      paymentType: payment.paymentType || 'Cash',
      total: payment.total || 0,
      expiryFormatted: payment.expiryFormatted || '',
      expiryTimestamp: payment.expiryTimestamp || Date.now(),
      staff: payment.staff || currentUser || 'Unknown',
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      localSaved: true,
      syncStatus: 'synced',
      lastUpdated: new Date().toISOString(),
      maldivesDate: payment.maldivesTimestamp || getMaldivesDate().toISOString()
    };
    
    // Add payment-specific fields
    if (payment.paymentType === 'Cash') {
      firebaseData.paidAmount = payment.paidAmount || 0;
      firebaseData.balance = payment.balance || 0;
      firebaseData.finalReceiptPrinted = payment.finalReceiptPrinted || false;
    } else {
      // For card/QR payments
      firebaseData.cardDetailsAdded = payment.cardDetailsAdded || false;
      if (payment.cardDetailsAdded) {
        firebaseData.batchNo = payment.batchNo || '';
        firebaseData.approvalCode = payment.approvalCode || '';
      }
    }
    
    // Add void information if available
    if (payment.voided) {
      firebaseData.voided = true;
      firebaseData.voidedAt = payment.voidedAt || new Date().toISOString();
      firebaseData.voidedBy = payment.voidedBy || currentUser || 'Unknown';
      firebaseData.voidReason = payment.voidReason || 'No reason provided';
      firebaseData.voidMaldivesDate = getMaldivesDate().toISOString();
    }
    
    // Try to sync to Firebase - Document ID is the receipt number
    const docRef = window.walkinDb.collection("payments").doc(payment.id);
    await docRef.set(firebaseData, { merge: true });
    
    console.log("Successfully synced to Firebase. Document ID:", payment.id, "Receipt No:", payment.receiptNo);
    
    // Mark as synced in localStorage
    markPaymentAsSynced(payment.id);
    
    // Remove from queue
    pendingSyncQueue.shift();
    
    // Show notification
    showNotification(`Synced to cloud: ${payment.receiptNo}`, 'success');
    
  } catch (error) {
    console.error("Error syncing payment to Firebase:", error);
    
    // Increment sync attempts
    incrementSyncAttempts(payment.id);
    
    // Retry after delay
    setTimeout(syncPendingPayments, 5000);
    return;
  }
  
  isSyncing = false;
  
  // Process next payment if any
  if (pendingSyncQueue.length > 0) {
    setTimeout(syncPendingPayments, 1000);
  }
}

// ======== FIXED: SAVE PAYMENT - DOCUMENT ID IS RECEIPT NUMBER ========
async function savePayment(data) {
  try {
    // Generate receipt number
    if (!data.receiptNo) {
      data.receiptNo = await getNextReceiptNumber();
    }
    
    console.log("Saving payment. Receipt No:", data.receiptNo, "Type:", typeof data.receiptNo);
    
    // CONFIRM the receipt number is being used
    confirmReceiptNumberUsed(data.receiptNo);
    
    // Add current user to data
    data.staff = currentUser;
    const userData = JSON.parse(localStorage.getItem("loggedInUser"));
    data.userId = userData ? userData.id : '';
    
    // Add current shift to data
    data.shift = currentShift;
    
    // Add Maldives timestamp
    data.maldivesTimestamp = getMaldivesDate().toISOString();
    
    // DOCUMENT ID IS THE RECEIPT NUMBER
    const docId = data.receiptNo.toString(); // Ensure it's a string
    data.id = docId;
    
    console.log("Document ID set to:", docId);
    
    // Create complete payment record with timestamp
    const paymentRecord = {
      ...data,
      timestamp: new Date().toISOString(),
      localSaveTime: new Date().toISOString(),
      maldivesDate: getMaldivesDate().toISOString(),
      synced: false,
      syncAttempts: 0
    };
    
    // Save to localStorage immediately (fast)
    saveToLocalStorage(paymentRecord);
    
    // Update current payment data
    currentPaymentData = {
      id: docId,
      ...data
    };
    
    // Update header display
    document.getElementById("headerReceiptNo").textContent = data.receiptNo;
    
    // Show success notification
    showNotification(`Saved locally: ${data.receiptNo}`, 'success');
    
    return { id: docId, receiptNo: data.receiptNo };
    
  } catch (error) {
    console.error("Error in savePayment:", error);
    throw error;
  }
}

// ======== FIXED: GET PAYMENTS ========
async function getPayments() {
  try {
    // Get local payments first
    const localPayments = getPendingPayments();
    
    if (!checkFirebase()) {
      return localPayments;
    }
    
    try {
      // Get Firebase payments - limit to reasonable number
      const snapshot = await window.walkinDb.collection("payments")
        .orderBy("timestamp", "desc")
        .limit(200)
        .get();
      
      const firebasePayments = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        firebasePayments.push({
          id: doc.id, // This is the document ID (should be receipt number)
          ...data,
          timestamp: data.timestamp ? data.timestamp.toDate() : new Date(),
          synced: true // Mark as synced since it's from Firebase
        });
      });
      
      console.log(`Loaded ${firebasePayments.length} payments from Firebase`);
      
      // Create a map of Firebase payments for quick lookup
      const firebaseMap = new Map();
      firebasePayments.forEach(p => firebaseMap.set(p.id, p));
      
      // Merge: Start with Firebase payments, then add local unsynced payments
      const mergedPayments = [...firebasePayments];
      
      localPayments.forEach(localPayment => {
        if (!localPayment.synced && !firebaseMap.has(localPayment.id)) {
          // Add unsynced local payments not already in Firebase
          mergedPayments.push(localPayment);
        }
      });
      
      // Sort by timestamp (most recent first)
      return mergedPayments.sort((a, b) => {
        const timeA = parsePaymentDate(a).getTime();
        const timeB = parsePaymentDate(b).getTime();
        return timeB - timeA;
      });
      
    } catch (firebaseError) {
      console.error("Error fetching from Firebase, using local only:", firebaseError);
      return localPayments;
    }
    
  } catch (error) {
    console.error("Error loading payments:", error);
    return [];
  }
}

// ======== FIXED: DELETE PAYMENT ========
async function deletePayment(id) {
  try {
    console.log("Deleting payment with ID:", id);
    
    // Delete from local storage first
    const pendingPayments = getPendingPayments();
    const updatedPayments = pendingPayments.filter(p => p.id !== id);
    localStorage.setItem('pendingPayments', JSON.stringify(updatedPayments));
    
    // Remove from sync queue
    pendingSyncQueue = pendingSyncQueue.filter(p => p.id !== id);
    
    // Try to delete from Firebase if available
    if (checkFirebase()) {
      await window.walkinDb.collection("payments").doc(id).delete();
      console.log("Deleted from Firebase:", id);
    }
    
    return true;
  } catch (error) {
    console.error("Error deleting payment:", error);
    return false;
  }
}

// ======== FIXED: UPDATE PAYMENT WITH IMMEDIATE FIREBASE SYNC ========
async function updatePayment(id, updates) {
  try {
    console.log("Updating payment ID:", id, "Updates:", updates);
    
    // Update in local storage first
    const pendingPayments = getPendingPayments();
    const updatedPayments = pendingPayments.map(payment => {
      if (payment.id === id) {
        const updatedPayment = { ...payment, ...updates };
        // Mark as unsynced when updated
        updatedPayment.synced = false;
        updatedPayment.syncAttempts = 0;
        updatedPayment.lastUpdated = new Date().toISOString();
        return updatedPayment;
      }
      return payment;
    });
    
    localStorage.setItem('pendingPayments', JSON.stringify(updatedPayments));
    
    // Update in sync queue
    const queueIndex = pendingSyncQueue.findIndex(p => p.id === id);
    if (queueIndex !== -1) {
      pendingSyncQueue[queueIndex] = { 
        ...pendingSyncQueue[queueIndex], 
        ...updates,
        synced: false,
        syncAttempts: 0,
        lastUpdated: new Date().toISOString()
      };
    }
    
    // Force immediate Firebase update (not background sync)
    if (checkFirebase()) {
      try {
        const docRef = window.walkinDb.collection("payments").doc(id);
        await docRef.update({
          ...updates,
          lastUpdated: new Date().toISOString(),
          syncStatus: 'synced',
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log("Immediately updated Firebase for ID:", id);
      } catch (firebaseError) {
        console.error("Immediate Firebase update failed:", firebaseError);
        // It will be synced via background sync later
      }
    }
    
    return true;
  } catch (error) {
    console.error("Error updating payment:", error);
    return false;
  }
}

// ======== FIXED: SEARCH RECEIPT - DOCUMENT ID IS RECEIPT NUMBER ========
async function searchPaymentByReceiptNo(receiptNo) {
  try {
    console.log("Searching for receipt:", receiptNo);
    
    // Clean the receipt number - ensure it's a string
    const cleanReceiptNo = receiptNo.toString().trim();
    
    // Always try Firebase first for fresh data
    if (checkFirebase()) {
      try {
        console.log("Trying Firebase search with receipt number:", cleanReceiptNo);
        
        // FIRST: Try direct document ID (receipt number)
        const doc = await window.walkinDb.collection("payments").doc(cleanReceiptNo).get();
        if (doc.exists) {
          console.log("Found by document ID (receipt number):", cleanReceiptNo);
          const data = doc.data();
          // Convert Firebase timestamp to Date
          const timestamp = data.timestamp ? 
            (data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp)) : 
            new Date();
          
          return {
            id: doc.id, // This should be the receipt number
            ...data,
            timestamp: timestamp,
            synced: true,
            isFreshFromFirebase: true
          };
        }
        
        console.log("Not found by document ID, trying receiptNo field...");
        
        // SECOND: If not found by document ID, search by receiptNo field
        const snapshot = await window.walkinDb.collection("payments")
          .where("receiptNo", "==", cleanReceiptNo)
          .limit(1)
          .get();
        
        if (!snapshot.empty) {
          console.log("Found by receiptNo field:", cleanReceiptNo);
          const doc = snapshot.docs[0];
          const data = doc.data();
          const timestamp = data.timestamp ? 
            (data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp)) : 
            new Date();
          
          return {
            id: doc.id,
            ...data,
            timestamp: timestamp,
            synced: true,
            isFreshFromFirebase: true
          };
        }
        
        console.log("Receipt not found in Firebase:", cleanReceiptNo);
        
      } catch (firebaseError) {
        console.warn("Firebase search failed, falling back to local:", firebaseError);
      }
    }
    
    // Fallback: Search in local storage
    console.log("Searching in local storage for:", cleanReceiptNo);
    const pendingPayments = getPendingPayments();
    const localPayment = pendingPayments.find(p => p.receiptNo === cleanReceiptNo || p.id === cleanReceiptNo);
    if (localPayment) {
      console.log("Found in local storage:", cleanReceiptNo);
      return {
        ...localPayment,
        isFreshFromFirebase: false
      };
    }
    
    console.log("Receipt not found anywhere:", cleanReceiptNo);
    return null;
    
  } catch (error) {
    console.error("Error searching payment:", error);
    return null;
  }
}

// ======== CALCULATE EXPIRY TIME ========
function calculateExpiryTime() {
  const now = getMaldivesDate(); // Use Maldives time for expiry
  const expiry = new Date(now.getTime() + 3 * 60 * 60 * 1000); // 3 hours from now
  
  // Format as HH:MM AM/PM in Maldives timezone
  let hours = expiry.getUTCHours();
  let minutes = expiry.getUTCMinutes();
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12;
  hours = hours ? hours : 12; // the hour '0' should be '12'
  minutes = minutes < 10 ? '0' + minutes : minutes;
  
  const expiryTime = `${hours}:${minutes} ${ampm}`;
  
  // Update header
  document.getElementById("headerExpiryTime").textContent = expiryTime;
  
  return {
    time: expiry,
    formatted: expiryTime,
    timestamp: expiry.getTime()
  };
}

// ======== PARSE BOARDING PASS ========
function parseCode(){
  const code = document.getElementById("codeInput").value.trim().toUpperCase();
  if(!code) return;
  const parts = code.split(/\s+/);

  // Name + PNR
  const idxMLE = code.indexOf('MLE');
  let name='', pnr='';
  if(idxMLE!==-1){
    let fullNamePart = code.substring(0,idxMLE).trim();
    if(fullNamePart.length>8){
      name = fullNamePart.substring(2, fullNamePart.length-6).trim();
      pnr = fullNamePart.substring(fullNamePart.length-6).trim();
    }
  }

  // Flight No
  let flightNo=''; let flightTokenIndex=-1;
  for(let i=0;i<parts.length;i++){
    if(parts[i].includes('MLE')){
      flightTokenIndex=i;
      const mleToken = parts[i];
      flightNo = mleToken.slice(-2) + (parts[i+1]||'').slice(0,4);
      break;
    }
  }

  // Seat No
  let seatNo='';
  if(flightTokenIndex!==-1 && parts[flightTokenIndex+2]){
    let seatToken = parts[flightTokenIndex+2];
    if(seatToken.length>9){
      seatNo = seatToken.substring(5, seatToken.length-4);
    }
  }

  document.getElementById("name").value = name;
  document.getElementById("flightNo").value = flightNo;
  document.getElementById("seatNo").value = seatNo;

  updatePricing();
}

// ======== DYNAMIC PRICING ========
function updatePricing(){
  const adults = parseInt(document.getElementById("adults").value) || 0;
  const kids = parseInt(document.getElementById("kids").value) || 0;
  const rateType = document.getElementById("rateType").value;
  const currency = document.getElementById("currency").value;

  // Check if rates are available from rate.js
  if (!window.rates) {
    console.error("Rates not loaded from rate.js");
    document.getElementById("subtotal").value = "0.00";
    document.getElementById("gst").value = "0.00";
    document.getElementById("total").value = "0.00";
    return;
  }

  const adultKey = `Adult${rateType}${currency}`;
  const kidKey = `Kids${rateType}${currency}`;
  
  if(!window.rates[adultKey] || !window.rates[kidKey]) {
    console.error("Rate not found for:", adultKey, kidKey);
    return;
  }

  // Calculate prices
  const adultRate = window.rates[adultKey];
  const kidRate = window.rates[kidKey];
  
  const subtotal = (adults * adultRate.price) + (kids * kidRate.price);
  const gst = subtotal * (adultRate.GST / 100);
  const total = subtotal + gst;

  // Update display
  document.getElementById("subtotal").value = subtotal.toFixed(2);
  document.getElementById("gst").value = gst.toFixed(2);
  document.getElementById("total").value = total.toFixed(2);
  
  // Update paid amount and balance for cash payments
  updateCashFields();
  
  // Update expiry time
  calculateExpiryTime();
}

// ======== UPDATE CASH PAYMENT FIELDS ========
function updateCashFields() {
  const paymentType = document.getElementById("paymentType").value;
  const total = parseFloat(document.getElementById("total").value) || 0;
  
  if (paymentType === "Cash") {
    const paidAmount = parseFloat(document.getElementById("paidAmount").value) || 0;
    const balance = paidAmount - total;
    
    document.getElementById("balance").value = balance.toFixed(2);
    
    // Style balance based on value
    const balanceField = document.getElementById("balance");
    balanceField.className = "summary-value";
    if (balance > 0) {
      balanceField.classList.add("positive");
    } else if (balance < 0) {
      balanceField.classList.add("negative");
    } else {
      balanceField.classList.add("zero");
    }
  }
}

// ======== TOGGLE PAYMENT FIELDS ========
function togglePaymentFields() {
  const paymentType = document.getElementById("paymentType").value;
  const cashFields = document.getElementById("cashPaymentFields");
  
  if (paymentType === "Cash") {
    // Show cash fields
    cashFields.style.display = "block";
    
    // Set paid amount to total by default
    const total = parseFloat(document.getElementById("total").value) || 0;
    document.getElementById("paidAmount").value = total.toFixed(2);
    updateCashFields();
  } else {
    // Hide cash fields (for all card/QR payments)
    cashFields.style.display = "none";
  }
}

// ======== SAVE PAYMENT (FAST LOCAL FIRST) - IMPROVED ========
async function saveNow(){
  // Check if rates are loaded
  if (!window.rates) {
    showNotification("Error: Rates not loaded. Check rate.js", "error");
    return;
  }

  const paymentType = document.getElementById("paymentType").value;
  const total = parseFloat(document.getElementById("total").value) || 0;
  
  // Use current shift from shift system
  const shift = currentShift;
  
  // Calculate expiry time (using Maldives timezone)
  const expiryData = calculateExpiryTime();
  
  // OPTIMIZED DATA STRUCTURE - Save only essential data
  const data = {
    time: new Date().toISOString(),
    name: document.getElementById("name").value,
    flightNo: document.getElementById("flightNo").value,
    seatNo: document.getElementById("seatNo").value,
    shift: shift,
    adults: parseInt(document.getElementById("adults").value),
    kids: parseInt(document.getElementById("kids").value),
    currency: document.getElementById("currency").value,
    paymentType: paymentType,
    total: total,
    expiryFormatted: expiryData.formatted,
    expiryTimestamp: expiryData.timestamp,
    firstReceiptPrinted: false,
    finalReceiptPrinted: false,
    cardDetailsAdded: false,
    voided: false // Initialize as not voided
  };
  
  // Add payment-specific fields
  if (paymentType === "Cash") {
    const paidAmount = parseFloat(document.getElementById("paidAmount").value) || 0;
    const balance = paidAmount - total;
    
    data.paidAmount = paidAmount;
    data.balance = balance;
    data.cardDetailsAdded = true; // Cash payments are complete immediately
    data.finalReceiptPrinted = false; // Cash payments need final receipt
  }
  
  // Validate data
  if (!data.name || !data.flightNo) {
    showNotification("Please fill in passenger name and flight number", "warning");
    return;
  }
  
  if (isNaN(data.total) || data.total <= 0) {
    showNotification("Invalid payment amount. Check passenger details.", "warning");
    return;
  }
  
  // Validate cash payment
  if (paymentType === "Cash") {
    if (data.paidAmount < data.total) {
      if (!confirm(`Paid amount (${data.paidAmount}) is less than total (${data.total}). Continue anyway?`)) {
        return;
      }
    }
  }
  
  // Check for duplicate pending payment
  const pendingPayments = getPendingPayments();
  const duplicate = pendingPayments.find(p => 
    p.name === data.name && 
    p.flightNo === data.flightNo &&
    !p.voided &&
    Math.abs(parsePaymentDate(p).getTime() - new Date().getTime()) < 60000 // Within 1 minute
  );
  
  if (duplicate) {
    if (!confirm(`A payment for ${data.name} (${data.flightNo}) was recently saved. Create another receipt?`)) {
      return;
    }
  }
  
  try {
    // Save immediately (local storage first, then background sync to Firebase)
    const result = await savePayment(data);
    currentPaymentData = {
      id: result.id,
      receiptNo: result.receiptNo,
      ...data
    };
    
    console.log("Payment saved locally. ID:", result.id, "Receipt No:", result.receiptNo);
    
    // Auto-print first receipt
    setTimeout(() => {
      printReceipt('first');
    }, 300);
    
    // Reset form for next entry
    resetFormForNextEntry();
    
  } catch (error) {
    console.error("Error in saveNow:", error);
    showNotification("Error saving payment: " + error.message, "error");
  }
}

function resetFormForNextEntry() {
  // Clear boarding pass input
  document.getElementById("codeInput").value = "";
  document.getElementById("name").value = "";
  document.getElementById("flightNo").value = "";
  document.getElementById("seatNo").value = "";
  
  // Reset counts
  document.getElementById("adults").value = 1;
  document.getElementById("kids").value = 0;
  
  // Keep other selections as they are
  updatePricing();
  
  // Focus on boarding pass input for next entry
  document.getElementById("codeInput").focus();
}

// ======== LOAD PAYMENTS WITH TABS - MODIFIED ========
async function loadPayments(){
  try {
    showNotification("Loading today's payments...", "info", 2000);
    const allPayments = await getPayments();
    
    // Filter payments by current day in Maldives timezone
    const todayPayments = filterByCurrentDay(allPayments);
    
    // Load ONLY pending payments for today (excluding voided)
    loadPendingCardPayments(todayPayments);
    
  } catch (error) {
    showNotification("Error loading payments", "error");
    console.error("Error loading payments:", error);
  }
}

// ======== LOAD PENDING CARD PAYMENTS (ONLY TODAY'S) ========
function loadPendingCardPayments(payments) {
  // First, deduplicate payments by receipt number or ID
  const uniquePayments = deduplicatePayments(payments);
  
  // Filter out voided payments and only show non-cash payments that need card details
  const pendingPayments = uniquePayments.filter(p => 
    p.paymentType !== "Cash" && 
    !p.cardDetailsAdded &&
    !p.voided // Exclude voided payments
  );
  
  let html = '';
  
  if (pendingPayments.length === 0) {
    html = `<p style="text-align: center; color: var(--text-light); padding: 20px;">No pending non-cash payments found for today.</p>`;
  } else {
    html = `<table><tr>
    <th>Receipt No</th><th>Name</th><th>Payment Method</th><th>Shift</th><th>Staff</th><th>Total</th>
    <th>Expiry</th><th>Action</th></tr>`;
    
    pendingPayments.forEach(p=>{
      const receiptBadge = p.receiptNo ? 
        `<span class="receipt-badge">${p.receiptNo}</span>` : 
        `<span class="receipt-badge">N/A</span>`;
      
      const currencyBadge = p.currency === 'USD' ? '<span class="currency-badge">USD</span>' : '<span class="currency-badge">MVR</span>';
      
      // Payment method badge
      const paymentBadge = `<span class="payment-method-badge payment-method-${p.paymentType ? p.paymentType.toLowerCase().replace('card', '').replace(' ', '') : 'card'}">${p.paymentType || 'Card'}</span>`;
      
      // Shift badge
      const shiftBadge = p.shift === 'Morning' ? 
        `<span class="shift-badge shift-morning">Morning</span>` : 
        `<span class="shift-badge shift-evening">Evening</span>`;
      
      // Staff info
      const staffInfo = p.staff || 'Unknown';
      
      // Format expiry time
      let expiryTime = 'N/A';
      if (p.expiryFormatted) {
        expiryTime = p.expiryFormatted;
      } else if (p.expiryTime) {
        const expiryDate = new Date(p.expiryTime);
        expiryTime = expiryDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      }
      
      // Format date for display (Maldives timezone)
      const paymentDate = parsePaymentDate(p);
      const displayDate = formatDateForDisplay(paymentDate);
      
      // DELETE BUTTON - Only for supervisors
      const deleteButton = isSupervisor ? 
        `<button class="action-btn" onclick="deleteEntry('${p.id}')">Delete</button>` : '';
      
      html+=`<tr>
        <td>${receiptBadge}</td>
        <td>${p.name || 'N/A'}</td>
        <td>${paymentBadge}</td>
        <td>${shiftBadge}</td>
        <td>${staffInfo}</td>
        <td><strong>${(p.total || 0).toFixed(2)}</strong> ${currencyBadge}</td>
        <td>${expiryTime}</td>
        <td>
          <button class="complete-btn" onclick="addCardDetails('${p.id}')">Add Details</button>
          <button class="print-btn" onclick="reprintPayment('${p.id}')">Print</button>
          ${deleteButton}
        </td>
      </tr>`;
    });
    html+="</table>";
  }
  
  document.getElementById("pendingLog").innerHTML = html;
}

// ======== DEDUPLICATE PAYMENTS ========
function deduplicatePayments(payments) {
  const uniqueMap = new Map();
  
  payments.forEach(payment => {
    // Use receipt number as primary key, fallback to ID
    const key = payment.receiptNo || payment.id;
    
    if (key) {
      // If we already have this payment, keep the most recent one
      const existing = uniqueMap.get(key);
      if (!existing) {
        uniqueMap.set(key, payment);
      } else {
        // Compare timestamps to keep the most recent
        const existingTime = parsePaymentDate(existing).getTime();
        const currentTime = parsePaymentDate(payment).getTime();
        
        if (currentTime > existingTime) {
          uniqueMap.set(key, payment);
        }
      }
    }
  });
  
  return Array.from(uniqueMap.values());
}

// ======== DELETE ENTRY - SUPERVISOR CHECK ========
async function deleteEntry(id){ 
  // Check if user is supervisor
  if (!isSupervisor) {
    showNotification("Only supervisors can delete payment records", "warning");
    return;
  }
  
  if(confirm("Are you sure you want to delete this payment record?")) {
    await deletePayment(id); 
    loadPayments(); 
    showNotification("Payment deleted", "success");
  }
}

async function viewPayment(id) {
  const payments = await getPayments();
  const payment = payments.find(p => p.id === id);
  if (payment) {
    const paymentDate = parsePaymentDate(payment);
    const displayDate = formatDateForDisplay(paymentDate);
    
    alert(`Payment Details:\n\n` +
          `Receipt No: ${payment.receiptNo}\n` +
          `Date: ${displayDate}\n` +
          `Name: ${payment.name}\n` +
          `Flight: ${payment.flightNo}\n` +
          `Seat: ${payment.seatNo}\n` +
          `Payment Method: ${payment.paymentType}\n` +
          `Staff: ${payment.staff || 'Unknown'}\n` +
          `Total: ${payment.total} ${payment.currency}\n` +
          `Expiry: ${payment.expiryFormatted}\n` +
          `Status: ${payment.synced ? 'Synced' : 'Local only'}\n` +
          `Voided: ${payment.voided ? 'Yes' : 'No'}`);
  }
}

async function addCardDetails(paymentId) {
  // Find the payment
  const payments = await getPayments();
  const payment = payments.find(p => p.id === paymentId);
  if (payment) {
    // Check if payment is voided
    if (payment.voided) {
      showNotification("Cannot add card details to a voided receipt", "error");
      return;
    }
    
    // Show modal with payment details
    document.getElementById("modalPaymentId").value = paymentId;
    document.getElementById("modalReceiptNo").value = payment.receiptNo || 'N/A';
    document.getElementById("modalPassengerName").value = payment.name || 'N/A';
    document.getElementById("modalTotalAmount").value = (payment.total || 0).toFixed(2);
    
    // Set existing values if available
    document.getElementById("modalPaymentMethod").value = payment.paymentType || '';
    document.getElementById("modalBatchNo").value = payment.batchNo || '';
    document.getElementById("modalApprovalCode").value = payment.approvalCode || '';
    
    // Show modal
    document.getElementById("cardDetailsModal").style.display = "flex";
  }
}

// ======== SAVE CARD DETAILS WITH IMMEDIATE REFRESH ========
async function saveCardDetails() {
  const paymentId = document.getElementById("modalPaymentId").value;
  const paymentMethod = document.getElementById("modalPaymentMethod").value;
  const batchNo = document.getElementById("modalBatchNo").value;
  const approvalCode = document.getElementById("modalApprovalCode").value;
  
  if (!paymentMethod || !batchNo || !approvalCode) {
    showNotification("Please enter payment method, batch number and approval code", "warning");
    return;
  }
  
  const success = await updatePayment(paymentId, {
    paymentType: paymentMethod,
    batchNo: batchNo,
    approvalCode: approvalCode,
    cardDetailsAdded: true,
    finalReceiptPrinted: false,
    lastUpdated: new Date().toISOString() // Add timestamp
  });
  
  if (success) {
    showNotification("Payment details saved successfully!", "success");
    closeModal();
    loadPayments();
    
    // If we have a found receipt from search, update it immediately
    if (foundReceiptData && foundReceiptData.id === paymentId) {
      // Force re-fetch from Firebase to get latest data
      const freshData = await searchPaymentByReceiptNo(foundReceiptData.receiptNo);
      if (freshData) {
        foundReceiptData = freshData;
        displaySearchResult(freshData);
      }
    }
    
    // Print final receipt
    const payments = await getPayments();
    const payment = payments.find(p => p.id === paymentId);
    if (payment) {
      printReceipt('final', payment);
    }
  } else {
    showNotification("Error saving payment details", "error");
  }
}

function editCardPayment(id) {
  addCardDetails(id);
}

async function printFinalCashReceipt(paymentId) {
  const payments = await getPayments();
  const payment = payments.find(p => p.id === paymentId);
  if (payment && payment.paymentType === "Cash") {
    // Mark as final receipt printed
    await updatePayment(paymentId, {
      finalReceiptPrinted: true
    });
    
    // Print final receipt
    printReceipt('final', payment);
    loadPayments();
    showNotification("Final receipt printed", "success");
  }
}

// ======== MANUAL CLEANUP FOR SUPERVISORS ========
async function manualCleanupAllOldData() {
  if (!isSupervisor) {
    showNotification("Only supervisors can perform manual cleanup", "warning");
    return;
  }
  
  if (!confirm("This will delete ALL local payment data except for today's entries. Are you sure?")) {
    return;
  }
  
  // First, sync all pending payments to Firebase
  if (checkFirebase() && pendingSyncQueue.length > 0) {
    showNotification("Syncing pending payments before cleanup...", "info", 3000);
    await syncPendingPayments();
  }
  
  // Perform cleanup
  const remainingPayments = cleanupOldLocalPayments();
  
  // Also cleanup Firebase locally cached data (if any)
  if (checkFirebase()) {
    try {
      // Get today's payments from Firebase to keep cache
      const today = getMaldivesDate();
      const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const snapshot = await window.walkinDb.collection("payments")
        .where("timestamp", ">=", todayStart)
        .limit(100)
        .get();
      
      // Update local cache with only today's data
      const todayFirebasePayments = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        todayFirebasePayments.push({
          id: doc.id,
          ...data,
          timestamp: data.timestamp ? data.timestamp.toDate() : new Date(),
          synced: true
        });
      });
      
      // Could store this in a separate cache if needed
      console.log(`Keeping ${todayFirebasePayments.length} Firebase records from today`);
    } catch (error) {
      console.error("Error cleaning Firebase cache:", error);
    }
  }
  
  // Reload payments
  loadPayments();
  
  showNotification("Cleanup completed! Only today's data remains.", "success");
}

// ======== SEARCH RECEIPT ========
async function searchReceipt() {
  const receiptNo = document.getElementById("receiptSearch").value.trim();
  if (!receiptNo) {
    showNotification("Please enter a receipt number to search", "warning");
    return;
  }
  
  showNotification("Searching for receipt...", "info", 2000);
  
  // Clear any cached data for this receipt
  foundReceiptData = null;
  
  const payment = await searchPaymentByReceiptNo(receiptNo);
  if (payment) {
    foundReceiptData = payment;
    displaySearchResult(payment);
    
    // Show source of data
    if (payment.isFreshFromFirebase) {
      showNotification(`Found receipt ${receiptNo} (Fresh from cloud)`, "success");
    } else {
      showNotification(`Found receipt ${receiptNo} (Local cache)`, "warning");
    }
  } else {
    showNotification(`Receipt number "${receiptNo}" not found.`, "error");
  }
}

// ======== DISPLAY SEARCH RESULT WITH REFRESH BUTTON AND VOID INFO ========
function displaySearchResult(payment) {
  const contentDiv = document.getElementById("searchResultContent");
  const actionsDiv = document.getElementById("searchResultActions");
  
  // Format dates for display
  const paymentDate = parsePaymentDate(payment);
  const displayDate = formatDateForDisplay(paymentDate);
  
  let html = `
    <div style="margin-bottom: 15px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h4 style="margin: 0;">Receipt Details</h4>
        <button class="refresh-btn" onclick="refreshReceiptData('${payment.receiptNo}')">
          üîÑ Refresh
        </button>
      </div>
  `;
  
  // Add VOID warning banner if receipt is voided
  if (payment.voided) {
    html += `
      <div class="void-warning">
        ‚ö†Ô∏è VOID RECEIPT ‚ö†Ô∏è
      </div>
      <div class="void-info">
        <div><b>Voided By:</b> ${payment.voidedBy || 'Unknown'}</div>
        <div><b>Voided At:</b> ${payment.voidedAt ? formatDateForDisplay(new Date(payment.voidedAt)) : 'Unknown'}</div>
        <div><b>Reason:</b> ${payment.voidReason || 'No reason provided'}</div>
      </div>
    `;
  }
  
  html += `
      <div class="input-group">
        <label>Receipt Number</label>
        <input type="text" readonly value="${payment.receiptNo || 'N/A'}" style="background: var(--gold-light);">
      </div>
      
      <div class="row">
        <div class="input-group">
          <label>Transaction Date</label>
          <input type="text" readonly value="${displayDate}">
        </div>
      </div>
      
      <div class="row">
        <div class="input-group">
          <label>Passenger Name</label>
          <input type="text" readonly value="${payment.name || 'N/A'}">
        </div>
        <div class="input-group">
          <label>Flight Number</label>
          <input type="text" readonly value="${payment.flightNo || 'N/A'}">
        </div>
      </div>
      
      <div class="row">
        <div class="input-group">
          <label>Payment Method</label>
          <input type="text" readonly value="${payment.paymentType}">
        </div>
        <div class="input-group">
          <label>Currency</label>
          <input type="text" readonly value="${payment.currency}">
        </div>
      </div>
      
      <div class="row">
        <div class="input-group">
          <label>Total Amount</label>
          <input type="text" readonly value="${(payment.total || 0).toFixed(2)}" class="summary-value">
        </div>
        <div class="input-group">
          <label>Expiry Time</label>
          <input type="text" readonly value="${payment.expiryFormatted || 'N/A'}">
        </div>
      </div>
      
      <div class="row">
        <div class="input-group">
          <label>Processed By</label>
          <input type="text" readonly value="${payment.staff || 'Unknown'}">
        </div>
        <div class="input-group">
          <label>Shift</label>
          <input type="text" readonly value="${payment.shift || currentShift}">
        </div>
      </div>
  `;
  
  if (payment.paymentType !== 'Cash' && !payment.voided) {
    html += `
      <div class="row">
        <div class="input-group">
          <label>Batch Number</label>
          <input type="text" readonly value="${payment.batchNo || 'Not Entered'}">
        </div>
        <div class="input-group">
          <label>Approval Code</label>
          <input type="text" readonly value="${payment.approvalCode || 'Not Entered'}">
        </div>
      </div>
    `;
  }
  
  html += `</div>`;
  
  contentDiv.innerHTML = html;
  actionsDiv.style.display = "flex";
  document.getElementById("searchResultModal").style.display = "flex";
}

// ======== REFRESH RECEIPT DATA ========
async function refreshReceiptData(receiptNo) {
  showNotification("Refreshing receipt data...", "info", 1500);
  
  // Clear cached data
  foundReceiptData = null;
  
  // Force fetch from Firebase
  const payment = await searchPaymentByReceiptNo(receiptNo);
  if (payment) {
    foundReceiptData = payment;
    displaySearchResult(payment);
    
    if (payment.isFreshFromFirebase) {
      showNotification("Data refreshed from cloud", "success");
    } else {
      showNotification("Using local data (cloud unavailable)", "warning");
    }
  } else {
    showNotification("Receipt not found after refresh", "error");
  }
}

function closeSearchModal() {
  document.getElementById("searchResultModal").style.display = "none";
  foundReceiptData = null;
}

function printFoundReceipt() {
  if (!foundReceiptData) {
    showNotification("No receipt data found", "error");
    return;
  }
  
  if (foundReceiptData.paymentType !== 'Cash' && foundReceiptData.cardDetailsAdded && !foundReceiptData.voided) {
    printReceipt('final', foundReceiptData);
  } else if (foundReceiptData.paymentType === 'Cash' && foundReceiptData.finalReceiptPrinted && !foundReceiptData.voided) {
    printReceipt('final', foundReceiptData);
  } else if (foundReceiptData.voided) {
    printReceipt('void', foundReceiptData);
  } else {
    printReceipt('first', foundReceiptData);
  }
  
  closeSearchModal();
}

function addCardDetailsToFoundReceipt() {
  if (!foundReceiptData) return;
  
  // Check if receipt is voided
  if (foundReceiptData.voided) {
    showNotification("Cannot add card details to a voided receipt", "error");
    return;
  }
  
  if (foundReceiptData.paymentType !== 'Cash' && !foundReceiptData.cardDetailsAdded) {
    addCardDetails(foundReceiptData.id);
    closeSearchModal();
  } else {
    showNotification("This receipt doesn't require payment details or already has them.", "info");
  }
}

async function reprintPayment(paymentId) {
  const payments = await getPayments();
  const payment = payments.find(p => p.id === paymentId);
  if (payment) {
    if (payment.voided) {
      printReceipt('void', payment);
    } else if (payment.paymentType !== 'Cash' && payment.cardDetailsAdded) {
      printReceipt('final', payment);
    } else if (payment.paymentType === 'Cash' && payment.finalReceiptPrinted) {
      printReceipt('final', payment);
    } else {
      printReceipt('first', payment);
    }
  }
}

// ======== MODAL FUNCTIONS ========
function closeModal() {
  document.getElementById("cardDetailsModal").style.display = "none";
  document.getElementById("modalPaymentMethod").value = "";
  document.getElementById("modalBatchNo").value = "";
  document.getElementById("modalApprovalCode").value = "";
}

// ======== TAB FUNCTIONALITY ========
function showTab(tabName) {
  // Hide all tab contents
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Remove active class from all tab buttons
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Show selected tab content
  document.getElementById(tabName).classList.add('active');
  
  // Activate selected tab button
  event.target.classList.add('active');
  
  // Load appropriate data based on tab
  if (tabName === 'pendingCards') {
    loadPayments(); // This now only loads pending payments
  }
}

// ======== PRINT RECEIPT - PROFESSIONAL DESIGN WITH VOID SUPPORT ========
async function printReceipt(type = 'first', paymentData = null) {
  let payment = paymentData;
  
  if (!payment && currentPaymentData) {
    payment = currentPaymentData;
  }
  
  if (!payment) {
    showNotification("No payment data available. Please save a payment first.", "warning");
    return;
  }
  
  // Check company info
  checkCompanyInfo();
  
  const receiptNo = payment.receiptNo;
  const paymentType = payment.paymentType;
  const isVoided = payment.voided || false;
  
  // Update receipt printed status (only if not voided)
  if (!isVoided) {
    if (type === 'first') {
      if (paymentType !== "Cash") {
        await updatePayment(payment.id, { firstReceiptPrinted: true });
      } else if (paymentType === "Cash") {
        await updatePayment(payment.id, { firstReceiptPrinted: true });
      }
    } else if (type === 'final') {
      if (paymentType !== "Cash") {
        await updatePayment(payment.id, { finalReceiptPrinted: true });
      } else if (paymentType === "Cash") {
        await updatePayment(payment.id, { finalReceiptPrinted: true });
      }
    }
  }
  
  // Set receipt content
  const receiptHeader = document.getElementById("r_header");
  const voidBanner = document.getElementById("r_void_banner");
  const voidInfo = document.getElementById("r_void_info");
  const expirySection = document.getElementById("r_expiry_section");
  
  if (isVoided) {
    receiptHeader.innerText = "VOID RECEIPT";
    voidBanner.style.display = "block";
    voidInfo.style.display = "block";
    expirySection.style.display = "none";
    
    // Set void information
    document.getElementById("r_voided_by").innerText = payment.voidedBy || 'Unknown';
    document.getElementById("r_voided_at").innerText = payment.voidedAt ? 
      formatDateForDisplay(new Date(payment.voidedAt)) : 
      'Unknown';
    document.getElementById("r_void_reason").innerText = payment.voidReason || 'No reason provided';
  } else {
    receiptHeader.innerText = "PASSENGER PAYMENT RECEIPT" + (type === 'final' ? ' (FINAL)' : '');
    voidBanner.style.display = "none";
    voidInfo.style.display = "none";
    expirySection.style.display = "block";
  }
  
  document.getElementById("r_receiptNo").innerText = receiptNo + (isVoided ? ' (VOID)' : (type === 'final' ? ' (FINAL)' : ''));
  document.getElementById("r_date").innerText = formatDateForDisplay(new Date());
  document.getElementById("r_shift").innerText = payment.shift || currentShift;
  document.getElementById("r_staff").innerText = payment.staff || currentUser || 'Unknown';
  document.getElementById("r_name").innerText = payment.name || 'N/A';
  document.getElementById("r_flight").innerText = payment.flightNo || 'N/A';
  document.getElementById("r_seat").innerText = payment.seatNo || 'N/A';
  document.getElementById("r_adults").innerText = payment.adults || 0;
  document.getElementById("r_kids").innerText = payment.kids || 0;
  document.getElementById("r_payment_method").innerText = paymentType;
  document.getElementById("r_currency").innerText = payment.currency || 'N/A';
  
  // Calculate subtotal and GST for display
  const subtotal = payment.total ? (payment.total / 1.08).toFixed(2) : '0.00';
  const gst = payment.total ? (payment.total - (payment.total / 1.08)).toFixed(2) : '0.00';
  
  document.getElementById("r_subtotal").innerText = subtotal;
  document.getElementById("r_gst").innerText = gst;
  document.getElementById("r_total").innerText = (payment.total || 0).toFixed(2);
  document.getElementById("r_expiry").innerText = payment.expiryFormatted || calculateExpiryTime().formatted;
  
  // Show/hide receipt sections based on payment type
  if (paymentType !== "Cash") {
    document.getElementById("r_card_details").style.display = "block";
    document.getElementById("r_cash_details").style.display = "none";
    
    // Only show payment details if they exist
    if (payment.cardDetailsAdded && payment.batchNo && payment.approvalCode) {
      document.getElementById("r_batch").innerText = payment.batchNo;
      document.getElementById("r_approval").innerText = payment.approvalCode;
    } else {
      // Hide payment details section if no details available
      document.getElementById("r_card_details").style.display = "none";
    }
  } else {
    document.getElementById("r_card_details").style.display = "none";
    document.getElementById("r_cash_details").style.display = "block";
    document.getElementById("r_paid").innerText = (payment.paidAmount || 0).toFixed(2);
    document.getElementById("r_balance").innerText = (payment.balance || 0).toFixed(2);
  }
  
  // Print receipt for 76mm thermal printer
  printThermalReceipt();
  
  // Show notification
  const receiptType = isVoided ? 'Void' : (type === 'final' ? 'Final' : 'First');
  showNotification(`Printed ${receiptType} Receipt: ${receiptNo}`, "success");
}

function printThermalReceipt() {
  const content = document.getElementById("receiptContent").innerHTML;
  
  // Create a print-friendly window with 76mm width
  const printWindow = window.open('', '_blank', 'width=300,height=600');
  
  // Thermal printer friendly CSS with void styling
  const thermalCSS = `
    <style>
      @media print {
        body {
          width: 70mm !important;
          margin: 0 !important;
          padding: 0 !important;
          font-family: 'Courier New', monospace !important;
          font-size: 12px !important;
        }
        * {
          font-size: 12px !important;
          line-height: 1.2 !important;
        }
        .no-print { display: none !important; }
        @page {
          margin: 0;
          size: 70mm auto;
        }
        #r_void_banner {
          background: #e74c3c !important;
          color: white !important;
          font-weight: bold !important;
          border: 2px solid #000 !important;
        }
        #r_void_info {
          background: #f8d7da !important;
          border: 1px solid #f5c6cb !important;
        }
      }
      body {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        width: 70mm;
        margin: 0 auto;
        padding: 5px;
      }
      h1, h2, h3 {
        font-size: 14px;
        margin: 5px 0;
      }
      hr {
        border: none;
        border-top: 1px dashed #000;
        margin: 5px 0;
      }
      .text-center { text-align: center; }
      .text-right { text-align: right; }
      .text-bold { font-weight: bold; }
      .text-large { font-size: 16px; }
      .text-small { font-size: 10px; }
      .border-dashed { border: 1px dashed #000; }
      .receipt-container {
        width: 100%;
        max-width: 70mm;
        margin: 0 auto;
      }
      #r_void_banner {
        background: #e74c3c;
        color: white;
        font-weight: bold;
        border: 2px solid #000;
      }
      #r_void_info {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
      }
    </style>
  `;
  
  printWindow.document.write(`
    <html>
      <head>
        <title>Koveli Lounge Receipt</title>
        ${thermalCSS}
      </head>
      <body onload="window.print(); setTimeout(() => window.close(), 500);">
        <div class="receipt-container">
          ${content}
        </div>
      </body>
    </html>
  `);
  
  printWindow.document.close();
}

// ======== NEW: INITIALIZE RECEIPT COUNTER ========
async function initializeReceiptCounter() {
  try {
    // Check if we have a last used receipt
    const lastUsed = localStorage.getItem('lastUsedReceipt');
    
    if (lastUsed) {
      const lastNumber = parseInt(lastUsed);
      if (!isNaN(lastNumber) && lastNumber >= 1564) {
        // Set local counter to last used number
        localStorage.setItem('receiptCounter', lastNumber.toString());
        console.log(`Initialized receipt counter from last used: ${lastNumber}`);
      }
    }
    
    // Try to sync with Firebase for the latest number
    if (checkFirebase()) {
      try {
        const receiptsRef = window.walkinDb.collection("receipts");
        const snapshot = await receiptsRef
          .orderBy("receiptNumber", "desc")
          .limit(1)
          .get();
        
        if (!snapshot.empty) {
          const latestReceipt = snapshot.docs[0].data();
          const firebaseNumber = latestReceipt.receiptNumber;
          
          const localCounter = parseInt(localStorage.getItem('receiptCounter') || '1563');
          
          // Use the higher number between Firebase and local
          if (firebaseNumber > localCounter) {
            localStorage.setItem('receiptCounter', firebaseNumber.toString());
            console.log(`Updated local counter from Firebase: ${firebaseNumber}`);
          }
        }
      } catch (error) {
        console.warn("Could not sync receipt counter with Firebase:", error);
      }
    }
    
  } catch (error) {
    console.error("Error initializing receipt counter:", error);
  }
}

// ======== AUTO EVENT LISTENERS ========
window.onload = async function(){
  // Initialize company info
  checkCompanyInfo();
  
  // Initialize receipt counter
  await initializeReceiptCounter();
  
  // Get current user from localStorage
  getCurrentUser();
  
  // Check if Firebase is initialized
  if (!checkFirebase()) {
    showNotification("Firebase not initialized. Working in offline mode.", "warning", 5000);
  } else {
    console.log("Firebase is ready");
  }
  
  // Initialize shift system FIRST
  console.log("Initializing shift system...");
  await fetchShiftData();
  
  updatePricing();
  togglePaymentFields();

  // Live update pricing
  ['adults','kids','rateType','currency'].forEach(id=>{
    document.getElementById(id).addEventListener('input', updatePricing);
    document.getElementById(id).addEventListener('change', updatePricing);
  });
  
  // Update cash fields when paid amount changes
  document.getElementById("paidAmount").addEventListener('input', updateCashFields);
  
  // Toggle payment fields when payment type changes
  document.getElementById("paymentType").addEventListener('change', function() {
    togglePaymentFields();
    
    // Update the modal payment method dropdown to match selection
    const selectedMethod = this.value;
    if (selectedMethod !== 'Cash') {
      // When selecting a non-cash method, pre-select it in modal
      const modalPaymentMethod = document.getElementById("modalPaymentMethod");
      if (modalPaymentMethod) {
        // Find and select the option
        for (let option of modalPaymentMethod.options) {
          if (option.value === selectedMethod) {
            option.selected = true;
            break;
          }
        }
      }
    }
  });

  // Auto parse code as user types
  document.getElementById("codeInput").addEventListener('input', parseCode);
  
  // Prevent focus on readonly fields
  ['subtotal','gst','total','balance'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('focus', function() { this.blur(); });
    }
  });
  
  // Close modals when clicking outside
  document.getElementById("cardDetailsModal").addEventListener('click', function(e) {
    if (e.target === this) {
      closeModal();
    }
  });
  
  document.getElementById("searchResultModal").addEventListener('click', function(e) {
    if (e.target === this) {
      closeSearchModal();
    }
  });
  
  // Search on Enter key in receipt search
  document.getElementById("receiptSearch").addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      searchReceipt();
    }
  });
  
  // Initialize expiry time
  calculateExpiryTime();
  
  // Cleanup old local payment data on startup
  setTimeout(() => {
    cleanupOldLocalPayments();
  }, 3000);
  
  // Start syncing any pending payments
  setTimeout(() => {
    pendingSyncQueue = getPendingPayments().filter(p => !p.synced);
    if (pendingSyncQueue.length > 0 && checkFirebase()) {
      syncPendingPayments();
      showNotification(`Syncing ${pendingSyncQueue.length} pending payments...`, "info", 3000);
    }
  }, 2000);
};
</script>
</body>
</html>
